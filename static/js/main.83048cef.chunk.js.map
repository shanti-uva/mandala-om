{"version":3,"sources":["legacy/kmapsSolrUtil.js","legacy/searchui.js","legacy/places.js","legacy/audiovideo.js","legacy/subjects.js","legacy/images.js","legacy/texts.js","legacy/sources.js","legacy/visuals.js","legacy/terms.js","legacy/collections.js","legacy/pages.js","main/TopBar.js","main/Home.js","main/ContentHeader.js","views/AudioVideoViewer.js","views/ImagesViewer.js","views/TextsViewer.js","views/SourcesViewer.js","views/VisualsViewer.js","views/PlacesViewer.js","views/SubjectsViewer.js","views/RelatedsViewer.js","views/LegacyViewer.js","views/common/utils.js","views/TermsViewer_Definitions.js","views/TermsViewer_Names.js","views/TermsViewer_AudioPlayer.js","views/TermsViewer_RelatedTerms.js","views/common/NodeHeader.js","views/common/FeaturePager.js","views/common/FeatureCard.js","views/common/FeatureGallery.js","views/common/FeatureDeck.js","views/common/FeatureList.js","views/common/FeatureCollection.js","views/common/RelatedsGallery.js","views/TermsViewer.js","views/SearchViewer.js","views/CollectionsViewer.js","logic/searchapi.js","context/KmapContext.js","model/SearchModel.ts","model/KmapModel.ts","model/StoreModel.ts","context/SearchContext.js","main/ContentPane.js","main/Hamburger.js","main/BasicSearch.js","main/AdvancedToggle.js","main/HamburgerToggle.js","search/SearchBar.js","search/FacetBox.js","search/SearchAdvanced.js","main/Main.js","App.js","serviceWorker.js","index.js"],"names":["KmapsSolrUtil","overrideDefaultState","$","this","defaultState","extend","facetJSON","facetAdvancedJSON","related","domain","blockChildren","type","field","limit","facet","related_subject","related_subject_name","id","title","bool","state","selected_facets","filter_facet","ALL_ASSETS","allAssets","currentFacets","length","n","sf","fac","console","error","isEmptyObject","log","facet_fqs","m","split","facet_name","facet_filter","new_fq","push","searchstring","query","text","replace","page","pageSize","starts","search","slashy","start","fq_array","places","buildFq","subjects","terms","features","collections","languages","assets","i","users","creators","project_filter","kmapid","basic_req","kmapid_req","reqbase","req","JSON","stringify","baseurl","solrUrl","params","URLSearchParams","append","p","URL","toString","atype","alist","createBasicQuery","collection_uid","facets","facet_field","tag","bangtag","st","entry","km","op","termIndexRoot","path","lvla","lvlb","fl","levelField","ancestorField","jsonfacetblob","fieldList","join","level_fqlist","lvl","short_path","slice","path_filter","level_fqs","queryObj","SearchUI","site","useProdIndex","sui","curResults","numItems","AND","OR","NOT","ss","icon","mode","data","all","c","g","images","sources","texts","visuals","searches","showBool","showSearch","noTop","rel","href","appendTo","solrId","solrBase","view","sort","numResults","solrUtil","ClearQuery","arguments","DrawResults","Error","html","slideToggle","on","alert","window","open","slideUp","here","location","history","pushState","hash","match","toLowerCase","setupPage","GetKmapFromID","kmap","uid","pages","Draw","v","relatedId","relatedType","relatedBase","DrawRelatedResults","ParseQuerystring","val","Query","scrollTop","remove","css","width","display","DrawHeader","DrawFooter","q","f","str","qString","o","fs","substr","relationships","termPerspective","subjectPerspective","placePerspective","fromHistory","collectionId","url","LoadingIcon","ts","parse","perspectives","buildAssetQuery","createKmapQuery","SetState","SerializeQuery","ActiveSearch","filter","s","splice","ajax","dataType","jsonp","done","dir","MassageKmapData","response","docs","ParseFacetData","fail","msg","Popup","callback","base","Math","max","buildQuery","res","getJSON","d","r","recordings","audio_file","e","url_json","asset_type","subcollection_uid_ss","xhr","asset_subtype","charAt","toUpperCase","url_thumb","ancestors_txt","ancestor_ids_is","display_label","buckets","asset_counts","count","min","ResetFacetList","noRefresh","slideDown","prop","DrawItems","lastPage","floor","isNaN","currentTarget","substring","a","b","timestamp","node_user","DrawCardItem","DrawGridItem","DrawListItem","DrawRelatedAssets","num","originalEvent","metaKey","SendMessage","url_html","creator","summary","caption","s1","offset","left","top","ShowItemMore","feature_types_ss","collection_title","j","kmapid_strict","kmapid_strict_ss","label","gg","data_phoneme_ss","duration_s","name_tibt","RecentSearches","DrawInput","DrawFacetList","DrawFacetTree","ignoreText","key","activeSearch","target","AddNewFilter","off","DrawAdvanced","k","undefined","AddPop","items","searchItem","sorted","QueryFacets","color","line","keyCode","RegExp","empty","itms","an","bn","height","curTree","div","LazyLoad","GetTopRow","focus","stopPropagation","_this","prefix","tops","ka","kha","ga","nga","ca","cha","ja","nya","ta","tha","da","na","pa","pha","ba","ma","tsa","tsha","dza","wa","zha","za","ya","ra","la","sha","sa","ha","row","parent","hasClass","offsetX","children","toggleClass","clientX","lastMode","handleClick","init","GetTreeChildren","re","facet_counts","facet_fields","ancestor_id_path","header","after","plc","lat","lon","lab","ui","size","time","x","y","fadeIn","delay","fadeOut","len","middle","cname","name","decodeURIComponent","document","cookie","indexOf","value","Date","setTime","getTime","toUTCString","message","debugObject","showAlert","Places","app","extent","showing","content","content2","popovers","DrawMetadata","container","map","baseMap","kml","mapView","sceneView","activeView","opt","bookmarks","legend","layers","basePick","sketch","center","zoom","tilt","reqs","loc","candidates","spatialReference","wkid","GoToExtent","DrawTabMenu","ShowTab","GeoLocate","DrawContent","GetChildNamesFromID","oo","l","_childDocuments_","related_names_header_s","lang","related_names_language_s","related_names_relationship_s","write","related_names_writing_system_s","ety","related_names_etymology_s","related_names_path_s","tab","related_names_level_i","GetRelatedFromID","illustration_external_url","addClass","illustration_mms_url","AddRelatedTabs","AddRelatedPlaces","AddRelatedSubjects","which","AddRelBranch","find","tabs","drawTabB","firstChild","sups","ancestors","AddRelTreeLine","ancestor_uids_generic","counts","child_counts","AddRelatedContext","block_child_type","related_places_header_s","related_places_relation_label_s","sub","related_places_feature_type_s","related_uid_s","biggest","Object","keys","drawCat","feature_types_idfacet","related_subjects_display_string_s","related_subjects_time_units_t","related_subjects_id_s","AudioVideo","inPlay","curTransSeg","transRes","scrollStart","handScroll","mouseDown","playEnd","wid","entryId","w","kWidget","destroy","GetJSONFromKmap","field_video","und","entryid","en","field_audio","field_year_published","node_created","FormatDate","collection_idfacet","collection_uid_s","field_pbcore_description","field_language","field_description","showTab","DrawTranscript","embed","targetId","uiconf_id","entry_id","flashvars","autoPlay","addReadyCallback","kdp","getElementById","kBind","PlayAV","clearInterval","transTimer","DrawMetaData","t","field_subcollection_new","field_subject","field_recording_location_new","field_language_kmap","field_terms","field_copyright_owner","field_pbcore_rights_summary","node_user_full_s","field_pbcore_creator","field_creator_role","field_creator","field_pbcore_contributor","field_contributor_role","field_contributor","field_pbcore_publisher","field_publisher","field_pbcore_instantiation","seg","trid_i","ts_content_rus","content_bod","dzo_bod","ts_content_sgt","ts_content_kjz","ts_content_tgf","ts_content_cgk","ts_content_dka","ts_content_dzl","ts_content_goe","ts_content_xkz","ts_content_kru","ts_content_lkh","ts_content_lya","ts_content_lep","ts_content_lhp","ts_content_luk","ts_content_npb","ts_content_neh","ts_content_ole","ts_content_tsj","ts_content_xkf","ts_content_wylie","ts_content_gyal","ts_content_gvr","ts_content_npa","ts_content_nmm","ts_content_kte","ts_content_tsum","ts_content_nep","ts_content_eng","ts_content_zho","ts_content_und","ts_content_gloss","speakers","segs","layout","rev","speaker","fts_start","end","fts_end","dur","fts_duration","ss_speaker_bod","ss_language","DrawTranscriptMenu","DrawTransContent","curHit","hits","show","av","HighlightSeg","trigger","SaveStrFile","sendNotification","element","createElement","setAttribute","encodeURIComponent","style","body","appendChild","click","removeChild","SecondsToTimecode","clearTimeout","setTimeout","setInterval","now","evaluate","position","timecode","h","Number","secs","Subjects","relatedPlaceData","relatedSubjectData","GetSubjectData","GetPlaceData","GetRelatedPlaces","DrawRelatedPlaces","sortMode","level","pop","ind","addTreeLine","countChildren","addChildren","marker","each","before","summary_eng","names_txt","AddSubjectContext","subs","related_subjects_relation_label_s","related_subjects_header_s","child_count","numFound","Images","mid","asp","url_thumb_height","url_thumb_width","img_width_s","img_height_s","drawDetails","DrawItem","field_image_type","field_image_descriptions","field_image_agents","field_agent_role","field_agent_dates","field_image_digital","field_image_color","field_image_quality","field_image_rotation","field_physical_size","field_image_capture_device","field_image_materials","field_image_enhancement","field_longitude","field_latitude","field_copyright_holder","field_copyright_statement","field_original_filename","field_technical_notes","field_license_url","sx","sy","px","py","pic","onmousedown","onwheel","cursor","event","preventDefault","deltaX","deltaY","pageX","pageY","onmousemove","dx","dy","onmouseup","onwheeel","def","bold","Texts","url_ajax","field_book_author","field_book_editor","field_dc_date_publication_year","field_dc_date_orginial_year","field_kmap_places","field_kmap_subjects","field_kmap_terms","field_kmap_termss","field_book_translator","field_dc_language_original","field_dc_rights_general","field_pdf_version","Sources","publisher_s","biblio_pages","hide","biblio_year","biblio_secondary_title","biblio_place_published","field_kmaps_subjects","field_kmaps_places","biblio_url","Visuals","shivaNode","parseJSON","shivanode_json","hgt","src","dataSourceUrl","node_user_full","toggle","Terms","recordingGroup","tagged","LEGACY_SUI","audioURLs","SetTabContent","Audio","play","GetAudioFromID","removeClass","GetChildDataFromID","odata","str2","str3","str4","firstName","related_definitions_source_s","related_definitions_content_s","related_definitions_author_s","related_definitions_language_s","GetDefinitionAssets","defNum","addSubjectsPopover","data_grammars_ss","data_tibet_and_himalayas_ss","data_literary_period_ss","data_register_ss","data_language_context_ss","etymologies_ss","kmapid_subjects_idfacet","related_uid_ss","pagesrelatedId","Collections","AddTabContent","collection_title_path_ss","collection_uid_path_ss","subcollection_name_ss","subcollection_id_is","members_name_ss","members_id_ss","collection_visibility_s","Pages","reldiv","curKmap","carouselTimer","img","txt","vis","trm","col","recentPages","editing","PageRouter","PopoverTimer","lastPopover","ClearPopover","DisplayPopover","pos","offsetString","String","one","sk","browse","tot","DrawTree","dot","curCon","setPanel","date","getMonth","getDate","getFullYear","small","TopBar","className","to","alt","Home","props","ContentHeader","siteClass","kmasset","AudioVideoViewer","errorInfo","prevProps","prevState","snapshot","nextProps","nextState","nextContext","parser","Parser","output","React","Component","ImagesViewer","class","TextsViewer","kmaps","SourcesViewer","VisualsViewer","PlacesViewer","SubjectsViewer","onStateChange","RelatedsViewer","baseArgs","baseType","baseUid","relateds","RelatedCount","iconClass","LegacyViewer","viewer","withRouter","buildNestedDocs","child_type","path_field","_","forEach","doc","order","curr","_nested_","Definition","primaryList","otherSort","otherList","entries","definitions","otherSource","otherDict","nested","isEmpty","DefinitionEntry","OtherDefinitionEntry","Fragment","useState","setOpen","details","setDetails","definitionUnescaped","definitionDetails","branches","startsWith","subjects_uids_t","subjects_headers_t","deets","header_s","values","detailsMarkup","valuesList","parseDetails","Card","onMouseEnter","onMouseLeave","Collapse","in","Header","Nav","variant","defaultActiveKey","Item","Link","eventKey","onSelect","Body","Text","name_latin","out","Definitions","definitionsTree","Title","TermNames","namesTree","NameEntry","names","outlist","TermAudioPlayer","audioRefs","player","useRef","defRecordingUrl","recording_url","audioUrl","setAudioUrl","option_list","recording_dialect_s","playButton","onClick","current","onChange","handleSelect","ref","onSubmit","RelatedTerms","NodeHeader","nameTibtElement","nameLatinElement","FeaturePager","aria-label","pager","getMaxPage","getPage","pg","setPage","onPressEnter","evt","blur","readOnly","disabled","loadingState","getPageSize","ps","setPageSize","FeatureCard","Img","Accordion","Toggle","as","Button","FeatureGallery","DEBUG_PRE","LIST","url_large","original","thumbnail","FeatureGalleryHeaderLine","targetRowHeight","photos","Jumbotron","BP_SIZES","sm","md","lg","xl","FeatureDeck","REMAINDER","bp_sizes","remainderCards","maxLength","remClasses","remainderCard","rowFiller","ret","featureCard","insertBreakPoints","Container","CardDeck","FeatureList","innerHTML","FeatureCollection","useParams","paramsViewMode","viewMode","setViewMode","requestedViewMode","FeatureCollectionViewModeSelector","useHistory","ToggleButtonGroup","navigate","ToggleButton","RelatedsGallery","TermsViewer","SearchViewer","CollectionsViewer","checksum","crypto","createHash","update","digest","searchstate","getAssetSearchPromise","getCached","request","sessionStorage","cached","getItem","setCache","setItem","rows","asset_count","related_subjects","related_terms","queryParams","searchString","constructTextQuery","searchText","jsonpAdapter","Promise","resolve","reject","performance","mark","axios","then","cleanAssetData","catch","reason","finally","measure","getEntriesByName","duration","getEntries","clearMeasures","getAssetDataPromise","getFullKmapDataPromise","cleanKmapData","getRelatedAssetsPromise","host","index","selectUrl","defaultStart","defaultRows","ALL","asset_types","startRec","rowsRec","facetJson","unpackResponse","stateKey","promise","deriveImageUrl","KmapContext","setKmapId","setKmAsset","setRelateds","setKmap","relatedPage","setRelatedPage","maxCount","maxPage","oldSize","oldPage","newPage","changed","promises","allSettled","kmasset_result","kmap_result","relateds_result","kmasset_status","status","new_kmasset","kmap_status","new_kmap","relateds_status","new_relateds","kmprops","Children","child","cloneElement","AssetType","Oper","BlockChildType","BlockType","searchModel","results","filters","operator","Or","facetConfigs","maxStart","gotoPage","action","pageNum","nextPage","increment","newStart","prevPage","decrement","firstPage","thunk","actions","payload","helpers","searchState","getStoreState","receiveResults","setSearchText","addFilters","removeFilters","clearFilters","onUpdate","thunkOn","storeActions","storeModel","asset","createTypedHooks","useStoreActions","useStoreState","useStoreDispatch","useStore","SearchContext","funcs","reduce","result","func","debounce","useEffect","ContentPane","useRouteMatch","exact","Error404","Hamburger","openclass","hamburgerOpen","BasicSearch","inputEl","handleSubmit","handleChange","defaultValue","placeholder","onKeyDownCapture","AdvancedToggle","toggleAdvanced","bind","setAdvanced","adv","advanced","BASIC_LABEL","ADVANCED_LABEL","HamburgerToggle","toggleHamburger","setHamburgerOpen","hamOpen","SearchBar","handleStateChange","handleInputChange","setState","newstate","FacetBox","chosen_icon","assetType","float","border","borderRadius","fontSize","paddingLeft","SearchAdvanced","defaultChecked","stateDefault","Main","new_state","basename","pathname","App","Boolean","hostname","store","createStore","ReactDOM","render","navigator","serviceWorker","ready","registration","unregister"],"mappings":"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","file":"static/js/main.83048cef.chunk.js","sourcesContent":["/*\nKmaps Solr Util to encaspulate solr query assembly logic\n\nUsage:\n\n        var util = new KmapsSolrUtil();\n        var url = util.createBasicQuery(state);\n\n    createBasicQuery(state) uses a populated \"state\" object and returns the appropriate url as a String.\n\n */\n/* eslint-disable */\n\nimport $ from 'jquery';\n\n\nconst DEBUG = false;\n\nexport default class KmapsSolrUtil {\n\n    constructor(overrideDefaultState) {\n        // // check to make sure that jQuery is available\n        // if (typeof $ !== \"function\")\n        //     $ = jQuery;\n\n        if (typeof $ === \"undefined\") {\n            throw(\"This libraries requires jQuery\");\n        }\n\n        // this is the default state, state that is passed in overrides these values\n        this.defaultState = {\n            \"solrUrl\": \"https://solrUrl.must.be.set.in.the.state.object\",\n            \"mode\": \"input\",\n            \"view\": \"Card\",\n            \"sort\": \"Alpha\",\n            \"type\": \"All\",\n            \"page\": 0,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current page being shown\n            \"pageSize\": 100,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Results per page\n            \"query\": { \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current query\n                \"text\": \"\",\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Search word\n                \"places\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Places\n                \"collections\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Collections\n                \"languages\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Languages\n                \"features\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Feature types\n                \"subjects\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Subjects\n                \"terms\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Terms\n                \"relationships\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Relationships\n                \"users\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Users\n                \"assets\": [],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assets\n                \"dateStart\": \"\",\n                \"dateEnd\": \"\",\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Beginning and ending dates\n                \"project_filter\": \"\"\n            }\n        };\n\n        // override the defaultState with state that was passed in the constructor\n        if (overrideDefaultState) {\n            this.defaultState = $.extend(true, {}, this.defaultState, overrideDefaultState);\n        }\n\n\n        // facet configs.\n\n        // This probably should be a config element.\n        this.facetJSON = {\n            \"asset_counts\": {\n                \"limit\": 100,\n                \"type\": \"terms\",\n                \"field\": \"asset_type\",\n                \"domain\": {\"excludeTags\": \"ast\"}\n            },\n\n            \"places\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"kmapid_places_idfacet\"\n            },\n            \"subjects\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"kmapid_subjects_idfacet\"\n            },\n            \"terms\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"kmapid_terms_idfacet\"\n            },\n            \"features\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"feature_types_idfacet\"\n            },\n            \"languages\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"node_lang\"\n            },\n            \"collections\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"collection_idfacet\"\n            },\n\n            // \"subjects\": {\n            //     \"limit\": 300,\n            //     \"type\": \"terms\",\n            //     \"field\": \"kmapid\",\n            //     \"prefix\": \"subjects\",\n            //     \"facet\": {\n            //         \"title\": {\n            //             \"limit\":1,\n            //             \"type\":\"terms\",\n            //             \"field\":\"title\"\n            //         }\n            //     }\n            // },\n            \"collection_nid\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"collection_nid\"\n            },\n            \"collection_uid\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"collection_uid_s\"\n            },\n            \"asset_subtype\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"asset_subtype\",\n                \"facet\": {\n                    \"parent_type\": {\n                        \"limit\": 1,\n                        \"type\": \"terms\",\n                        \"field\": \"asset_type\"\n                    }\n                }\n            },\n            \"node_user\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"user_name_full_s\"\n            },\n            \"creator\": {\n                \"limit\": 300,\n                \"type\": \"terms\",\n                \"field\": \"creator\"\n            }\n            // \"feature_types_ss\": {\n            //     \"limit\": 300,\n            //     \"type\": \"terms\",\n            //     \"field\": \"feature_types_ss\"\n            // },\n\n            // \"node_lang\": {\n            //     \"limit\": 300,\n            //     \"type\": \"terms\",\n            //     \"field\": \"node_lang\"\n            // },\n            // \"schema_version\": {\n            //     \"limit\": -1,\n            //     \"type\": \"terms\",\n            //     \"field\": \"schema_version_i\"\n            // }\n        };\n\n\n        this.facetAdvancedJSON = {\n            related: {\n                domain: {blockChildren: \"block_type:parent\"},\n                type: \"terms\",\n                field: \"related_subjects_relation_code_s\",\n                limit: -1,\n                facet: {\n                    related_subject: {\n                        type: \"terms\",\n                        field: \"related_subjects_id_s\",\n                        limit: -1,\n                        facet: {\n                            related_subject_name: {\n                                type: \"terms\",\n                                field: \"related_subjects_header_s\",\n                                limit: 1\n                            }\n                        }\n                    }\n                }\n            }\n        };\n    }\n\n    allAssets() {\n        return [\n            {id: \"audio-video\", title: \"audio-video\", bool: \"OR\"},\n            {id: \"images\", title: \"images\", bool: \"OR\"},\n            {id: \"texts\", title: \"images\", bool: \"OR\"},\n            {id: \"visuals\", title: \"visuals\", bool: \"OR\"},\n            {id: \"sources\", title: \"sources\", bool: \"OR\"},\n            {id: \"subjects\", title: \"subjects\", bool: \"OR\"},\n            {id: \"places\", title: \"places\", bool: \"OR\"},\n            {id: \"terms\", title: \"terms\", bool: \"OR\"}\n        ];\n    }\n\n    createBasicQuery(state, selected_facets, filter_facet) {\n\n        const ALL_ASSETS = this.allAssets();\n\n        state = $.extend(true, {}, this.defaultState, state);\n\n        // process selected facets.\n        var currentFacets = {};\n\n        // selected facets\n        if (selected_facets && selected_facets.length > 0) {\n            for (var n = 0; n < selected_facets.length; n++) {\n                var sf = selected_facets[n];\n                var fac = this.facetJSON[sf];\n                if (fac) {\n                    currentFacets[sf] = fac;\n                } else {\n                    console.error(\"Warning: ignoring unknown facet: \" + sf);\n                }\n            }\n        }\n\n        if ($.isEmptyObject(currentFacets)) {\n            console.log(\"no currentFacets so using ALL facets\");\n            currentFacets = this.facetJSON;\n        }\n\n        var facet_fqs = [];\n        // argument form [ facetname:filterstring ]\n        if (filter_facet) {\n            if (filter_facet.length > 0) {\n                for (var m = 0; m < filter_facet.length; m++) {\n                    var split = filter_facet[m].split(':');\n                    var facet_name = split[0];\n                    var facet_filter = split[1];\n                    // console.dir({ \"facet_name\": facet_name, \"facet_filter\": facet_filter });\n\n                    var facet_blob = this.facetJSON[facet_name];\n                    // console.dir(facet_blob);\n\n                    var field = facet_blob.field;\n\n                    // console.log (\"FIELD: \"+ field);\n                    var new_fq = field + \":*\" + facet_filter + \"*\"\n                    facet_fqs.push(new_fq);\n                }\n            }\n        }\n\n        function escapeSearchString(str) {\n            str = str.replace(/ /g, '\\\\ '); // escape spaces\n            str = str.replace('(', '\\\\(');\n            str = str.replace(')', '\\\\)');\n            str = str.replace(':', '\\\\:');\n            str = str.replace('+', '\\\\+');\n            str = str.replace('-', '\\\\-');\n            str = str.replace('\"', '\\\\\\\"');\n            str = str.replace('?', '\\\\?');\n\n            return str;\n        }\n\n        // create request object\n\n        var searchstring = state.query.text || \"\";\n        searchstring = escapeSearchString(searchstring);\n        var page = state.page || 0;\n        var pageSize = state.pageSize || 100;\n\n        if (facet_fqs.length > 0) pageSize = 0;  // zero pagesize if this is a facet filtering situation\n\n        // console.log (JSON.stringify(state));\n        var starts = (searchstring.length) ? searchstring + \"*\" : \"*\";\n        var search = (searchstring.length) ? \"*\" + searchstring + \"*\" : \"*\";\n        var slashy = searchstring + \"/\";\n        if ($.type(searchstring) === \"undefined\" || searchstring.length === 0) {\n            searchstring = search = slashy = \"*\";\n        }\n        var start = page * pageSize;\n\n        var fq_array = [];\n\n        // places\n        if (state.query.places && state.query.places.length) {\n            fq_array.push(this.buildFq(state.query.places, \"kmapid\"));\n        }\n\n        // subjects\n        if (state.query.subjects && state.query.subjects.length) {\n            fq_array.push(this.buildFq(state.query.subjects, \"kmapid\"));\n        }\n\n        // terms\n        if (state.query.terms && state.query.terms.length) {\n            fq_array.push(this.buildFq(state.query.terms, \"kmapid\"));\n        }\n\n        // slices\n        if (state.query.features && state.query.features.length) {\n\n            // console.error(\"FEATURES!\");\n            // console.dir(state.query.slices);\n            fq_array.push(this.buildFq(state.query.features, \"feature_types_ss\", \"title\"));\n        }\n\n        // collections\n        if (state.query.collections && state.query.collections.length) {\n            fq_array.push(this.buildFq(state.query.collections, \"collection_uid_s\", \"id\"));\n        }\n\n        // languages\n        if (state.query.languages && state.query.languages.length) {\n            fq_array.push(this.buildFq(state.query.languages, \"node_lang\", \"title\"));\n            // console.error(\"LANGUAGES!\");\n            // console.dir(state.query.languages);\n        }\n\n        if (state.query.assets && state.query.assets.length) {\n\n            // handle \"all\" id\n            for (var i = 0; i < state.query.assets.length; i++) {\n\n                // console.log(\"asset id = \" + state.query.assets[i].id);\n                if (state.query.assets[i].id === \"all\") {\n                    state.query.assets = ALL_ASSETS;\n                }\n            }\n\n            fq_array.push(this.buildFq(state.query.assets, \"asset_type\", \"id\", \"ast\"));\n        }\n\n        if (state.query.users && state.query.users.length) {\n\n\n            if (DEBUG) {\n                console.error(\"USERS!\");\n                console.dir(state.query.users);\n            }\n\n            fq_array.push(this.buildFq(state.query.users, \"node_user\", \"title\"));\n\n        }\n\n        if (state.query.creators && state.query.creators.length) {\n\n\n            if (DEBUG) {\n                console.error(\"CREATORS!\");\n                console.dir(state.query.creators);\n            }\n\n            fq_array.push(this.buildFq(state.query.creators, \"creator\", \"title\"));\n\n        }\n\n        // project filtering\n        if (state.project_filter && state.project_filter.length) {\n            fq_array.push(state.project_filter);\n            if (DEBUG) { // debugging\n                console.error(\"PROJECT_FILTER:\");\n                console.dir(state.project_filter);\n                console.error(\"FQ:\");\n                console.dir(fq_array);\n            }\n        }\n\n        var kmapid = \"\";\n        if (state.query.kmapid) {\n            kmapid = state.query.kmapid;\n        }\n        // console.log(JSON.stringify (fq_array, undefined, 2));\n\n        var basic_req = {\n            // search: tweak for scoping later\n            \"q\": \"(\" +\n                \" title:${xact}^100\" +\n                \" title:${slashy}^100\" +\n                \" names_txt:${xact}^90\" +\n                \" title:${starts}^80\" +\n                \" names_txt:${starts}^70\" +\n                \" title:${search}^10\" +\n                \" caption:${search}\" +\n                \" summary:${search}\" +\n                \" names_txt:${search}\" +\n                \")\",\n\n            // search strings\n            \"xact\": searchstring,\n            \"starts\": starts,\n            \"search\": search,\n            \"slashy\": slashy,\n        };\n\n        var all_req = {\n            \"q\": \"*\"\n        };\n\n        var kmapid_req = {\n            \"q\": \"(uid:${kmapid}^100 kmapid:${kmapid})\",\n            \"kmapid\": kmapid\n        };\n\n        if (searchstring === \"*\" || searchstring === \"\") {\n            basic_req = all_req;\n        }\n\n        var reqbase = (kmapid.length) ? kmapid_req : basic_req;\n        var req = $.extend(\n            {},\n            {\n                // generic settings (maybe tweak for efficiency later)\n                \"fl\": \"*\",\n                \"wt\": \"json\",\n\n                // paging\n                \"start\": start,\n                \"rows\": pageSize,\n\n                // facets\n                \"facet\": \"on\",\n                \"json.facet\": JSON.stringify(currentFacets),\n\n                /*\n                // highlighting\n                \"hl\": \"on\",\n                \"hl.method\": \"unified\",\n                \"hl.fl\": \"title,caption,summary,names_txt\",\n                \"hl.fragsize\": 0,\n                \"hl.tag.pre\": \"<mark>\",\n                \"hl.tag.post\": \"</mark>\",\n                */\n\n                // debug settings  -- set both to false in production?\n                \"echoParams\": \"explicit\",\n                \"indent\": \"true\"\n            },\n            reqbase);\n\n        var baseurl = state.solrUrl;\n        var params = new URLSearchParams(req);\n\n        // process the fq's\n\n        for (var i = 0; i < fq_array.length; i++) {\n            params.append(\"fq\", fq_array[i]);\n        }\n\n        for (var p = 0; p < facet_fqs.length; p++) {\n            params.append(\"fq\", facet_fqs[p]);\n        }\n\n        var url = new URL(baseurl + \"?\" + params.toString());\n        return url;\n    }\n\n    createKmapQuery(kmapid, atype, page, pageSize) {\n\n        const ALL_ASSETS = this.allAssets();\n        pageSize = (pageSize) ? pageSize : 10;\n        page = (page) ? page : 0;\n        var alist = (atype) ? [{id: atype, title: atype, bool: \"OR\"}] : ALL_ASSETS;\n        return this.createBasicQuery(\n            {\n                page: page,\n                pageSize: pageSize,\n                query: {\n                    kmapid: kmapid,\n                    assets: alist\n                }\n            },\n            ['asset_counts']\n        );\n    }\n\n    createAssetsByCollectionQuery(collection_uid, page, pageSize) {\n        return this.createBasicQuery(\n            {\n                page: page,\n                pageSize: pageSize,\n                query: {\n                    collections: [{title: collection_uid, id: collection_uid, bool: \"OR\"}]\n                }\n            }\n        );\n    }\n\n    buildFq(facets, facet_field, type, tag) {\n        if (!type) {\n            type = \"id\";\n        }\n        var bangtag = (tag) ? \"{!tag=\" + tag + \"}\" : \"\";\n        // console.log(\"Got facet values: \" + JSON.stringify(facets));\n        var st = \"\";\n        for (var i = 0; i < facets.length; i++) {\n            var entry = facets[i];\n            // console.log(\"Got facet: \" + JSON.stringify(entry));\n            var km = entry[type];\n            var op = \"\";\n\n            if (entry.bool === \"AND\") {\n                op = \"+\";\n            } else if (entry.bool === \"NOT\") {\n                op = \"-\";\n            } else if (entry.bool === \"OR\") {\n                op = \"\";\n            } else {\n                console.error(\"Unknown operator = \" + entry.bool + \" : \" + JSON.stringify(entry));\n            }\n\n            st += \" \" + op + \"\\\"\" + km + \"\\\"\";\n        }\n\n        var fq = bangtag + facet_field +\n            \":(\" + st + \")\";\n        // console.log(\"FQ: \" + fq);\n        return fq;\n    }\n\n    createAdvancedFacetQuery(state) {\n        state = $.extend(true, {}, this.defaultState, state);\n\n        state.solrUrl = \"https://ss251856-us-east-1-aws.measuredsearch.com/solr/kmterms_dev/select\"\n\n        // create request object\n\n        var searchstring = state.query.text || \"\";\n        var page = state.page || 0;\n        var pageSize = state.pageSize || 100;\n        // console.log (JSON.stringify(state));\n        var starts = searchstring + \"*\";\n        var search = \"*\" + searchstring + \"*\";\n        var slashy = searchstring + \"/\";\n        if ($.type(searchstring) === \"undefined\" || searchstring.length === 0) {\n            searchstring = search = slashy = \"*\";\n        }\n\n        var req =\n            {\n                // search: tweak for scoping later\n                \"q\": \"(\" +\n                    \" header:${xact}^100\" +\n                    \" header:${slashy}^100\" +\n                    // \" names_txt:${xact}^90\" +\n                    \" header:${starts}^80\" +\n                    // \" names_txt:${starts}^70\" +\n                    \" header:${search}^10\" +\n                    // \" caption:${search}\" +\n                    // \" summary:${search}\" +\n                    // \" names_txt:${search}\" +\n                    \")\",\n\n                // search strings\n                \"xact\": searchstring,\n                \"starts\": starts,\n                \"search\": search,\n                \"slashy\": slashy,\n\n                // generic settings (maybe tweak for efficiency later)\n                \"fl\": \"*,[child parentFilter=block_type:parent]\",\n                \"wt\": \"json\",\n\n                // paging\n                \"start\": page,\n                \"rows\": pageSize,\n\n                // facets\n                \"facet\": \"on\",\n                \"json.facet\": JSON.stringify(this.facetAdvancedJSON),\n\n                // highlighting\n                // \"hl\": \"on\",\n                // \"hl.method\": \"unified\",\n                // \"hl.fl\": \"header,caption,summary,names_txt\",\n                // \"hl.fragsize\": 0,\n                // \"hl.tag.pre\": \"<mark>\",\n                // \"hl.tag.post\": \"</mark>\",\n\n                // debug settings  -- set both to false in production?\n                \"echoParams\": \"explicit\",\n                \"indent\": \"true\"\n            };\n\n        var baseurl = state.solrUrl;\n        var params = new URLSearchParams(req);\n        var url = new URL(baseurl + \"?\" + params.toString());\n        return url;\n    }\n\n    buildQuery(termIndexRoot, type, path, lvla, lvlb, fl) {\n        var SOLR_ROW_LIMIT = 2000;\n        path = path.replace(/^\\//, \"\").replace(/\\s\\//, \" \");  // remove root slashes\n        if (path === \"\") {\n            path = \"*\";\n        }\n\n        var levelField = \"level_i\";\n        var ancestorField = \"ancestor_id_path\";\n        if (type === \"terms\") {\n            levelField = \"level_tib.alpha_i\";\n            ancestorField = \"ancestor_id_tib.alpha_path\";\n        }\n\n        var jsonfacetblob = {\n            \"child_counts\": {\n                \"limit\": 300,\n                \"mincount\": 2,\n                \"type\": \"terms\",\n                \"field\": ancestorField,\n                \"domain\": {\"excludeTags\": \"hoot\"}\n            }\n        };\n\n        // noinspection ConditionalExpressionJS\n        var fieldList = (fl) ? fl : ([\n            \"header\",\n            \"id\",\n            \"ancestor*\",\n            \"caption_eng\",\n            \"position*\",\n            levelField\n        ].join(\",\"));\n\n        var level_fqlist = [];\n\n        for ( var lvl = lvlb + 1; lvl > lvla; lvl--) {\n            var short_path = path.split(\"/\").slice(0,lvl-1).join(\"/\");\n            // console.log(\"shorty: \" + lvl +\": \" + JSON.stringify(short_path));\n            let path_filter = (short_path.length)?\" AND \" + ancestorField + \":\" + short_path: \"\";\n            level_fqlist.push(\"(\" + levelField + \":\" + (lvl - 1) + path_filter +\")\");\n        }\n        const level_fqs = level_fqlist.join(\" \");  // space separated list (OR)\n        let top_path = path.split(\"/\").slice(0,lvla).join(\"/\");\n        // console.dir(level_fqs);\n        // console.log(\"top_path = \" + top_path)\n\n        var req_url =\n            termIndexRoot + \"/select?\" +\n            \"df=\" + ancestorField +\n            \"&q=\" + top_path +\n            \"&wt=json\" +\n            \"&indent=true\" +\n            \"&limit=\" + SOLR_ROW_LIMIT +\n            \"&facet=true\" +\n            \"&fl=\" + fieldList +\n            \"&indent=true\" +\n\n            \"&fq=tree:\" + type +\n            \"&fq=\" + levelField + \":[\" + lvla + \"+TO+\" + (lvlb + 1) + \"]\" +\n            \"&fq={!tag=hoot}\" + level_fqs +\n            \"&facet.mincount=2\" +\n            \"&facet.limit=-1\" +\n            \"&sort=\" + levelField + \"+asc,position_i+asc,header+asc\" +\n            \"&facet.sort=\" + ancestorField + \"+ASC\" +\n            \"&facet.field={!ex=hoot}\" + ancestorField +\n            \"&json.facet=\" + JSON.stringify(jsonfacetblob) +\n            \"&wt=json\" +\n            \"&json.wrf=?\" +\n            \"&rows=\" + SOLR_ROW_LIMIT;\n        return req_url;\n    }\n\n    buildAssetQuery(queryObj) {\n        var url = this.createBasicQuery(queryObj);\n        // console.log(\"Returning \" + url);\n        return url;\n    }\n\n\n};","/* \tMANDALA SEARCH UI ****************************************************************************************************************************\n\n\tUSE CASE 1:\n\tWhen allocated, attaches a <div> framework containing a search button in the top white bar of the Mandala app.\n\tWhen clicked, it will expand to cover the entire screen. \n\tAn sui=open message is sent to host.\n\tWhen a SOLR query is needed, a JSON formatted version of the search object is sent to host uoing a sui=query message.\n\tThe host responds with a SOLR query.\n\tWhen an item has been selected, a sui=page message is sent to host and the host navigates there.\n\tThe UI retreats to only the search button.\n\tA sui=close message is sent to host.\n\n\tUSE CASE 2:\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCalls:\t\tkmapsSolrUtil.js, [places.js, pages.js, texts.js,\t// Other JS modules that are dynamically loaded (not used in plain search)\n\t\t\t\taudiovideo.js, visuals.js, sources.js, subjects.js]\t\t\t\t\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tImages:\t\tloading.gif, gradient.jpg, treebuts.png\n\tGlobals:\tsui\t\t\t\t\t\t\t\t\t\t\t\t\t// Needs to be declared globally!\n\tUsage: \t\tvar sui=new SearchUI();\t\t\t\t\t\t\t\t// Allocs SearchUI class (fully encapsulated)\n\tMessages: \tsui=page|url ->\t\t\t\t\t\t\t\t\t\t// Hides search and send url to direct Drupal to display\n\t\t\t\tsui=open|searchState ->\t\t\t\t\t\t\t\t// Tells Drupal search page is open w/ current search state (ss object)\n\t\t\t\tsui=query|searchState ->\t\t\t\t\t\t\t// Asks Drupul to turn search state (JSON) into SOLR query string\n\t\t\t\tsui=close ->\t\t\t\t\t\t\t\t\t\t// Tells Drupal search page is closed\n\t\t\t\t-> sui=open|[searchState] \t\t\t\t\t\t\t// Open search page is to search state\n\t\t\t\t-> sui=close\t\t\t\t\t\t\t\t\t\t// Close search page\n\n**********************************************************************************************************************************************/\n/* eslint-disable */\n\nimport $ from 'jquery';\nimport KmapsSolrUtil from './kmapsSolrUtil';\n\nexport default class SearchUI  {\n\n\tconstructor(site, useProdIndex)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tthis.sui = this;\n\t\tthis.curResults=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Returns results\n\t\tthis.numItems=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Number of items\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\tthis.AND=\"AND\";\tthis.OR=\"OR\";\tthis.NOT=\"NOT\";\t\t\t\t\t\t\t\t\t\t\t\t// Boolean display names\n\t\tthis.ss={};\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds search state\n\t\tthis.site=site;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Site to use\n\t\tthis.facets={};\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\tthis.facets.assets=\t\t\t{ type:\"list\",  icon:\"&#xe60b\", mode:null, data:[] };\t\t\t// Assets \n\t\tthis.facets.places=\t\t\t{ type:\"tree\",  icon:\"&#xe62b\", mode:null, data:[] };\t\t\t// Places \n\t\tthis.facets.features=\t\t{ type:\"tree\",  icon:\"&#xe638\", mode:null, data:[] };\t\t\t// Features \n\t\tthis.facets.subjects=\t\t{ type:\"tree\",  icon:\"&#xe634\", mode:null, data:[] };\t\t\t// Subjects \n\t\tthis.facets.terms=\t\t\t{ type:\"tree\",  icon:\"&#xe635\", mode:null, data:[] };\t\t\t// Terms \n\t\tthis.facets.collections=\t{ type:\"list\",  icon:\"&#xe633\", mode:null, data:[] };\t\t\t// Collections \n\t\tthis.facets.languages=\t\t{ type:\"tree\",  icon:\"&#xe670\", mode:null, data:[] };\t\t\t// Languages \n\t\tthis.facets.users=\t\t\t{ type:\"input\", icon:\"&#xe600\", mode:null, data:[] };\t\t\t// Terms \n\t\n\t\tthis.assets={};\n\t\tthis.assets.all=\t \t\t{ c:\"#5b66cb\", g:\"&#xe60b\" };\t\t\t\t\t\t\t\t\t// All assets\n\t\tthis.assets.places=\t \t\t{ c:\"#6faaf1\", g:\"&#xe62b\" };\t\t\t\t\t\t\t\t\t// Places\n\t\tthis.assets[\"audio-video\"]=\t{ c:\"#58aab4\", g:\"&#xe648\" };\t\t\t\t\t\t\t\t\t// AV\n\t\tthis.assets.images=\t \t\t{ c:\"#b49c59\", g:\"&#xe62a\" };\t\t\t\t\t\t\t\t\t// Images\n\t\tthis.assets.sources= \t\t{ c:\"#5a57ad\", g:\"&#xe631\" };\t\t\t\t\t\t\t\t\t// Sources\n\t\tthis.assets.texts=\t \t\t{ c:\"#8b5aa1\", g:\"&#xe636\" };\t\t\t\t\t\t\t\t\t// Texts\n\t\tthis.assets.visuals= \t\t{ c:\"#6e9456\", g:\"&#xe63b\" };\t\t\t\t\t\t\t\t\t// Visuals\n\t\tthis.assets.subjects=\t\t{ c:\"#cc4c39\", g:\"&#xe634\" };\t\t\t\t\t\t\t\t\t// Subjects\n\t\tthis.assets.terms=   \t\t{ c:\"#a2733f\", g:\"&#xe635\" };\t\t\t\t\t\t\t\t\t// Terms\n\t\tthis.assets.collections=   \t{ c:\"#5b66cb\", g:\"&#xe633\" };\t\t\t\t\t\t\t\t\t// Collections\n\t\tthis.searches=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Saves recent searches\n\t\tthis.showBool=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Where to show Boolean in advanced\n\t\tthis.showSearch=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Click to search or add facet\n\n\t\tthis.noTop=(site == \"CU\") ? true : false;\t\t\t\t\t\t\t\t\t\t\t\t\t// Has a top\n\t\t$(\"<link/>\", { rel:\"stylesheet\", type:\"text/css\", href:\"searchui.css\" }).appendTo(\"head\"); \t// Load CSS\n\n\t\tthis.solrId=useProdIndex ? \"_prod\" : \"_dev\";\t\t\t\t\t\t\t\t\t\t\t\t// Set solrId\n\t\tthis.solrBase=\"https://\"+(useProdIndex ? \"ss395824\" : \"ss251856\")+\"-us-east-1-aws.measuredsearch.com/solr/\"; // Solr base\t\n\t\tthis.ss.solrUrl=this.solrBase+\"kmassets\"+(useProdIndex ?  \"\" : \"_dev\")+\"/select\";\t\t\t// Full url\n\t\tthis.ss.mode=\"input\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current mode - can be input, simple, or advanced\n\t\tthis.ss.view=\"Card\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Dispay mode - can be List, Grid, or Card\n\t\tthis.ss.sort=\"Alpha\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sort mode - can be Alpha, Date, or Author\n\t\tthis.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current page being shown\n\t\tthis.ss.pageSize=100;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Results per page\t\n\t\tthis.ss.site=\"Mandala\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Site\n\t\tthis.ss.numResults=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Number of resulrts found\n\t\tthis.solrUtil=new KmapsSolrUtil( {solrUrl: this.ss.solrUrl });\t\t\t// Alloc Yuji's search class and pass defaultState\n\t\tthis.ClearQuery();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Cleae our all search elements in query\n\t\t// this.AddFrame();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add div framework\n\t\t\n\t\t// if (!window.location.hash)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Normal startup\n\t\t// \tthis.Draw(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw\n\t\t// }\n\t\t// window.onresize=()=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON RESIZE\n\t\t// \tif (this.ss.mode == \"advanced\") \t\t\t\t\t\t\t\t\t\t\t\t\t\t// Advanced search\n\t\t// \t\t$(\"#sui-content\").css({ width:$(\"#sui-main\").width()-$(\"#sui-adv\").width() });\t\t\t// Size results area\n\t\t// };\n\t\t\n\t\t// window.addEventListener(\"popstate\", (h)=> { \t\t\t\t\t\t\t\t\t\t\t\t// ON PAGE STATE CHANGE\n\t\t// \tlet state=h.state;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get state\n\t\t// \tif (!state)\tstate=window.location.hash;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If no state, get directly from hash\n\t\t// \tthis.PageRouter(state); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Route on state\n\t\t// \t});\n\t\t}\n\t\n\t// AddFrame()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD DIV FRAMEWORK FOR APP\n\t// {\n\t// \talert(\"addFrame()\");\n\t// \tconsole.error(\"AddFrame() called!\");\n\t// \treturn;\n\t//\n\t// \tlet key;\n\t// \tthis.showBool=this.GetCookie(\"showBool\") == \"true\";\n\t// \tvar str=\"\";\n\t// \tif (this.site != \"CU\") str+=`<div class='sui-topBar'><img src='img/bhutanleft.gif' style='cursor:pointer' onclick='alert(\"draw landing page\")' title='Home page'></div>\n\t// \t\t<div id='sui-top' class='sui-top'>\n\t// \t\t<div style='display:inline-block'>\n\t// \t\t<div class='sui-search1'>\n\t// \t\t\t\t<input type='text' id='sui-search' class='sui-search2' placeholder='Enter Search'>\n\t// \t\t\t\t<div id='sui-clear' class='sui-search3'>&#xe610</div>\n\t// \t\t\t</div>\n\t// \t\t\t<div id='sui-searchgo' class='sui-search4'>&#xe623</div>\n\t// \t\t\t<div id='sui-mode' class='sui-search5' title='Advanced search'>ADVANCED<br>SEARCH</div>\n\t// \t\t\t<div id='sui-hamBut' class='sui-hamBut' title='Help + options'>&#xe627</div>\n\t// \t\t\t</div>\n\t// \t\t</div>\n\t// \t<div>`;\n\t// \tstr+=`<div id='sui-content' class='sui-content'>\n\t// \t\t<div id='sui-header' class='sui-header'>\n\t// \t\t\t<div id='sui-contentHead' class='sui-contentHead'></div>\n\t// \t\t</div>\n\t// \t\t<div id='sui-legacy' class='sui-legacy scrollbar' style='color:#000'></div>\n\t// \t</div>\n\t// \t<div id='sui-adv' class='sui-adv'>`;\n\t// \tfor (key in this.facets) {\n\t// \t\t\tstr+=`<div class='sui-advBox' id='sui-advBox-${key}'>\n\t// \t\t\t<div class='sui-advHeader' id='sui-advHeader-${key}'>\n\t// \t\t\t\t${this.facets[key].icon}&nbsp;&nbsp;${key.toUpperCase()}\n\t// \t\t\t\t<span id='sui-advPlus-${key}' style='float:right'>&#xe669 </span></div>\n\t// \t\t\t\t<div class='sui-advTerm' id='sui-advTerm-${key}'></div>\n\t// \t\t\t<div class='sui-advEdit' style='display:none' id='sui-advEdit-${key}'></div></div>`;\n\t// \t\t\tif ((key == \"terms\") || (key == \"users\")) str+=\"<hr style='border-top:8px solid #ddd;margin:16px 0 16px 12px'>\";\n\t// \t\t\t}\n\t// \tstr+=`<div class='sui-advBox' id='sui-advBox-recent'>\n\t// \t\t<div class='sui-advHeader' id='sui-advHeader-recent'>&#xe62e&nbsp;&nbsp;RECENT SEARCHES\n\t// \t\t<span id='sui-advPlus-recent' style='float:right'>&#xe669</span></div>\n\t// \t\t<div class='sui-advTerm'></div>\n\t// \t\t<div class='sui-advEdit' style='display:none' id='sui-advEdit-recent'></div></div>\n\t// \t\t<div style='margin-top:4px;float:right;font-size:13px'>\n\t// \t\t\t<div>Show Boolean controls? &nbsp;<input type='checkbox' id='sui-showBool' ${this.showBool ? \"checked\" : \"\"}></div>\n\t// \t\t\t<!-- div class='sui-geoLocate' id='sui-geoLocate'>Geo-Locate</div-->\n\t// \t\t</div>\n\t// \t</div>\n\t// \t<div id='sui-footer' class='sui-footer'></div></div>\n\t// \t<div class='sui-hamburger' id='sui-hamburger'></div>`;\n\t//\n\t// \t$(\"#sui-main\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove formatting and add framework to main div\n\t// \t// $(\"#sui-advHeader-assets\").html($(\"#sui-advHeader-assets\").html().replace(/Assets/i,\"ITEM TYPE\"));  // Rename assets\n\t// \t$(\"#sui-clear, sui-clear2\").on(\"mouseover\",function() { $(this).html(\"&#xe60d\"); });\t\t// Highlight\n\t// \t$(\"#sui-clear, sui-clear2\").on(\"mouseout\", function() { $(this).html(\"&#xe610\"); });\t\t// Normal\n\t// \t$(\"#sui-clear, sui-clear2\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t// ON ERASE\n\t// \t\t$(\"#sui-search\").val(\"\");\tthis.ClearQuery(); \t\t\t\t\t\t\t\t\t\t\t// Clear input and query\n\t// \t\tthis.Query(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Load and redraw\n\t// \t\t});\n\t//\n\t// \t$(\"#sui-search\").on(\"change\", (e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON SEARCH CHANGE\n\t// \t\tthis.ss.query.text=$(\"#\"+e.currentTarget.id).val(); \t\t\t\t\t\t\t\t\t// Get query\n\t// \t\t$(\"#sui-search\").val(this.ss.query.text);\t\t\t\t\t\t\t\t\t\t\t\t// Set top search\n\t// \t\tif ((this.ss.mode == \"input\") || (this.ss.mode == \"related\")) this.ss.mode=\"simple\";\t// Toggle simple mode\n\t// \t\tif (this.ActiveSearch(false)) this.ss.mode=\"advanced\";\t\t\t\t\t\t\t\t\t// Some advanced search items set, open advanced search\n\t// \t\tthis.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at beginning\n\t// \t\tthis.Query(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Load and redraw\n\t// \t\t});\n\t//\n\t// \t$(\"#sui-searchgo, #sui-searchgo2\").on(\"click\", (e)=> { \t\t\t\t\t\t\t\t\t\t// ON SEARCH BUTTON CLCK\n\t// \t\tif ((this.ss.mode == \"input\") || (this.ss.mode == \"related\") ) this.ss.mode=\"simple\";\t// Toggle simple mode\n\t// \t\tif (this.ActiveSearch(false)) this.ss.mode=\"advanced\";\t\t\t\t\t\t\t\t\t// Some advanced search items set, open advanced search\n\t// \t\tthis.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at beginning\n\t// \t\tthis.Query(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Load and redraw\n\t// \t\t});\n\t//\n\t// \t$(\"#sui-mode\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON CHANGE MODE\n\t// \t\tthis.ShowAdvanced((this.ss.mode == \"advanced\") ? false : true);\t\t\t\t\t\t\t// Toggle advanced menu\n\t// \t\t});\n\t//\n\t// \t$(\"#sui-showBool\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON CHANGE BOOLEAN\n\t// \t\tthis.showBool=!this.showBool;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Toggle flag\n\t// \t\tthis.SetCookie(\"showBool\", this.showBool);\t\t\t\t\t\t\t\t\t\t\t\t// Set cookie\n\t// \t\tthis.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw search UI\n\t// \t\t});\n\t// \t$(\"#sui-geoLocate\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON GEO LOCATE\n\t// \t\tthis.GeoLocate();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show geolocation\n\t// \t\t});\n\t//\n\t// \t$(\"[id^=sui-advHeader-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON FACET HEADER CLICK\n\t// \t\tvar id=e.currentTarget.id.substring(14);\t\t\t\t\t\t\t\t\t\t\t\t// Get facet name\n\t// \t\t$(\".sui-advEdit\").slideUp(400, ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// Close any open tree or lists\n\t// \t\t\t$(\"[id^=sui-advHeaderBox-]\").css(\"border\",\"solid\")\t\t\t\t\t\t\t\t\t// Reset them all to closed\n\t// \t\t$(\"[id^=sui-advPlus-]\").html(\"&#xe669\");\t\t\t\t\t\t\t\t\t\t\t\t// Reset them all to closed\n\t// \t\tif ($(\"#sui-advEdit-\"+id).css(\"display\") != \"none\")\t{\t\t\t\t\t\t\t\t\t// If open\n\t// \t\t\t$(\"#sui-advPlus-\"+id).html(\"&#xe66a\");\t\t\t\t\t\t\t\t\t\t\t\t// Show open\n\t// \t\t\t$(\"#sui-advHeaderBox-\"+id).css(\"border-top-style\",\"hidden\")\t\t\t\t\t\t\t// Hide border\n\t// \t\t\t}\n\t// \t\t});\n\t// \t\t$(\"#sui-advPlus-\"+id).html(\"&#xe66a\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Show open\n\t//\n\t// \t\tfor (var key in this.facets)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each facet\n\t// \t\t\tif (this.facets[key] == \"list\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a list\n\t// \t\t\t\t$(\"#sui-advEdit-\"+key).html(\"\");\t\t\t\t\t\t\t\t\t\t\t\t// Erase contents\n\t// \t\tthis.DrawFacetItems(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw appropriate tree, list, or input\n\t// \t\t});\n\t//\n\t// \t$(\"#sui-main\").on(\"click\",(e)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK OF RESULTS PAGE\n\t// \t\tthis.pages.ClearPopover();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear popover\n\t// \t\tif (e.target.id != \"sui-hamBut\") $(\"#sui-hamburger\").slideUp();\t\t\t\t\t\t\t// Hide hanburderv menu if open\n\t// \t\t});\n\t// \t$(\"#sui-hamBut\").on(\"click\",()=>{ this.ShowHamburger() });\t\t\t\t\t\t\t\t\t// SHOW HAMBURGER MENU\n\t// \tif (this.noTop)\t$(\"#sui-content\").css({ top:0, height:\"calc(100% - 30px)\" });\n\t// }\n\n\tDraw(mode)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW SEARCH COMPONENTS\n\t{\n\t\tconsole.log(\"Draw called!\");\n\t\tconsole.log(\"searchui.Draw called with \" + JSON.stringify(arguments));\n\t\tif (mode) this.ss.mode=mode;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If mode spec'd, use it\n\t\tthis.DrawResults();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw results page if active\n\t\t// this.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw search UI if active\n\t}\n\n\tShowAdvanced(mode)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// HIDE/SHOW ADVANCED MENU\n\t{\n\t\tthrow new Error(\"ShowAdvanced\");\n\t\tthis.ss.mode=(mode) ? \"advanced\" : \"simple\";\t\t\t\t\t\t\t\t\t\t\t\t// Set mode\n\t\t$(\"#sui-adv\").css({ display:mode ? \"block\" : \"none\"});\t\t\t\t\t\t\t\t\t\t// Hide/show adv ui\n\t\tif (mode) $(\"#sui-content\").css({ width:($(\"#sui-main\").width()-$(\"#sui-adv\").width())+\"px\"});\t// Size results area to fit advanced\n\t\telse\t $(\"#sui-content\").css({ width:$(\"#sui-main\").width()+\"px\" });\t\t\t\t\t\t\t// 100%\n\t\tthis.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw search UI if active\n\t}\n\t\n\tShowHamburger()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW HAMBURGER MENU\n\t{\n\t\tlet str=`<span id='sui-help' class='sui-hamItem'>&#xe67e&nbsp;&nbsp;HELP GUIDE</span>\n\t\t<span id='sui-home' class='sui-hamItem'>&#xe60b&nbsp;&nbsp;HOME</span>`;\n\t\t$(\"#sui-hamburger\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t// Remove formatting and add to menu\n\t\t$(\"#sui-hamburger\").slideToggle();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Open or close\n\t\t$(\"#sui-home\").on(\"click\",()=>{  alert(\"DrawLandingPage()\"); });\t\t\t\t\t\t\t\t\t\t// Go home\n\t\t$(\"#sui-help\").on(\"click\",()=>{ window.open(\"//confluence.its.virginia.edu/display/KB/Mandala+Suite+of+Tools\",\"_blank\"); });\t// Show help\n\t\t$(\"#sui-hamburger\").on(\"click\",()=>{$(\"#sui-hamburger\").slideUp() });\t\t\t\t\t\t// Close\n\t}\n\n/*\tPAGE STATE  ////////////////////////////////////////////////////////////////////////////////////\n\t\n\tControls the forward/back buttons  and the bookmarking for the standlone version.\n\tIt uses the HTML5 History API. When page is navigated to programatically, SetState() is called.\n\tIt's state parameter contains information identifying the page via it's kmapId\n\tThis is added as a hash value to the browser's search bar for bookmarking.\n\tIt is added to the browser history for the browser's forward/back buttons.\n\n\tA listener to the 'hashchanged' event calls PageRouter() with that kmpaId, and\n\tthsat page is drawn on the screen.\n\t\n\tOPTIONS:\n\t#p=kmapId\t\t// Shows page that has kmapid\n\n///////////////////////////////////////////////////////////////////////////////////////////////// */\n\n\tSetState(state)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SET PAGE STATE\n\t{\n\t\tconst here=window.location.href.split(\"#\")[0];\t\t\t\t\t\t\t\t\t\t\t\t// Remove any hashes\n\t\twindow.history.pushState(\"#\"+state,\"Mandala\",here+(state ? \"#\"+state : \"\"));\t\t\t\t\t\t// Show current state search bar\n\t}\n\n\tPageRouter(hash)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ROUTE PAGE BASED ON QUERY HASH OR BACK BUTTON\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t{\n\t\tconsole.log (\"PageRouter called.\");\n\t\tconst sui = this.sui;\n\t\tconst here = window.location.href.split(\"#\")[0];\t\t\t\t\t\t\t\t\t\t\t\t// Remove any hashes\n\t\tlet id;\n\t\tif ((id = hash.match(/#p=(.+)/))) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a page\n\t\t\tid = id[1].toLowerCase();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Isolate kmap id\n\t\t\tsetupPage();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Prepare page's <div> environment\n\t\t\tthis.alert(\"======== PAGEROUTER: \" + hash + \" Handling p: Drawing \" + id);\n\t\t\tthis.log(\"\tPAGEROUTER: calling pages.Draw() with id=\" + id);\n\t\t\tthis.GetKmapFromID(id, (kmap) => {\n\t\t\t\tthis.log(\"\tPAGEROUTER: calling pages.Draw() with kmap=\" + kmap.uid);\n\t\t\t\tthis.pages.Draw(kmap, true);\n\t\t\t});\t\t\t\t\t\t// Get kmap and show page\n\t\t} else if ((id = hash.match(/#r=(.+)/))) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If showing related results\n\t\t\tsetupPage();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Prepare page's <div> environment\n\t\t\tlet v = id[1].replace(/\\%20/g, \" \").split(\"=\");\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\tthis.pages.relatedId = v[0];\n\t\t\tthis.pages.relatedType = v[2];// Set factors\n\t\t\tthis.alert(\"======== PAGEROUTER: \" + hash + \" Handling r: calling getKmapFromID with id = \" + v[3] + \" this.pages.relatedId=\" + this.pages.relatedId + \" this.pages.relatedType=\" + this.pages.relatedType   );\n\t\t\tthis.GetKmapFromID(v[3], (kmap) => {\n\t\t\t\tthis.pages.relatedBase = kmap;\n\t\t\t\tconsole.log(\"\tPAGEROUTER handling callback.  calling pages.DrawRelatedResults with kmap uid = \" + kmap.uid);\n\t\t\t\tthis.pages.DrawRelatedResults(kmap, true);\n\t\t\t});\t\t// Get kmap and show page\n\t\t} else if ((id = hash.match(/#s=(.+)/))) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If showing search results\n\t\t\tsetupPage();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Prepare page's <div> environment\n\t\t\tid = id[1].replace(/\\%20/g, \" \");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\tthis.ParseQuerystring(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get query\n\t\t\tthis.alert(\"======== PAGEROUTER: \" + hash + \" Handling s: Parsing querystring: \" + id + \" set ss.query.text to \" + ss.query.text) ;\n\t\t\t$(\"#sui-search\").val(this.ss.query.text);\t\t\t\t\t\t\t\t\t\t\t\t// Set top search\n\t\t\tthis.Query(true);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Run query\n\t\t}\n\n\t\tfunction setupPage() {\n\t\t\t// PREPARES <DIV> TO DRAW NEW PAGE\n\t\t\tsui.ss.mode = \"simple\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Simple display mode\n\t\t\tsui.ss.page = 0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at beginning\n\t\t\t$(\"#sui-legacy\").scrollTop(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Scroll to top\n\t\t\t$(\"#sui-content\").scrollTop(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Scroll to top\n\t\t\t$(\"#plc-infoDiv\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove map buttons\n\t\t\t$(\"#sui-content\").css({width: \"100%\", display: \"inline-block\"});\t\t\t\t\t\t\t// Size and show results area\n\t\t\t$(\"#sui-adv\").css({display: \"none\"});\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide search ui\n\t\t\t$(\"#sui-legacy\").css({display: \"block\"});\t\t\t\t\t\t\t\t\t\t\t\t// Show page\n\t\t\tsui.DrawHeader(true);\n\t\t\tsui.DrawFooter();\t\t\t\t\t\t\t\t\t\t\t// Redraw header and footer\n\t\t}\n\t}\n\n\tSerializeQuery(q)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SERIALZE QUERY INTO STRING\n\t{\n\t\tlet i,f,str=\"\";\n\t\tthis.ss.query.assets=[ this.ss.query.assets[0] ];\t\t\t\t\t\t\t\t\t\t\t// Keep only 1st asset *************************** ASSETS1\n\t\tfor (f in q.query) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each facet type\n\t\t\tif ((f == \"text\") && q.query[f])\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If text spec'd\n\t\t\t\tstr+=`${f}:${q.query[f]}=`;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it\n\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// All other facets\n\t\t\t\tfor (i=0;i<q.query[f].length;++i)\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tstr+=`${f}:${q.query[f][i].title}:${q.query[f][i].id}:${q.query[f][i].bool}=`;\t// Add it\n\t\t\t}\n\t\treturn str.slice(0,-1);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove last '+'\n\t}\n\n\tParseQuerystring(qString)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// PARSE QUERY FROM STRING\n\t{\n\t\tlet i, v, o;\n\t\tlet fs = qString.split(\"=\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Split parts\n\t\tthis.ClearQuery();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear search query\n\t\tthis.ss.query.assets = [];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear assets ********************************** ASSETS1\n\t\tfor (i = 0; i < fs.length; ++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each term\n\t\t\tif (fs[i].match(/^text/)) {\n\t\t\t\tthis.ss.query.text = fs[i].substr(5);\n\t\t\t}\t\t\t\t\t\t\t// Get text\n\t\t\telse {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get all other facets\n\t\t\t\tv = fs[i].split(\":\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get parts\n\t\t\t\to = {title: v[1], id: v[2], bool: v[3]};\t\t\t\t\t\t\t\t\t\t\t\t// Make search item\n\t\t\t\tthis.ss.query[v[0]].push(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add\t\n\t\t\t}\n\t\t}\n\t\tthis.ss.query.assets = [this.ss.query.assets[0]];\t\t\t\t\t\t\t\t\t\t\t// Keep only 1st asset *************************** ASSETS1\n\t}\n\n/*\tQUERY TOOLS //////////////////////////////////////////////////////////////////////////////////\n\n\tA series of functions that manage the search process. The state of the current search is\n\tsaved in the ss object. It is initialized using InitSearchState(). The UI modifies the ss \n\tobject to the search parameters desired and Query() uses Yuji's query builder to get a query\n\tURL for SOLR. The results come in, they are displayed. The lists in the advsnced UI are also \n\tfiltered to reflect the current possible options based on that search.\n\n\tThere are 3 modes of the search. A general qwery, as described above. The standalone version\n\tadds search of assets related to a kmapId, and a query to get the kmaps in a given collection.\n\n//////////////////////////////////////////////////////////////////////////////////////////////  */\n\n\n\n\tClearQuery()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CLEAR SEARCH QUERY STATE TO START\n\t{\n\t\t$(\"#sui-search\").val(\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear input field\n\t\tif (this.pages) this.pages.relatedBase=this.pages.relatedId=\"\";\t\t\t\t\t\t\t\t// Clear relateds\n\t\tthis.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start of page 0\n\t\tthis.ss.query={ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current query\n\t\t\ttext:\"\",\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Search word \n\t\t\tplaces:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Places\n\t\t\tcollections:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Collections\n\t\t\tlanguages:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Languages\n\t\t\tfeatures:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Feature types\n\t\t\tsubjects:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Subjects\n\t\t\tterms:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Terms\n\t\t\trelationships:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Relationships\n\t\t\tusers:[],\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Users\n\t\t\tassets:[{title:\"All\", id:\"all\",bool:\"AND\"}],\t\t\t\t\t\t\t\t\t\t\t// Assets\n\t\t\ttermPerspective:\"\", subjectPerspective:\"\", placePerspective:\"\",\t\t\t\t\t\t\t// Perspectives\n\t\t\tview:\"\"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// View\n\t\t\t};\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t}\n\n\n\t//\n\n\n\t//\n\tQuery(fromHistory, collectionId)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// QUERY AND UPDATE RESULTS\n\t{\n\t\tconsole.log(\"Query() called with fromHistory = \" + fromHistory + \" collectionId =  \" + collectionId);\n\t\tlet url;\n\t\tthis.LoadingIcon(true, 64);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\n\t\tif (collectionId) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If getting collection members\n\t\t\tconsole.log(\"\tSearchUI.Query: collection mode\");\n\t\t\tlet ts = JSON.parse(JSON.stringify(this.ss));\t\t\t\t\t\t\t\t\t\t\t\t// Clone search\n\t\t\tts.query = {\n\t\t\t\ttext: \"\",\n\t\t\t\tplaces: [],\n\t\t\t\tassets: [{id: this.pages.relatedType, bool: \"AND\"}],\n\t\t\t\tlanguages: [],\n\t\t\t\tfeatures: [],\n\t\t\t\tsubjects: [],\n\t\t\t\tterms: [],\n\t\t\t\trelationships: [],\n\t\t\t\tusers: [],\n\t\t\t\tperspectives: [],\n\t\t\t\tcollections: [{title: \"all\", id: collectionId, bool: \"AND\"}]\n\t\t\t};\t\t\t\t// Set new search\n\t\t\turl = this.solrUtil.buildAssetQuery(ts); // Set url\n\t\t} else if (this.ss.mode == \"related\") {\n\t\t\tconsole.log(\"\tSearchUI.Query: related mode\");\n\t\t\turl = this.solrUtil.createKmapQuery(this.pages.relatedId.toLowerCase(), this.pages.relatedType.toLowerCase(), this.ss.page, this.ss.pageSize);\n\t\t}\t// Get assets related to relatedId\n\t\telse {\n\t\t\tconsole.log(\"\tSearchUI.Query: asset mode\");\n\t\t\turl = this.solrUtil.buildAssetQuery(this.ss);\n\t\t}\t\t\t// Get assets that match query\n\t\tif ((this.ss.mode != \"related\") && !fromHistory) { \t\t\t\t\t\t\t\t\t\t\t// These set their own states and not from history API\n\t\t\tconsole.log(\"\tSearchUI.Query: default mode\");\n\t\t\tthis.SetState(\"s=\" + this.SerializeQuery(this.ss));\t\t\t\t\t\t\t\t\t\t// Save search state\n\t\t}\n\t\t$(\"#sui-relatedAssets\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove related assets panel\n\t\tif (this.ActiveSearch()) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If an active search\n\t\t\tthis.searches.filter((s, i) => {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Check to see if it already exists in list\n\t\t\t\tif (JSON.stringify(s.query) === JSON.stringify(this.ss.query)) \t\t\t\t\t\t// It does\n\t\t\t\t\tthis.searches.splice(i, 1);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove old one\n\t\t\t});\n\t\t\tthis.searches.push(JSON.parse(JSON.stringify(this.ss)));\t\t\t\t\t\t\t\t// Add to recent searches\n\t\t}\n\t\t$.ajax({url: url, dataType: 'jsonp', jsonp: 'json.wrf'}).done((data) => {\t\t\t\t// Get data from SOLR\n\t\t\tconsole.log (\"\tSearchUI.Query: got data back from SOLR query: \" + url);\n\t\t\tconsole.dir(data);\n\t\t\tthis.curResults = this.MassageKmapData(data.response.docs);\t\t\t\t\t\t\t\t// Normalize for display\n\t\t\tthis.ParseFacetData(data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get facet data counts\n\t\t\tthis.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\tthis.DrawResults();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw results page if active\n\t\t\t// this.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw advanced search if active\n\t\t}).fail((msg) => {\n\t\t\tconsole.log(msg);\n\t\t\tthis.LoadingIcon(false);\n\t\t\tthis.Popup(\"Query error\");\n\t\t});\t// Failure message\n\t}\n\n\n\tGetKmapFromID(id, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET KMAP FROM ID\n\t{\n\t\tconsole.log(\"GetKmapFromID() called with id=\" + id);\n\t\tvar url=this.ss.solrUrl+\"?q=uid:\"+id.toLowerCase()+\"&wt=json\";\n\t\tconsole.log(\"SOLR QUERY GetKmapFromID() = \" + url);// Set query url\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t\t// Get kmap\n\n\t\t\ttry {\n\t\t\t\tdata = this.MassageKmapData(data.response.docs[0]);\t\t\t\t\t\t\t\t\t\t// Normalize kmap\n\t\t\t} catch ( error) {\n\t\t\t\tdata.error = error;\n\t\t\t}\n\t\t\tcallback(data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return kmap\n\t\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\n\tGetDefinitionAssets(id, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET TAGGED ASSETS TO TERM\n\t{\n\t\tlet url=this.ss.solrUrl+\"?q=kmapid:\"+id.toLowerCase()+\"&wt=json\";\t\t\t\t\t\t\t// Set query url\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t\t// Get kmap\n\t\t\tdata=this.MassageKmapData(data.response.docs);\t\t\t\t\t\t\t\t\t\t\t// Normalize kmap\n\t\t\tcallback(data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return kmaps\n\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\n\tGetRelatedFromID(id, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET RELATED THINGS FROM ID\n\t{\n\t\tthis.log(\"GetRelatedFromID() called with arguments\");\n\t\tconsole.log(JSON.stringify(arguments));\n\t\tlet url=`${this.solrBase}kmterms${this.solrId}/query`;\t\t\t\t\t\t\t\t\t\t// Base url\n\t\turl+=\"?child_count.fq=related_kmaps_node_type:child&child_count.fl=uid&fq=!related_kmaps_node_type:parent\";\n\t\turl+=\"&child_count.rows=0&fl=child_count:[subquery],*&child_count.q={!child%20of='block_type:parent'}\";\n\t\turl+=\"{!term%20f=uid%20v=$row.related_subjects_id_s}&rows=2000&q=id:\"+id+\"%20OR%20{!child%20of=block_type:parent}id:\"+id+\"%20&sort=block_type%20DESC,%20related_subjects_header_s%20ASC\";\n\t\tthis.log(\"SOLR QUERY GetRelatedFromID():  query = \" + url);\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t\t// Get kmap\n\t\t\tthis.log(\"GetRelatedFromID() returns \" + data);\n\t\t\tconsole.dir(data);\n\t\t\tcallback(data.response.docs);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return data\n\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\t\n\tGetRelatedPlaces(id, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET RELATED THINGS FROM ID\n\t{\n\t\tthis.LoadingIcon(true,64);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\t\tvar url=this.solrUtil.createKmapQuery(id,\"places\",0,10000);\t\t\t\t\t\t\t\t\t\t// Make query url\n\t\t$.ajax( { url: url,  dataType: 'jsonp', jsonp: 'json.wrf' }).done((data)=> {\t\t\t\t// Get data from SOLR\n\t\t\tdata=this.MassageKmapData(data.response.docs);\t\t\t\t\t\t\t\t\t\t\t// Normalize for display\n\t\t\tthis.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\tcallback(data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return data\n\t\t\t}).fail((msg)=> { console.log(msg); this.LoadingIcon(false);  this.Popup(\"Related query error\"); });\t// Failure message\n\t}\n\n\tGetChildNamesFromID(facet,id, callback) \t\t\t\t\t\t\t\t\t\t\t\t\t// GET NAMES/ETYMOLGY DATA FROM ID\n\t{\n\t\tlet url=`${this.solrBase}kmterms${this.solrId}/select?fl=uid%2C%5Bchild%20childFilter%3Did%3A${facet}-${id}_names-*%20parentFilter%3Dblock_type%3Aparent%5D&q=uid%3A${facet}-${id}&wt=json&rows=300`;\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t\t// Get kmap\n\t\t\tcallback(data.response.docs);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return data\n\t\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\t\n\tGetChildDataFromID(uid, callback) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET CHILD DATA FROM ID\n\t{\n\t\tlet url=`${this.solrBase}kmterms${this.solrId}/query?q=uid:${uid}&wt=json&fl=*,[child%20parentFilter=block_type:parent%20limit=300]`;\n\t\tconsole.log(\"SOLR QUERY GetChildDataFromID = \" + url);\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t\t// Get kmap\n\t\t\tcallback(data.response.docs[0]);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return data\n\t\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\n\tGetTreeChildren(facet, path, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET CHILDREN OF TREE LIMB\n\t{\n\t\tconst sui = this.sui;\n\t\tlet base=`${this.solrBase}kmterms${this.solrId}`;\t\t\t\t\t\t\t\t\t\t\t// Base url\n\t\tlet lvla=Math.max(path.split(\"/\").length+1,2);\t\t\t\t\t\t\t\t\t\t\t\t// Set level\n\t\tif ((facet == \"features\") ||  (facet == \"languages\")) facet=\"subjects\";\t\t\t\t\t\t// Features and languages are in subjects\n\t\tvar url=sui.solrUtil.buildQuery(base,facet,path,lvla,lvla);\t\t\t\t\t\t\t\t\t// Build query using Yuji's builder\n\t\t$.ajax( { url: url, dataType: 'jsonp' } ).done((res)=> {\t\t\t\t\t\t\t\t\t// Get children\n\t\t\tcallback(res);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return dats\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\t\n\tGetAudioFromID(id, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET AUDIO FILE FROM ID\n\t{\n\t\t$.getJSON(\"//terms.kmaps.virginia.edu/slices/\"+id+\"/recordings\", (d)=> {\t\t\t// Get info\n\t\t\tlet i,r=[];\n\t\t\ttry{ for (i=0;i<d.recordings.length;++i)\t\t\t\t\t\t\t\t\t\t\t\t// For each recording\n\t\t\t\t\tr.push(d.recordings[i].audio_file);\t\t\t\t\t\t\t\t\t\t\t\t// Add to array\n\t\t\t\tcallback(r); } \tcatch(e){}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return audio file urls as array\n\t\t\t}).fail((msg)=> { console.log(msg); });\t\t\t\t\t\t\t\t\t\t\t\t\t// Failure message\n\t}\n\n\tGetJSONFromKmap(kmap, callback)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET JSON FROM KMAP\n\t{\n\t\tvar url=kmap.url_json;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get json\n\t\tif (!url) return;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No asset type\n\t\turl=url.replace(/images.shanti.virginia.edu/i,\"images-dev.shanti.virginia.edu\");\t\t\t// Look in dev\t\t\t\n\t\turl=url.replace(/https:|http:/i,\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Strip off http\n\t\turl+=\"?callback=myfunc\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add callback\n\t\tif ((kmap.asset_type == \"audio-video\") || kmap.subcollection_uid_ss)\t\t\t\t\t\t// AV or collection\n\t\t\turl=url.replace(/.json/i,\".jsonp\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Json to jsonp \t\t\t\n\t\t$.ajax( { url:url, dataType:'jsonp', error: (xhr)=>{ this.Popup(\"JSON access error\");}}).done((data)=> { callback(data); });\t// Get JSON and send to callback\n\t}\n\n\tMassageKmapData(data)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// MASSAGE KMAP RESPONSE FOR DISPLAY\n\t{\n\t\tvar i,o;\n\t\tfor (i=0;i<data.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each result, massage data\n\t\t\to=data[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item\n\t\t\tif (o.asset_subtype) o.asset_subtype=o.asset_subtype.charAt(0).toUpperCase()+o.asset_subtype.slice(1);\t\n\t\t\tif (o.url_thumb)\t o.url_thumb=o.url_thumb.replace(/images-test/i,\"images\");\t\t\t// Force to prod\n\t\t\tif (o.asset_type ==\"places\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If places\n\t\t\t\tif (o.ancestors_txt && o.ancestors_txt.length)\t\to.ancestors_txt.splice(0,1);\t// Remove \"Earth\" from trail\n\t\t\t\tif (o.ancestor_ids_is && o.ancestor_ids_is.length)\to.ancestor_ids_is.splice(0,1);\t// And it's id\n\t\t\t\t}\n\t\t\tif (o.asset_type == \"texts\")\t\t\t\t\to.url_thumb=\"gradient.jpg\";\t\t\t\t// Use gradient for texts\n\t\t\telse if (!o.url_thumb)\t\t\t\t\t\t\to.url_thumb=\"gradient.jpg\";\t\t\t\t// Use gradient for generic\n\t\t\tif (o.display_label) \t\t\t\t\t\t\to.title=o.display_label;\t\t\t\t// Get title form display\n\t\t\t}\n\t\treturn data;\n\t}\n\n\tParseFacetData(data)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET FACET COUNTS\n\t{\n\t\tlet i,f,val,buckets,n=0;\n\t\tfor (f in this.assets)\tthis.assets[f].n=0;\t\t\t\t\t\t\t\t\t\t\t\t\t// Zero them out\n\t\tif (data && data.facets && data.facets.asset_counts && data.facets.asset_counts.buckets) {\t// If valid\n\t\t\t\tbuckets=data.facets.asset_counts.buckets;\t\t\t\t\t\t\t\t\t\t\t// Point at buckets\n\t\t\t\tfor (i=0;i<buckets.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each bucket\n\t\t\t\t\tval=buckets[i].val;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get name\n\t\t\t\t\tif(this.assets[val]) this.assets[val].n=buckets[i].count;\t\t\t\t\t\t// Set count\n\t\t\t\t\tn+=buckets[i].count;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to count\n\t\t\t\t\t}\n\t\t\t\tthis.ss.numResults=this.assets.all.n=n;\t\t\t\t\t\t\t\t\t\t\t\t// Set total count\n\t\t\t\t}\t\n\t}\n\t\n    QueryFacets(facet, filter)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// QUERY AND UPDATE FACET OPTIONS\n    {\n\t\tif ((facet == \"users\") || (facet == \"relationships\"))\treturn;\t\t\t\t\t\t\t\t// No facets for these \n\t\tthis.LoadingIcon(true,64); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\t\tlet url=this.solrUtil.createBasicQuery(this.ss,[facet == \"assets\" ? \"languages\" : facet ]);\t // Get query url (avoid assets)\n\t\t$.ajax( { url: url,  dataType: 'jsonp', jsonp: 'json.wrf' }).done((data)=> {\t\t\t\t// Get facets\n\t\t\t\tlet i,o,v;\n\t\t\t\tthis.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\t\tif (data.facets[facet]) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If something there\n\t\t\t\t\to=data.facets[facet].buckets;\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at data\n\t\t\t\t\tthis.facets[facet].data=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start fresh\n\t\t\t\t\tfor (i=0;i<Math.min(300,o.length);++i)\t{\t\t\t\t\t\t\t\t\t\t// Get items\n\t\t\t\t\t\tv=o[i].val.split(\"|\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Split into parts\n\t\t\t\t\t\tthis.facets[facet].data.push({ title:v[0], id: v[1], n:o[i].count }); \t\t// Add to assets data\n\t\t\t\t\t\t}\t\n\t\t\t\t}\n\t\t\tthis.ResetFacetList(facet);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Reset list UI elements\n\t\t});\n\t}\n\n/*\tRESULTS ///////////////////////////////////////////////////////////////////////////////////////\n\n\tShow results based on the state of the search state object ss. When a Query() is run, 100\n\tresults are paged at a time and shown in one of 3 display modes. A list mode, a full card mode,\n\tand a grid image mode.\n\n///////////////////////////////////////////////////////////////////////////////////////////////  */\n\n\tDrawResults(noRefresh)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RESULTS SECTION\n\t{\n\t\tthis.log(\"DrawResults() called\",arguments);\n\n\t\t$(\"#sui-content\").scrollTop(0);\n\t\t$(\"#sui-legacy\").scrollTop(0);\t\t\t\t\t\t\t// Scroll to top\n\t\t$(\"#sui-legacy\").css({ \"background-image\":\"\"});\t\t\t\t\t\t\t\t\t\t\t// Remove any backgeound image\n\t\t$(\"#sui-legacy\").css({ display:\"block\" });\t\t\t\t\t\t\t\t\t\t\t\t\t// Show results page\n\t\t$(\"#plc-infoDiv\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove map buttons\n\n\t\tif (this.ss.mode == \"related\")\t\tthis.numItems=this.assets[this.pages.relatedType].n;\t// Set number of items based on related type\n\t\telse\t\t\t\t\t\t\t\tthis.numItems=this.assets[this.ss.query.assets[0].id].n; // Set number of items based on current asset being shown  ***ASSETS1\n\t\tif (this.ss.mode == \"input\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Just the search box\n\t\t\t$(\"#sui-header\").css({ display:\"none\"});\t\t\t\t\t\t\t\t\t\t\t\t// Show header\n\t\t\t$(\"#sui-header\").css({display:\"inline-block\",\"background-color\":\"#4d59ca\"} );\t\t\t// Show header\n\t\t\t$(\"#sui-content\").css({ display:\"block\",width:\"100%\" });\t\t\t\t\t\t\t\t\t// Size and show left side\n\n\t\t\t$(\"#sui-adv\").css({ display:\"none\"});\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide search ui\n\t\t\t$(\"#sui-legacy\").css({ display:\"none\" });\t\t\t\t\t\t\t\t\t\t\t\t// Hide results page\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t}\n\t\telse if (this.ss.mode == \"simple\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Simple search\n\t\t\t$(\"#sui-content\").css({ width:\"100%\" });\t\t\t\t\t\t\t\t\t\t\t\t\t// Size and show results area\n\t\t\t$(\"#sui-adv\").css({ display:\"none\"});\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide search ui\n\t\t\t$(\"#sui-content\").slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Slide down\n\t\t\t$(\"#sui-content\").css({ width:$(\"#sui-main\").width() });\t\t\t\t\t\t\t\t\t// Size and results area 100%\n\t\t\t}\n\t\telse if (this.ss.mode == \"advanced\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Advanced search\n\t\t\t$(\"#sui-adv\").css({ display:\"block\" });\t\t\t\t\t\t\t\t\t\t\t\t\t// Show search ui\n\t\t\t$(\"#sui-content\").css({ width:$(\"#sui-main\").width()-$(\"#sui-adv\").width() });\t\t\t\t// Size results area to fit advanced\n\t\t\t}\n\t\t$(\"#sui-mode\").prop({\"title\": this.ss.mode == \"advanced\" ? \"Basic search\" : \"Advanced search\" } );\t// Set tooltip\n\t\t$(\"#sui-mode\").html(this.ss.mode == \"advanced\" ? \"BASIC<br>SEARCH\" : \"ADVANCED<br>SEARCH\" );\t\t// Set mode icon\n\t\t$(\"#sui-header\").css({display:\"block\"} );\t\t\t\t\t\t\t\t\t\t\t\t\t// Show header\n\t\tif (noRefresh)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't refresh page\n\t\tthis.DrawHeader();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw header\n\t\tthis.DrawItems();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw items\n\t\tthis.DrawFooter();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw footer\n\t}\n\n\tDrawHeader()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RESULTS HEADER\n\t{\n\t\t// alert(\"pages.DrawHeader called()\");\n\t\tconsole.log(\"pages.Drawheader called!\");\n\t\tif (this.ss.mode == \"related\") \treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit for special search modes\n\t\tvar lastPage=Math.floor(this.numItems/this.ss.pageSize);\t\t\t\t\t\t\t\t\t// Calc last page\n\t\tvar s=this.ss.page*this.ss.pageSize+1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Starting item number\n\t\tvar e=Math.min(s+this.ss.pageSize,this.numItems);\t\t\t\t\t\t\t\t\t\t\t// Ending number\n\t\tvar str=`<span style='vertical-align:-10px'>${this.ss.query.assets[0].title.toUpperCase()} search results &nbsp; <span style='font-size:12px'> (${s}-${e}) of ${this.numItems}\t\n\t\t<div style='float:right;font-size:11px;margin:12px -48px 0 0'>\n\t\t\t<div id='sui-page1T' class='sui-resDisplay' title='Go to first page'>&#xe63c</div>\n\t\t\t<div id='sui-pagePT' class='sui-resDisplay' title='Go to previous page'>&#xe63f</div>\n\t\t\t<div class='sui-resDisplay'> PAGE <input type='text' id='sui-typePageT' \n\t\t\tstyle='border:0;border-radius:4px;width:30px;text-align:center;vertical-align:1px;font-size:10px;padding:2px'\n\t\t\ttitle='Enter page, then press Return'> OF ${lastPage+1}</div>\n\t\t\t<div id='sui-pageNT' class='sui-resDisplay' title='Go to next page'>&#xe63e</div>\n\t\t\t<div id='sui-pageLT' class='sui-resDisplay' title='Go to last page'>&#xe63d</div>\n\t\t\t</div>`;\n\n\n\n\t\t$(\"#sui-contentHead\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\t\t$(\"#sui-header\").css(\"background-color\",\"#888\");\t\t\t\t\t\t\t\t\t\t\t// Set b/g color\n\n\t\t$(\"#sui-typePageT\").val(this.ss.page+1);\t\t\t\t\t\t\t\t\t\t\t\t\t// Set page number\n\t\t$(\"[id^=sui-page]\").css(\"color\",\"#fff\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Reset pagers\n\t\tif (this.ss.page == 0) \t\t  \t  { $(\"#sui-page1T\").css(\"color\",\"#ddd\"); $(\"#sui-pagePT\").css(\"color\",\"#ddd\"); }\t// No back\n\t\tif (this.ss.page == lastPage)     { $(\"#sui-pageNT\").css(\"color\",\"#ddd\"); $(\"#sui-pageLT\").css(\"color\",\"#ddd\"); }\t// No forward\n\t\t$(\"#sui-page1T\").on(\"click\",()=> { this.ss.page=0; this.Query(); });\t\t\t\t\t\t// ON FIRST CLICK\n\t\t$(\"#sui-pagePT\").on(\"click\", ()=> { this.ss.page=Math.max(this.ss.page-1,0);  this.Query(); });\t // ON PREVIOUS CLICK\n\t\t$(\"#sui-pageNT\").on(\"click\", ()=> { this.ss.page=Math.min(this.ss.page+1,lastPage); this.Query(); });// ON NEXT CLICK\n\t\t$(\"#sui-pageLT\").on(\"click\", ()=> { this.ss.page=lastPage; this.Query(); });\t\t\t\t// ON LAST CLICK\n\t\t$(\"#sui-typePageT\").on(\"change\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON TYPE PAGE\n\t\t\tvar p=$(\"#sui-typePageT\").val();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get value\n\t\t\tif (!isNaN(p))   this.ss.page=Math.max(Math.min(p-1,lastPage),0);\t\t\t\t\t\t// If a number, cap 0-last\t\n\t\t\tthis.Query(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get new results\n\t\t\t});\t\t\t\t\t\t\t\n\t}\n\n\tDrawFooter()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RESULTS FOOTER\n\t{\n\t\tvar lastPage=Math.floor(this.numItems/this.ss.pageSize);\t\t\t\t\t\t\t\t\t// Calc last page\n\t\tif (this.ss.mode != \"related\")\t$(\"#sui-footer\").css(\"background-color\",\"#888\");\t\t\t// Set b/g color\n\t\tvar str=`\n\t\t<div style='float:left;font-size:18px'>\n\t\t\t<div id='sui-viewModeList' class='sui-resDisplay' title='List view'>&#xe61f</div>\n\t\t\t<div id='sui-viewModeGrid' class='sui-resDisplay' title='Grid view'>&#xe61b</div>\n\t\t\t<div id='sui-viewModeCard' class='sui-resDisplay' title='Card view'>&#xe673</div>\n\t\t</div>\t\n\t\t<div style='display:inline-block;font-size:11px'>\n\t\t\t<div id='sui-page1' class='sui-resDisplay' title='Go to first page'>&#xe63c</div>\n\t\t\t<div id='sui-pageP' class='sui-resDisplay' title='Go to previous page'>&#xe63f</div>\n\t\t\t<div class='sui-resDisplay'> PAGE <input type='text' id='sui-typePage' \n\t\t\tstyle='border:0;border-radius:4px;width:30px;text-align:center;vertical-align:1px;font-size:10px;padding:2px'\n\t\t\ttitle='Enter page, then press Return'> OF ${lastPage+1}</div>\n\t\t\t<div id='sui-pageN' class='sui-resDisplay' title='Go to next page'>&#xe63e</div>\n\t\t\t<div id='sui-pageL' class='sui-resDisplay' title='Go to last page'>&#xe63d</div>\n\t\t\t</div>\t\n\t\t<div style='float:right;font-size:16px;'>\n\t\t\t<div id='sui-viewSortAlpha' class='sui-resDisplay' title='Sort alphabetically'>&#xe652</div>\n\t\t\t<div id='sui-viewSortDate'  class='sui-resDisplay' title='Sort by date'>&#xe60c</div>\n\t\t\t<div id='sui-viewSortAuthor' class='sui-resDisplay' title='Sort by author'>&#xe600</div>\n\t\t\t</div>`;\n\t\t$(\"#sui-footer\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\t\t\n\t\t$(\"#sui-typePage\").val(this.ss.page+1);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set page number\n\t\t$(\"[id^=sui-viewMode]\").css(\"color\",\"#ddd\");\t\t\t\t\t\t\t\t\t\t\t\t// Reset modes\n\t\t$(\"#sui-viewMode\"+this.ss.view).css(\"color\",\"#fff\");\t\t\t\t\t\t\t\t\t\t// Highlight current mode\n\t\t$(\"[id^=sui-viewMode]\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t// ON MODE CLICK\n\t\t\tthis.ss.view=e.currentTarget.id.substring(12);\t\t\t\t\t\t\t\t\t\t\t// Get/set mode name\t\t\n\t\t\tthis.DrawResults(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\t});\t\t\n\n\t\t$(\"[id^=sui-viewSort]\").css(\"color\",\"#ddd\");\t\t\t\t\t\t\t\t\t\t\t\t// Reset modes\n\t\t$(\"#sui-viewSort\"+this.ss.sort).css(\"color\",\"#fff\");\t\t\t\t\t\t\t\t\t\t// Highlight current mode\n\t\t$(\"[id^=sui-viewSort]\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t// ON SORT CLICK\n\t\t\tthis.ss.sort=e.currentTarget.id.substring(12);\t\t\t\t\t\t\t\t\t\t\t// Get/set mode name\t\t\n\t\t\tif (this.ss.sort == \"Alpha\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alpha sort\n\t\t\t\tthis.curResults.sort(function(a, b) {\t\t\t\t\t\t\t\t\t\t\t\t// Sort by title\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (a.title[0] > b.title[0]) \t\treturn 1;\t\t\t\t\t\t\t\t\t// Higher\n\t\t\t\t\telse if (a.title[0] < b.title[0]) \treturn -1;\t\t\t\t\t\t\t\t\t// Lower\n\t\t\t\t\telse\t\t\t\t\t\t\t\treturn 0;\t\t\t\t\t\t\t\t\t// The same\n\t\t\t\t\t});\n\t\t\telse if (this.ss.sort == \"Date\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Date sort\n\t\t\t\tthis.curResults.sort(function(a, b) {\t\t\t\t\t\t\t\t\t\t\t\t// Sort by date\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (a.timestamp > b.timestamp) \t\treturn 1;\t\t\t\t\t\t\t\t\t// Higher\n\t\t\t\t\telse if (a.timestamp < b.timestamp) return -1;\t\t\t\t\t\t\t\t\t// Lower\n\t\t\t\t\telse\t\t\t\t\t\t\t\treturn 0;\t\t\t\t\t\t\t\t\t// The same\n\t\t\t\t\t});\n\t\t\telse if (this.ss.sort == \"Author\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t// User sort\n\t\t\t\tthis.curResults.sort(function(a, b) {\t\t\t\t\t\t\t\t\t\t\t\t// Sort by user\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (a.node_user > b.node_user) \t\treturn 1;\t\t\t\t\t\t\t\t\t// Higher\n\t\t\t\t\telse if (a.node_user < b.node_user) return -1;\t\t\t\t\t\t\t\t\t// Lower\n\t\t\t\t\telse\t\t\t\t\t\t\t\treturn 0;\t\t\t\t\t\t\t\t\t// The same\n\t\t\t\t\t});\n\t\t\t\tthis.DrawResults(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\t});\t\t\n\t\t\t\n\t\t$(\"[id^=sui-page]\").css(\"color\",\"#fff\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Reset pagers\n\t\tif (this.ss.page == 0) \t\t  \t  { $(\"#sui-page1\").css(\"color\",\"#ddd\"); $(\"#sui-pageP\").css(\"color\",\"#ddd\"); }\t// No back\n\t\tif (this.ss.page == lastPage)     { $(\"#sui-pageN\").css(\"color\",\"#ddd\"); $(\"#sui-pageL\").css(\"color\",\"#ddd\"); }\t// No forward\n\t\t$(\"#sui-page1\").on(\"click\",()=> { this.ss.page=0; this.Query(); });\t\t\t\t\t\t\t\t\t// ON FIRST CLICK\n\t\t$(\"#sui-pageP\").on(\"click\", ()=> { this.ss.page=Math.max(this.ss.page-1,0);  this.Query(); });\t\t// ON PREVIOUS CLICK\n\t\t$(\"#sui-pageN\").on(\"click\", ()=> { this.ss.page=Math.min(this.ss.page+1,lastPage); this.Query(); });// ON NEXT CLICK\n\t\t$(\"#sui-pageL\").on(\"click\", ()=> { this.ss.page=lastPage; this.Query(); });\t\t\t\t\t// ON LAST CLICK\n\t\t$(\"#sui-typePage\").on(\"change\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON TYPE PAGE\n\t\t\tvar p=$(\"#sui-typePage\").val();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get value\n\t\t\tif (!isNaN(p))   this.ss.page=Math.max(Math.min(p-1,lastPage),0);\t\t\t\t\t\t// If a number, cap 0-last\t\n\t\t\tthis.Query(); \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get new results\n\t\t\t});\t\t\t\t\t\t\t\n\t}\n\n\t// CALLS DrawCardItem(), DrawGridItem() or DrawListItem()\n\t// CALLS this.pages.DrawRelatedAssets()\n\n\tDrawItems()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RESULT ITEMS\n\t{\n\t\tconsole.log(\"SearchUI.DrawItems()\");\n\t\tvar i,str=\"\";\n\t\t$(\"#sui-legacy\").css({ \"background-color\":(this.ss.view == \"List\") ? \"#fff\" : \"#ddd\" }); \t// White b/g for list only\n\t\tif (this.ss.mode == \"related\")  $(\"#sui-legacy\").css({ \"padding-left\": \"204px\", width:\"calc(100% - 216px\"});\t// Shrink page\n\t\telse  \t\t \t\t\t\t\t$(\"#sui-legacy\").css({ \"padding-left\":\"12px\", width:\"calc(100% - 24px\"});\t// Reset to normal size\n\n\t\tfor (i=0;i<this.curResults.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each result\n\t\t\tif (this.ss.view == \"Card\")\t\t\tstr+=this.DrawCardItem(i);\t\t\t\t\t\t\t// Draw if shoing as cards\n\t\t\telse if (this.ss.view == \"Grid\")\tstr+=this.DrawGridItem(i);\t\t\t\t\t\t\t// Grid\n\t\t\telse\t\t\t\t\t\t\t\tstr+=this.DrawListItem(i);\t\t\t\t\t\t\t// List\n\t\t\t}\t\n\t\tif (!this.curResults.length)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No results\n\t\t\tstr=\"<br><br><br><div style='text-align:center;color:#666'>Sorry, there were no items found<br>Try broadening your search</div>\";\n\n\t\t// OUTPUT\n\t\t$(\"#sui-legacy\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\t// CALL\n\t\tif (this.ss.mode == \"related\") this.pages.DrawRelatedAssets();\t\t\t\t\t\t\t\t// Draw related assets menu\n\n\t\t// HANDLERS\n\t\t$(\".sui-itemIcon\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON ICON BUTTON CLICK\n\t\t\tvar num=e.currentTarget.id.substring(13);\t\t\t\t\t\t\t\t\t\t\t\t// Get index of result\t\n\t\t\tif (e.originalEvent.metaKey) window.open(\"#p=\"+this.curResults[num].uid,\"_blank\");\t\t// Open in new window\n\t\t\telse this.SendMessage(\"page=\"+this.curResults[num].url_html,this.curResults[num]);\t\t// Send message\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});\n\t\t$(\"[id^=sui-itemPic-]\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t// ON ITEM CLICK\n\t\t\tvar num=e.currentTarget.id.substring(12);\t\t\t\t\t\t\t\t\t\t\t\t// Get index of result\t\n\t\t\tif (e.originalEvent.metaKey) window.open(\"#p=\"+this.curResults[num].uid,\"_blank\");\t\t// Open in new window\n\t\t\telse this.SendMessage(\"page=\"+this.curResults[num].url_html,this.curResults[num]);\t\t// Send message\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});\n\t\t$(\".sui-gridInfo\").on(\"mouseover\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t// ON INFO BUTTON HOVER\n\t\t\tvar num=e.currentTarget.id.substring(13);\t\t\t\t\t\t\t\t\t\t\t\t// Get index of result\t\n\t\t\tvar o=this.curResults[num];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item\n\t\t\tvar str=\"\";\n\t\t\tif (o.title) str+=\"<b>\"+o.title+\"</b><br><br>\";\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\t\tstr+=this.assets[o.asset_type].g+\"&nbsp;&nbsp;\"+o.asset_type.toUpperCase();\t\t\t\t// Add type\n\t\t\tif (o.asset_subtype) str+=\" / \"+o.asset_subtype;\t\t\t\t\t\t\t\t\t\t// Add subtype\n\t\t\tstr+=\"<br>\";\n\t\t\tif (o.creator) str+=\"<p>&#xe600&nbsp;&nbsp;\"+o.creator.join(\", \")+\"</p>\";\t\t\t\t// Add creator\n\t\t\tif (o.summary || o.caption) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a summary or caption\n\t\t\t\tvar s1=o.summary || o.caption;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Use either summary or caption\n\t\t\t\tif (s1.length > 80)\ts1=s1.substr(0,80)+\"...\";\t\t\t\t\t\t\t\t\t\t// Limit size\n\t\t\t\tstr+=\"<p><div style='display:inline-block;background-color:#ccc;width:4px;height:18px;margin:2px 10px 0 5px;vertical-align:-4px'></div>&nbsp;<i>\"+s1+\"</i></p>\";\t\t\t\t\t\t\t\t\t\t// Add summary\n\t\t\t\t}\n\t\t\tif (o.summary) str+=\"<p style='font-family:serif;'>\"+o.summary+\"</p>\";\t\t\t\t\t// Add summary\n\t\t\tvar p=$(\"#\"+e.currentTarget.id).offset();\t\t\t\t\t\t\t\t\t\t\t\t// Get position\n\t\t\tthis.Popup(str,20,Math.max(8,p.left-220),p.top+24);\t\t\t\t\t\t\t\t\t\t// Show popup\t\n\t\t\t});\n\t\t$(\".sui-gridInfo\").on(\"mouseout\",(e)=> { $(\"#sui-popupDiv\").remove(); });\t\t\t\t\t// ON INFO BUTTON OUT\n\t\t$(\"[id^=sui-itemTitle-]\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t// ON TITLE CLICK\n\t\t\tvar num=e.currentTarget.id.substring(14);\t\t\t\t\t\t\t\t\t\t\t\t// Get index of result\t\n\t\t\tif (e.originalEvent.metaKey) window.open(\"#p=\"+this.curResults[num].uid,\"_blank\");\t\t// Open in new window\n\t\t\telse this.SendMessage(\"page=\"+this.curResults[num].url_html,this.curResults[num]);\t\t// Send message\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});\n\t\t$(\".sui-itemPlus\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON MORE BUTTON CLICK\n\t\t\tthis.ShowItemMore(e.currentTarget.id.substring(13));\t\t\t\t\t\t\t\t\t// Show more info below\n\t\t\t});\n\t}\t\n\n\t// NO SIDE EFFECTS\n\t// PASSED FROM CONTEXT:  this.curResults\n\tDrawListItem(num)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW A LIST ITEM\n\t{\n\t\tvar i;\n\t\tvar o=this.curResults[num];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at list item\n\t\tvar str=\"<div class='sui-item'>\";\n\t\tstr+=\"<div class='sui-itemPlus' id='sui-itemPlus-\"+num+\"'>&#xe669</div>\";\n\t\tstr+=\"<div class='sui-itemIcon' id='sui-itemIcon-\"+num+\"' style='background-color:\"+this.assets[o.asset_type].c+\"'>\";\n\t\tstr+=\"<a class='sui-noA' href='#p=\"+o.uid+\"'><span style='color:#fff'>\"+this.assets[o.asset_type].g+\"</span></a></div>\";\t// Add href for right click\n\t\tstr+=\"<div class='sui-itemTitle' id='sui-itemTitle-\"+num+\"'>\";\t\t\t\t\t\t\t\t// Add\n\t\tstr+=\"<a class='sui-noA' href='#p=\"+o.uid+\"'>\"+o.title+\"</a></div>\";\t\t\t\t\t\t// Add href for right click\n\t\tif (o.feature_types_ss) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a feature\n\t\t\tstr+=\"<span style='color:\"+this.assets[o.asset_type].c+\"'>&nbsp;&bull;&nbsp;</span>\";\t// Add dot\n\t\t\tstr+=\"<div class='sui-itemFeature'>&nbsp;\"+o.feature_types_ss.join(\", \")+\"</div>\";\t\t// Add feature(s)\n\t\t\t}\n\t\tstr+=\"<div class='sui-itemId'>\"+o.uid;\n\t\tif (o.collection_title)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a collection\n\t\t\tstr+=\"<div style='text-align:right;margin-top:2px;'>&#xe633&nbsp;\"+o.collection_title+\"</div>\";\t\t// Add title\n\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close title div\n\t\tif (o.ancestors_txt && o.ancestors_txt.length > 1) {\t\t\t\t\t\t\t\t\t\t// If has an ancestors trail\n\t\t\tstr+=\"<div class='sui-itemTrail'>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds trail\n\t\t\tfor (i=0;i<o.ancestors_txt.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t// For each trail member\n\t\t\t\tstr+=\"<span class='sui-itemAncestor' onclick='sui.SendMessage(\\\"page=\";\t\t\t\t// Add ancestor\n\t\t\t\tstr+=\"https://mandala.shanti.virginia.edu/\"+o.asset_type+\"/\";\t\t\t\t\t\t// URL stem\n\t\t\t\tstr+=o.ancestor_ids_is[i+1]+\"/overview/nojs#search\\,\"+this.curResults[num]+\")'>\";\t// URL end\n\t\t\t\tstr+=\"<a href='#p=\"+o.uid+\"'>\"+o.ancestors_txt[i]+\"</a></span>\";\t\t\t\t\t// Add href for right click\n\t\t\t\tif (i < o.ancestors_txt.length-1)\tstr+=\" > \";\t\t\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t}\n\t\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close trail div\n\t\t\t}\n\t\tstr+=\"<div class='sui-itemMore' id='sui-itemMore-\"+num+\"'></div>\";\t\t\t\t\t\t\t// More area\n\t\treturn str+\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return items markup\n\t}\n\n\t// MORE EXPANDER\n\tShowItemMore(num)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW MORE INFO\n\t{\n\t\tvar j,o,s1,str=\"\";\n\t\tif ($(\"#sui-itemMore-\"+num).html()) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If open\n\t\t\t$(\"#sui-itemMore-\"+num).slideUp(400,()=>{ $(\"#sui-itemMore-\"+num).html(\"\"); } );\t\t// Close it and clear\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\t\n\t\t\t}\n\t\t\n\t\to=this.curResults[num];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item\n\t\tif (!o.url_thumb.match(/gradient.jpg/)) \t\t\t\t\t\t\t\t\t\t\t\t\t// If not a generic\n\t\t\tstr+=\"<img src='\"+o.url_thumb+\"' class='sui-itemPic' id='sui-itemPic-\"+num+\"'>\";\t\t// Add pic\n\t\tstr+=\"<div class='sui-itemInfo'>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Info holder\n\t\tstr+=this.assets[o.asset_type].g+\"&nbsp;&nbsp;\"+o.asset_type.toUpperCase();\t\t\t\t\t// Add type\n\t\tif (o.asset_subtype) str+=\" / \"+o.asset_subtype;\t\t\t\t\t\t\t\t\t\t\t// Add subtype\n\t\tif (o.creator) str+=\"<br>&#xe600&nbsp;&nbsp;\"+o.creator.join(\", \");\t\t\t\t\t\t\t// Add creator\n\t\tif (o.summary || o.caption) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a summary or caption\n\t\t\ts1=o.summary || o.caption;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Use either summary or caption\n\t\t\tif (s1.length > 137)\ts1=s1.substr(0,137)+\"...\";\t\t\t\t\t\t\t\t\t\t// Limit size\n\t\t\tstr+=\"<br><div style='display:inline-block;background-color:#ccc;width:4px;height:18px;margin:2px 10px 0 5px;vertical-align:-4px'></div>&nbsp;<i>\"+s1+\"</i>\";\t// Add summary\n\t\t\t}\n\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close info div\n\t\tif (o.summary) str+=\"<br><div style='font-family:serif'>\"+o.summary+\"</div>\";\t\t\t\t// Add summary\n\t\tif (o.kmapid_strict && o.kmapid_strict.length) {\t\t\t\t\t\t\t\t\t\t\t// Add related places/subjects\n\t\t\tvar places=[],subjects=[];\n\t\t\tstr+=\"<div style='margin-bottom:12px'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Related places and subjects container\n\t\t\tfor (j=0;j<o.kmapid_strict.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tif (o.kmapid_strict[j].match(/subjects/i))\t\tsubjects.push(j);\t\t\t\t\t// Add to subjects\n\t\t\t\telse if (o.kmapid_strict[j].match(/places/i))\tplaces.push(j);\t\t\t\t\t\t// Add to places\n\t\t\t\t}\n\t\t\tstr+=\"<div style='float:left;min-width:200px;'><span style='color:\"+this.assets.places.c+\"'>\";\n\t\t\tstr+=\"<br><b>\"+this.assets.places.g+\"</b></span>&nbsp;RELATED PLACES\";\t\t\t\t\t// Add header\n\t\t\tif (places.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If any places\n\t\t\t\tfor (j=0;j<places.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each place\n\t\t\t\t\tstr+=\"<br>\";\n\t\t\t\t\tif (o.kmapid_strict_ss)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If has names\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tstr+=\"<span class='sui-itemRelated'>\"+o.kmapid_strict_ss[places[j]]+\"</span>\";\t// Add place name\n\t\t\t\t\tstr+=\"&nbsp;<span style='font-size:10px;margin-right:40px'>(\"+o.kmapid_strict[places[j]]+\")</span>\";\t// Add place id\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End places div\n\t\t\t\n\t\t\tstr+=\"<div><span style='display:inline-block;color:\"+this.assets.subjects.c+\"'>\";\n\t\t\tstr+=\"<br><b>\"+this.assets.subjects.g+\"</b></span>&nbsp;RELATED SUBJECTS\";\t\t\t\t// Add header\n\t\t\tif (subjects.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If any subjects\n\t\t\t\tfor (j=0;j<subjects.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each subject\n\t\t\t\t\tstr+=\"<br>\";\n\t\t\t\t\tif (o.kmapid_strict_ss)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If has names\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tstr+=\"<span class='sui-itemRelated'>\"+o.kmapid_strict_ss[subjects[j]]+\"</span>\"; // Add place name\n\t\t\t\t\tstr+=\"&nbsp;<span style='font-size:10px'>(\"+o.kmapid_strict[subjects[j]]+\")</span>\"; // Add place id\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tstr+=\"</div></div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End subjects and relateds div\n\t\t\t}\n\t\t$(\"#sui-itemMore-\"+num).html(str);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to div\n\t\t\n\t\t$(\"#sui-itemMore-\"+num).slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Slide it down\n\t\t$(\"[id^=sui-itemPic]\").on(\"click\",(e)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t// ON PIC CLICK\n\t\t\tvar num=e.currentTarget.id.substring(12);\t\t\t\t\t\t\t\t\t\t\t\t// Get index of result\t\n\t\t\tthis.SendMessage(\"page=\"+this.curResults[num].url_html,this.curResults[num]);\t\t\t// Send message\n\t\t\t});\n\t\t}\n\n\t// NO SIDE EFFECTS\n\t// PASSED FROM CONTEXT this.curResults\n\tDrawGridItem(num)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW GRID ITEM\n\t{\n\t\tvar str=\"<div class='sui-grid'>\";\n\t\tvar o=this.curResults[num];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item\n\t\tstr+=\"<a href='#p=\"+o.uid+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add href for right click\n\t\tstr+=\"<img src='\"+o.url_thumb+\"' class='sui-gridPic' id='sui-itemPic-\"+num+\"'></a>\";\t\t// Add pic\n\t\tif (o.url_thumb.match(/gradient.jpg/))\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// If a generic\n\t\t\t str+=`<div class='sui-gridGlyph' style='color:${this.assets[o.asset_type].c}'>\n\t\t\t ${this.assets[o.asset_type].g}\n\t\t\t <p style='font-size:12px;margin-top:0'>${o.title}</p>\n\t\t\t </div>`;\n\t\t\t  }\n\t\tstr+=\"<div id='sui-gridInfo-\"+num+\"' class='sui-gridInfo'>&#xe67f</div>\";\t\t\t\t\t// Add info button\n\t\treturn str+\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return grid markup\n\t}\n\n\t// NO SIDE EFFECTS\n\t// PASSED FROM CONTEXT:   this.curResults\n\tDrawCardItem(num)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW CARD ITEM\n\t{\n\t\tlet i,o=this.curResults[num];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item\n\t\tlet g=\"&#xe633\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Collections glyph\n\t\tlet c=\"#9e894d\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Color\n\t\tlet label=o.collection_title;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set label\n\t\tlet str=\"<div class='sui-card'>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Overall container\n\t\tstr+=\"<div style='width:100%;height:100px;overflow:hidden;display:inline-block;margin:0;padding:0'>\";\t\t\t// Div container\n\t\tstr+=\"<a href='#p=\"+o.uid+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add href for right click\n\t\tstr+=\"<img src='\"+o.url_thumb+\"' class='sui-cardPic' id='sui-itemPic-\"+num+\"'></a></div>\";\t// Add pic\n\t\tvar gg=this.assets[o.asset_type].g;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume generic icon\n\t\tif (o.asset_subtype == \"Audio\")\t\t\tgg=\"&#xe60a\";\t\t\t\t\t\t\t\t\t\t// Audio\n\t\telse if (o.asset_subtype == \"Video\")\tgg=\"&#xe62d\";\t\t\t\t\t\t\t\t\t\t// Video\n\t\tstr+=\"<div class='sui-cardType'>\"+gg+\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t// Show icon\n\t\tif (o.url_thumb.match(/gradient.jpg/))\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a generic\n\t\t\t str+=`<div class='sui-cardGlyph' style='color:${this.assets[o.asset_type].c}'>${this.assets[o.asset_type].g}</div>`;\n\t\tstr+=\"<div class='sui-cardInfo'><div class='sui-cardTitle' id='sui-itemTitle-\"+num+\"'\";\n\t\tif (o.ancestors_txt && o.ancestors_txt.length > 2) str+=\"title='\"+o.ancestors_txt.join(\"/\")+\"'\";\t// Add tooltip showing path\n\t\tstr+=\"><b>\"+o.title+\"</b><br></div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\tstr+=\"<div style='border-top:.5px solid \"+c+\";height:1px;width:100%;margin:6px 0 6px 0'></div>\";\t// Dividing line\n\t\tif (o.ancestors_txt && o.ancestors_txt.length > 1) {\t\t\t\t\t\t\t\t\t\t// If has an ancestors trail\n\t\t\tstr+=\"&#xe638&nbsp;&nbsp;\"+o.ancestors_txt[0]+\"/...<br>\";\t\t\t\t\t\t\t\t// Add start\n\t\t\tstr+=\"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.../\"+o.ancestors_txt[o.ancestors_txt.length-2]+\"<br>\";// Add antecedant\n\t\t\t}\n\t\tif (o.feature_types_ss) str+=\"&#xe62b&nbsp;&nbsp;\"+o.feature_types_ss.join(\", \")+\"<br>\";\t// Add feature, if a place\n\t\tif (o.data_phoneme_ss)  str+=\"&#xe635&nbsp;&nbsp;\"+o.data_phoneme_ss.join(\", \")+\"<br>\";\t\t// Add phoneme if a term\n\t\tif (o.creator)  \t\tstr+=\"&#xe600&nbsp;&nbsp;\"+o.creator[0]+\"<br>\";\t\t\t\t\t\t// Add creator \n\t\tif (o.duration_s) \t\tstr+=\"&#xe61c&nbsp;&nbsp;\"+o.duration_s+\"<br>\";\t\t\t\t\t\t// Add duration\n\t\tif (o.timestamp) \t\tstr+=\"&#xe60c&nbsp;&nbsp;\"+o.timestamp.substr(0,10)+\"<br>\";\t\t\t// Add timestamp\n\t\tif (o.name_tibt)  \t\tstr+=\"=&nbsp;&nbsp;\"+o.name_tibt+\"<br>\";\t\t\t\t\t\t\t// Add Tibettan name\n\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End info div\n\t\tif (!label)\t { label=o.asset_type; g=this.assets[o.asset_type].g; }\t\t\t\t\t\t\t// Generic label if no collection\n\t\tstr+=\"<div class='sui-cardFooter' style='background-color:\"+c+\"'>\"+g+\"&nbsp;&nbsp;\";\t\t// Card footer\n\t\tstr+=\"<span style='font-size:11px;vertical-align:2px'>\"+label+\"<span></div>\";\t\t\t\t// Add label\t\n\t\treturn str+\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return items markup\n\t}\n\n/*\tADVANCED SEARCH //////////////////////////////////////////////////////////////////////////////\n\n//////////////////////////////////////////////////////////////////////////////////////////////  */\n\n\tDrawAdvanced()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW SEARCH UI SECTION\n\t{\n\n\t\tthis.log(\"searchui.DrawAdvanced() short circuit\");\n\t\treturn; // short circuit\n\n\t\tlet i,o,str;\n\t\tlet _this=this;\n\t\tif (this.noTop)\t$(\"#sui-adv\").css({ top:0, height:\"calc(100% - 50px)\" })\t\t\t\t\t// Scale to fit\n\t\tfor (let key in this.facets) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each facet\n\t\t\tif ($(\"#sui-advEdit-\"+key).css(\"display\") == \"block\") {\t\t\t\t\t\t\t\t\t// Refresh list results if open\n\t\t\t\tthis.DrawFacetItems(key,true);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw proper facets menu\n\t\t\t\tthis.QueryFacets(key);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Fill facet data\t\t\t\n\t\t\t\t}\n\t\t\t$(\"#sui-advTerm-\"+key).empty();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear list\n\t\t\tfor (i=0;i<this.ss.query[key].length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t// For each term in facet\t\n\t\t\t\to=sui.ss.query[key][i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at facet to add to div\n\t\t\t\tstr=`<div><div class='sui-advTermRem' id='sui-advKill-${key}-${i}'>&#xe60f</div>`;\n\t\t\t\tif (this.showBool)\n\t\t\t\t\tstr+=`<div class='sui-advEditBool' id='sui-advBool-${key}-${i}' title='Change boolean method'>${this[o.bool]}&#xe642</div>`;\n\t\t\t\tstr+=`<i> &nbsp;${o.title}</i></div>`;\n\t\t\t\tif (key == \"assets\") \t$(\"#sui-advTerm-\"+key).html(`<span style='color:${this.assets[o.id].c}'>${this.assets[o.id].g} </span><i> &nbsp;${o.title}</i>`);\n\t\t\t\telse\t\t\t\t\t$(\"#sui-advTerm-\"+key).append(str);\t\t\t\t\t\t\t// Add term\n\t\t\t\t}\n\t\t\t}\n\n\t\t$(\"[id^=sui-advBool-]\").on(\"mouseenter\",function(e) {\t\t\t\t\t\t\t\t\t\t// ON BOOLEAN HOVER\n\t\t\tlet v=e.currentTarget.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\tlet str=`<div class='sui-boolItem' id='sui-boolItem-${v[2]}-${v[3]}-AND'>AND</div>|\t\t\t\n\t\t\t\t<div class='sui-boolItem' id='sui-boolItem-${v[2]}-${v[3]}-OR'>OR</div>|\t\t\t\t\t\n\t\t\t\t<div class='sui-boolItem' id='sui-boolItem-${v[2]}-${v[3]}-NOT'>NOT</div>&nbsp;`;\t// Add options\t\n\t\t\t$(this).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t\t// Set new value\n\n\t\t\t$(\".sui-boolItem\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK\n\t\t\t\tlet v=e.currentTarget.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\t\t$(\"#\"+e.currentTarget.id).html(_this[v[4]]+\"&#xe642\");\t\t\t\t\t\t\t\t// Set new value\n\t\t\t\t_this.ss.query[v[2]][v[3]].bool=v[4];\t\t\t\t\t\t\t\t\t\t\t\t// Set state\n\t\t\t\t$(this).html(_this[v[4]]+\"&#xe642\");\t\t\t\t\t\t\t\t\t\t\t\t// Set new value\n\t\t\t\t_this.Query();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Run query and show results\n\t\t\t\t});\n\t\t\t});\n\n\t\t$(\"[id^=sui-advBool-]\").on(\"mouseleave\",function(e) {\t\t\t\t\t\t\t\t\t\t// ON BOOLEAN OUT\n\t\t\tlet v=e.currentTarget.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\tlet b= _this.ss.query[v[2]][v[3]].bool ;\t\t\t\t\t\t\t\t\t\t\t\t// Get current boolean state \n\t\t\t$(this).html(_this[b]+\"&#xe642\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set new value \n\t\t\t});\n\n\t\t$(\"[id^=sui-advKill-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// REMOVE ITEM FROM QUERY\n\t\t\tlet v=e.currentTarget.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\n\t\t\tthis.ss.query[v[2]].splice(v[3],1);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove\n\t\t\tthis.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\tthis.Query();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Run query and show results\n\t\t\t});\n\t\t}\n\n\tDrawFacetItems(facet, open)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW FACETS ITEMS\n\t{\n\t\tif ((facet == \"assets\") && !this.curResults) \tthis.Query();\t\t\t\t\t\t\t\t// If no results, run query\n\t\tif (facet == \"recent\") \t\t\t\t\t\t\tthis.RecentSearches();\t\t\t\t\t\t// Show recent searches\t\t\t\n\t\telse if (this.facets[facet].type == \"input\") \tthis.DrawInput(facet,open);\t\t\t\t\t// Draw input editor\t\t\t\n\t\telse if (this.facets[facet].type == \"tree\") {\t\t\t\t\t\t\t\t\t\t\t\t// If base type is a tree\n\t\t\tif (this.ActiveSearch())\t\t\t\t\tthis.DrawFacetList(facet,open);\t\t\t\t// If an active search, draw tree as a list\t\n\t\t\telse \t\t\t\t\t\t\t\t\t\tthis.DrawFacetTree(facet,open);\t\t\t\t// Draw tree as a tree \t\n\t\t\t}\t\t\t\n\t\telse \t\t\t\t\t\t\t\t\t\t\tthis.DrawFacetList(facet,open);\t\t\t\t// Draw list editor\n\t}\n\n\tActiveSearch(ignoreText)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// IS THERE AN ACTIVE SEARCH?\n\t{\n\t\tlet key,activeSearch=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume no active search happening\n\t\tif (this.ss.query.text.length && !ignoreText) \tactiveSearch=true;\t\t\t\t\t\t\t// Flag if something set in text\n\t\tfor (key in this.facets) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each facet\n\t\t\tif ((this.ss.query[key].length) && (key != \"assets\"))\tactiveSearch=true;\t\t\t\t// Flag if something set\n\t\treturn activeSearch;\n\t}\n\n\t// SIDE EFFECTS\n\tDrawInput(facet)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW INPUT FACET PICKER\n\t{\n\t\tif ($(\"#sui-advEdit-\"+facet).css(\"display\") != \"none\") {\t\t\t\t\t\t\t\t\t// If open\n\t\t\t$(\"#sui-advEdit-\"+facet).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close it\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t}\n\t\tvar tot=934;\n\t\tthis.facets[facet].mode=\"input\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Input mode active\n\t\tvar str=`<input id='sui-advInput-${facet}' placeholder='Type here'  \n\t\tstyle='width:90px;border:1px solid #999;border-radius:12px;font-size:11px;padding-left:6px'>\n\t\t<div class='sui-advEditNums'> <span id='sui-advListNum'>${tot}</span> ${facet}</div>`;\n\t\t$(\"#sui-advEdit-\"+facet).html(str+\"</div>\".replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t// Add to div\n\t\t$(\"#sui-advEdit-\"+facet).slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it\n\n\t\t$(\"#sui-advInput-\"+facet).on(\"change\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON CHANGE\n\t\t\tvar v=e.target.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\t\t\n\t\t\tthis.AddNewFilter($(\"#sui-advInput-\"+facet).val(),facet+\"-0\",\"AND\", facet);\t\t\t\t// Add term to search state\n\t\t\t});\n\t}\n\n\t// SELF-CONTAINED\n\tRecentSearches()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW RECENT SEARCHES\n\t{\n\t\tif ($(\"#sui-advEdit-recent\").css(\"display\") != \"none\") {\t\t\t\t\t\t\t\t\t// If open\n\t\t\t$(\"#sui-advEdit-recent\").slideUp();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close it\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t}\n\t\tlet i,j,f,str=\"<i>Click below to recall a previous search</i><hr><div class='sui-advEditList'>\"; // Enclosing div\n\t\tfor (i=this.searches.length-1;i>=0;i--) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each search, last first\n\t\t\tstr+=`<div class='sui-advEditLine' style='width:100%' id='sui-recSrc-${i}' `;\t\t\t// Add text item, if any\n\t\t\tstr+= \"title='\"+this.searches[i].query.assets[0].title.toUpperCase();\t\t\t\t\t// Add tooltip to show entire search\n\t\t\tstr+=\" \"+this.searches[i].query.text;\t\t\t\t\t\t\t\t\t\t\t\t\t// Add text\n\t\t\tfor (f in this.facets) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each facet\n\t\t\t\tif (this.searches[i].query[f].length &&\t(f != \"assets\"))\t\t\t\t\t\t\t// If something there\n\t\t\t\t\tfor (j=0;j<this.searches[i].query[f].length;++j)  \t\t\t\t\t\t\t\t// For each one of them\n\t\t\t\t\t\tstr+=\" \"+this[this.searches[i].query[f][j].bool]+\" \"+this.searches[i].query[f][j].title;\t// Add to tooltip\n\t\t\t\t\t}\n\t\t\tf=this.searches[i].query.assets[0].id;\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at asset id\n\t\t\tstr+=`'><span style='color:${this.assets[f].c}'>${this.assets[f].g} </span>`; \t\t\t// Add asset type\n\t\t\tstr+=this.searches[i].query.text;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End title and add text item\n\t\t\tfor (f in this.facets) \tif (this.searches[i].query[f].length && (f != \"assets\")) str+=\" + \"+this.facets[f].icon; // Add facets icons, except assets\n\t\t\tstr+=\"</div>\";\n\t\t\t}\n\t\t$(\"#sui-advEdit-recent\").html(str+\"</div>\".replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t// Add to div\n\t\t$(\"[id^=sui-recSrc-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLERS\n\t\t$(\"[id^=sui-recSrc-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON ITEM CLICK\n\t\t\tlet id=e.target.id.substr(11);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get which\n\t\t\tthis.ss.query=(JSON.parse(JSON.stringify(this.searches[id].query)));\t\t\t\t\t// Restore search query only\n\t\t\t$(\"#sui-search\").val(this.ss.query.text);\t\t\t\t\t\t\t\t\t\t\t\t// Set top search\n\t\t\tthis.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw advanced \n\t\t\tthis.Query();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Rerun search\t\n\t\t\t});\n\t\t$(\"#sui-advEdit-recent\").slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it\n\t}\n\n\t//\n\tResetFacetList(facet)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// RESET FACET LIST UI\n\t{\n\t\tvar i,k,str=\"\";\n\t\tif (facet == \"assets\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If assets\n\t\t\tlet o=this.facets.assets.data=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at data\n\t\t\tfor (k in this.assets)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each asset type\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\to.push({ title:k.charAt(0).toUpperCase()+k.slice(1), id:k, n:this.assets[k].n});\t// Add data\n\t\t\t}\n\t\tlet n=Math.min(300,this.facets[facet].data.length);\t\t\t\t\t\t\t\t\t\t\t// Cap at 300\n\t\t$(\"[id^=sui-advEditLine-]\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove old members, in all facets\n\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add items\n\t\t\tk=this.facets[facet].data[i].n;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Number of assets\n\t\t\tif (k == undefined) k=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide if undefined\n\t\t\tif (k > 1000)\tk=Math.floor(k/1000)+\"K\";\t\t\t\t\t\t\t\t\t\t\t\t// Shorten\n\t\t\tstr+=`<div class='sui-advEditLine' id='sui-advEditLine-${i}'>` \n\t\t\tif (facet == \"assets\")  str+=`<span style='color:${this.assets[this.facets[facet].data[i].id].c}'>${this.assets[this.facets[facet].data[i].id].g}</span> &nbsp;`;\n\t\t\tstr+=`${this.facets[facet].data[i].title} (${k})`; \t\t\t\t\t\t\t\t\t\t// Add item to list\n\t\t\tif (facet != \"assets\")\tstr+=this.pages.AddPop(this.facets[facet].data[i].id,true);\t\t// Add popover\t\t\n\t\t\tstr+=\"</div>\"\n\t\t\t}\n\t\t$(\"#sui-advEditList-\"+facet).html(\"</div>\"+str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t// Add to div\n\t\t$(\"[id^=sui-advEditLine-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLERS\n\t\t$(\"[id^=sui-advEditLine-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON ITEM CLICK\n\t\t\tlet v=e.target.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get ids\t\t\n\t\t\tlet items=this.facets[facet].data;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at items\n\t\t\tif (this.showSearch && (facet != \"assets\"))\t\t\t\t\t\t\t\t\t\t\t\t// Show page\n\t\t\t\tthis.GetKmapFromID(items[v[2]].id,(kmap)=>{ this.SendMessage(\"page=\"+items[v[2]].url,kmap); }); // Get kmap and show page\n\t\t\telse\t\n\t\t\t\tthis.AddNewFilter(items[v[2]].title,items[v[2]].id,\"AND\", facet);\t\t\t\t\t// Add to search state\n\t\t\t});\n\t\t$(\"#sui-advListNum\").html((n < 300) ? n : \"300+\");\t\t\t\t\t\t\t\t\t\t\t// Set number\n\t}\n\n\t// NEEDS ANALYSIS\n\tDrawFacetList(facet, open, searchItem)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW LIST FACET PICKER\n\t{\n\t\tlet i, sorted = 0;\n\t\tif (!open && ($(\"#sui-advEdit-\" + facet).css(\"display\") != \"none\")) {\t\t\t\t\t\t\t// If open\n\t\t\t$(\"#sui-advEdit-\" + facet).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close it\n\t\t\treturn;\n\t\t}\n\t\tthis.QueryFacets(facet);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get initial list\t\n\t\tthis.facets[facet].mode = \"list\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// List mode active\n\t\tvar str = `<input id='sui-advEditFilter-${facet}' placeholder='Search this list' value='${searchItem ? searchItem : \"\"}' \n\t\tstyle='width:90px;border:1px solid #999;border-radius:12px;font-size:11px;padding-left:6px'> &nbsp; `;\n\t\tif (this.facets[facet].type == \"tree\") {\n\t\t\tstr += `<div class='sui-advEditBut' id='sui-advListMap-${facet}' title='Tree view'>&#xe638</div> | \n\t\t\t<div class='sui-advEditBut' id='sui-advTreeMap-${facet}' title='List view'>&#xe61f</div>\n\t\t\t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`;\n\t\t}\n\t\tif (facet != \"assets\")\n\t\t\tstr += `<div class='sui-advEditBut' id='sui-advEditSort-${facet}' title='Sort'>&#xe652</div>`;\n\t\tstr += `<div class='sui-advEditNums'> <span id='sui-advListNum'></span> ${facet}`;\n\t\tstr += `</div><hr style='border: .5px solid #a4baec'>\n\t\t<div class='sui-advEditList' id='sui-advEditList-${facet}'></div>`;\n\t\t$(\"#sui-advEdit-\" + facet).html(str.replace(/\\t|\\n|\\r/g, \"\"));\t\t\t\t\t\t\t\t\t// Add to div\n\t\t$(\"#sui-advEdit-\" + facet).slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it\n\t\t$(\"#sui-advTreeMap-\" + facet).css({color: \"#668eec\"});\t\t\t\t\t\t\t\t\t\t// Highlight list\n\n\t\t$(\"[id^=sui-advEditFilter-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLER\n\t\t$(\"#sui-advEditFilter-\" + facet).on(\"keydown\", (e) => {\t\t\t\t\t\t\t\t\t\t\t// ON FILTER CHANGE\n\t\t\tlet line;\n\t\t\tvar n = Math.min(300, this.facets[facet].data.length);\t\t\t\t\t\t\t\t\t\t// Cap at 300\n\t\t\tlet r = $(\"#sui-advEditFilter-\" + facet).val();\t\t\t\t\t\t\t\t\t\t\t\t// Get filter text\n\t\t\tif ((e.keyCode > 31) && (e.keyCode < 91)) r += e.key;\t\t\t\t\t\t\t\t\t\t// Add current key if a-Z\n\t\t\tif ((e.keyCode == 8) && r.length) r = r.slice(0, -1);\t\t\t\t\t\t\t\t\t// Remove last char on backspace\n\t\t\tr = RegExp(r, \"i\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Turn into regex\n\t\t\tfor (i = 0; i < n; ++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tline = $(\"#sui-advEditLine-\" + i);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at line\n\t\t\t\tif (line.text().match(r)) line.css(\"display\", \"block\");\t\t\t\t\t\t\t// Show item if it matches\n\t\t\t\telse line.css(\"display\", \"none\");\t\t\t\t\t\t\t\t// Hide\n\t\t\t}\n\t\t});\n\n\t\t$(\"[id^=sui-advEditSort-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLER\n\t\t$(\"#sui-advEditSort-\" + facet).on(\"click\", () => {\t\t\t\t\t\t\t\t\t\t\t\t// ON SORT BUTTON CLICK\n\t\t\tstr = \"\";\n\t\t\tlet items = this.facets[facet].data;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at items\n\t\t\tlet i, k, n = Math.min(300, items.length);\t\t\t\t\t\t\t\t\t\t\t\t\t// Cap at 300\n\t\t\tsorted = 1 - sorted;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Toggle flag\n\t\t\tif (!sorted) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If not sorted\n\t\t\t\t$(\"#sui-advEditList-\" + facet).empty();\t\t\t\t\t\t\t\t\t\t\t\t// Remove items from list\n\t\t\t\tfor (i = 0; i < n; ++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each one\n\t\t\t\t\tk = this.facets[facet].data[i].n;\t\t\t\t\t\t\t\t\t\t\t\t\t// Number of assets\n\t\t\t\t\tif (k > 1000) k = Math.floor(k / 1000) + \"K\";\t\t\t\t\t\t\t\t\t\t// Shorten\n\t\t\t\t\tstr += `<div class='sui-advEditLine' id='sui-advEditLine-${i}'>`;\n\t\t\t\t\tstr += `${items[i].title} (${k})${this.pages.AddPop(items[i].id, true)}</div>`;\t// Add item to list\n\t\t\t\t}\n\t\t\t\t$(\"#sui-advEditList-\" + facet).html(str);\t\t\t\t\t\t\t\t\t\t\t\t// Add back\n\t\t\t\t$(\"#sui-advEditSort-\" + facet).css(\"color\", \"#666\");\t\t\t\t\t\t\t\t\t// Off\n\t\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t}\n\t\t\tlet itms = $(\".sui-advEditLine\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Items to sort\n\t\t\titms.sort(function (a, b) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sort\n\t\t\t\tvar an = $(a).text();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// A name\n\t\t\t\tvar bn = $(b).text();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// B\n\t\t\t\tif (an > bn) return 1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Higher\n\t\t\t\telse if (an < bn) return -1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Lower\n\t\t\t\telse return 0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// The same\n\t\t\t});\n\t\t\t$(\"#sui-advEditList-\" + facet).html(itms);\n\t\t\t$(\"#sui-advEditSort-\" + facet).css(\"color\", \"#668eec\");\t\t\t\t\t\t\t\t\t// On\n\t\t});\n\n\t\t$(\"[id^=sui-advListMap-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLER\n\t\t$(\"#sui-advListMap-\" + facet).on(\"click\", () => {\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK TREE BUTTON\n\t\t\tthis.DrawFacetTree(facet, 1, $(\"#sui-advEditFilter-\" + facet).val());\t\t\t\t\t\t// Close it and open as tree\n\t\t});\n\t\t$(\"#sui-advEditList-\" + facet).css(\"max-height\", $(\"#sui-main\").height() - $(\"#sui-advTerm-\" + facet).offset().top - $(\"#sui-advTerm-\" + facet).height() - 102 + \"px\");\t// Fill space\n\t}\n\n\n\t// SIDE EFFECTS!\n\tAddNewFilter(title, id, bool, facet)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD NEW TERM TO SEARCH STATE\n\t{\n\t\tlet o=this.ss.query[facet];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at facet\n\t\tif (o.filter(o => (o.title == title)).length) \treturn;\t\t\t\t\t\t\t\t\t\t// Don't add if already there\t\t\t\t\t\t\t\t\t\t\t\n\t\tif (id) id=id.replace(/languages-|features-/i,\"subjects-\");\t\t\t\t\t\t\t\t\t// Languages and feature\n\t\tlet num=o.length;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Facet index to add to\t\t\t\t\t\t\t\t\t\t\t\t\n\t\to.push({});\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add obj\n\t\to[num].title=title;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get title\n\t\to[num].id=id ? id.replace(/collections-/,\"\") : \"\";\t\t\t\t\t\t\t\t\t\t\t// Id (remove collections- prefix)\n\t\to[num].bool=bool;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Bool\n\t\tif (facet == \"assets\") \tthis.ss.query.assets=[ {title:title, id:id, bool:bool} ];\t\t\t// Only one\t\t\t\t\t\t\n\t\tthis.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at 1st page in results\n\t\tthis.DrawAdvanced();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\tthis.Query();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Run query and show results\n\t}\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// TREE \n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\n\t// ANALYZE\n\tDrawFacetTree(facet, open, searchItem)  \t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW FACET TREE\n\t{\n\t\tvar _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tif (!open && ($(\"#sui-advEdit-\"+facet).css(\"display\") != \"none\")) {\t\t\t\t\t\t\t// If open\n\t\t\t$(\"#sui-advEdit-\"+facet).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close it\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t}\n\t\tthis.facets[facet].mode=\"tree\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Tree mode active\n\t\tthis.curTree=facet;\n\t\tvar div=\"#sui-tree\"+facet;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Tree div\n\n\t\tvar str=`<input id='sui-advTreeFilter' placeholder='Search this list' value='${searchItem ? searchItem : \"\"}' \n\t\tstyle='width:90px;border:1px solid #999;border-radius:12px;font-size:11px;padding-left:6px'> &nbsp; \n\t\t<div class='sui-advEditBut' id='sui-advListMap-${facet}' title='Tree view'>&#xe638</div> | \n\t\t<div class='sui-advEditBut' id='sui-advTreeMap-${facet}' title='List view'>&#xe61f</div>`;\n\t\tstr+=`<hr style='border: .5px solid #a4baec'>\n\t\t<div id='sui-tree${facet}' class='sui-tree'></div>`;\t\t\n\t\t$(\"#sui-advEdit-\"+facet).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t// Add tree frame to div\n\t\t\n\t\tif (facet == \"places\") \t\t \tthis.LazyLoad(div,null,facet,13735);\t\t\t\t\t\t// Embedded top layer for places\n\t\telse if (facet == \"features\") \tthis.LazyLoad(div,null,facet,20);\t\t\t\t\t\t\t// Features\n\t\telse if (facet == \"languages\") \tthis.LazyLoad(div,null,facet,301);\t\t\t\t\t\t\t// Languages\n\t\telse \t\t\t\t\t\t\tthis.GetTopRow(div,facet);\t\t\t\t\t\t\t\t\t// Constructed top layers\n\n\t\t$(\"#sui-advListMap-\"+facet).css({ color: \"#668eec\" });\t\t\t\t\t\t\t\t\t\t// Highlight tree\n\n\t\t$(\"[id^=sui-advTreeMap-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLER\n\t\t$(\"#sui-advTreeMap-\"+facet).on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK LIST BUTTON\n\t\t\tthis.DrawFacetList(facet,1,$(\"#sui-advTreeFilter\").val());\t\t\t\t\t\t\t\t// Close it and open as list\n\t\t\t});      \n\n\t\t$(\"[id^=sui-advTreeFilter-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL OLD HANDLER\n\t\t$(\"#sui-advTreeFilter\").on(\"keydown\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON TYPING IN TEXT BOX\n\t\t\tthis.DrawFacetList(facet,1,$(\"#sui-advTreeFilter\").val());\t\t\t\t\t\t\t\t// Close it and open as list\n\t\t\t$(\"#sui-advEditFilter-\"+facet).focus();\t\t\t\t\t\t\t\t\t\t\t\t\t// Focus on input in list\n\t\t\t});      \n\n\t\t$('.sui-advViewTreePage').off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill old handlers\n\t\t$('.sui-advViewTreePage').on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK VIEW BUTTON\n\t\t\tvar v=e.target.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\tthis.GetKmapFromID(v[1]+\"-\"+v[2],(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t\t\t\t// Get kmap and show page\n\t\t\te.stopPropagation();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});      \n\n\t\t$(div).css(\"max-height\",$(\"#sui-main\").height()-$(\"#sui-advTerm-\"+facet).offset().top-$(\"#sui-advTerm-\"+facet).height()-102+\"px\");\t// Fill space\n\t\t$(\"#sui-advEdit-\"+facet).slideDown();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it\n\t}\n\n\t// SIDE EFFECTS?\n\tGetTopRow(div, facet)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET TOP-MOST TREE LEVEL\n\t{\n\t\tvar _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tlet prefix=(div.match(/sui-btree-/)) ? \"b\" : \"\";\t\t\t\t\t\t\t\t\t\t\t\t// Id prefix to prevent confusion between trees\n\t\tvar id,k,tops=[],str=\"<ul>\";\n\t\tif (facet == \"terms\") {\n\t\t\ttops.ka=1;\t\t\ttops.kha=14263;\t\ttops.ga=24465;\t\ttops.nga=45101;\ttops.ca=51638;\t\ttops.cha=55178;\t\t\n\t\t\ttops.ja=62496;\t\ttops.nya=66477;\t\ttops.ta=73101;\t\ttops.tha=80697;\ttops.da=87969;\t\ttops.na=105631;\t\n\t\t\ttops.pa=114065;\t\ttops.pha=120048;\ttops.ba=127869;\t\ttops.ma=142667;\ttops.tsa=154251;\ttops.tsha=158451;\t\n\t\t\ttops.dza=164453;\ttops.wa=166888;\t\ttops.zha=167094;\ttops.za=172249;\ttops[\"'a\"]=177092;\ttops.ya=178454;\n\t\t\ttops.ra=185531;\t\ttops.la=193509;\t\ttops.sha=199252;\ttops.sa=204036;\ttops.ha=215681;\t\ttops.a=219022;\n\t\t\t}\n\t\telse if (facet == \"subjects\") {\n\t\t\ttops[\"Administration\"]=5550;\t\ttops[\"Architecture\"]=6669;\t\t\ttops[\"Collections\"]=2823;\t\ttops[\"Community Services Project Types\"]=5553;\n\t\t\ttops[\"Contemplation\"]=5806;\t\t\ttops[\"Cultural Landscapes\"]=8868;\ttops[\"Cultural Regions\"]=305;\ttops[\"Event\"]=2743;\n\t\t\ttops[\"General\"]=6793;\t\t\t\ttops[\"Geographical Features\"]=20;\ttops[\"Grammars\"]=5812;\t\t\ttops[\"Higher Education Digital Tools\"]=6404;\n\t\t\ttops[\"Historical Periods\"]=5807;\ttops[\"Human Relationships\"]=306;\ttops[\"Language Tree\"]=301;\t\ttops[\"Literary Genres\"]=5809;\n\t\t\ttops[\"Material Objects\"]=2693;\t\ttops[\"Mesoamerican Studies\"]=6664;\ttops[\"Oral Genres\"]=5808;\t\ttops[\"Organizations and Organizational Units\"]=2688;\n\t\t\ttops[\"Politics\"]=7174;\t\t\t\ttops[\"Profession\"]=6670;\t\t\ttops[\"Religious Sects\"]=302;\ttops[\"Religious Systems\"]=5810;\n\t\t\ttops[\"Ritual\"]=5805;\t\t\t\ttops[\"Scripts\"]=192;\t\t\t\ttops[\"Teaching Resources\"]=6844; tops[\"Text Typologies\"]=4833;\n\t\t\ttops[\"Tibet and Himalayas\"]=6403;\ttops[\"Zoologies (Biological and Spiritual)\"]=5813;\n\t\t\t}\n\t\tfor (k in tops) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each top row\n\t\t\tid=facet+\"-\"+tops[k];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// id\n\t\t\tstr+=\"<li class='parent'><a id='\"+prefix+id+\"'\";\t\t\t\t\t\t\t\t\t\t\t// Start row\n\t\t\tstr+=\"' data-path='\"+tops[k]+\"'>\"+k;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add path/header\n\t\t\tstr+=this.pages.AddPop(id,true);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add popover\n\t\t\tstr+=\"</a></li>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\t\t}\n\t\t$(div).html(str+\"</ul>\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If initing 1st level\n\t\t$('.sui-tree li > a').off();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear handlers\n\t\t$('.sui-tree li > a').on(\"click\",function(e) { handleClick($(this),e); }); \t\t\t\t\t\t// Restore handler\n\n\t\tfunction handleClick(row, e) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// HANDLE NODE CLICK\n\t\t\tlet off=$(row.parent()).hasClass(\"parent\") ? 20 : 0;\t\t\t\t\t\t\t\t\t\t// Adjust for icon\n\t\t\tif (e.offsetX < off) {                                         \t\t\t\t  \t\t\t\t// In icon\n\t\t\t\tif (row.parent().children().length == 1) \t\t\t\t\t\t\t\t\t\t\t\t// If no children\n\t\t\t\t\t_this.LazyLoad(div,row,_this.curTree);\t\t\t\t\t\t\t\t\t\t\t\t// Lazy load from SOLR\n\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Open or close\n\t\t\t\t\trow.parent().toggleClass('active');                         \t\t\t\t\t\t// Toggle active class on or off\n\t\t\t\t\trow.parent().children('ul').slideToggle('fast');            \t\t\t\t\t\t// Slide into place\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\telse{\n\t\t\t\tif ((e.clientX < 200) || _this.showSearch) {\t\t\t\t\t\t\t\t\t\t\t// If browsing\t\t\n\t\t\t\t\t_this.pages.relatedBase=_this.pages.relatedId=\"\";\t\t\t\t\t\t\t\t\t// No related\n\t\t\t\t\tif (_this.ss.mode == \"related\") _this.ss.mode=_this.ss.lastMode;\t\t\t\t\t// Get back to search mode\n\t\t\t\t\tsui.GetKmapFromID(_this.curTree+\"-\"+e.target.id.split(\"-\")[1],(kmap)=>{ sui.SendMessage(\"\",kmap); });\t// Get kmap and show page\n\t\t\t\t\t}\n\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Adding facet to query\n\t\t\t\t\tlet s=$(\"#\"+e.target.id).text();\t\t\t\t\t\t\t\t\t\t// Get term\n\t\t\t\t\tsui.AddNewFilter(s,_this.curTree+\"-\"+e.target.id.split(\"-\")[1],\"AND\",_this.curTree); // Add term to search state and refresh\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t}\n\n\t// SIDE EFFECTS?\n\tLazyLoad(div, row, facet, init) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD NEW NODES TO TREE\n\t{\n\t\tconst sui = this.sui;\n\t\tvar path;\n\t\tvar _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tif (init || row.parent().children().length == 1) {\t\t\t\t\t\t\t\t\t\t\t\t// If no children, lazy load \n\t\t\tlet prefix=(div.match(/sui-btree-/)) ? \"b\" : \"\";\t\t\t\t\t\t\t\t\t\t\t// Id prefix to prevent confustion between trees\n\t\t\tif (init) \tpath=\"\"+init;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Force path as string\n\t\t\telse \t\tpath=\"\"+row.data().path;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get path\tas string\t\t\t\t\t\t\t\t\t\t\n\t\t\tthis.GetTreeChildren(facet, path, (res)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// Get children\n\t\t\t\tvar o,i,re,f=\"\";\n\t\t\t\tvar str=\"<ul>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Wrapper, show if not initting\n\t\t\t\tif (facet == \"terms\") {\n\t\t\t\t\tif (res.facet_counts && res.facet_counts.facet_fields && res.facet_counts.facet_fields[\"ancestor_id_tib.alpha_path\"])\t// If valid\n\t\t\t\t\t\tf=res.facet_counts.facet_fields[\"ancestor_id_tib.alpha_path\"].join();\t\t\t\t\t// Get list of facets\n\t\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\tif (res.facet_counts && res.facet_counts.facet_fields && res.facet_counts.facet_fields.ancestor_id_path)\t// If valid\n\t\t\t\t\tf=res.facet_counts.facet_fields.ancestor_id_path.join();\t\t\t\t\t\t\t// Get list of facets\n\t\t\t\t\t}\n\t\t\t\tfor (i=0;i<res.response.docs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t// For each child\n\t\t\t\t\to=res.response.docs[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at child\n\t\t\t\t\tre=new RegExp(\"\\/\"+o.id.split(\"-\")[1]);\t\t\t\t\t\t\t\t\t\t\t\t// Id\n\t\t\t\t\tstr+=\"<li\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start row\n\t\t\t\t\tif ((f && f.match(re)) || init)\tstr+=\" class='parent'\";\t\t\t\t\t\t\t\t// If has children or is top, add parent class\n\t\t\t\t\tstr+=\"><a id='\"+prefix+o.id;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add id\n\t\t\t\t\tif (facet == \"terms\")\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If terms\n\t\t\t\t\t\tstr+=\"' data-path='\"+o[\"ancestor_id_tib.alpha_path\"]+\"'>\";\t\t\t\t\t\t// Add path\n\t\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// All others\n\t\t\t\t\t\tstr+=\"' data-path='\"+o.ancestor_id_path+\"'>\";\t\t\t\t\t\t\t\t\t// Add path\n\t\t\t\t\tstr+=o.header;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\t\t\t\tstr+=this.pages.AddPop(o.id,true);\t\t\t\t\t\t\t\t\t\t\t\t\t// Add popover\n\t\t\t\t\tstr+=\"</a></li>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\t\t\t\t}\n\t\t\t\tif (res.response.docs.length) {\n\t\t\t\t\tif (init)\t$(div).html(str+\"</ul>\");\t\t\t\t\t\t\t\t\t\t\t\t// If initing 1st level\n\t\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Adding a level to a branch\n\t\t\t\t\t\trow.after(str+\"</ul>\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add children to tree\n\t\t\t\t\t\trow.parent().toggleClass('active');                         \t\t\t\t\t// Toggle active class on or off\n\t\t\t\t\t\trow.parent().children('ul').slideToggle('fast');            \t\t\t\t\t// Slide into place\n\t\t\t\t\t\t}\n\t\t\t\t\t$('.sui-tree li > a').off();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear handlers\n\t\t\t\t\t$('.sui-tree li > a').on(\"click\",function(e) { handleClick($(this),e); }); \t\t\t// Restore handler\n\t\t\t\t\t}\n\t\t\t\t$('.sui-advViewTreePage').off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill old handlers\n\t\t\t\t$('.sui-advViewTreePage').on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON CLICK VIEW BUTTON\n\t\t\t\t\tvar v=e.target.id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\t\tthis.GetKmapFromID(v[1]+\"-\"+v[2],(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t\t\t// Get kmap and show page\n\t\t\t\t\te.stopPropagation();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t\t\t});      \n\t\t\t\t});\n\t\t\t}\n\n\t\tfunction handleClick(row, e) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// HANDLE NODE CLICK\n\t\t\tlet off=$(row.parent()).hasClass(\"parent\") ? 20 : 0;\t\t\t\t\t\t\t\t\t\t// Adjust for icon\n\t\t\tif (e.offsetX < off) {                                         \t\t\t\t  \t\t\t\t// In icon\n\t\t\t\tif (row.parent().children().length == 1) \t\t\t\t\t\t\t\t\t\t\t\t// If no children\n\t\t\t\t\t_this.LazyLoad(div,row,_this.curTree);\t\t\t\t\t\t\t\t\t\t\t\t// Lazy load from SOLR\n\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Open or close\n\t\t\t\t\trow.parent().toggleClass('active');                         \t\t\t\t\t\t// Toggle active class on or off\n\t\t\t\t\trow.parent().children('ul').slideToggle('fast');            \t\t\t\t\t\t// Slide into place\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\telse{\n\t\t\t\tif ((e.clientX < 200) || _this.showSearch) {\t\t\t\t\t\t\t\t\t\t\t// If browsing\t\t\n\t\t\t\t\t_this.pages.relatedBase=_this.pages.relatedId=\"\";\t\t\t\t\t\t\t\t\t// No related\n\t\t\t\t\tif (_this.ss.mode == \"related\") _this.ss.mode=_this.ss.lastMode;\t\t\t\t\t// Get back to search mode\n\t\t\t\t\tsui.GetKmapFromID(_this.curTree+\"-\"+e.target.id.split(\"-\")[1],(kmap)=>{ sui.SendMessage(\"\",kmap); });\t// Get kmap and show page\n\t\t\t\t\t}\n\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Adding facet to query\n\t\t\t\t\tlet s=$(\"#\"+e.target.id).text();\t\t\t\t\t\t\t\t\t\t\t\t\t// Get term\n\t\t\t\t\tsui.AddNewFilter(s,_this.curTree+\"-\"+e.target.id.split(\"-\")[1],\"AND\",_this.curTree); // Add term to search state and refresh\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t}\n\n\tGeoLocate()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW GEOLOCATED ASSESTS\n\t{\n\t\tlet d=[{ lat:36.6251, lon:-118.085, lab:\"Lhasa\",  ui:\"subjects-6061\" },{ lat:37.6251, lon:-119.085, lab:\"Lhasa2\",  ui:\"subjects-6060\" }];\n\t\t//move lat by .0001 to stack\n\t\tsui.plc.Draw(\"\",\"\",d); \n\t}\n\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// HELPERS\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\tLoadingIcon(mode, size)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW/HIDE LOADING ICON\t\t\n\t{\n\t\tif (!mode) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If hiding\n\t\t\t$(\"[id^=sui-loadingIcon]\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove it\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t}\n\t\tvar str=\"<img src='loading.gif' width='\"+size+\"' \";\t\t\t\t\t\t\t\t\t\t\t// Img\n\t\tstr+=\"id='sui-loadingIcon' style='position:absolute;top:calc(50% - \"+size/2+\"px);left:calc(50% - \"+size/2+\"px);z-index:5000'>\";\n\t\t$(\"#sui-main\").append(str);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add icon to results\n\t}\n\n\tSendMessage(msg, kmap)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SEND MESSAGE TO HOST\n\t{\n\t\tthis.pages.Draw(kmap);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Route to page\n\t}\n\n\tPopup(msg, time, x, y)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// POPUP \n\t{\n\t\tvar str=\"\";\n\t\t$(\"#sui-popupDiv\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill old one, if any\n\t\tstr+=\"<div id='sui-popupDiv' class='sui-gridPopup' style='left:\"+x+\"px;top:\"+y+\"px'>\"; \t\t// Add div\n\t\tstr+=msg+\"</div>\"; \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add content\n\t\t$(\"#sui-main\").append(str);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to div\n\t\t$(\"#sui-popupDiv\").fadeIn(500).delay(time ? time*1000 : 3000).fadeOut(500);\t\t\t\t\t// Animate in and out\n\t}\n\n\tShortenString(str, len, middle)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHORTEN A STRING TO LENGTH\n\t{\n\t\tif (typeof str == \"object\")\tstr=str[0];\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get 1st member if an array\n\t\tif (str && str.length > len) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Too long\n\t\t\tif (middle) str=str.substr(0,(len-3)/2)+\"...\"+str.slice((len-3)/-2);\t\t\t\t\t// Shorten middle\n\t\t\telse\t\tstr=str.substr(0,(len-3))+\"...\";\t\t\t\t\t\t\t\t\t\t\t// Shorten end\t\n\t\t\t}\n\t\treturn str;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return string\n\t}\n\n\tGetCookie(cname) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET COOKIE\n\t{\n\t\tlet i,c,name=cname+\"=\";\n\t\tlet ca=decodeURIComponent(document.cookie).split(';');\t\t\t\t\t\t\t\t\t\t// Get cookie array\n\t\tfor (i=0;i<ca.length;i++) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each cookie\n\t\t\tc=ca[i];\n\t\t\twhile (c.charAt(0) == ' ')\tc=c.substring(1);\n\t\t\tif (c.indexOf(name) == 0) \treturn c.substring(name.length, c.length);\n\t\t\t}\n\t\treturn \"\";\n\t}\n\n\tSetCookie(cname, value) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SET COOKIE\n\t{\n\t\tlet d=new Date();\td.setTime(d.getTime()+365*24*60*60*1000);\td=d.toUTCString()\t\t\t// Cookie expires after a year\n\t\tdocument.cookie=`${cname}=${value}; expires=${d};`;\t\t\t\t\t\t\t\t\t\t\t// Set cookie\n\t}\n\n\n\tlog(message, debugObject, showAlert) {\n\t\tconsole.log(message);\n\t\tif (debugObject) {\n\t\t\tconsole.dir(debugObject);\n\t\t}\n\t\tif (showAlert) {\n\t\t\talert(message, debugObject);\n\t\t}\n\t}\n\n\talert(message, debugObject) {\n\t\tthis.log(message,debugObject,false);\n\t}\n\n} // SearchUI class closure","/* \tPLACES PAGES ****************************************************************************************************************************\n\n\tThis module draws the places page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the child data in the Terms index.  A map pulled from\n\tarcGIS online is drawn and framed on the area highlighted. The feature\ttypes and summary are drawn below \n\tthe map.\n\n\t[ document map functions ]\n\t\n\tThe related resources menu is drawn, which pulls data via another SOLR call. If an image is present\n\tit is drawn there. Below that is a browsable index of places. Clicking on one will bring up that page.\n\t\n\tA tabbed menu shows the CONTEXT, where the page fits in the tree. Clicking on one will bring up that page.\n\tYou can drill down further in the tree by clicking on a '+' dot or collapse branches with th '-'. The SUMMARY,\n\twhich lists the related subjects to this page, catagorized by their type and alpabetically sorted.\tClicking \n\ton one will bring up that page. Hovering over a blue popover icon will show more information about it. \n\tThe NAMES tab shows the names and etymoogy and Location the GIS datas\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tImages:\t\timg/basemapicon.gif,\n\t\t\t\timg/layericon.png\n\t\t\t\timg/legendicon.gif\n\t\t\t\timg/sketchicon.gif\n\t\t\t\timg/bookmarkicon.gif\n\n\tESRI:\t\thttps://js.arcgis.com/4.12\n\t\t\t\thttps://js.arcgis.com/4.12/esri/themes/light/main.css (dynamically loaded)\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\topt: \t\tBitmapped: 1=Scale | 2=Search| 4=3D | 8=Base | 16=Layers | 32=Legend | 64=Sketch | 128=Bookmarks\n\n*******************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\n\nexport default class Places  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tthis.app=null;\n\t\tthis.kmap=null;\n\t\tthis.extent=null;\n\t\tthis.showing=false;\n\t\t$(\"<link/>\", { rel:\"stylesheet\", type:\"text/css\", href:\"https://js.arcgis.com/4.12/esri/themes/light/main.css\" }).appendTo(\"head\");\n\t\tthis.div=sui.pages.div;\t\n\t\tthis.content=[\"\",\"...loading\",\"...loading\"];\n\t\tthis.content2=[\"<br>\",\"<br>\"];\n\t\tthis.popovers=null;\n\t}\n\n\tDraw(kmap, related, popovers)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW MAP PAGE\n\t{\n\t\tconsole.error(\"places.Draw() called with arguments: \");\n\t\tconsole.dir(arguments);\n\t\tconst sui = this.sui;\n\t\tvar _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tthis.popovers=popovers;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add data for any popovers\n\t\t$(\"#sui-legacy\").css({ \"padding-left\":\"12px\", width:\"calc(100% - 24px\"});\t\t\t\t// Reset to normal size\n\t\tthis.kmap=kmap;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save kmap\n\t\tthis.DrawMetadata(related);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw metadata\n\t\tsui.LoadingIcon(true,64);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\t\t\t\n\t\tvar app={ container:\"plc-main\",\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds startup parameters\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\tmap:null, baseMap:\"hybrid\", kml:null, \t\t\t\t\t\t\t\t\n\t\t\tmapView: null,  sceneView: null, activeView:null, opt:4|8|64,\n\t\t\tbookmarks:null, legend:null, layers:null, basePick:null, sketch:null,\t\t\t\t\n\t\t\tcenter: [91.1721, 29.6524], zoom:12, tilt:80,\n\t\t\treqs:[\"esri/Map\",\"esri/WebMap\", \"esri/views/MapView\", \"esri/views/SceneView\", \"esri/Graphic\", \"esri/layers/FeatureLayer\", \"esri/layers/KMLLayer\", \"esri/core/watchUtils\",\"esri/geometry/Extent\"],\n\t\t\tdiv: this.div\t\t\t\t\t\t\t\t\n\t   \t\t};\n\t\n\t\t// app.kml=`http://www.thlib.org:8080/thdl-geoserver/wms\n\t\t// \t?LAYERS=thl:roman_popular_poly,thl:roman_popular_pt,thl:roman_popular_line\n\t\t// \t&TRANSPARENT=TRUE&SPHERICALMERCATOR=true&PROJECTION=EPSG:900913&UNITS=m\n\t\t// \t&GEOSERVERURL=http://www.thlib.org:8080/thdl-geoserver\n\t\t// \t&STYLES=thl_noscale,thl_noscale,thl_noscale\n\t\t// \t&CQL_FILTER=fid=${id};fid=${id};fid==${id}\n\t\t// \t&SERVICE=WMS&SRS=EPSG:900913&FORMAT=kml&VERSION=1.1.1\n\t\t// \t&BBOX=3159514.209965,-1447629.9642176,20066161.87184,9001617.5490246\n\t\t// \t&WIDTH=864&HEIGHT=53\n\t\t// \t&REQUEST=GetMap`.replace(/\\t|\\n|\\r|/g,\"\")\n\t\t// \tapp.kml=\"https://viseyes.org/visualeyes/projects/test.kml\"\n\n\n\t\tthis.app=app;\t   \n\t\t\n\t\tif (app.opt&1)\t app.reqs.push(\"esri/widgets/ScaleBar\");\t\t\t\t\t\t\t\t// Scalebar if spec'd\n\t\tif (app.opt&2)\t app.reqs.push(\"esri/widgets/Search\");\t\t\t\t\t\t\t\t\t// Search\n\t\tif (app.opt&8)\t app.reqs.push(\"esri/widgets/BasemapGallery\");\t\t\t\t\t\t\t// Basepicker \n\t\tif (app.opt&16)\t app.reqs.push(\"esri/widgets/LayerList\");\t\t\t\t\t\t\t\t// Layerlist \n\t\tif (app.opt&32)  app.reqs.push(\"esri/widgets/Legend\");\t\t\t\t\t\t\t\t\t// Legend\n\t\tif (app.opt&64)\t { app.reqs.push(\"esri/widgets/Sketch\"); app.reqs.push(\"esri/layers/GraphicsLayer\"); }\t// Sketch\n\t\tif (app.opt&128) app.reqs.push(\"esri/widgets/Bookmarks\");\t\t\t\t\t\t\t\t// Bookmarks \n\t/*\n\t\trequire(app.reqs, function() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// LOAD ArcGIS MODULES\n\t\t\tvar i,key;\n\t\t\tvar Map,WebMap,MapView,SceneView,Graphic,FeatureLayer,KMLLayer,Extent;\n\t\t\tvar ScaleBar,Search,BasemapGallery,LayerList,Legend,Sketch,GraphicsLayer,Bookmarks,watchUtils;\n\t\t\tfor (i=0;i<app.reqs.length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// For each required module\n\t\t\t\tkey=app.reqs[i].match(/([^\\/]+)$/i)[1];\t\t\t\t\t\t\t\t\t\t\t// Extract variable name\n\t\t\t\tif (key == \"Map\") \t\t\t\t\tMap=arguments[i];\t\t\t\t\t\t\t// Set variable\n\t\t\t\telse if (key == \"WebMap\")\t\t\tWebMap=arguments[i];\n\t\t\t\telse if (key == \"MapView\")\t\t\tMapView=arguments[i];\n\t\t\t\telse if (key == \"SceneView\")\t\tSceneView=arguments[i];\n\t\t\t\telse if (key == \"Graphic\")\t\t\tGraphic=arguments[i];\n\t\t\t\telse if (key == \"FeatureLayer\")\t\tFeatureLayer=arguments[i];\n\t\t\t\telse if (key == \"KMLLayer\")\t\t\tKMLLayer=arguments[i];\n\t\t\t\telse if (key == \"watchUtils\")\t\twatchUtils=arguments[i];\n\t\t\t\telse if (key == \"Extent\")\t\t\tExtent=arguments[i];\n\t\t\t\telse if (key == \"ScaleBar\")\t\t\tScaleBar=arguments[i];\n\t\t\t\telse if (key == \"Search\")\t\t\tSearch=arguments[i];\n\t\t\t\telse if (key == \"BasemapGallery\")\tBasemapGallery=arguments[i];\n\t\t\t\telse if (key == \"LayerList\")\t\tLayerList=arguments[i];\n\t\t\t\telse if (key == \"Legend\")\t\t\tLegend=arguments[i];\n\t\t\t\telse if (key == \"Sketch\")\t\t\tSketch=arguments[i];\n\t\t\t\telse if (key == \"GraphicsLayer\")\tGraphicsLayer=arguments[i];\n\t\t\t\telse if (key == \"Bookmarks\")\t\tBookmarks=arguments[i];\n\t\t\t\t}\n\n\t\t\tvar str=`<div id=\"plc-infoDiv\">\n\t\t\t\t<input class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-switch-btn\" value=\"3D\"             title=\"Change view\" />\n\t\t\t\t<img   class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-base-btn\"   src=\"basemapicon.gif\"  title=\"Change base map\"/>\n\t\t\t\t<img   class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-layer-btn\"  src=\"layericon.png\"    title=\"Show list of layers\" />\n\t\t\t\t<img   class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-legend-btn\" src=\"legendicon.gif\"   title=\"Show legend\" />\n\t\t\t\t<img   class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-sketch-btn\" src=\"sketchicon.gif\"   title=\"Show sketch\" />\n\t\t\t\t<img   class=\"esri-component esri-widget--button esri-widget esri-interactive\" type=\"button\" style=\"display:none\" id=\"plc-book-btn\"   src=\"bookmarkicon.gif\" title=\"Show bookmarks\" />\n\t\t\t\t</div>`;\n\t\t\t$(\"#plc-main\").append(str);\n\n\t\tapp.ShowOptions=function() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW ACTIVE OPTIONS\n\t\t\tdocument.getElementById(\"plc-switch-btn\").style.display=(app.opt&4) ? \"block\" : \"none\";\t// Hide/show icons\n\t\t\tdocument.getElementById(\"plc-base-btn\").style.display=(app.opt&8) ? \"block\" : \"none\";\n\t\t\tdocument.getElementById(\"plc-layer-btn\").style.display=(app.opt&16 && (app.map.portalItem || app.kml)) ? \"block\" : \"none\";\n\t\t\tdocument.getElementById(\"plc-legend-btn\").style.display=(app.opt&32 && app.map.portalItem)  ? \"block\" : \"none\";\n\t\t\tdocument.getElementById(\"plc-sketch-btn\").style.display=(app.opt&64) ? \"block\" : \"none\";\n\t\t\tdocument.getElementById(\"plc-book-btn\").style.display=(app.opt&128 && app.map.bookmarks) ? \"block\" : \"none\";\n\t\t\tif (app.opt&16  && app.show&16) \tsetOption(app.layers);\t\t\t\t\t\t\t\t// Layers\n\t\t\tif (app.opt&32  && app.show&32) \tsetOption(app.legend);\t\t\t\t\t\t\t\t// Legend\n\t\t\tif (app.opt&64  && app.show&64) \tsetOption(app.sketch);\t\t\t\t\t\t\t\t// Sketch\n\t\t\tif (app.opt&128 && app.show&128) \tsetOption(app.bookmarks);\t\t\t\t\t\t\t// Bookmarks\n\n\t\t\tfunction setOption(option) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SET OPTION ON\n\t\t\t\tapp.mapView.ui.add(option,\"top-right\");\t\t\t\t\t\t\t\t\t\t\t\t// Show\n\t\t\t\toption.visible=true;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it's on\n\t\t\t\t}\n\t\t\t}\n\t\tapp.map=new Map({ basemap:app.baseMap, ground:\"world-elevation\" });\t\t\t\t\t\t\t// Make new map\n\t\tapp.sceneView=new SceneView( { \tcontainer:null,\tmap: app.map });\t\t\t\t\t\t\t// 3D view (hidden)\n\t\tapp.activeView=app.mapView=new MapView({\t\t\t\t\t\t\t\t\t\t\t\t\t// 2D view\n\t\t\tcontainer: app.container, map: app.map \t\t\t\t\t\t\t\t\t\t\t\t\t// Primary view\n\t\t\t});\n\t\tapp.ShowOptions();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide/show options\n\n\t\tif (app.kml) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add KML/KMZ if spec'd\n\t\t\tapp.kml=new KMLLayer({ url:app.kml });\t\t\t\t\t\t\t\t\t\t\t\t\t// Make new layer\n\t\t\tapp.map.add(app.kml);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it to map\n\t\t\tapp.mapView.whenLayerView(app.kml).then(function(layerView) {\n\t\t\t\twatchUtils.whenFalseOnce(layerView, \"updating\", function() {\n\t\t\t\t\tvar polygons=layerView.allVisiblePolygons;\n\t\t\t\t\tvar lines=layerView.allVisiblePolylines;\n\t\t\t\t\tvar points=layerView.allVisiblePoints;\n\t\t\t\t\tvar images=layerView.allVisibleMapImages;\n\t\t\t\t\tvar kmlFullExtent=polygons.concat(lines).concat(points).concat(images)\n\t\t\t\t\t.map(graphic => (graphic.extent ? graphic.extent : graphic.geometry.extent))\n\t\t\t\t\t.reduce((previous, current) => previous.union(current));\n\t\t\t\t\tapp.mapView.goTo({ extent: kmlFullExtent });\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\n// POPOVERS\n\n\t\tfunction AddPopovers(data) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD POPOVERS\n\t\t{\n// \t\t\tapp.fl=new FeatureLayer({\n// \t\t\t\tfields:[{ name:\"ObjectID\", alias:\"ObjectID\", type:\"oid\" },\n// \t\t\t\t  \t\t{ name:\"Name\", alias:\"Name\", type:\"string\" },\n// \t\t\t\t  \t\t{ name:\"kmid\",\talias:\"kmid\", type:\"string\" }],\n// \t\t\t\tobjectIdField:\"ObjectID\", geometryType:\"point\",\n// \t\t\t\tspatialReference:{ wkid: 4326 }, source: [],\n// \t\t\t\trenderer: { type: \"simple\", symbol: {\n// \t\t\t\t\t\t\ttype: \"web-style\", // autocasts as new WebStyleSymbol()\n// \t\t\t\t\t\t\tstyleName: \"Esri2DPointSymbolsStyle\",\n// \t\t\t\t\t\t\tname: \"landmark\" }\n// \t\t\t\t\t},\n// \t\t\t  popupTemplate: {  title: \"{Name}\"\t}\n// \t\t\t  });\n// \t\t\tapp.map.add(app.fl);\n//\n\t\t\t$(\"#sui-contentHead\").html(\"<div style='margin-top:12px'>&#xe61a&nbsp;&nbspGeo-Locate</div>\")\t// Header text\n\t\t\t$(\"#sui-footer\").html(\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Footer text\n\t\t\t$(\"#sui-header\").css(\"background-color\",\"#6faaf1\");\t\t\t\t\t\t\t\t\t\t// Color header\n\t\t\t$(\"#sui-footer\").css(\"background-color\",\"#6faaf1\");\t\t\t\t\t\t\t\t\t\t// Color footer\n\t\t\t$(\"#plc-infoDiv\").css(\"left\",\"25px\");\n\n\t\t\tlet i,graphic;\n\t\t\tlet minLat=999999,minLon=999999,maxLat=-999999,maxLon=-999999;\n\n\t\t\tfor (i=0;i<data.length;i++) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each element\n\t\t\t\tif (data[i].lat < minLat)\tminLat=data[i].lat;\t\t\t\t\t\t\t\t\t\t// Get min lat\n\t\t\t\tif (data[i].lat > maxLat)\tmaxLat=data[i].lat;\t\t\t\t\t\t\t\t\t\t// Get max lat\n\t\t\t\tif (data[i].lon < minLon)\tminLon=data[i].lon;\t\t\t\t\t\t\t\t\t\t// Get min lon\n\t\t\t\tif (data[i].lon > maxLon)\tmaxLon=data[i].lon;\t\t\t\t\t\t\t\t\t\t// Get max lom\n\t\t\t\tgraphic=new Graphic({\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Addloc new graphic\n\t\t\t\t\tgeometry:{ type: \"point\", latitude:data[i].lat, longitude:data[i].lon },\t\t// Position\n\t\t\t\t\tsymbol:{ type: \"picture-marker\", url:\"popover.png\", width:19, height:13 },\t\t// Shape\n\t\t\t\t\tattributes:data[i]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Raw data\n\t\t\t\t});\n\t\t\t\tapp.gl.add(graphic);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to layer\n\t\t\t\t}\n\n\t\t\t_this.extent={ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set extent based on minimax of popovers\n\t\t\t\tspatialReference:4326, \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// In lat/lon coord space\n\t\t\t\txmax:maxLon, xmin:minLon,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Longitude\n\t\t\t\tymax:maxLat, ymin:minLat\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Latitude\n\t\t\t\t}\n\n\t\t\tapp.mapView.on(\"pointer-move\", function(event) {\t\t\t\t\t\t\t\t\t\t// HANDLE HOVER\n\t\t\t\tvar screenPoint={ x: event.x, y: event.y };\t\t\t\t\t\t\t\t\t\t\t// Format pos\n\t\t\t\tapp.mapView.hitTest(screenPoint).then(function(response) {\t\t\t\t\t\t\t// Search for graphics at the clicked location\n\t\t\t\t\tif (response.results.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t// Found at least one\n\t\t\t\t\t\tlet id=response.results[0].graphic.attributes.ui;\t\t\t\t\t\t\t// Get id\n\t\t\t\t\t\tevent.type=\"mousemove\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Make event compatible\n\t\t\t\t\t\tsui.pages.ShowPopover(id, event)\n\t\t\t\t \t\t}\n\t\t\t\t\t});\n\t\t\t   });\n\t\t\t}\n\n// ADD WIDGETS\n\n\t\tif (app.opt&1)  app.mapView.ui.add(new ScaleBar({ view:app.mapView }), \"bottom-left\");\t\t// Add scale widget\n\t\tif (app.opt&2)  app.mapView.ui.add(new Search({ view:app.mapView }), \"top-right\");\t\t\t// Add Search widget\n\t\tif (app.opt&4)\tdocument.getElementById(\"plc-switch-btn\").addEventListener(\"click\", function() { app.SwitchView();  });// 3D\n\t\tif (app.opt&8) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add basemap picker\n\t\t\tapp.basePick=new BasemapGallery({ view:app.mapView, source: { portal: { url:\"https://www.arcgis.com\", useVectorBasemaps: true } }, visible:false });\n\t\t\tdocument.getElementById(\"plc-base-btn\").addEventListener(\"click\", function() { app.ToggleOption(app.basePick); });\t // Add button handler\n\t\t\t}\n\t\tif (app.opt&16) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Layer list\n\t\t\tapp.layers=new LayerList({ view:app.mapView, visible:false });\t\t\t\t\t\t\t// Add widget\n\t\t\t\tdocument.getElementById(\"plc-layer-btn\").addEventListener(\"click\", function() { app.ToggleOption(app.layers);  });\t// Add button handler\n\t\t\t}\n\t\tif (app.opt&32) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Legend\n\t\t\tapp.legend=new Legend({ view:app.mapView, visible:false });\t\t\t\t\t\t\t\t// Add widget\n\t\t\tdocument.getElementById(\"plc-legend-btn\").addEventListener(\"click\", function() { app.ToggleOption(app.legend); });\t// Add button handler\n\t\t\t}\n\t\tif (app.opt&64) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sketch\n\t\t\tapp.gl=new GraphicsLayer();  app.map.add(app.gl);\t\t\t\t\t\t\t\t\t\t// Add new graphics layer to map\n\t\t\tapp.sketch=new Sketch({ view:app.mapView, visible:false, layer:app.gl });\t\t\t\t// Add widget\n\t\t\tdocument.getElementById(\"plc-sketch-btn\").addEventListener(\"click\", function() { app.ToggleOption(app.sketch); });\t// Add button handler\n\t\t\t}\n\t\tif (app.opt&128) {  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Bookmarks\n\t\t\tapp.bookmarks=new Bookmarks({ view:app.mapView, visible:false });\t\t\t\t\t\t// Add widget\n\t\t\tdocument.getElementById(\"plc-book-btn\").addEventListener(\"click\", function() { app.ToggleOption(app.bookmarks); });\t // Add button handler\n\t\t\t}\n\n// POSITION\n\n\t\tapp.mapView.when(function() { \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// When 2D map loads\n\t\t\tif (_this.popovers)\t\t\t\tAddPopovers(_this.popovers);\t\t\t\t\t\t\t// Add popovers if any\n\t\t\tif (_this.extent)\t\t\t\tapp.GoToExtent(_this.extent);\t\t\t\t\t\t\t// If an extent given\n\t\t\telse if (!app.map.portalItem) \tapp.mapView.goTo({ center:app.center, zoom:app.zoom });\t// Center\n\t\t\tsui.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\t_this.showing=true;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Been shown\n\t\t\t});\n\t\tapp.sceneView.when(function() { app.sceneView.goTo({ tilt:80 }); });\t\t\t\t\t\t// When 3D loads, tilt\n\n\t// \tapp.DrawFooter=function()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW MAP FOOTER\n\t// \t{\n\t// \t\tstr=`<div style='float:left;font-size:18px'>\n\t// \t\t\t<div id='plc-customMap' class='sui-resDisplay' title='Custom/normal map'>&#xe625</div></div>\n\t// \t\t\t<div style='float:right;font-size:14px;margin-right:16px'>PLACE ID: ${kmap.id}</div>`;\n\t// \t\t$(\"#sui-footer\").html(str);\n\t// \t\t$(\"#plc-customMap\").on(\"click\", ()=> {\n\t// \t\t\tif ($(\"#plc-infoDiv\").length) {\n\t// \t\t\t\t$(\"#plc-infoDiv\").remove();\n\t// \t\t\t\tvar h=$(app.div).height()-4;\n\t// \t\t\t\tvar link=\"https://www.thlib.org/places/maps/interactive_ajax/#fid:\"+kmap.id;\n\t// \t\t\t\t$(app.div).html(\"<iframe frameborder='0' src='\"+link+\"' style='height:\"+h+\"px;width:100%'></iframe>\");\n\t// \t\t\t\t}\n\t// \t\t\telse sui.plc.Draw(kmap);\n\t// \t\t\t});\n\t// \t}\n\t//\n\t// app.DrawFooter();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw footer\n\n\n// HELPER FUNCTIONS //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\t\tapp.ToggleOption=function(option) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// HIDE/SHOW WIDGET OPTION\n\t\t\tif (option.visible)\tapp.activeView.ui.remove(option);\t\t\t\t\t\t\t\t\t// If visible, hide\n\t\t\telse\t\t\t\tapp.activeView.ui.add(option,\"top-right\");\t\t\t\t\t\t\t// Else show\n\t\t\toption.visible=!option.visible;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Toggle flag (why?)\n\t\t\t};\n\n\t\tapp.GoToExtent=function(extent) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SET NEW EXTENT\n\t\t\tapp.mapView.goTo({ extent:new Extent(extent) });\t\t\t\t\t\t\t\t\t\t// Set view to extent\n\t\t\t};\n\n\t\tapp.SwitchView=function() { \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SWITCH 2D/3D MODE\n\t\t\tvar is3D=app.activeView.type === \"3d\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Current mode\n\t\t\tvar activeViewpoint=app.activeView.viewpoint.clone();\t\t\t\t\t\t\t\t\t// Clone viewport\n\t\t\tapp.activeView.container=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide current one\n\n\t\t\tif (is3D) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If 3D now\n\t\t\t\tapp.activeView=app.mapView;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Use 2D view\n\t\t\t\tdocument.getElementById(\"plc-switch-btn\").value=\"3D\";\t\t\t\t\t\t\t\t// Set button\n\t\t\t\t}\n\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If 2D now\n\t\t\t\tapp.activeView=app.sceneView;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Use 2D view\n\t\t\t\tdocument.getElementById(\"plc-switch-btn\").value=\"2D\";\t\t\t\t\t\t\t\t// Set button\n\t\t\t\t}\n\t\t\tapp.activeView.viewpoint=activeViewpoint;\t\t\t\t\t\t\t\t\t\t\t\t// Set viewport\n\t\t\tapp.activeView.container=app.container;\t\t\t\t\t\t\t\t\t\t\t\t\t// Set container\n\t\t\t};\n\n\t\t});\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Require closure\n\n\t\t*/\n\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End Draw()\n\n\tGeoLocate()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET EXTENT FROM PLACE PATH TREE IN KMAP\n\t{\n\t\tlet loc=\"\";\n\t\tthis.extent=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume not found\n\t\tvar _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\ttry{\n\t\t\tfor (let i=this.kmap.ancestors_txt.length-1;i>0;--i)\t\t\t\t\t\t\t\t// For each ancestor backwards\n\t\t\tloc+=this.kmap.ancestors_txt[i]+\"%20\";\t\t\t\t\t\t\t\t\t\t\t\t// Add name\n\t\t\tif (this.kmap.ancestors_txt.length == 1) loc=this.kmap.ancestors_txt[0];\t\t\t// Top level places\n\t\t\tlet url=\"//geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/findAddressCandidates?f=pjson&SingleLine=\"+loc;\n\t\t\t$.ajax( { url: url, dataType: 'jsonp' } ).done(function(res) {\t\t\t\t\t\t// Run query\n\t\t\t\t_this.extent=res.candidates[0].extent;\t\t\t\t\t\t\t\t\t\t\t// Extract extent\n\t\t\t\t_this.extent.spatialReference=res.spatialReference.wkid;\t\t\t\t\t\t// Set ref\n\t\t\t\tif (_this.showing) _this.app.GoToExtent(_this.extent);\t\t\t\t\t\t\t// If already showing a map, go there\n\t\t\t});\t\n\t\t} catch(e) {};\t\n\t}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////\n// META DATA\n/////////////////////////////////////////////////////////////////////////////////////////////////\n\n\tDrawContent()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TABS AND CAPTION INFO\n\t{\n\t\tconst sui = this.sui;\n\t\tlet str=\"<div id='sui-topCon' style='margin-left:192px'>\";\t\t\t\t\t\t\t\t// Top content div\n\t\tif (this.kmap.caption) str+=\"<div style='margin:5px 0 13px 0' class='sui-sourceText'>\"+this.kmap.caption+\"</div>\";\t// Add caption\n\t\tstr+=sui.pages.DrawTabMenu([\"MAP\",\"NAMES\",\"LOCATION\"]);\t\t\t\t\t\t\t\t\t// Add tab menu\n\t\tstr+=\"</div><div class='plc-main' id='plc-main' ></div>\";\t\t\t\t\t\t\t\t// Map holder\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r|/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Add to div\n\t\t$(\"#plc-main\").css(\"height\",$(\"#sui-main\").height()*.667+\"px\");\t\t\t\t\t\t\t// Fill 2/3rds\n\t\t$(\"[id^=sui-tabTab]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\tthis.ShowTab(e.currentTarget.id.substring(10));\t\t\t\t\t\t\t\t\t\t// Get index of tab\tand draw it\n\t\t\t});\n\t\t}\n\n\tDrawMetadata(related)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW PLACES METADATA\n\t{\n\t\tconst sui = this.sui;\n\n\t\tif (this.popovers) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Has popovers\n\t\t\t$(this.div).html(\"<div class='plc-main' id='plc-main'></div>\");\t\t\t\t\t\t// Add to div\n\t\t\t$(\"#plc-main\").css({ \"margin\":0, \"width\":\"100%\", \"height\":$(\"#sui-legacy\").height()+\"px\"});\t// Resize map area\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't need any metadata or tabs\n\t\t\t}\n\t\tthis.GeoLocate();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get extent\n\t\tthis.DrawContent();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw tabset and captions is not related subject/places\n\t\tthis.ShowTab(related ? related : 0);\t\t\t\t\t\t\t\t\t\t\t\t\t// Show tab contents\n\t\tsui.pages.DrawRelatedAssets(this.kmap);\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu\n\t\tsui.GetChildNamesFromID(\"places\", this.kmap.id, (d)=> {\t\t\t\t\t\t\t\t\t// Get name from children\n\t\t\tlet i,o,oo,l=[];\n\t\t\tlet str=`<div style='display:inline-block;width:50%'><br>\n\t\t\t<div style='font-weight:bold;color:#6faaf1;margin-bottom:8px'>NAMES</div>`;\n\t\t\tif (d && d[0] && d[0]._childDocuments_ && d[0]._childDocuments_.length) {\t\t\t// If docs\n\t\t\t\tfor (i=0;i<d[0]._childDocuments_.length;++i) {\t\t\t\t\t\t\t\t\t// For each one\n\t\t\t\t\to=d[0]._childDocuments_[i];\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\t\too={};\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear obj\n\t\t\t\t\too.lab=o.related_names_header_s;\t\t\t\t\t\t\t\t\t\t\t// Label\n\t\t\t\t\too.lang=o.related_names_language_s;\t\t\t\t\t\t\t\t\t\t\t// Language\n\t\t\t\t\too.rel=o.related_names_relationship_s;\t\t\t\t\t\t\t\t\t\t// Relationship\n\t\t\t\t\too.write=o.related_names_writing_system_s;\t\t\t\t\t\t\t\t\t// Writing system\n\t\t\t\t\too.ety=o.related_names_etymology_s;\t\t\t\t\t\t\t\t\t\t\t// Etymology\n\t\t\t\t\too.path=o.related_names_path_s;\t\t\t\t\t\t\t\t\t\t\t\t// Path\n\t\t\t\t\too.tab=o.related_names_level_i-1;\n\t\t\t\t\tl.push(oo);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to array\n\t\t\t\t\t}\n\t\t\t\tl.sort(function(a, b) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Sort by path\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tif (a.path > b.path) \t\treturn 1;\t\t\t\t\t\t\t\t\t// Higher\n\t\t\t\t\t\telse if (a.path < b.path) \treturn -1;\t\t\t\t\t\t\t\t\t// Lower\n\t\t\t\t\t\telse\t\t\t\t\t\treturn 0;\t\t\t\t\t\t\t\t\t// The same\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\tfor (i=0;i<l.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each one\n\t\t\t\tstr+=`<div style='margin-left:${l[i].tab*16}px'>`;\t\t\t\t\t\t\t\t// Header\n\t\t\t\tif (i) str+=\"&bull; \";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add bullet\n\t\t\t\tstr+=`<b>${l[i].lab} </b>&nbsp; (${l[i].lang}, ${l[i].write}, ${l[i].rel})</div>`;\t// Text\n\t\t\t\t}\n\t\t\tstr+=`<br></div><div style='display:inline-block;width:calc(50% - 24px);vertical-align:top;border-left:1px solid #ccc; padding-left:12px;margin-top:22px'>\n\t\t\t<div style='font-weight:bold;color:#6faaf1;margin-bottom:8px'>ETYMOLOGY</div>`;\n\t\t\tfor (i=0;i<l.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each one\n\t\t\t\tif (l[i].ety)\tstr+=`<div>Etymology for <b>${l[i].lab}</b>: &nbsp; ${l[i].ety}</div>`; // Text\n\t\t\tstr+=\"</div><br>\";\n\t\t\tthis.content[1]=str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t// Set tab\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t});\n\t\n\t\tsui.GetRelatedFromID(this.kmap.uid,(data)=> { \t\t\t\t\t\t\t\t\t\t\t// Load data\n\t\t\tif (data[0].illustration_external_url && data[0].illustration_external_url) {\t\t// If an image spec'd\n\t\t\t\t$(\"#sui-relatedImg\").addClass(\"sui-relatedImg\");\t\t\t\t\t\t\t\t// Set style\n\t\t\t\t$(\"#sui-relatedImg\").prop(\"src\",data[0].illustration_external_url[0]);\t\t\t// Show it\n\t\t\t\t}\n\t\t\telse if (data[0].illustration_mms_url && data[0].illustration_mms_url[0]) {\t\t\t// If an image spec'd\n\t\t\t\t$(\"#sui-relatedImg\").addClass(\"sui-relatedImg\");\t\t\t\t\t\t\t\t// Set style\n\t\t\t\t$(\"#sui-relatedImg\").prop(\"src\",data[0].illustration_mms_url[0]);\t\t\t\t// Show it\n\t\t\t\t}\n\t\t\tthis.AddRelatedTabs();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add related places/context tab controls\n\t\t\tthis.AddRelatedPlaces(this.kmap,data,this.content2,0);\t\t\t\t\t\t\t\t// Add related place context html\n\t\t\tthis.AddRelatedSubjects(this.kmap,data);\t\t\t\t\t\t\t\t\t\t\t// Add related subjects html\n\t\t\t});\n\t}\t\n\n\tShowTab(which)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// OPEN TAB\n\t{\n\t\tconst sui = this.sui;\n\t\tlet _this=this;\n\t\t$(\"[id^=sui-tabTab]\").css({\"background-color\":\"#999\",color:\"#fff\" });\t\t\t\t\t// Reset all tabs\n\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t\t// Show content\n\t\t$(\"#sui-tabTab\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\t$(\"#sui-tabTab\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\tif (which == 0)\t\t$(\"#plc-main\").slideDown();\t\t\t\t\t\t\t\t\t\t\t// Show map\n\t\telse\t\t\t\t$(\"#plc-main\").slideUp();\t\t\t\t\t\t\t\t\t\t\t// Hide map\n\t\tif (which > 2)\t\t$(\"#sui-topCon\").html(this.content[which]);\t\t\t\t\t\t\t// If related subjects/places\n\t\telse\t\t\t\t$(\"#sui-tabContent\").html(this.content[which]);\t\t\t\t\t\t// Set content\n\t\tif (which == 4) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Related places\n\t\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t// Show content\n\t\t\t$(\"#sui-tabTabB0\").css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\t\t$(\"#sui-tabTabB0\").css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\t\t$(\"#sui-tabContent\").html(this.content2[0]);\t\t\t\t\t\t\t\t\t\t// Set content\n\t\t\t$(\"[id^=sui-spLab-]\").on(\"click\", function(e) {return false;\t});\t\t\t\t\t// ON CONTEXT LINE CLICK, INHIBIT\n\t\t\t$(\"[id^=sui-spDot-]\").on(\"click\", function(e) {\t\t\t\t\t\t\t\t\t\t// ON RELATIONSHIP TREE DOT CLICK\n\t\t\t\tlet path=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif (path != \"null\") sui.pages.AddRelBranch(_this.kmap.asset_type,path,$(this));\t// Lazy load branch\n\t\t\t\t$(this).html(\"&ndash;\"); \t\t\t\t\t\t\t\t\t\t\t\t\t\t// Change label\n\t\t\t\t$(this).parent().find('ul').slideToggle();            \t\t\t\t\t\t\t// Slide into place\n\t\t\t\t});\n\t\t\t}\n\t\t$(\"#sui-spLab-\"+this.kmap.uid).css({ \"font-weight\":\"bold\", \"text-decoration\": \"underline\" });\t// Highlight current one\n\t}\n\n\tAddRelatedTabs()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD TAB CONTROLS FOR RELATED PLACES/SUBJECTS\n\t{\n\t\tconst sui = this.sui;\n\t\tconst _this = this;\n\t\tlet str=drawTabB([\"PLACE CONTEXT\",\"RELATED PLACES\"]);\t\t\t\t\t\t\t\t\t// Add tab menu\n\t\tthis.content[4]=str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t// Set content for related places\n\t\t$(\"[id^=sui-tabTabB]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\tlet which=e.currentTarget.id.substring(11);\t\t\t\t\t\t\t\t\t\t\t// Get index of tab\tand draw it\n\t\t\t$(\"[id^=sui-spDot-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t\t$(\"[id^=sui-spItem-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t\t$(\"[id^=sui-togCat-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t\t$(\"[id^=sui-spCatUL-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t\t$(\"[id^=sui-tabTabB]\").css({\"background-color\":\"#999\",color:\"#fff\" });\t\t\t\t// Reset all tabs\n\t\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t// Show content\n\t\t\t$(\"#sui-tabTabB\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t// Active tab\n\t\t\t$(\"#sui-tabTabB\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t// Active tab\n\t\t\t$(\"#sui-tabContent\").html(this.content2[which]);\t\t\t\t\t\t\t\t\t// Set content\n\t\t\n\t\t\t$(\"[id^=sui-spDot-]\").on(\"click\", function(e) {\t\t\t\t\t\t\t\t\t\t// ON RELATIONSHIP TREE DOT CLICK\n\t\t\t\tlet firstChild=$(this).parent().find(\"ul\")[0];\t\t\t\t\t\t\t\t\t// Get first child\n\t\t\t\tlet path=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif (path != \"null\") sui.pages.AddRelBranch(_this.kmap.asset_type,path,$(this));\t// Lazy load branch\n\t\t\t\t$(this).html($(firstChild).css(\"display\") == \"none\" ? \"&ndash;\" : \"+\"); \t\t// Change label\n\t\t\t\t$(this).parent().find('ul').slideToggle();            \t\t\t\t\t\t\t// Slide into place\n\t\t\t\t});\n\t\t\t$(\"[id^=sui-spLab-]\").on(\"click\",  function(e) {\treturn false;\t\t});\t\t\t// ON CONTEXT LINE CLICK, INHIBIT\n\t\t\t$(\"[id^=sui-spItem-]\").on(\"click\", function(e) {\treturn false;\t\t});\t\t\t// ON LINE CLICK, INHIBIT\n\t\t\t$(\"[id^=sui-spCatUL-]\").slideDown();\t\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t$(\"[id^=sui-spCat-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON CATEGORY CLICK\n\t\t\t\tlet id=e.currentTarget.id.substring(9);\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\t\tif ($(\"#sui-spCatUL\"+id).css(\"display\") == \"none\")\t\t\t\t\t\t\t// If hidden\n\t\t\t\t\t$(\"#sui-spCatUL\"+id).slideDown();\t\t\t\t\t\t\t\t\t\t\t// Show\n\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If showing\n\t\t\t\t\t$(\"#sui-spCatUL\"+id).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t// Hide\n\t\t\t\t});\n\t\t\t$(\"[id^=sui-spSub-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON SUB-CATEGORY CLICK\n\t\t\t\tlet id=e.currentTarget.id.substring(9);\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif ($(\"#sui-spSubUL\"+id).css(\"display\") == \"none\")\t\t\t\t\t\t\t\t// If hidden\n\t\t\t\t\t$(\"#sui-spSubUL\"+id).slideDown();\t\t\t\t\t\t\t\t\t\t\t// Show\n\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If showing\n\t\t\t\t\t$(\"#sui-spSubUL\"+id).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t// Hide\n\t\t\t\t});\n\t\t\t$(\"#sui-togCatA\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON EXPAND ALL\n\t\t\t\t$(\"[id^=sui-spCatUL-]\").slideDown();\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t\t});\n\t\t\t$(\"#sui-togCatN\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLAPSE ALL\n\t\t\t\t$(\"[id^=sui-spCatUL-]\").slideUp();\t\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t\t});\n\t\t});\n\n\t\tfunction drawTabB(tabs)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TAB MENU\n\t\t\tlet i, str=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\tfor (i=0;i<tabs.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each tab\t\n\t\t\t\tstr+=`<div class='sui-tabTab' id='sui-tabTabB${i}' style='width:calc(${100/tabs.length}% - 2px)'>${tabs[i]}&nbsp;&#xe609</div>`;\n\t\t\tstr+=\"<div class='sui-tabContent' id='sui-tabContent'></div>\";\t\t\t\t\t\t// Tab contents\n\t\t\treturn str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t\t// Return tab markup\n\t\t\t}\t\t\n\t\t}\n\n\tAddRelatedPlaces(o, d, content)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD RELATED PLACES CONTENTS \n\t{\n\t\tconst sui = this.sui;\n\t\tlet n=0,sups=0;\n\t\tif (d[0].ancestors && d[0].ancestors.length > 2) sups=d[0].ancestors.length-2;\n\t\tlet str=`<br><div class='sui-spHead'>Places related to ${o.title}</div>\n\t\t<div style='max-width:900px'>\n\t\t<b>${o.title[0]}</b> has <b>${sups}</b> superordinate places and<b> TBD </b> immediately subordinate places. \n\t\tYou can browse these subordinate places as well as its superordinate categories with the tree below. \n\t\tSee the RELATED PLACES tab if you instead prefer to view only its immediately subordinate places grouped together in useful ways, \n\t\tas well as places non-hierarchically related to it.</div><br>\n\t\t<ul class='sui-spLin' id='sui-spRows'>`;\n\t\tif (o.asset_type == \"subjects\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If subjects assets\n\t\t\tcontent[0]=str.replace(/\\t|\\n|\\r/g,\"\")+\"</ul><br>\";\t\t\t\t\t\t\t\t\t// Set 1st content array member with html\n\t\t\treturn;\t\t\n\t\t\t}\n\t\tif (!d[0].ancestors)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No ancestors\n\t\tfor (n=0;n<d[0].ancestors.length-1;++n) {\t\t\t\t\t\t\t\t\t\t\t\t// For each ancestor (skipping Earth)\n\t\t\tstr+=\"<ul style='list-style-type:none'>\";\t\t\t\t\t\t\t\t\t\t\t// Add header\n\t\t\tstr+=sui.pages.AddRelTreeLine(d[0].ancestors[n+1],d[0].ancestor_uids_generic[n+1],\"&ndash;\",null); // Add it \n\t\t\t}\n\t\n\t\tsui.GetTreeChildren(o.asset_type,d[0].ancestor_id_path,(res)=>{\t\t\t\t\t\t\t// Get children\n\t\t\tlet i,j,re,m,path;\n\t\t\tlet counts=[];\n\t\t\ttry { counts=res.facets.child_counts.buckets; } catch(e) {}\t\t\t\t\t\t\t// Get child counts\n\t\t\tres=res.response.docs;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at docs\n\t\t\tfor (i=0;i<res.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each child\n\t\t\t\tpath=\"\";\tm=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume a loner\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tre=new RegExp(res[i].id.split(\"-\")[1]);\t\t\t\t\t\t\t\t\t\t\t// Get id to search on\n\t\t\t\tfor (j=0;j<counts.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each count\n\t\t\t\t\tif (counts[j].val.match(re)) {\t\t\t\t\t\t\t\t\t\t\t\t// In this one\n\t\t\t\t\t\tm=\"+\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Got kids\n\t\t\t\t\t\tpath=counts[j].val;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add path\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tstr+=\"<ul style='list-style-type:none'>\";\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\t\tstr+=sui.pages.AddRelTreeLine(res[i].header,res[i].id,m,path)+\"</li></ul>\"; \t// Add it\n\t\t\t\t}\n\t\t\t\n\t\t\tfor (i=0;i<d[0].ancestors.length;++i) str+=\"</li></ul>\";\t\t\t\t\t\t\t// Close chain\n\t\t\tcontent[0]=str.replace(/\\t|\\n|\\r/g,\"\")+\"</ul><br>\";\t\t\t\t\t\t\t\t\t// Set 1st content array member with html\n\t\t\t});\n\t\t\n\t\tthis.AddRelatedContext(o,d,content);\t\t\t\t\t\t\t\t\t\t\t\t\t// Get context\n\t\t}\n\n\tAddRelatedContext(o, c, content)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD PLACE CONTEXT CONTENT \t\n\t{\n\t\t\tconst sui = this.sui;\n\t\t\tlet f,i,s=[],n=0;\n\t\t\tfor (i=0;i<c.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each subject get data as 's=[category[{title,id}]]' \n\t\t\t\tif (c[i].block_child_type != \"related_places\") continue;\t\t\t\t\t\t\t// Add only related places\n\t\t\t\tif (c[i].related_places_header_s == \"Earth\")   continue;\t\t\t\t\t\t\t// Skip earth\n\t\t\t\t++n;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to count\n\t\t\t\tif (!s[c[i].related_places_relation_label_s])\t\t\t\t\t\t\t\t\t\t// If first one of this category \n\t\t\t\t\t\ts[c[i].related_places_relation_label_s]=[];\t\t\t\t\t\t\t\t\t// Alloc category array\n\t\t\t\ts[c[i].related_places_relation_label_s].push({\t\t\t\t\t\t\t\t\t\t// Add subject to category \n\t\t\t\t\ttitle:c[i].related_places_header_s,\t\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\t\t\t\tsub:c[i].related_places_feature_type_s,\t\t\t\t\t\t\t\t\t\t\t// Sub category\n\t\t\t\t\tid:c[i].related_uid_s });\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add id\n\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\n\t\t\tlet biggest=Object.keys(s).sort((a,b)=>{return a.length > b.length ? -1 : 1;})[0];\t\t// Find category with most elements\t \n\t\t\tlet str=`<br><div class='sui-spHead'>Places related to ${o.title}</div>\n\t\t\t<div style='max-width:900px'>\n\t\t\t<b>${o.title[0]}</b> has <b>${\"TBD\"}</b> other place${(n > 1) ? \"s\": \"\"} directly related to it, which is presented here. \n\t\t\tSee the PLACE CONTEXT tab if you instead prefer to browse all subordinate and superordinate places for ${o.title[0]}.</div>\n\t\t\t<p><a class='sui-advEditBut' id='sui-togCatA'>Expand all</a> / <a class='sui-advEditBut' id='sui-togCatN'>Collapse all</a>\n\t\t\t</p><div style='width:100%'><div style='width:50%;display:inline-block'>`;\n\t\t\tstr+=drawCat(biggest)+\"</div><div style='display:inline-block;width:50%;vertical-align:top'>\";\t// Add biggest to 1st column, set up 2nd\t \n\t\t\tfor (f in s) if (f != biggest)\tstr+=drawCat(f);\t\t\t\t\t\t\t\t\t\t// For each other category, draw it in 2nd column\n\t\t\tstr+=\"</div></div>\";\n\t\t\tcontent[1]=str.replace(/\\t|\\n|\\r/g,\"\")+\"</ul><br>\";\t\t\t\t\t\t\t\t\t\t// Set 2nd content array member with html\n\n\t\t\tfunction drawCat(f) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW CATEGORY\n\t\t\t\tlet sub=\"xxx\";\n\t\t\t\ts[f]=s[f].sort((a,b)=>{ return a.sub < b.sub ? -1 : 1;});\t\t\t\t\t\t\t// Sort by sub category\n\t\t\t\tlet str=`<div id='sui-spCat-${f.replace(/ /g,\"_\")}' \n\t\t\t\tclass='sui-spCat' style='background-color:${sui.assets[o.asset_type].c}'> ${o.title} ${f}</div>\n\t\t\t\t<ul id='sui-spCatUL-${f.replace(/ /g,\"_\")}'><ul>`;\n\t\t\t\tfor (i=0;i<s[f].length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tif (sub != s[f][i].sub) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// A new sub category\n\t\t\t\t\t\tsub=s[f][i].sub;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// New sub\n\t\t\t\t\t\tstr+=\"</ul><div class='sui-spSubCat'>\";\t\t\t\t\t\t\t\t\t\t// End last sub container ul, add sub container div\n\t\t\t\t\t\tstr+=\"<div style='background-color:#999' class='sui-spDot' id='sui-spSub-\"+s[f][i].id+\"'>&ndash;</div>\";\t// Add folding dot\n\t\t\t\t\t\tstr+=\"<b>\"+sub+\"</b></div>\";\t\t\t\t\t\t\t\t\t\t\t\t// Add sub title\n\t\t\t\t\t\tstr+=\"<ul id='sui-spSubUL-\"+s[f][i].id+\"' style='list-style-type:none'>\";\t// Add new container ul\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"<li style='list-style-type:none'><a class='sui-noA' id='sui-spItem-\"+s[f][i].id;\n\t\t\t\t\tstr+=\"' href='#p=\"+s[f][i].id+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Add url\n\t\t\t\t\tstr+=s[f][i].title+\"</a>\"+sui.pages.AddPop(s[f][i].id)+\"</li>\";\t\t\t\t\t//Add title it with popover\n\t\t\t\t\t}\n\t\t\t\treturn str+\"</ul></ul>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close category and sub container ul\n\t\t\t\t}\n\t\t}\n\t\n\n\tAddRelatedSubjects(o,c)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD RELATED SUBJECTS CONTENT \t\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,s=[],ss;\n\t\tlet str=`<div style='width:50%;vertical-align:top'>\n\t\t\t<div class='sui-spHead'>Subjects related to ${o.title}</div>`;\n\t\tif (o.feature_types_ss && o.feature_types_ss.length) {\t\t\t\t\t\t\t\t\t// If feature types\n\t\t\tstr+=`<div class='sui-spCat' style='background-color:#6faaf1'>\n\t\t\tFeature Types</div>\n\t\t\t<div style='margin-left:24px'>`;\t\t\t\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\tfor (i=0;i<o.feature_types_ss.length;++i) \t\t\t\t\t\t\t\t\t\t\t// For each feature\n\t\t\t\tstr+=\"<li>\"+o.feature_types_idfacet[i].split(\"|\")[0]+sui.pages.AddPop(o.feature_types_idfacet[i].split(\"|\")[1])+\"</li>\";  // Add\n\t\t\tstr+=\"</div><br>\"\n\t\t\t}\n\t\tfor (i=0;i<c.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each subject get data  \n\t\t\tif (c[i].block_child_type != \"related_subjects\") continue;\t\t\t\t\t\t\t// Add only related subjects\n\t\t\tss=c[i].related_subjects_display_string_s;\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\t\tif (c[i].related_subjects_time_units_t && c[i].related_subjects_time_units_t[0])\t// If a time\n\t\t\t\tss+=` (${c[i].related_subjects_time_units_t[0]})`;\t\t\t\t\t\t\t\t// Add it to title\n\t\t\ts.push({ title:ss, id:c[i].related_subjects_id_s });\t\t\t\t\t\t\t\t// Add title and id\n\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\n\t\tif (s.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If subjects\n\t\t\tstr+=`<div class='sui-spCat' style='background-color:#6faaf1'>\n\t\t\t\tRelated subjects</div>\n\t\t\t\t<div style='margin-left:24px'>`;\t\t\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\tfor (i=0;i<s.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each subject  \n\t\t\t\tstr+=\"<li>\"+s[i].title+sui.pages.AddPop(s[i].id)+\"</li>\";\t\t\t\t\t\t// Add it\n\t\t\t}\n\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End half div\n\t\tthis.content[3]=str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t// Set summary tab\n\t}\n\n} // Places class closure\n","/* \tAUDIO VIDEO PAGES ****************************************************************************************************************************\n\n\tThis module puts up the audio video pages based on a kmap from SOLR. It uses the Kaltura media \n\tplayer to actually play the video and has a transcript section that tracks the video.\n\n\tThe SHANTI-styled Kaltura player is loaded into an iFrame using their kwidget API. Once loaded, \n\tevents are bound to trap whenever the video is played or paused. On play, PlayAV() is called to \n\tstart a ~10fps time that calls a function to update the transcript code (see section below) to \n\ttrack the video. On pause, that timer is canceled.\n\n\tSome metadata is displyed under the video along with the summary. A MORE link will reveal and \n\tadditonal summary information about the clip. A tabbed menu appears below that\n\tto reduce coginitive load, with sections showing video DETAILS, PEOPLE, involved and TECHNICAL data.\n\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tKaltura: \thttps://cfvod.kaltura.com,\t//cdnapi.kaltura.com,\t// Kaltura API\n\tJSON:\t\tFrom Drupal site\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\tGlobals:\tLooks for sui and sui.pages\n\n*************************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\nexport default class AudioVideo  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t\tthis.content=[\"...loading\",\"...loading\",\"...loading\"];\t\t\t\t\t\t\t\t\t// Content pages\n\t\tthis.inPlay=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If AV is in play\n\t\tthis.curTransSeg=-1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Currently active transceipt segment\n\t\tthis.transRes=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds transcript resources\t\n\t\tthis.scrollStart=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Initial transcript scroll distance when starting play\n\t\tthis.handScroll=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set when transcript is scrolled by hand\n\t\tthis.mouseDown=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// When mouse is down\n\t\tthis.playEnd=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End of clip\n\t\tthis.kmap=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current kmap of clip\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW AUDIO/VIDEO PAGE\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,f,wid=100;\n\t\tconst _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Context\n\t\tvar partnerId=\"381832\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kaltura partner id\n\t\tvar uiConfId=\"31832371\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kaltura confidential code\n\t\tvar entryId=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Media id\n\t\tthis.inPlay=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Not playying yet\n\t\tlet w=$(this.div).width();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Width of area\n\t\t$(this.div).css(\"background-color\",\"#eee\");\t\t\t\t\t\t\t\t\t\t\t\t// BG color\n\t\t$(this.div).html(\"<div id='sui-av'></div>\");\t\t\t\t\t\t\t\t\t\t\t// Clear screen\n\t\tsui.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\t\tthis.kmap=o;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save kmap\n\t\tif (typeof window.kWidget != \"undefined\") \twindow.kWidget.destroy(\"sui-kplayer\");\t\t\t\t\t\t// If Kaltura player already initted yet, kill it\n\t\t\n\t\tsui.LoadingIcon(true,64);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\t\tsui.GetJSONFromKmap(o, (d)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get details from JSON\n\t\t\tvar str=`<div id='sui-viewerSide' style='display:inline-block;width:${w}px;max-width:1100px'>`;\t\t// Left side\n\t\t\tif (d.field_video && d.field_video.und)\t\t\t\t\t\t\t\t\t\t\t\t// If video\n\t\t\t\tentryId=d.field_video.und[0].entryid;\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\telse if (d.field_video && d.field_video.en)\t\t\t\t\t\t\t\t\t\t\t// If video (english)\n\t\t\t\tentryId=d.field_video.en[0].entryid;\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\telse if (d.field_audio && d.field_audio.und) {\t\t\t\t\t\t\t\t\t\t// Audio\n\t\t\t\tentryId=d.field_audio.und[0].entryid;\t\t\t\t\t\t\t\t\t\t\t// Id\n\t\t\t\twid=50;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Make smaller\n\t\t\t\t}\n\t\t\telse if (d.field_audio && d.field_audio.en) {\t\t\t\t\t\t\t\t\t\t// Audio (english)\n\t\t\t\tentryId=d.field_audio.en[0].entryid;\t\t\t\t\t\t\t\t\t\t\t// Id\n\t\t\t\twid=50;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Make smaller\n\t\t\t\t}\n\t\t\tstr+=`<div class='sui-vPlayer' style='width:${wid}%;height:${w*0.5625*wid/100}px' id='sui-kplayer'>\n\t\t\t<img src=\"https://cfvod.kaltura.com/p/${partnerId}/sp/${partnerId}00/thumbnail/entry_id/${entryId}/version/100301/width/560/height/0\" fill-height\"></div>`;\n\t\t\tstr+=`<br><br><div style='display:inline-block;width:300px;margin-left:16px'>\n\t\t\t<div title='Duration'>&#xe61c&nbsp;&nbsp;&nbsp;${o.duration_s}</div>\n\t\t\t<div title='Published'>&#xe60c&nbsp;&nbsp;&nbsp;Published `;\n\t\t\tif (d.field_year_published && d.field_year_published.en)\tstr+=+d.field_year_published.en[0].value;\n\t\t\telse if (o.node_created) \t\t\t\t\t\t\t\t\tstr+=sui.pages.FormatDate(o.node_created);\n\t\t\tstr+=\"</div>\";\n\t\t\ttry{ if (o.collection_title) \t\n\t\t\t\t\tstr+=`<a title='Collection' id='sui-avCol'\n\t\t\t\t\thref='#c=${o.asset_type}-${o.id}=${o.collection_idfacet[0]}'>\n\t\t\t\t\t&#xe633&nbsp;&nbsp;&nbsp;\n\t\t\t\t\t<a title='Collection' id='sui-avCol'\thref='#p=${o.collection_uid_s}'>${o.collection_title}</a>`;\n\t\t\t\t   }  catch(e) {}\n\t\t\tstr+=`</div><div style='display:inline-block;vertical-align:top;width:calc(100% - 320px)'>`;\n\t\t\ttry{ str+=\"<div title='Creators'>&#xe600&nbsp;&nbsp;&nbsp;\"+o.creator.join(\", \")+\"</div>\";  } catch(e) {}\n\t\t\tstr+=`</div><hr>\n\t\t\t<p class='sui-sourceText'>${o.summary ? o.summary : o.caption ? o.caption : \"\"}</p>`;\n\t\t\tif (d.field_pbcore_description && d.field_pbcore_description.und && d.field_pbcore_description.und.length) {\t\n\t\t\t\tstr+=`<div class='sui-avMore1'><a class='sui-avMore2' onclick='$(\"#sui-avlang\").toggle();this.text=(this.text == \"SHOW MORE\") ? \"SHOW LESS\" : \"SHOW MORE\"'>\n\t\t\t\tSHOW MORE</a></div><br>`;\n\t\t\t\tstr+=\"<div id='sui-avlang' style='display:none'>\";\n\t\t\t\tfor (i=0;i<d.field_pbcore_description.und.length;++i) {\t\t\t\t\t\t\t// For each new description\n\t\t\t\t\ttry{ f=d.field_pbcore_description.und[i];\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\t\t str+=`<b>${f.field_language.und[0].value.toUpperCase()}</b>:<br>${f.field_description.und[0].value}<br>`;  } catch(e) {}\n\t\t\t\t\t}\n\t\t\t\tstr+=\"</div>\";\n\t\t\t\t}\n\t\t\tstr+=sui.pages.DrawTabMenu([\"DETAILS\",\"PEOPLE\",\"TECHNICAL\"]);\t\t\t\t\t\t// Add tab menu\n\t\t\t$(\"#sui-av\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t// Add player\n\t\n\t\t\t$(\"#sui-avCol\").on(\"click\",()=>\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLECTION CLICK\n\t\t\t\tsui.GetKmapFromID(o.collection_uid_s,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t// Get kmap and show page\n\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t\t});\n\n\t\t\tthis.DrawTranscript(o,\"#sui-trans\");\t\t\t\t\t\t\t\t\t\t\t\t// Draw transcript in div\n\t\t\tstr=`//cdnapi.kaltura.com/p/${partnerId}/sp/${partnerId}00/embedIframeJs/uiconf_id/${uiConfId}/partner_id/${partnerId}`;\n\t\t\t$.ajax(\t{ url:str, dataType:\"script\" }).done((e)=> { \n\t\t\t\twindow.kWidget.embed({\n\t\t\t\t\ttargetId:\"sui-kplayer\",  wid:\"_\"+partnerId,\t\t\t\tuiconf_id:uiConfId,\n\t\t\t\t\tentry_id:entryId,\t\t flashvars:{ autoPlay:false},\tparams:{ \"wmode\": \"transparent\"} \n\t\t\t\t\t});\n\t\t\t\twindow.kWidget.addReadyCallback(()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// When ready, add icon callback\n\t\t\t\t\tlet kdp=document.getElementById(\"sui-kplayer\");\t\t\t\t\t\t\t\t// Get div\n\t\t\t\t\tif (typeof(kdp) != \"object\")\treturn;\t\t\t\t\t\t\t\t\t\t// Quit if no player ready yet\n\t\t\t\t\tkdp.kBind(\"doPlay.__tests__\", ()=> {\t$(\"#sui-transTab1\").html(\"&#xe681\"); this.inPlay=true; this.PlayAV(); });\t// Pause icon\n\t\t\t\t\tkdp.kBind(\"doPause.__tests__\",()=> { $(\"#sui-transTab1\").html(\"&#xe641\"); this.inPlay=false; this.playEnd=0; clearInterval(this.transTimer); });\t// Play\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\tsui.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\t\tif (typeof window.kWidget != \"undefined\") window.kWidget.embed({ entry_id:entryId });\t\t\t// If Kaltura player already inittted yet\n\t\t\t\tthis.DrawMetaData(o,d);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw metadata content\n\t\t\t\tshowTab(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Open details\n\n\t\t\t\t$(\"[id^=sui-tabTab]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\t\t\tvar id=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t// Get index of tab\t\n\t\t\t\t\t\tshowTab(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t\t\t\t});\n\t\t\t\n\t\t\t\tfunction showTab(which) {\n\t\t\t\t\t$(\"[id^=sui-tabTab]\").css({\"background-color\":\"#999\",color:\"#fff\" });\t\t// Reset all tabs\n\t\t\t\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#fff\"});\t\t// Show content\n\t\t\t\t\t$(\"#sui-tabTab\"+which).css({\"background-color\":\"#fff\",color:\"#000\"});\t\t// Active tab\n\t\t\t\t\t$(\"#sui-tabContent\").html(_this.content[which]);\t\t\t\t\t\t// Set content\n\t\t\t\t\t}\n\t\t\t});\n\t}\n\n\tDrawMetaData(o,d)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TABBED METADATA\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,t,v,f;\n\t\tlet\tstr=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start fresh on tab 0\n\t\ttry{ if (o.title) str+=\"<p title='Title'><b>TITLE</b>:&nbsp;&nbsp;\"+o.title+\"</p>\"; } catch(e) {}\n\t\ttry{ if (o.collection_title) str+=\"<p title='Collection'><b>COLLECTION</b>:&nbsp;&nbsp;\"+o.collection_title+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>SUBCOLLECTION</b>:&nbsp;&nbsp;\";\n\t\t\tfor (i=0;i<d.field_subcollection_new.und.length;++i) {\n\t\t\t\tstr+=d.field_subcollection_new.und[i].header+sui.pages.AddPop(d.field_subcollection_new.und[i].domain+\"-\"+d.field_subcollection_new.und[i].id)+\"&nbsp;&nbsp; \";\n\t\t\t\t}\n\t\t\tstr+=\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>SUBJECT</b>:&nbsp;&nbsp;\";\n\t\t\tfor (i=0;i<d.field_subject.und.length;++i) {\n\t\t\t\tstr+=d.field_subject.und[i].header+sui.pages.AddPop(d.field_subject.und[i].domain+\"-\"+d.field_subject.und[i].id)+\"&nbsp;&nbsp; \";\n\t\t\t\t}\n\t\t\tstr+=\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>RECORDING LOCATION</b>:&nbsp;&nbsp;\"+d.field_recording_location_new.und[0].header+sui.pages.AddPop(d.field_recording_location_new.und[0].domain+\"-\"+d.field_recording_location_new.und[0].id)+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p'><b>LANGUAGE</b>:&nbsp;&nbsp;\"+d.field_language_kmap.und[0].header+sui.pages.AddPop(d.field_language_kmap.und[0].domain+\"-\"+d.field_language_kmap.und[0].id)+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>TERMS</b>:&nbsp;&nbsp;\"+d.field_terms.und[0].header+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>COPYRIGHT OWNER</b>:&nbsp;&nbsp;\"+d.field_copyright_owner.en[0].value+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>YEAR PUBLISHED</b>:&nbsp;&nbsp;\"+d.field_year_published.en[0].value+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>RIGHTS SUMMARY</b>:&nbsp;&nbsp;\"+d.field_pbcore_rights_summary.en[0].value+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>UPLOADED</b>:&nbsp;&nbsp;\"+o.timestamp.substr(0,10)+\" by \"+o.node_user_full_s+\"</p>\"; } catch(e) {}\n\t\tthis.content[0]=\"<div style='height:2px'/>\"+str+\"<br>\"; \t\t\t\t\t\t\t\t// Add to tab\n\n\t\tstr=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start fresh on tab 1\n\t\tif (d.field_pbcore_creator && d.field_pbcore_creator.und && d.field_pbcore_creator.und.length) {\t// If creators spec'd\t\n\t\t\tfor (i=0;i<d.field_pbcore_creator.und.length;++i) {\t\t\t\t\t\t\t\t\t// For each creator\n\t\t\t\tf=d.field_pbcore_creator.und[i];\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\ttry{ str+=`<p><b>${f.field_creator_role.und[0].value.toUpperCase()}</b>:&nbsp;&nbsp;${f.field_creator.und[0].value}</p>`;  } catch(e) {}\n\t\t\t\t}\n\t\t\t}\n\t\tif (d.field_pbcore_contributor && d.field_pbcore_contributor.und && d.field_pbcore_contributor.und.length) {\t// If creators spec'd\t\n\t\t\tfor (i=0;i<d.field_pbcore_contributor.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tf=d.field_pbcore_contributor.und[i];\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\ttry{ str+=`<p><b>CONTRIBUTING ${f.field_contributor_role.und[0].value.toUpperCase()}</b>:&nbsp;&nbsp;${f.field_contributor.und[0].value}</p>`;  } catch(e) {}\n\t\t\t\t}\n\t\t\t}\n\t\ttry{ str+=\"<p><b>PUBLISHER</b>:&nbsp;&nbsp;\"+d.field_pbcore_publisher.und[0].field_publisher.und[0].value+\"</p>\"; } catch(e) {}\n\t\ttry{ str+=\"<p><b>DATA ENTRY</b>:&nbsp;&nbsp;\"+o.node_user_full_s+\"</p>\"; } catch(e) {}\n\t\tthis.content[1]=\"<div style='height:2px'/>\"+str+\"<br>\"; \t\t\t\t\t\t\t\t// Add to tab\n\n\t\tstr=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start fresh on tab 2\n\t\tif (d.field_pbcore_instantiation && d.field_pbcore_instantiation.und && d.field_pbcore_instantiation.und.length) {\t// If instantiation spec'd\t\n\t\t\tfor (i in d.field_pbcore_instantiation.und[0]) {\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tv=d.field_pbcore_instantiation.und[0][i];\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\tt=i.replace(/field_/,\"\").replace(/_/g,\" \");\t\t\t\t\t\t\t\t\t\t// Remove header and spaces\n\t\t\t\ttry{ str+=`<p><b>${t.toUpperCase()}</b>:&nbsp;&nbsp;${v.und[0].value}</p>`;  } catch(e) {}\n\t\t\t\t}\n\t\t\t}\n\t\ttry{ str+=\"<p><b>FORMAT ID</b>:&nbsp;&nbsp;\"+d.field_video.und[0].entryid+\"</p>\"; } catch(e) {}\n\t\tstr+=\"<p><b>FORMAT ID SOURCE</b>:&nbsp;&nbsp;(Kaltura.com)</p>\"; \n\t\tthis.content[2]=\"<div style='height:2px'/>\"+str+\"<br>\"; \t\t\t\t\t\t\t\t// Add to tab\n\t}\n\n/* TRANSCRIPT //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\tThis section draws the transcript which follows a video, if available.\n\n*///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\tDrawTranscript(kmap, div)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TRANSCRIPT FROM SOLR \n\t{\n\t\tvar i,o,seg;\n\t\tvar l={};\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds filed:language pairs\n\t\tif (!kmap.trid_i)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if no transcript\n\t\tthis.curTransSeg=-1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at top\n\n\t\tl.ts_content_rus=\"Russian\";\t\tl.content_bod=\"Tibetan\";\t\tl.dzo_bod=\"Dzongkha\";\t\t\t\tl.ts_content_sgt=\"Brokpake\";\t\n\t\tl.ts_content_kjz=\"Bumthangkha\";\tl.ts_content_tgf=\"Chalikha\";\tl.ts_content_cgk=\"Chocangacakha\";\tl.ts_content_dka=\"Dakpakha\";\t\n\t\tl.ts_content_dzl=\"Dzalakha\";\tl.ts_content_goe=\"Gongduk\";\t\tl.ts_content_xkz=\"Kurtop\";\t\t\tl.ts_content_kru=\"Kuruz\";\t\t\n\t\tl.ts_content_lkh=\"Lakha\";\t\tl.ts_content_lya=\"Layakha\";\t\tl.ts_content_lep=\"Lepcha\";\t\t\tl.ts_content_lhp=\"Lhokpu\";\t\t\n\t\tl.ts_content_luk=\"Lunanakha\";\tl.ts_content_npb=\"Nupbikha\";\tl.ts_content_neh=\"Mangdekha\";\t\tl.ts_content_ole=\"Olekha\";\t\t\n\t\tl.ts_content_tsj=\"Tshangla\";\tl.ts_content_xkf=\"Khengkha\";\tl.ts_content_wylie=\"Wylie\";\t\t\tl.ts_content_gyal=\"Gyalsumdo\";\n\t\tl.ts_content_gvr=\"Gurung\";\t\tl.ts_content_npa=\"Nar Phu\";\t\tl.ts_content_nmm=\"Manange\";\t\t\tl.ts_content_kte=\"Nubri\";\t\n\t\tl.ts_content_tsum=\"Tsum\";\t\tl.ts_content_nep=\"Nepali\";\t\tl.ts_content_eng=\"English\";\t\t\tl.ts_content_zho=\"Chinese\"; \n\t\tl.ts_content_und=\"Unknown\";\t\tl.ts_content_gloss=\"Morpheme glossing\";\n\t\t\n\t\tvar res={ languages:{}, speakers:{}, segs:[], layout:\"Normal\", rev:0, speaker:\"\" };\t\t// Final data\t\t\t\t\t\t\t\t\n\t\tvar url=\"https://ss251856-us-east-1-aws.measuredsearch.com/solr/av_test/select?indent=on&q=is_trid:\"+kmap.trid_i+\"&wt=json&start=0&rows=1000\";\n\t\t$.ajax( { url:url, dataType:'jsonp', jsonp:'json.wrf' }).done((data)=> {\t\t\t\t// Get transcript data\n\t\t\tdata.response.docs.sort(function(a,b) { return (a.fts_start > b.fts_start) ? 1 : -1; }); // Sort\n\t\t\tfor (i=0;i<data.response.docs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t// For each seg in doc\n\t\t\t\to=data.response.docs[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\tseg={ start: o.fts_start, end: o.fts_end, dur:o.fts_duration };\t\t\t\t\t// Make seg with timings\n\t\t\t\tif (o.ss_speaker_bod) { res.speakers[o.ss_speaker_bod]=1; seg.speaker=o.ss_speaker_bod; }\t// Set speaker?\n\t\t\t\tseg.lang=o.ss_language ? o.ss_language : \"\";\t\t\t\t\t\t\t\t\t// Set seg language\n\t\t\t\t\tfor (var lang in l) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\t\t\t\tif (o[lang]) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a language match\t\n\t\t\t\t\t\t\tseg[l[lang]]=o[lang];\t\t\t\t\t\t\t\t\t\t\t\t// Add to transcript under language\n\t\t\t\t\t\t\tres.languages[l[lang]]=1;\t\t\t\t\t\t\t\t\t\t\t// Add to languages list\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\tres.segs.push(seg);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add seg to list\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\tif (!res.segs.length)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if no segs\n\t\t\tthis.transRes=res;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set segs\n\t\t\tif ($(this.div).width() > 700)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If mobile\n\t\t\t\t$(\"#sui-viewerSide\").width($(this.div).width()*0.5);\t\t\t\t\t\t\t// Halve viewer width\n\t\t\t$(\"#sui-kplayer\").height($(this.div).width()*0.5*0.5625);\t\t\t\t\t\t\t// Set height based on aspect ratio\n\t\t\tthis.DrawTranscriptMenu();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw transcripts header\t\n\t\t\tthis.DrawTransContent();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw the transcipt content\n\t\t});\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// AJAX closure\n\t}\n\n\tDrawTranscriptMenu()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TRANSCRIPT MENU \n\t{\n\t\tvar res=this.transRes;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at res\n\t\tvar str=`<div style='display:inline-block;width:calc(50% - 24px);margin-left:12px;vertical-align:top; min-width:350px;'>\n\t\t<div id='sui-transTab0' class='sui-transTab' title='Options'>&#xe66f&#xe609</div>\n\t\t<div id='sui-transTab1' class='sui-transTab' title='Play/Pause'>&#xe641</div>\n\t\t<div id='sui-transTab2' class='sui-transTab' title='Previous line'>&#xe602</div>\n\t\t<div id='sui-transTab3' class='sui-transTab' title='Same line'>&#xe632</div>\n\t\t<div id='sui-transTab4' class='sui-transTab' title='Next line'>&#xe604</div>\n\t\t<div id='sui-transTab5' class='sui-transTab' style='border:none' title='Search transcript'>&#xe623</div>\n\t\t<div id='sui-transSrc' class='sui-transSrc'>\n\t\t\t\t<div style='display:inline-block;margin:14px 0 0 16px;user-select:none'>\n\t\t\t\t\t<div id='sui-transSrcB' style='display:inline-block;color:#fff;;font-size:20px;cursor:pointer' title='Previous result'>&#xe640</div>\n\t\t\t\t\t<div id='sui-transSrcN' style='display:inline-block;color:#fff;margin:0 16px;font-size:12px;cursor:pointer;vertical-align:4px'>0 of 0</div>\n\t\t\t\t\t<div id='sui-transSrcF' style='display:inline-block;color:#fff;font-size:20px;cursor:pointer' title='Previous result'>&#xe641</div>\n\t\t\t\t\t</div>\n\t\t\t\t<div id='sui-transSrcGo' class='sui-search4' style='float:right;margin:12px 16px 0 0'>&#xe623</div>\n\t\t\t\t<div class='sui-search1' style='float:right;margin-top:12px'>\n\t\t\t\t\t<input type='text' id='sui-transSrcInp' class='sui-search2' placeholder='Search this transcript'>\n\t\t\t\t\t<div id='sui-clear' class='sui-search3'>&#xe610</div>\n\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t<div id='sui-transOps' class='sui-transOps'></div>\n\t\t\t<div id='sui-trans' class='sui-trans'></div>\n\t\t</div>`;\n\t\t$(\"#sui-av\").append(str.replace(/\\t|\\n|\\r/g,\"\"));\n\t\t\n\t\tvar curHit=0,hits=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds search hits\n\n\t\t$(\"#sui-transSrcGo\").on(\"click\", ()=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON SEARCH\n\t\t\tlet i,r,lang;\n\t\t\thits=[]; \tcurHit=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Reset hits\n\t\t\n\t\t\tif ($(\"#sui-transSrcInp\").val()) {\t\t\t\t\t\t\t\t\t\t\t\t\t// If a valid term\n\t\t\t\tr=RegExp($(\"#sui-transSrcInp\").val(),\"i\");\t\t\t\t\t\t\t\t\t\t// Turn into regex\n\t\t\t\tfor (i=0;i<res.segs.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\t\t\tfor (lang in res.languages) \t\t\t\t\t\t\t\t\t\t\t\t// For each language\n\t\t\t\t\t\tif (res.segs[i][lang] && res.segs[i][lang].match(r)) hits.push(i);\t\t// If something there \n\t\t\t\t}\n\t\t\tshow();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show status\n\t\t\t});\n\t\n\t\t$(\"#sui-transSrcInp\").on(\"change\", ()=>{ $(\"#sui-transSrcGo\").trigger(\"click\"); });\t\t// ON TEXT CHANGED\n\t\t$(\"#sui-transSrcB\").on(\"click\",    ()=>{ curHit=Math.max(0,curHit-1); show();\t});\t\t// ON PREVIOUS\n\t\t$(\"#sui-transSrcF\").on(\"click\",    ()=>{ curHit=Math.min(hits.length-1,curHit+1); show(); });\t// ON NEXT\n\t\t\n\t\tfunction show() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW STATUS\n\t\t\tconst sui = this.sui;\n\t\t\tvar t=hits.length ? curHit+1 : 0;\t\t\t\t\t\t\t\t\t\t\t\t\t// Current number\n\t\t\t$(\"#sui-transSrcN\").html(t+\" of \"+hits.length);\t\t\t\t\t\t\t\t\t\t// Set number found\n\t\t\tif (hits.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If somthing\n\t\t\t\tsui.av.curTransSeg=hits[curHit];\t\t\t\t\t\t\t\t\t\t\t\t// Set cur seg\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tsui.av.HighlightSeg(sui.av.curTransSeg,undefined);\t\t\t\t\t\t\t\t// Highlight seg\n\t\t\t\t}\n\t\t\t}\n\n\t\tstr=`<div class='sui-transRow'>Transcript options<span class='sui-transCheck'\n\t\tonclick='$(\"#sui-transOps\").slideToggle()'>&#xe60f</span></div>\n\t\t<div class='sui-transLab'>LANGUAGES</div>`;\n\t\tfor (var lang in res.languages)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add each language found in transcript\n\t\t\tstr+=\"<div class='sui-transRow' id='sui-transLan-\"+lang+\"'>- \"+lang+\"<span id='sui-transLang-\"+lang+\"' class='sui-transCheck' style='color:#58aab4'>&#xe60e</span></div>\";\n\t\tstr+=`<div class='sui-transLab'>SPEAKERS</div>\n\t\t<div class='sui-transRow'>- Tibetan<span id='sui-transS1' class='sui-transCheck' style='color:#58aab4'>&#xe60e</span></div>\t\n\t\t<div class='sui-transLab'>LAYOUTS</div>\n\t\t<div class='sui-transRow' id='sui-transMinR'>- Minimal<span id='sui-transMin' class='sui-transCheck'>&#xe60e</span></div>\n\t\t<div class='sui-transRow' id='sui-transRevR'>- Reversed<span id='sui-transRev' class='sui-transCheck'>&#xe60e</span></div>\n\t\t<div class='sui-transLab'>DOWNLOADS</div>\n\t\t<div class='sui-transRow' id='sui-transStr'->- SRT file<span class='sui-transCheck' style='color:#58aab4'>&#xe616</span></div>`;\n\t\t$(\"#sui-transOps\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\n\n\t\t$(\"#sui-transStr\").on(\"click\",()=> { this.SaveStrFile(); });\t\t\t\t\t\t// ON SAVE SRT FILE\n\n\t\t$(\"[id^=sui-transLan-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t// ON LANGUAGE CLICK\n\t\t\tvar lang=e.currentTarget.id.substring(13);\t\t\t\t\t\t\t\t\t\t// Get language\n\t\t\tres.languages[lang]=1-res.languages[lang];\t\t\t\t\t\t\t\t\t\t// Toggle value\n\t\t\t$(\"#sui-transLang-\"+lang).css(\"color\",(res.languages[lang]) ? \"#58aab4\" : \"#ccc\");\t// Set check color\n\t\t\tthis.DrawTransContent();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\t});\t\t\t\n\n\t\t$(\"#sui-transMinR\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK MINIMAL/NORMAL\n\t\t\tres.layout=(res.layout == \"Minimal\") ? \"Normal\" : \"Minimal\";\t\t\t\t\t// Toggle state\n\t\t\t$(\"#sui-transMin\").css(\"color\",(res.layout == \"Minimal\") ? \"#58aab4\" : \"#ccc\");\t// Set check color\n\t\t\tthis.DrawTransContent();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\t});\t\t\t\n\t\t\n\t\t$(\"#sui-transRevR\").on(\"click\",()=> { \t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK REVERSE\n\t\t\tres.rev=(res.rev) ? 0 : 1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Toggle state\n\t\t\t$(\"#sui-transRev\").css(\"color\",(res.rev) ? \"#58aab4\" : \"#ccc\");\t\t\t\t\t// Set check color\n\t\t\tthis.DrawTransContent();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Redraw\n\t\t\t});\t\t\t\n\t\n\t\t$(\"#sui-transTab0\").on(\"click\",()=>{ $(\"#sui-transOps\").slideToggle(); });\t\t\t// ON OPTIONS MENU CLICK\n\t\t$(\"#sui-transTab5\").on(\"click\",()=>{ $(\"#sui-transSrc\").slideToggle(); });\t\t\t// ON SEARCH MENU CLICK\n\n\t\t$(\"#sui-transTab1\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON PLAY CLICK\n\t\t\tclearInterval(this.transTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\t\tif (this.inPlay) $(\"#sui-kplayer\")[0].sendNotification(\"doPause\");\t\t\t\t// Pause\n\t\t\telse {\n\t\t\t\tthis.PlayAV();\n\t\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPlay\"); // Play\n\t\t\t}\n\t\t\t});\t\t\t\t\t\t\n\n\t\t$(\"#sui-transTab2\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON PLAY PREVIOUS SEG CLICK\n\t\t\tthis.curTransSeg=Math.max(this.curTransSeg-1,0);\t\t\t\t\t\t\t\t// Go back one\n\t\t\tthis.PlayAV(res.segs[this.curTransSeg].start, res.segs[this.curTransSeg].end);\t// Play it\n\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPlay\");\t\t\t\t\t\t\t\t// Start playing\n\t\t\t});\t\t\t\t\t\t\t\n\t\n\t\t$(\"#sui-transTab3\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON PLAY THIS SEG CLICK\n\t\t\tthis.PlayAV(res.segs[this.curTransSeg].start, res.segs[this.curTransSeg].end);\t// Play it\n\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPlay\");\t\t\t\t\t\t\t\t// Start playing\n\t\t\t});\n\t\n\t\t$(\"#sui-transTab4\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON PLAY NEXT SEG CLICK\n\t\t\tthis.curTransSeg=Math.min(this.curTransSeg+1,res.segs.length-1);\t\t\t\t// Go to next one\n\t\t\tthis.PlayAV(res.segs[this.curTransSeg].start,res.segs[this.curTransSeg].end);\t// Play it\n\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPlay\");\t\t\t\t\t\t\t\t// Start playing\n\t\t\t});\n\t}\t\t\t\n\n\tSaveStrFile()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SAVE AS SRT FILE\n\t{\n\t\tvar res=this.transRes;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at res\n\t\tlet lang,i,o,str=\"\";\n\t\tfor (i=0;i<res.segs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\to=res.segs[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\tstr+=`${(i+1)}\\n${o.start},000 --> ${o.end},000\\n${o.speaker ? \">> \"+o.speaker+ \"\\n\" : \"\"}`;\n\t\t\tfor (lang in res.languages) { \t\t\t\t\t\t\t\t\t\t\t\t\t// For each language\n\t\t\t\tif (res.segs[i][lang] && res.languages[lang]) \t\t\t\t\t\t\t\t// If something there and checked\n\t\t\t\t\tstr+=res.segs[i][lang]+\"\\n\";\t\t\t\t\t\t\t\t\t\t\t// Add transcription\t\n\t\t\t\t}\n\t\t\tstr+=\"\\n\";\n\t\t\t}\n\t\tvar element = document.createElement('a');\n\t\telement.setAttribute('href','data:text/plain;charset=utf-8,'+encodeURIComponent(str));\n\t\telement.setAttribute('download', \"transcript-\"+this.kmap.id+\".str\");\n\t\telement.style.display = 'none';\n\t\tdocument.body.appendChild(element);\n\t\telement.click();\n\t\tdocument.body.removeChild(element);\n\t}\n\n\tDrawTransContent()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TRANSCRIPT CONTENT IN WINDOW\n\t{\n\t\tvar i,lang,str=\"\";\n\t\tconst _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Context\n\t\tvar res=this.transRes;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at res\n\t\tif (res.layout == \"Minimal\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Drawing minimal layput\n\t\t\tfor (i=0;i<res.segs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\t\tstr+=`<div class='sui-transMinSeg' id='sui-transMinSeg-${i}'>\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t<div style='float:${(res.rev) ? \"right\" : \"left\"};font-size:18px;'>\n\t\t\t\t${(res.segs[i].speaker) ? res.segs[i].speaker+\"<br>\" : \"\"}\n\t\t\t\t<div class='sui-transMinPlay' id='sui-transPlay-${i}' title='Play line ${this.SecondsToTimecode(res.segs[i].start)}'>&#xe680</div> \n\t\t\t\t</div>\n\t\t\t\t<div class='sui-transMinBox' id='sui-transMinBox-${i}'\n\t\t\t\tstyle='margin:${(res.rev) ? \"0 150px 0 0\" : \"0  0 0 150px\"}'>`;\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tfor (lang in res.languages)  \t\t\t\t\t\t\t\t\t\t\t\t\t// For each language\n\t\t\t\t\tif (res.segs[i][lang] && res.languages[lang])\t\t\t\t\t\t\t\t// If something there and checked\n\t\t\t\t\t\tstr+=res.segs[i][lang]+\"<hr style='margin:0;border-top:1px dashed #eee'>\";\t// Add transcription and dividing line\t\n\t\t\t\tstr+=\"</div></div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close box and seg\n\t\t\t\t}\n\t\t\t}\n\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Normal\n\t\t\tfor (i=0;i<res.segs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\t\tstr+=`<div class='sui-transSeg' id='sui-transSeg-${i}'>\n\t\t\t\t<div style='float:${(res.rev) ? \"right\" : \"left\"};font-size:18px;'>\n\t\t\t\t${(res.segs[i].speaker) ? res.segs[i].speaker+\"<br>\" : \"\"}\n\t\t\t\t<div class='sui-transPlay' id='sui-transPlay-${i}' \n\t\t\t\ttitle='Play line'>&#xe680\n\t\t\t\t<span style='margin-left:24px;font-size:12px;vertical-align:4px'>\n\t\t\t\t${this.SecondsToTimecode(res.segs[i].start)}</span></div></div> \n\t\t\t\t<div class='sui-transBox' id='sui-transBox-${i}'\n\t\t\t\tstyle='margin:${(res.rev) ? \"0 150px 0 0\" : \"0  0 0 150px\"}'>`;\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tfor (lang in res.languages)  \t\t\t\t\t\t\t\t\t\t\t\t\t// For each language\n\t\t\t\t\tif (res.segs[i][lang] && res.languages[lang])\t\t\t\t\t\t\t\t// If something there and checked\n\t\t\t\t\t\tstr+=res.segs[i][lang]+\"<hr style='margin:0;border-top:1px dashed #eee'>\";\t// Add transcription and dividing line\t\n\t\t\t\tstr+=\"</div></div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close box and seg\n\t\t\t\t}\n\t\t\t}\n\t\t$(\"#sui-trans\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t// Add transcript to div\n\t\t\n\t\t$(\"#sui-trans\").on(\"mousedown\", ()=> {  this.mouseDown=true;  });\t\t\t\t\t\t// Set scrolling flag\n\t\t$(\"#sui-trans\").on(\"mouseup\",   ()=> {  this.mouseDown=false; });\t\t\t\t\t\t// Unset flag\n\t\t$(\"#sui-trans\").on(\"scroll\", function() { \t\t\t\t\t\t\t\t\t\t\t\t// On scroll event\n\t\t\t_this.handScroll=true;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Inhibit auto scrolling\n\t\t\tif (_this.mouseDown)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if mouse is still down\n\t\t\tclearTimeout($.data(this,'scrollTimer'));\n\t\t\t$.data(this,'scrollTimer', setTimeout(function() {\n\t\t\t\t_this.handScroll=false; }, 250));\n\t\t\t});\n\n\t\t$(\"[id^=sui-transPlay-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON PLAY CLICK\n\t\t\tthis.curTransSeg=e.currentTarget.id.substring(14);\t\t\t\t\t\t\t\t\t// Get index of seg\t\n\t\t\tthis.PlayAV(res.segs[this.curTransSeg].start,res.segs[this.curTransSeg].end);\t\t// Play seg\n\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPlay\");\t\t\t\t\t\t\t\t\t// Start playing\n\t\t\t});\n\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\n\tPlayAV(start, end)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// PLAY TRANSCRIPT SEGMENT\n\t{\n\t\tvar i;\n\t\tvar res=this.transRes;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at res\n\t\tclearInterval(this.transTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\tthis.scrollStart=$(\"#sui-trans\").scrollTop();\t\t\t\t\t\t\t\t\t\t\t// Scroll\n\t\tif (start != undefined)\t$(\"#sui-kplayer\")[0].sendNotification(\"doSeek\",start);\t\t\t// Seek to start\n\t\tif (end)\t\t\t\tthis.playEnd=end;\t\t\t\t\t\t\t\t\t\t\t\t// Set ending point \n\t\tthis.transTimer=setInterval((e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set interval and handler\n\t\t\tvar now=$(\"#sui-kplayer\")[0].evaluate(\"{video.player.currentTime}\");\t\t\t\t// Get current player time\n\t\t\tif ((this.playEnd) && (now >= this.playEnd)) {\t\t\t\t\t\t\t\t\t\t// An end set and past it\n\t\t\t\tclearInterval(this.transTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\t\t\t$(\"#sui-kplayer\")[0].sendNotification(\"doPause\");\t\t\t\t\t\t\t\t// Pause video\n\t\t\t\tthis.playEnd=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear end\n\t\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t\t}\n\t\t\tfor (i=0;i<res.segs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each seg\n\t\t\t\tif ((now >= res.segs[i].start) && (now < res.segs[i].end)) {\t\t\t\t\t// In this one\n\t\t\t\t\tthis.curTransSeg=i;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set as current\n\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit looking\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tif (this.curTransSeg > 0) this.HighlightSeg(this.curTransSeg,start);\t\t\t\t// Highlight seg if note prelude\n\t\t\t},100);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Time ~10fps\n\t}\t\t\n\n\tHighlightSeg(num, start)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// HIGHLIGHT A SEGMENT\n\t{\n\t\tlet t=$(`#sui-trans${this.transRes.layout == \"Minimal\" ? \"Min\" : \"\"}Seg-${num}`).position().top-$(`#sui-trans${this.transRes.layout == \"Minimal\" ? \"Min\" : \"\"}Seg-0`).position().top;\t// Get offset to top seg\n\t\tif (this.handScroll)\tstart=1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Inhibit transcript autoscrolling while manually scrolling\n\t\tif (start == undefined)\t $(\"#sui-trans\").scrollTop(t-this.scrollStart);\t\t\t\t\t// Scroll to position if not playing a particular seg\n\t\t$(\"[id^=sui-transSeg-]\").css(\"background-color\",\"#ddd\");\t\t\t\t\t\t\t\t// All backgrounds off\n\t\t$(\"[id^=sui-transMinSeg-]\").css(\"border-color\",\"#fff\");\t\t\t\t\t\t\t\t\t// All borders off\n\t\t$(\"[id^=sui-transMinSeg-]\").css(\"background-color\",\"#fff\");\t\t\t\t\t\t\t\t// All backgrounds off\n\t\t$(\"#sui-transMinSeg-\"+num).css(\"border-color\",\"#999\");\t\t\t\t\t\t\t\t\t// Hilite active one\n\t\t$(\"#sui-transMinSeg-\"+num).css(\"background-color\",\"#eee\");\t\t\t\t\t\t\t\t// Hilite active one\n\t\t$(\"#sui-transSeg-\"+num).css(\"background-color\",\"#aaa\");\t\t\t\t\t\t\t\t\t// Hilite active one\n\t}\n\n////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// HELPER FUNCTIONS \n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\tTimecodeToSeconds(timecode) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONVERT TIMECODE TO SECONDS\n\t{\n\t\tvar h = 0, m = 0;\n\t\tvar v = (\"\" + timecode).split(\":\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Split by colons\n\t\tvar s = v[0];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add them\n\t\tif (v.length == 2) {\n\t\t\t// Just minutes, seconds\n\t\t\ts = v[1];\n\t\t\tm = v[0];\n\t}// Add them\n\t\telse if (v.length == 3) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hours, minutes, seconds\n\t\t\ts = v[2];\n\t\t\tm = v[1];\n\t\t\th = v[0];\n\t\t\t// Add them\n\t\t}\n\t\treturn(Number(h*3600)+Number(m*60)+Number(s));\t\t\t\t\t\t\t\t\t\t\t// Convert\n\t}\n\t\n\tSecondsToTimecode(secs) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONVERT SECONDS TO TIMECODE\n\t{\n\t\tvar str=\"\",n;\n\t\tn=Math.floor(secs/3600);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get hours\n\t\tif (n) str+=n+\":\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to tc\n\t\tn=Math.floor(secs/60);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get mins\n\t\tif (n < 10) str+=\"0\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add leading 0\n\t\tstr+=n+\":\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to tc\n\t\tn=Math.floor(secs%60);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get secs\n\t\tif (n < 10) str+=\"0\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add leading 0\n\t\tstr+=n;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to tc\n\t//\tstr+=\".\"+Math.round((secs-Math.floor(secs))*10);\t\t\t\t\t\t\t\t\t\t// Add fractional\n\t\treturn str;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return timecode\t\t\t\n\t}\n\t\n} // AudioVideo class closure\n","/* \tSUBJECTS PAGES ****************************************************************************************************************************\n\n\tThis module draws the subjects page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the child data in the Terms index. \n\t\n\tThe related resources menu is drawn, which pulls data via another SOLR call. If an image is present\n\tit is drawn there. Below that is a browsable index of subjects. Clicking on one will bring up that page.\n\t\n\tA tabbed menu shows the CONTEXT, where the page fits in the tree. Clicking on one will bring up that page.\n\tYou can drill down further in the tree by clicking on a '+' dot or collapse branches with th '-'. The SUMMARY,\n\twhich lists the related subjects to this page, catagorized by their type and alpabetically sorted. \tClicking \n\ton one will bring up that page. Hovering over a blue popover icon will show more information about it.\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tLooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n*********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\n\nexport default class Subjects  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\n\t\tthis.sui=sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t\tthis.content=[\"...loading\",\"...loading\"];\t\t\t\t\t\t\t\t\t\t\t\t// Content pages for relateds\n\t\tthis.content2=[\"<br>\",\"<br>\"];\n\t\tthis.kmap=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds kmap\n\t\tthis.relatedPlaceData=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds related places\n\t\tthis.relatedSubjectData=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds related subjects\n\t}\n\n\t// CALLS this.GetSubjectData(),\n\t// CALLS this.DrawContent()\n\t// CALLS sui.pages.DrawRelatedAssets();\n\t// ACCESSES this.sui\n\t// SIDE-EFFECT sets this.kmap\n\tDraw(o, related)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW SOURCE PAGE FROM KMAP\n\t{\n\t\tconsole.error(\"subjects.Draw() called \");\n\t\tconsole.dir(arguments);\n\n\t\tconst sui = this.sui;\n\t\tthis.kmap=o;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save kmap\n\t\t$(\"#sui-legacy\").css({ \"padding-left\":\"12px\", width:\"calc(100% - 24px\"});\t\t\t\t// Reset to normal size\n\t\tthis.GetSubjectData(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get related subjects content\t\n\t\tthis.DrawContent(o,related);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw content\n\t\tsui.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu\n\t}\n\n\t// USES this.sui (sui.assets)\n\t// CALLS this.ShowTab()\n\t// CALLS sui.pages.DrawTabMenu()\n\t// CALLS this.GetPlaceData(o)\n\t// OUTPUT this.div\n\tDrawContent(o, related)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW CONTENT\n\t{\n\t\tconst sui = this.sui;\n\t\tlet str = `<div class='sui-subjects' id='sui-subConDiv'>\n\t\t<div><span class='sui-subIcon'>${sui.assets[o.asset_type].g}</span>\n\t\t<span class='sui-subText'>${o.title[0]}</span>\n\t\t<hr style='border-top: 1px solid ${sui.assets[o.asset_type].c}'>`;\n\t\tif (o.caption) {\n\t\t\tstr += \"<p id='sui-spCap'>\" + o.caption + \"</p></div>\";\n\t\t}\n\t\tif (related == 1) {\n\t\t\tstr = \"<div style='margin-left:192px'>\"\n\t\t\t\t+ sui.pages.DrawTabMenu([\"SUBJECT CONTEXT\", \"RELATED SUBJECTS\"]);\n\t\t} \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If subjects, add tab menu\n\t\telse if (related == 2) {\n\t\t\tstr = \"<div id='sui-topCon' style='margin-left:216px'>\"\n\t\t\t\t+ this.GetPlaceData(o);\n\t\t} \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If places, get data\n\n\t\t// OUTPUT\n\t\t$(this.div).html(str + \"</div>\".replace(/\\t|\\n|\\r/g, \"\"));\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\t// HANDLERS\n\t\t$(\"[id^=sui-tabTab]\").on(\"click\", (e) => {\t\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\tvar id = e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t\t// Get index of tab\n\t\t\tthis.ShowTab(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t});\n\t}\n\n\tShowTab(which) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW TAB\n\t{\n\t\tlet _this=this;\n\t\t$(\"[id^=sui-spLab-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t$(\"[id^=sui-spDot-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t$(\"[id^=sui-spItem-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t$(\"[id^=sui-togCat-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t$(\"[id^=sui-spCatUL-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t$(\"[id^=sui-tabTab]\").css({\"background-color\":\"#999\",color:\"#fff\" });\t\t\t\t\t// Reset all tabs\n\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t\t// Show content\n\t\t$(\"#sui-tabTab\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\t$(\"#sui-tabContent\").html(this.content[which]);\t\t\t\t\t\t\t\t\t\t\t// Set content\n\t\tif (which == 0)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If SUBJECT CONTEXT\n\t\t\t$(\"#sui-spLab-\"+this.kmap.uid).css({ \"font-weight\":\"bold\", \"text-decoration\": \"underline\"  });\t// Highlight current one\n\t\t\t$(\"[id^=sui-spLab-]\").on(\"click\", function(e) {return false;\t});\t\t\t\t\t// ON CONTEXT LINE CLICK, INHIBIT\n\t\t\t$(\"[id^=sui-spDot-]\").on(\"click\", function(e) {\t\t\t\t\t\t\t\t\t\t// ON RELATIONSHIP TREE DOT CLICK\n\t\t\t\tlet path=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif (path != \"null\") sui.pages.AddRelBranch(_this.kmap.asset_type,path,$(this));\t// Lazy load branch\n\t\t\t\t$(this).html(\"&ndash;\"); \t\t\t\t\t\t\t\t\t\t\t\t\t\t// Change label\n\t\t\t\t$(this).parent().find('ul').slideToggle();            \t\t\t\t\t\t\t// Slide into place\n\t\t\t\t});\n\t\t\t}\n\t\telse if (which == 1) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If RELATED SUBJECTS\n\t\t\t$(\"[id^=sui-spItem-]\").on(\"click\", function(e) {return false;\t});\t\t\t\t\t// ON CONTEXT LINE CLICK, INHIBIT\n\t\t\t$(\"[id^=sui-spCatUL-]\").slideDown();\t\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t$(\"[id^=sui-spCat-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON CATEGORY CLICK\n\t\t\t\tlet id=e.currentTarget.id.substring(9);\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif ($(\"#sui-spCatUL\"+id).css(\"display\") == \"none\")\t\t\t\t\t\t\t\t// If hidden\n\t\t\t\t\t$(\"#sui-spCatUL\"+id).slideDown();\t\t\t\t\t\t\t\t\t\t\t// Show\n\t\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If showing\n\t\t\t\t\t$(\"#sui-spCatUL\"+id).slideUp();\t\t\t\t\t\t\t\t\t\t\t\t// Hide\n\t\t\t\t});\n\n\t\t\t$(\"#sui-togCatA\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON EXPAND ALL\n\t\t\t\t$(\"[id^=sui-spCatUL-]\").slideDown();\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t\t});\n\t\t\t$(\"#sui-togCatN\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLAPSE ALL\n\t\t\t\t$(\"[id^=sui-spCatUL-]\").slideUp();\t\t\t\t\t\t\t\t\t\t\t\t// All down\n\t\t\t\t});\n\t\t\t}\n\t}\n\n\tGetPlaceData(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET RELATED PLACES\n\t{\n\t\tsui.GetRelatedPlaces(o.uid, (d)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get related place data\n\t\t\tthis.relatedPlaceData=d;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save data\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\tthis.DrawRelatedPlaces(\"tree\",1);\t\t\t\t\t\t\t\t\t\t\t\t\t// Display related places\n\t\t\t});\t\n\t\treturn \"Loading...\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Say we're loading...\n\t}\t\n\t\t\t\n\n\n\tDrawRelatedPlaces(mode, sortMode)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RELATED PLACES\n\t{\t\t\t\n\t\tlet i,j,id,tops=[];\n\t\tlet d=this.relatedPlaceData;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at realte placev data\n\t\tlet o=this.kmap;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at kmap\n\t\tlet str=`<br><div class='sui-spHead'>Places related to ${o.title}</div>\n\t\t<p style='color:#666'>\n\t\t<input id='sui-rpSearch' placeholder='&nbsp;Search places' \n\t\tstyle='width:100px;border:1px solid #999;border-radius:12px;padding-left:8px'> &nbsp;\n\t\t<span class='sui-advEditBut' style='color:${mode == \"tree\" ? \"#668eec\" : \"#666\"}' \n\t\tid='sui-rpTree' title='Tree view'>&#xe638</span> | \n\t\t<span class='sui-advEditBut' style='color:${mode != \"tree\" ? \"#668eec\" : \"#666\"}'\n\t\tid='sui-rpList' title='List view'>&#xe61f</span>`;\n\t\tif (mode != \"tree\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If drawing as a list\n\t\t\tj=$(\"#sui-footer\").offset().top-$(\"#sui-legacy\").offset().top-150;\t\t\t\t\t// Fill space\n\t\t\tstr+=` | <span class='sui-advEditBut' id='sui-rpSort' title='Sort'>\n\t\t\t${(sortMode == 1) ? \"&#xe653\" : \"&#xe652\"}</span>\t\t\n\t\t\t</p><div class='sui-rpList' style='height:${j}px'>`;\t\t\t\t\t\t\t\t// Add container\t\t\t\n\t\t\td=d.sort((a,b)=>{ return a.title < b.title ? -sortMode : sortMode })\t\t\t\t// Sort by title acending\n\t\t\tfor (i=0;i<d.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each related place\n\t\t\t\tstr+=`<div id='sui-rpLine-${i}' style='width:300px' title='${d[i].ancestors_txt.join(\"/\")}'>${d[i].title}</div>`; \t// Add line\n\t\t\t\t}\n\n\t\t\t// OUTPUT TO SUI-TOPCON\n\t\t\t$(\"#sui-topCon\").html(str+\"</div>\");\t\t\t\t\t\t\t\t\t\t\t\t// Draw as list\n\n\n\t\t\t// HANDLERS\n\t\t\t$(\"#sui-rpTree\").on(\"click\", ()=> {\n\t\t\t\tthis.DrawRelatedPlaces(\"tree\",sortMode);\n\t\t\t});\t// HANDLE TREE CLICK\n\t\t\t$(\"#sui-rpSort\").on(\"click\", ()=> {\n\t\t\t\tthis.DrawRelatedPlaces(\"list\",sortMode*-1);\n\t\t\t});\t// HANDLE SORT\n\t\t\t$(\"#sui-rpSearch\").on(\"keydown\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON SEARCH\n\t\t\t\tlet line;\n\t\t\t\tlet r=$(\"#sui-rpSearch\").val();\t\t\t\t\t\t\t\t\t\t\t\t\t// Get filter text\n\t\t\t\tif ((e.keyCode > 31) && (e.keyCode < 91)) \t {\n\t\t\t\t\tr+=e.key;\n\t\t\t\t}\t\t\t\t\t\t\t// Add current key if a-Z\n\t\t\t\tif ((e.keyCode == 8) && r.length) {\t\t\tr=r.slice(0,-1);\t}\t\t\t\t// Remove last char on backspace\n\t\t\t\tr=RegExp(r,\"i\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Turn into regex\n\t\t\t\tfor (i=0;i<d.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tline = $(\"#sui-rpLine-\" + i);\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at line\n\t\t\t\t\tif (line.text().match(r)) {\n\t\t\t\t\t\tline.css(\"display\", \"block\");\t\t\t\t\t// Show item if it matches\n\t\t\t\t\t} else {\n\t\t\t\t\t\tline.css(\"display\", \"none\");\t\t\t\t\t\t// Hide\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t}\n\t\tstr+=` | <span class='sui-advEditBut' style='vertical-align:0' \n\t\tid='sui-togCatA' title='Expand all'<b>&#x2295</b></span> | \n\t\t<span class='sui-advEditBut' style='vertical-align:0'\n\t\tid='sui-togCatN' title='Collapse all'><b>&#x2296</b></span> \n\t\t</p><div style='width:100%'><div style='display:inline-block'>\n\t\t<ul style='list-style-type:none;margin-left:-24px'>`;\t\t\t\t\t\t\t\t\t// Top-most <ul>\n\t\tlet n=d.length;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Number of places\n\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each related place\t\n\t\t\tid=\"places-\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start id\n\t\t\tfor (j=0;j<d[i].ancestor_ids_is.length;++j) {\t\t\t\t\t\t\t\t\t\t// For each level\t\n\t\t\t\tid+=d[i].ancestor_ids_is[j]+\"-\";\t\t\t\t\t\t\t\t\t\t\t\t// Add levels\n\t\t\t\ttops.push({ lab:d[i].ancestors_txt[j], level:j, id:id.slice(0,-1), uid:\"places-\"+d[i].ancestor_ids_is[j]});\t\t// Add to list\n\t\t\t\ttops[tops.length-1].parent=id.split(\"-\").slice(0,-2).pop();\t\t\t\t\t\t// Add parent\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\ttops=tops.sort((a,b)=>{ return a.id < b.id ? -1 : 1 })\t\t\t\t\t\t\t\t\t// Sort by path\n\t\ti=tops[tops.length-1];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save last\n\t\ttops=tops.filter((a,ind)=>{ try { return a.id != tops[ind+1].id } catch(e){} })\t\t\t// Only uniques\n\t\ttops.push(i);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it back\n\t\tn=tops.length;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// New n\n\t\tfor (i=0;i<n;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For place\t\n\t\t\tif (tops[i].level == 0) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add top row\n\t\t\t\tstr+=addTreeLine(tops[i].lab,tops[i].id,tops[i].id,\"&ndash;\");\t\t\t\t\t// Add tree line\n\n\t\t$(\"#sui-topCon\").html(str+\"</ul></div>\");\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\n\t\t$(\"#sui-rpList\").on(\"click\", ()=> {\tthis.DrawRelatedPlaces(\"list\",sortMode); });\t\t// HANDLE LIST CLICK\n\t\t$(\"#sui-rpSearch\").on(\"keyup\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// HANDLE SEARCH WORD ENTRY\n\t\t\tlet t=$(\"#sui-rpSearch\").val();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get value entered\n\t\t\tthis.DrawRelatedPlaces(\"list\",sortMode); \t\t\t\t\t\t\t\t\t\t\t// Draw as list\t\t\t\t\t\t\t\t\t\t\n\t\t\t$(\"#sui-rpSearch\").val(t);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Restore value\n\t\t\t$(\"#sui-rpSearch\").focus();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set focus\n\t\t\t$(\"#sui-rpSearch\").trigger(\"keydown\",{ keyCode:13 });\t\t\t\t\t\t\t\t// Filter matches\n\t\t\t});\n\n\t\tfor (i=0;i<n;++i) tops[i].n=countChildren(tops[i].id);\t\t\t\t\t\t\t\t\t// For each place, count children\n\t\tfor (i=0;i<n;++i) if (tops[i].level == 0) addChildren(tops[i].id,1);\t\t\t\t\t// For each place, add top row children and recurse\n\t\n\t\t$('#sui-topCon').find('li').each(function() { \t\t\t\t\t\t\t\t\t\t\t// For each line\n\t\t\tj=$(this).parent().find('li').find('b').length;\t\t\t\t\t\t\t\t\t\t// Get count\n\t\t\tif (j && !$(this).find('b').length)\t\t\t\t\t\t\t\t\t\t\t\t\t// If something\n\t\t\t\t$(this).find('img').before(\"(\"+j/2+\") \"); \t\t\t\t\t\t\t\t\t\t// Add it before popover\n\t\t\t});\n\t\n\t\tfunction countChildren(id) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// COUNT NODE'S CHILDREN\n\t\t\tlet i,num=0;\n\t\t\tid=id.split(\"-\").pop();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get last id\n\t\t\tfor (i=0;i<n;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each place\t\n\t\t\t\tif (tops[i].parent == id)\t++num;\t\t\t\t\t\t\t\t\t\t\t\t// Has them\n\t\t\treturn num;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return count\n\t\t\t}\n\n\t\tfunction addChildren(id, level) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD CHILDREN TO NODE RECURSIVELY\n\t\t\tlet i,marker,str=\"\";\n\t\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each place\n\t\t\t\tif (tops[i].id.match(id) && (tops[i].level == level)) {\t\t\t\t\t\t\t// A child\n\t\t\t\t\tmarker=tops[i].n > 0 ? \"+\" : \"&bull;\";\t\t\t\t\t\t\t\t\t\t// Set marker type\n\t\t\t\t\tstr=\"<ul style='list-style-type:none;display:none;padding:2px 0 0 24px'>\";\t// Enclosing <ul> if not a loner\n\t\t\t\t\tstr+=addTreeLine(tops[i].lab,tops[i].id,tops[i].uid,marker);\t\t\t\t// Add tree line\n\t\t\t\t\tstr+=\"</ul>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close <ul>\n\t\t\t\t\t$(\"#sui-rpDot-\"+id).parent().parent().append(str);\t\t\t\t\t\t\t// Add it\n\t\t\t\t\taddChildren(tops[i].id,level+1);\t\t\t\t\t\t\t\t\t\t\t// Recurse\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\tfunction addTreeLine(lab, id, uid, marker) {\t\t\t\t\t\t\t\t\t\t\t// ADD LINE TO TREE\n\t\t\tlet s=`<li>`;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\tif (marker != \"&bull;\")\ts+=`<div class='sui-spDot' id='sui-rpDot-${id}'>${marker}</div>`;\t\t// If a dot, add it\n\t\t\telse\t\t\t\t\ts+=`<div class='sui-spDot' id='sui-rpDot-${id}' style='display:none;color:#5b66cb'><b>&bull;</div>&bull;&nbsp;&nbsp;`;\t// If a loner\n\t\t\ts+=`<a class='sui-noA' href='#p=${uid}'>${lab}</b>${sui.pages.AddPop(uid)}</a>`;\t// Add line\n\t\t\treturn s;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return line\n\t\t\t}\n\t\t\n\t\t$(\"[id^=sui-rpDot-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill old handlers\n\t\t$(\"[id^=sui-rpDot-]\").on(\"click\", function(e) {\t\t\t\t\t\t\t\t\t\t\t// ON RELATIONSHIP TREE DOT CLICK\n\t\t\tlet container=$(this).parent().parent();\t\t\t\t\t\t\t\t\t\t\t// Point a container\n\t\t\tlet c=$(this).html();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get char\n\t\t\t$(this).html(c == \"+\" ? \"&ndash;\" : \"+\"); \t\t\t\t\t\t\t\t\t\t\t// Toggle label\n\t\t\t$(container).children('ul').slideToggle();            \t\t\t\t\t\t\t\t// Slide into place\n\t\t\t});\n\n\t\t$(\"#sui-togCatA\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON EXPAND ALL\n\t\t\tlet i,container;\n\t\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each place\t\n\t\t\t\tcontainer=$(\"#sui-rpDot-\"+tops[i].id).parent();\t\t\t\t\t\t\t\t\t// Point a container\n\t\t\t\t$(\"#sui-rpDot-\"+tops[i].id).html(\"&ndash;\");\t\t\t\t\t\t\t\t\t// If not a loner, change label\n\t\t\t\tcontainer.parent().css(\"display\",\"block\");\t\t\t\t\t\t\t\t\t\t// Show\tparent ul\n\t\t\t\tcontainer.css(\"display\",\"block\");\t\t\t\t\t\t\t\t\t\t\t\t// Show\t\n\t\t\t\t}\n\t\t\t});\n\n\t\t$(\"#sui-togCatN\").on(\"click\", ()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLAPSE, INIT TO STARTING STATE\n\t\t\tlet i,p;\n\t\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each place\t\n\t\t\t\tp=$(\"#sui-rpDot-\"+tops[i].id);\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at dot\n\t\t\t\tif (p.html() != \"&bull;\")\tp.html(\"+\"); \t\t\t\t\t\t\t\t\t\t// Change label\n\t\t\t\tp.parent().parent().css(\"display\",\"none\");\t\t\t\t\t\t\t\t\t\t// Hide\t\n\t\t\t\tif (tops[i].level < 3) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If 2nd level\n\t\t\t\t\tif (tops[i].level < 2) p.html(\"&ndash;\" ); \t\t\t\t\t\t\t\t\t// Change label is past 1st rows\n\t\t\t\t\tp.parent().parent().css(\"display\",\"block\");\t\t\t\t\t\t\t\t\t// Show\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t$(\"#sui-togCatN\").trigger(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Collapse to starting point\n\t}\n\n\n\n\n\t//  LOOK THIS OVER CAREFULLY!\n\tGetSubjectData(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET TAB DATA FOR CONTEXT\n\t{\n\t\tconst sui = this.sui;\n\t\tsui.GetRelatedFromID(o.uid, (data) => { \t\t\t\t\t\t\t\t\t\t\t\t\t// Load data\n\t\t\tlet d, i, k = 0, str = \"<table>\";\n\t\t\tif (!data) return;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if no data\n\t\t\tthis.relatedSubjectData = data;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save subject data\n\n\t\t\t// THIS SHOULDN'T BE HAPPENING AND CERTAINLY NOT HERE\n\t\t\t// if (data[0].illustration_external_url && data[0].illustration_external_url[0]) { // If an image spec'd\n\t\t\t// \t$(\"#sui-relatedImg\").addClass(\"sui-relatedImg\");\t\t\t\t\t\t\t\t// Set style\n\t\t\t// \t$(\"#sui-relatedImg\").prop(\"src\", data[0].illustration_external_url[0]);\t\t\t// Show it\n\t\t\t// } else if (data[0].illustration_mms_url && data[0].illustration_mms_url[0]) {\t\t\t// If an image spec'd\n\t\t\t// \t$(\"#sui-relatedImg\").addClass(\"sui-relatedImg\");\t\t\t\t\t\t\t\t// Set style\n\t\t\t// \t$(\"#sui-relatedImg\").prop(\"src\", data[0].illustration_mms_url[0]);\t\t\t\t// Show it\n\t\t\t// }\n\n\t\t\tif (data[0].summary_eng && data[0].summary_eng[0]) \t\t\t\t\t\t\t\t\t// If an summary spec'd\n\t\t\t\t$(\"#sui-spCap\").html(data[0].summary_eng[0]);\t\t\t\t\t\t\t\t\t\t// Replace caption\n\t\t\tif (o.names_txt && o.names_txt.length) {\t\t\t\t\t\t\t\t\t\t\t// If names\n\t\t\t\tfor (i = 0; i < o.names_txt.length; ++i) \t\t\t\t\t\t\t\t\t\t\t\t// For each name\n\t\t\t\t\tif (o.names_txt[i].match(/lang=\"bo\"/i))\t\t\t\t\t\t\t\t\t\t// Language id - bo\n\t\t\t\t\t\tstr += \"<tr><td style='color:#000099;font-size:20px'><b>\" + o.names_txt[i] + \"</b>&nbsp;&nbsp;&nbsp;</td><td span='2'><i>Dzongkha, Tibetan script, Original</i></td></tr>\";\t// Add it\n\t\t\t}\n\t\t\tfor (i = 0; i < data.length; ++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each doc\n\t\t\t\td = data[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\tif (d.block_child_type != \"related_names\") continue;\t\t\t\t\t\t\t// Not a name\n\t\t\t\tif (!k) d.related_names_level_i = 0;\n\t\t\t\tstr += `<tr><td style='padding-left:${d.related_names_level_i * 16}px'>\n\t\t\t\t${k++ ? \">&nbsp;\" : \"\"}\n\t\t\t\t<b>${d.related_names_header_s}&nbsp;&nbsp;&nbsp;</b></td><td>\n\t\t\t\t<i>${d.related_names_language_s}, ${d.related_names_writing_system_s}, ${d.related_names_relationship_s}\n\t\t\t\t</i></td></tr>`;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it\n\t\t\t}\n\t\t\tstr += \"</table><br>\";\n\t\t\t$(\"#sui-subConDiv\").append(str.replace(/\\t|\\n|\\r/g, \"\"));\t\t\t\t\t\t\t// Remove format and add to div\n\t\t\tthis.AddRelatedSubjects(o, data);\t\t\t\t\t\t\t\t\t\t\t\t\t// Add related subjects html\n\t\t\tthis.AddSubjectContext(o, data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add context html\n\t\t});\n\t}\n\n\tAddRelatedSubjects(o,c)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD RELATED SUBJECTS TAB CONTENTS \t\n\t{\t\n\t\tlet f,i,subs=0,s=[];\n\t\tlet n=c.length;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get number of subjects\n\t\tfor (i=0;i<n;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each subject get data as 's=[category[{title,id}]]' \n\t\t\tif (c[i].block_child_type != \"related_subjects\") continue;\t\t\t\t\t\t\t// Add only related subjects\n\t\t\tif (!s[c[i].related_subjects_relation_label_s])\t\t\t\t\t\t\t\t\t\t// If first one of this category \n\t\t\t\ts[c[i].related_subjects_relation_label_s]=[];\t\t\t\t\t\t\t\t\t// Alloc category array\n\t\t\ts[c[i].related_subjects_relation_label_s].push({\t\t\t\t\t\t\t\t\t// Add subject to category \n\t\t\t\ttitle:c[i].related_subjects_header_s,\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\t\t\tid:c[i].related_uid_s });\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add id\n\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\n\t\tlet biggest=Object.keys(s).sort((a,b)=>{return a.length > b.length ? -1 : 1;})[0];\t\t// Find category with most elements\t \n\t\tlet str=`<br><div class='sui-spHead'>Subjects related to ${o.title}</div>\n\t\t<div style='max-width:900px'>\n\t\t${o.title[0]}</b> has <b>~|~</b> other subject${(n > 1) ? \"s\": \"\"} directly related to it, which is presented here. \n\t\tSee the SUBJECT CONTEXT tab if you instead prefer to browse all subordinate and superordinate categories for ${o.title[0]}.</div>\n\t\t<p><a class='sui-advEditBut' id='sui-togCatA'>Expand all</a> / <a class='sui-advEditBut' id='sui-togCatN'>Collapse all</a>\n\t\t</p><div style='width:100%'><div style='width:50%;display:inline-block'>`;\n\t\tstr+=drawCat(biggest)+\"</div><div style='display:inline-block;width:50%;vertical-align:top'>\";\t// Add biggest to 1st column, set up 2nd\t \n\t\tfor (f in s) if (f != biggest)\tstr+=drawCat(f);\t\t\t\t\t\t\t\t\t\t// For each other category, draw it in 2nd column\n\t\tstr+=\"</div></div>\";\n\t\tstr=str.replace(/~\\|~/,subs);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set subjects count\n\t\tthis.content[1]=str;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set tab\n\n\t\tfunction drawCat(f) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW CATEGORY\n\t\t\tif (!s || !s[f]) return \"</ul>\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Bad data \n\t\t\ts[f]=s[f].sort((a,b)=>{ return a.title < b.title ? -1 : 1;});\t\t\t\t\t\t// Sort\n\t\t\tlet str=\"<div id='sui-spCat-\"+f.replace(/ /g,\"_\")+\"' class='sui-spCat'>\"+o.title+\" \"+f+\"</div><ul id='sui-spCatUL-\"+f.replace(/ /g,\"_\")+\"' style='display:none'>\";// Add category header\n\t\t\tfor (i=0;i<s[f].length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tstr+=\"<li><a class='sui-noA' id='sui-spItem-\"+s[f][i].id;\t\t\t\t\t\t// Line\n\t\t\t\tstr+=\"' href='#p=\"+s[f][i].id+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Href\n\t\t\t\tstr+=s[f][i].title+\"</a>\"+sui.pages.AddPop(s[f][i].id)+\"</li>\";\t\t\t\t\t// Add popover\n\t\t\t\t++subs;\n\t\t\t}\n\t\treturn str+\"</ul>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close category\n\t\t}\n\t}\n\n\tAddSubjectContext(o,d)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD SUNJECYCONTEXT TAB CONTENTS \t\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,n=0,subs=0;\n\t\tfor (i=0;i<d.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each child\n\t\t\tsubs+=d[i].child_count.numFound;\t\t\t\t\t\t\t\t\t\t\t\t\t// Add children\n\t\t\t}\n\nsubs=\"(TBD)\"\n\n\tlet str=`<br><div class='sui-spHead'>Subjects related to ${o.title}</div>\n\t\t<div style='max-width:900px'>\n\t\t<b>${o.title[0]}</b> has <b> ${d[0].ancestors.length-1} </b>superordinate subjects \n\t\tand <b> ${subs} </b>subordinate subjects. \n\t\tYou can browse these subordinate subjects as well as its superordinate categories with the tree below. \n\t\tSee the RELATED SUBJECTS tab if you instead prefer to view only its immediately \n\t\tsubordinate subjects grouped together in useful ways, as well as subjects non-hierarchically related to it.</div><br>\n\t\t<ul class='sui-spLin' id='sui-spRows'>`;\n\t\t\n\t\tfor (n=0;n<d[0].ancestors.length;++n) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each ancestor \n\t\t\tstr+=\"<ul style='list-style-type:none'>\";\t\t\t\t\t\t\t\t\t\t\t// Add header\n\t\t\tstr+=sui.pages.AddRelTreeLine(d[0].ancestors[n],d[0].ancestor_uids_generic[n],\"&ndash;\",null); // Add it \n\t\t\t}\n\n\t\tsui.GetTreeChildren(o.asset_type,d[0].ancestor_id_path,(res)=>{\t\t\t\t\t\t\t// Get children\n\t\t\tlet i,j,re,m,path;\n\t\t\tlet counts=[];\n\t\t\ttry { counts=res.facets.child_counts.buckets; } catch(e) {}\t\t\t\t\t\t\t// Get child counts\n\t\t\tres=res.response.docs;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at docs\n\t\t\tfor (i=0;i<res.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each child\n\t\t\t\tpath=\"\";\tm=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume a loner\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tre=new RegExp(res[i].id.split(\"-\")[1]);\t\t\t\t\t\t\t\t\t\t\t// Get id to search on\n\t\t\t\tfor (j=0;j<counts.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each count\n\t\t\t\t\tif (counts[j].val.match(re)) {\t\t\t\t\t\t\t\t\t\t\t\t// In this one\n\t\t\t\t\t\tm=\"+\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Got kids\n\t\t\t\t\t\tpath=counts[j].val;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add path\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tstr+=\"<ul style='list-style-type:none'>\";\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\t\tstr+=sui.pages.AddRelTreeLine(res[i].header,res[i].id,m,path)+\"</li></ul>\"; \t\t\t// Add it\n\t\t\t\t}\n\t\t\t\n\t\t\tstr=str.replace(/~~/,n+res.length);\t\t\t\t\t\t\t\t\t\t\t\t\t// Set total count\n\t\t\tfor (i=0;i<d[0].ancestors.length;++i) str+=\"</li></ul>\";\t\t\t\t\t\t\t// Close chain\n\t\t\tthis.content[0]=str.replace(/\\t|\\n|\\r/g,\"\")+\"</ul><br>\";\t\t\t\t\t\t\t// Set 1st content array member with html\n\t\t\tthis.ShowTab(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t\t});\n\t\t}\n\n} // CLASS CLOSURE\n","/* \tIMAGE PAGES ****************************************************************************************************************************\n\n\tThis module draws the images page based on a kmap from SOLR. The image can be zoomed into an panned \n\tby clicking the magnifier icon.\tA row of thumbnails of all the imges in the search results appears in\n\t a scrollable window below the picture.\tClicking one shows that picture's page.\n\t\t\n\tSome metadata is displyed under the image along with the summary. Images can be downloaded by clicking\n\ton the DOWNLOAD IMAGE label.\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tlooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n**********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\nexport default class Images  {\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW IMAGE PAGE FROM KMAP\n\t{\n\t\tconst sui = this.sui;\n\t\tvar i,j,mid;\n\t\tvar asp=o.url_thumb_height/o.url_thumb_width;\n\t\tvar w=$(this.div).width()/2;\n\t\tvar h=w*asp;\n\t\tif (o.url_thumb)\t o.url_thumb=o.url_thumb.replace(/images-test/i,\"images\");\t\t\t// Force to prod\n\t\tfor (i=0;i<sui.curResults.length;++i) {\tif (o.id == sui.curResults[i].id)\tmid=i; }\n\n\t\tvar str=`<div class='sui-imagesBox' id='sui-imagesBox' style='margin:${(sui.ss.mode == \"related\") ? \"-12px 0 0 0\" : \"-12px -12px 0 -12px\"}'>\n\t\t<div id='sui-picEnlarge' style='cursor:pointer;font-size:18px' title='Click to enlarge and pan'>&#xe650</div></p>\n\t\t<div id='sui-imageDiv' class='sui-imageDiv' >\n\t\t\t<img id='sui-thisPic' src='${o.url_thumb.replace(/200,200/,\"2000,2000\")}' style='width:100%'> \n\t\t</div><br>\n\t\t<div><span style='max-width:900px;font-size:20px;vertical-align:-2px;color:#ccc'>&#xe62a&nbsp;&nbsp;${o.title[0]}</span></div>\n\t\t<div style='color:#ccc;margin-bottom:24px'>${o.creator}&nbsp;&nbsp;|&nbsp;&nbsp;${o.img_width_s} x ${o.img_height_s} px</div>\n\t\t<div class='sui-imageGal'id='sui-imageGal'>`;\n\t\tfor (i=0;i<mid;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each image up mid point\n\t\t\tif (sui.curResults[i].asset_type == \"images\")\n\t\t\t\tstr+=`<div class='sui-pageThumb'><img id='sui-pageThumb-${i}' src='${sui.curResults[i].url_thumb}' style='height:100%'></div>`;\n\t\tstr+=`<div class='sui-pageThumb' style=' border-color:#fff'><img id='sui-pageThumb-${mid}' src='${o.url_thumb}' style='height:100%'></div>`;\t\n\t\tfor (i=mid+1;i<sui.curResults.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t// For each after mid point\n\t\t\tif (sui.curResults[i].asset_type == \"images\")\n\t\t\t\tstr+=`<div class='sui-pageThumb'><img id='sui-pageThumb-${i}' src='${sui.curResults[i].url_thumb}' style='height:100%'></div>`;\n\t\tstr+=\"</div></div>\";\n\t\t\n\t\tsui.GetJSONFromKmap(o, (d)=> { drawDetails(d); });\t\t\t\t\t\t\t\t\t\t// Load detaill from JSON\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\t\tsui.pages.DrawRelatedAssets();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\t\t// $(\"#sui-imageGal\").scrollLeft($(\"#sui-pageThumb-\"+mid).offset().left-w+25);\t\t\t\t// Scroll to center\n\n\t\tlet s, places=[],subjects=[],terms=[];\n\t\ttry{\n\t\t\tfor (i=0;i<o.kmapid_strict.length;++i) {\n\t\t\t\tif (o.kmapid_strict[i].match(/places/))\t\tplaces.push(o.kmapid_strict_ss[i]+sui.pages.AddPop(o.kmapid_strict[i]));\n\t\t\t\tif (o.kmapid_strict[i].match(/subjects/))\tsubjects.push(o.kmapid_strict_ss[i]+sui.pages.AddPop(o.kmapid_strict[i]));\n\t\t\t\tif (o.kmapid_strict[i].match(/terms/))\t{\t\t\t\t\t\t\t\t\t\t// If a term\n\t\t\t\t\ts=o.kmapid_strict_ss[i];\t\t\t\t\t\t\t\t\t\t\t\t\t// Add term\n\t\t\t\t\tlet r=RegExp(o.kmapid_strict[i]+\"_definitions-(\\d*)\",\"g\");\t\t\t\t\t// Get any definitions for this term\n\t\t\t\t\tr=o.kmapid.join().match(r);\t\t\t\t\t\t\t\t\t\t\t\t\t// Count\n\t\t\t\t\tif (r) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If any\n\t\t\t\t\t\ts+=\"<span><i><sup> (\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Start superscript\n\t\t\t\t\t\tfor (j=1;j<=r.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t// For each def\n\t\t\t\t\t\t\ts+=j;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add number\n\t\t\t\t\t\t\tif (j < r.length) s+=\",\";\t\t\t\t\t\t\t\t\t\t\t// Add comma\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\ts+=\")</sup></i></span>\";\t\t\t\t\t\t\t\t\t\t\t\t// End super\n\t\t\t\t\t\t}\n\t\t\t\t\ts+=sui.pages.AddPop(o.kmapid_strict[i]);\t\t\t\t\t\t\t\t\t// Add popover\n\t\t\t\t\tterms.push(s);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add term\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t} catch(e) {}\n\t\n\t\tstr=`<br><table class='sui-imageMid'>\n\t\t\t<tr class='sui-pageLab' style='font-size:16px;padding-bottom:4px'><td style='width:50%'>MANDALA COLLECTIONS</td><td>CLASSIFICATION</td></tr>\n\t\t\t<tr class='sui-pageLab' style='padding-bottom:8px'><td>&#xe633&nbsp;&nbsp;<i>`;\n\t\t\tif (o.collection_title) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If a collection\t\n\t\t\t\tstr+=`${o.collection_title}${sui.pages.AddPop(o.collection_uid_s)}`;\t\t\t// Show name and popup\n\t\t\telse str+=\"None\";\n\t\t\tstr+=\"</td><td><i>\";  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close left side\n\t\t\tif (subjects.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If subjects\t\n\t\t\t\tstr+=\"<span style='color:#cc4c39'>&#xe634</span>&nbsp;&nbsp\";\t\t\t\t\t// Add icon\n\t\t\t\tfor (i=0;i<subjects.length;++i) str+=subjects[i]+\", \";\t\t\t\t\t\t\t// Add item\n\t\t\t\tstr=str.slice(0,-2)+\"<br>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove last comma\n\t\t\t\t}\t\n\t\t\tif (places.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If places\t\n\t\t\t\tstr+=\"<span style='color:#6faaf1'>&#xe62b</span>&nbsp;&nbsp\";\t\t\t\t\t// Add icon\n\t\t\t\tfor (i=0;i<places.length;++i) str+=places[i]+\", \";\t\t\t\t\t\t\t\t// Add item\n\t\t\t\tstr=str.slice(0,-2)+\"<br>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove last comma\n\t\t\t\t}\t\n\t\t\tif (terms.length) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If terms\t\n\t\t\t\tstr+=\"<span style='color:#a2733f'>&#xe635</span>&nbsp;&nbsp\";\t\t\t\t\t// Add icon\n\t\t\t\tfor (i=0;i<terms.length;++i) str+=terms[i]+\", \";\t\t\t\t\t\t\t\t// Add item\n\t\t\t\tstr=str.slice(0,-2)+\"<br>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove last comma\n\t\t\t\t}\t\n\t\t\tstr+=\"</td></tr></i></table>\";\n\n\t\tvar d=this.DrawItem;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at this item drawer\n\t\tfunction drawDetails(j) {\t\n\t\t\t// trace(j)\n\t\t\tstr+=\"<div class='sui-images'>\";\n\t\t\tstr+=\"<div style='width:calc(49% - 24px);display:inline-block;margin-right:16px;vertical-align:top;height:100%;'><table style='width:100%'>\";\n\t\t\t\ttry{ str+=d(sui.assets[o.asset_type].g,\"CAPTION\",o.caption,\"Untitled\"); } catch(e){}\n\t\t\t\tstr+=\"<tr><td colspan='2'><hr></td></tr>\";\n\t\t\t\ttry{ str+=d(\"&#xe600\",\"CREATOR\",o.creator) } catch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe66d\",\"TYPE\",j.field_image_type.und[0].value.charAt(0).toUpperCase()+j.field_image_type.und[0].value.slice(1)); } catch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe665\",\"SIZE\", o.img_width_s+\" x \"+o.img_height_s+\" px\"); } catch(e){}\n\t\t\t\tstr+=\"<tr><td colspan='2'><hr></td></tr>\";\n\t\t\t\ttry{ str+=\"<p class='sui-pageLab'>\";\n\t\t\t\t\tfor (i=0;i<j.field_image_descriptions.und.length;++i) \t\t\t\t\t\t\t// For each note\n\t\t\t\t\t\tstr+=j.field_image_descriptions.und[i].title+\"<br>\";\t\t\t\t\t\t// Add it\n\t\t\t\t\tstr+=\"</p>\";  \n\t\t\t\t\t} catch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe600\",j.field_image_agents.und[0].field_agent_role.und[0].value.toUpperCase(),\n\t\t\t\t\t\tj.field_image_agents.und[0].title+\" (\"+sui.pages.FormatDate(j.field_image_agents.und[0].field_agent_dates.und[0].value)+\")\"\n\t\t\t\t\t); } \tcatch(e) {}\n\t\t\t\ttry{ str+=\"</table><p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// A sub description\n\t\t\t\tstr+=j.field_image_descriptions.und[0].field_description.und[0].value+\"<br></p>\";  } \t\tcatch(e){}\n\t\t\t\tstr+=\"</div><div style='width:49%;display:inline-block;vertical-align:top;border-left:1px solid #ddd;padding-left:16px'><br><table style='width:100%'>\";\n\t\t\t\ttry{ str+=d(\"&#xe67f\",\"ONLY DIGITAL\",j.field_image_digital.und[0].value ? \"Yes\" : \"No\"); } \tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe67f\",\"COLOR\",j.field_image_color.und[0].value ? \"Yes\" : \"No\"); } \t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe67f\",\"QUALITY\",j.field_image_quality.und[0].value); } \t\t\t\t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe67f\",\"ROTATION\",j.field_image_rotation.und[0].value+\"&deg;\"); } \t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe665\",\"PHYSICAL&nbsp;SIZE\",j.field_physical_size.und[0].value); } \t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe659\",\"CAPURE&nbsp;DEVICE\",j.field_image_capture_device.und[0].value); } \tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe65f\",\"MATERIALS\",j.field_image_materials.und[0].value); } \t\t\t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe66c\",\"ENHANCEMENT\",j.field_image_enhancement.und[0].value); } \t\t\t\tcatch(e){}\n\t\t\t\ttry{ str+=\"<tr><td>&#xe62B&nbsp;&nbsp;<span class='sui-pageLab'>LOCATION</span>:</td><td>\"+j.field_longitude.und[0].value+\"&nbsp;&nbsp;&nbsp;\"+j.field_latitude.und[0].value+\"</td></tr>\"; } \t\t\t\t\t\t\t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&copy;\",\"COPYRIGHT&nbsp;HOLDER\",j.field_copyright_holder.und[0].value); } \t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&copy;\",\"COPYRIGHT&nbsp;STATEMENT\",j.field_copyright_statement.und[0].value);} catch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe614\",\"ORIGINAL&nbsp;FILE\",j.field_original_filename.und[0].value); } \t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe678\",\"TECHNICAL&nbsp;NOTES\",j.field_technical_notes.und[0].value); } \t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe639\",\"UPLOADED&nbsp;BY\",o.node_user_full_s); } \t\t\t\t\t\t\tcatch(e){}\n\t\t\t\ttry{ str+=d(\"&#xe67f\",\"LICENSE\",\"<a style='font-weight:400' target='_blank' href='\"+j.field_license_url.und[0].value+\"'>\"+j.field_license_url.und[0].value+\"</a>\"); } catch(e){} \n\t\t\t\t\n\t\t\t\tlet asp=o.img_height_s/o.img_width_s;\n\t\t\t\tstr+=`</table><p class='sui-pageLab' style='cursor:pointer' onclick='$(\"#sui-dlOps\").toggle()'>\n\t\t\t\t&#xe616&nbsp;&nbsp;<a>DOWNLOAD IMAGE</a>\n\t\t\t\t\t<div id='sui-dlOps' style='display:none;margin-left:24px;font-size:12px'>\t\t\t\n\t\t\t\t\t<a target='_blank' href='${o.url_thumb.replace(/200,200/,o.img_width_s+\",\"+o.img_width_s)}'\n\t\t\t\t\tstyle='display:inline-block;cursor:pointer'>Original (${o.img_width_s}x${o.img_height_s})</a><br>\n\t\t\t\t\t<a target='_blank' href='${o.url_thumb.replace(/200,200/,\"1200,1200\")}'\n\t\t\t\t\tstyle='display:inline-block;cursor:pointer'>Large (1200x${1200*asp}))</a><br>\n\t\t\t\t\t<a target='_blank' href='${o.url_thumb.replace(/200,200/,\"800,800\")}'\n\t\t\t\t\tstyle='display:inline-block;cursor:pointer'>Medium (800x${800*asp})</a><br>\n\t\t\t\t\t<a target='_blank' href='${o.url_thumb.replace(/200,200/,\"400,400\")}'\n\t\t\t\t\tstyle='display:inline-block;cursor:pointer'>Small (400x${400*asp})</a>\n\t\t\t\t\t<p><i>Right-click and select \"Download/Save Linked File\"</i></p>\n\t\t\t\t\t</div>\n\t\t\t\t</p></div></div></div>`;\n\t\t\t\t$(sui.pages.div).append(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t// Remove format and add to div\n\t\t\t\t\n\t\t\t\t$(\"#sui-imgCol\").on(\"click\",()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLECTION CLICK\n\t\t\t\t\tsui.GetKmapFromID(o.collection_uid_s,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t// Get kmap and show page\n\t\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t\t\t});\n\t\t\t}\n\t\n\t\t$(\"[id^=sui-pageThumb-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON THUMBNAIL CLICK\n\t\t\tlet id=e.currentTarget.id.split(\"-\")[2];\t\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\tsui.pages.Draw(sui.curResults[id]);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show image\n\t\t\t});\n\n\t\t$(\"#sui-picEnlarge\").on(\"click\",()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON RESIZE PIC\n\t\t\tlet sx,sy,px,py;\n\t\t\tlet pic=$(\"#sui-legacy\")[0];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at image\n\t\t\tlet h=$(this.div).width()/2*asp;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Make heighr\n\t\t\t$(\"#sui-imagesBox\").css({\"padding-top\":\"12px\"});\t\t\t\t\t\t\t\t\t\t// Thinner top\n\t\t\t$(\"#sui-imageDiv\").css({width:\"100%\", height:$(\"#sui-legacy\").height()+\"px\"});\t\t\t// Full screen\n\t\t\tif ($(\"#sui-picEnlarge\").html().match(/Zoom/)) {\t\t\t\t\t\t\t\t\t\t// If zoomed already\n\t\t\t\t$(\"#sui-picEnlarge\").html(\"&#xe650\");\t\t\t\t\t\t\t\t\t\t\t\t// Restore icon\n\t\t\t\t$(\"#sui-thisPic\").offset($(\"#sui-imageDiv\").offset());\t\t\t\t\t\t\t\t// Restore offset\n\t\t\t\t$(\"#sui-imageDiv\").css({width:\"50%\",height:h+\"px\"});\t\t\t\t\t\t\t\t// Back to half screen\n\t\t\t\t$(\"#sui-imagesBox\").css({\"padding-top\":\"60px\"});\t\t\t\t\t\t\t\t\t// Restore spacing\n\t\t\t\tpic.onmousedown=pic.onwheel=null;\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove listeners\n\t\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t\t}\n\t\t\t$(\"#sui-picEnlarge\").html(\"Zoom &nbsp; &#xe651  &nbsp; out \");\t\t\t\t\t\t\t// Zoom out icon\n\t\t\t$(\"#sui-thisPic\").css(\"width\",\"auto\");\t\t\t\t\t\t\t\t\t\t\t\t\t// True size\n\n\t\t\tpic.style.cursor=\"grab\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Grab cursor\n\t\t\tpic.onwheel=(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// On wheel foir trackpad moving\n\t\t\t\te=e||window.event;\t\t\t\t\t\te.preventDefault();\t\t\t\t\t\t\t// Set event locally\t\t\t\t\t\t\t\t\t\n\t\t\t\tsx=$(\"#sui-thisPic\").offset();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current pos\n\t\t\t\t$(\"#sui-thisPic\").offset({left:(e.deltaX ? e.deltaX : 0)/5+sx.left,top:(e.deltaY ? e.deltaY : 0)/3+sx.top}); // Set image via offset\n\t\t\t\t};\n\n\t\t\tpic.onmousedown=(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// On click for mouse moving\n\t\t\t\te=e||window.event;\t\t\t\t\t\te.preventDefault();\t\t\t\t\t\t\t// Set event locally\t\t\t\t\t\t\t\t\t\n\t\t\t\tsx=e.pageX;    \t\t\t\t\t\t\tsy=e.pageY;\t\t\t\t\t\t\t\t\t// Start of drag\n\t\t\t\tpx=$(\"#sui-thisPic\").offset().left;\t\tpy=$(\"#sui-thisPic\").offset().top;\t\t\t// Start image offset\n\t\t\t\tpic.onmousemove=(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// On drag\n\t\t\t\t\te=e||window.event;\t\te.preventDefault();\t\t\t\t\t\t\t\t\t\t// Set event\n\t\t\t\t\tvar dx=e.pageX-sx;   \tvar dy=e.pageY-sy;\t\t\t\t\t\t\t\t\t\t// Get delta\n\t\t\t\t\t$(\"#sui-thisPic\").offset({left:px+dx,top:py+dy});\t\t\t\t\t\t\t\t// Set image via offset\n\t\t\t\t\t};\n\t\t\t\tpic.onmouseup=(e)=> {\tpic.onwheeel=pic.onmouseup=pic.onmousemove=null; }; \t\t// Remove listeners\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tDrawItem(icon, label, value, def, style, bold)\t\t\t\t\t\t\t\t\t\t\t// DRAW ITEM\n\t\t{\n\t\t\tlet i,str=\"<tr><td>\";\n\t\t\tif ((value == null) || (value == undefined) || (value == \"\"))\treturn \"\";\t\t\t\t// Return nothing\n\t\t\tif (icon)\tstr+=icon+\"&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add icon\n\t\t\tstr+=\"<span class='sui-pageLab'\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Label head\n\t\t\tif (bold)\tstr+=\" style='font-weight:600'\";\t\t\t\t\t\t\t\t\t\t\t// Bold?\n\t\t\tstr+=\">\"+label+\":&nbsp;&nbsp;</span>\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\t\tstr+=\"</td><td><span class='\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add value span\n\t\t\tstr+=(style ? style : \"sui-pageVal\")+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Default, or special style\n\t\t\tif (typeof(value) == \"object\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If an array\n\t\t\t\tfor (i=0;i<value.length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tif (value[i].header)\t\tstr+=value[i].header;\t\t\t\t\t\t\t\t// Use .header\n\t\t\t\t\telse if (value[i].value)\tstr+=value[i].value;\t\t\t\t\t\t\t\t// .value\n\t\t\t\t\telse if (value[i].val)\t\tstr+=value[i].val;\t\t\t\t\t\t\t\t\t// .val\n\t\t\t\t\telse if (value[i].title)\tstr+=value[i].title;\t\t\t\t\t\t\t\t// .title\n\t\t\t\t\telse \t\t\t\t\t\tstr+=value[i];\t\t\t\t\t\t\t\t\t\t// Plain\t\n\t\t\t\t\tif (i != value.length-1)\tstr+=\", \";\t\t\t\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\telse str+=(value && (!value.match(/undefined/))) ? value : def;\t\t\t\t\t\t\t// Add def if bad value or show value\n\t\t\treturn str+\"</span></td></tr>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return item\n\t\t}\n\t\n\n\n} // Images class closure\n","/* \tTEXT PAGES ****************************************************************************************************************************\n\n\tThis module draws the Texts page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the JSON data coming from Drupal. The formatted \n\ttable of contents and text content are tsaken directly from the JSON markup.\n\n\tA tabbed interface shows that TOC, descriptive metadata. and links to alternative ways to view \n\tthe text in other formats. \n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\t\t\t\thttps://texts-dev.shanti.virginia.edu/sites/all/themes/shanti_sarvaka_texts/css/shanti_texts.css\t\t// For contents formatting\t\t\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tLooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n******************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\nexport default class Texts  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui=sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t\tthis.content=[\"...loading\",\"...loading\",\"...loading\"];\t\t\t\t\t\t\t\t\t// Content pages\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TEXTS PAGE FROM KMAP\n\t{\n\t\tconsole.error(\"texts.Draw()\");\n\t\tconst sui = this.sui;\n\t\tlet _this=this;\n\t\tif (!$(\".shanti-texts-section-content\").length)\t\t\t\t\t\t\t\t\t\t\t// No CSS yet\n\t\t\t$(\"<link/>\", { rel:\"stylesheet\", type:\"text/css\", href:\"https://texts-dev.shanti.virginia.edu/sites/all/themes/shanti_sarvaka_texts/css/shanti_texts.css\" }).appendTo(\"head\"); \t// Load CSS\n\t\tvar url=o.url_ajax.replace(/node_ajax/i,\"node_embed\")+\"?callback=pfunc\";\t\t\t\t// Make url\n\t\t$(this.div).html();// Clear page\n\t\tvar str=`<div id='sui-textCon' class='sui-texts'></div>\n\t\t<div style='display:inline-block;width:calc(34% + 3px);margin-left:-8px;vertical-align:top'>\n\t\t<div class='sui-textTop' id='sui-textTop'>\n\t\t\t<div class='sui-textTab' id='sui-textTab0'>CONTENTS</div>\n\t\t\t<div class='sui-textTab' id='sui-textTab1'>DESCRIPTION</div>\n\t\t\t<div class='sui-textTab' id='sui-textTab2'>VIEWS</div>\n\t\t</div>\n\t\t<div class='sui-textContent' id='sui-textContent'></div></div>`;\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\n\t\t// sui.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\n\t\tsui.LoadingIcon(true,64);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show loading icon\n\n\t\t$.ajax( { url:url, dataType:'jsonp'}).done((data)=> {\t\t\t\t\t\t\t\t\t// Get json\n\t\t\tsui.LoadingIcon(false);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hide loading icon\n\t\t\t$(\"#sui-textCon\").html(data);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add text content\n\t\t\t$(\"#shanti-texts-container\").height($(\"#sui-content\").height()-80);\t\t\t\t\t// Reset text height\n\t\t\t$(\"#shanti-texts-body\").height($(\"#sui-content\").height()-110);\t\t\t\t\t\t// Reset text height\n\t\t\tthis.content[0]=$(\"#shanti-texts-toc\").html();\t\t\t\t\t\t\t\t\t\t// Save TOC\n\t\t\t$(\"#shanti-texts-sidebar\").remove();\t\t\t\t\t\t\t\t\t\t\t\t// Remove original sidebar\n\t\t\tshowTab(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show TOC\n\t\n\t\t\t$(\"#shanti-texts-container\").append(\"xxxxxxxxxxxxx<br><br>\")\n\t\t\t$(\".kmap-tag-group\").each(function() {\t\t\t\t\t\t\t\t\t\t\t\t// For each tag group\n\t\t\t\tlet facet=$(this).data(\"kmdomain\");\t\t\t\t\t\t\t\t\t\t\t\t// Get facet\n\t\t\t\tlet id=facet+\"-\"+$(this).data(\"kmid\");\t\t\t\t\t\t\t\t\t\t\t// Make id\n\t\t\t\tlet str=`<span style='font-family:\"Open Sans\",shanticon;color:${sui.assets[facet].c}'>\n\t\t\t\t\t${sui.assets[facet].g}&nbsp;</span>\n\t\t\t\t\t${$(this.children[0]).text()}\n\t\t\t\t\t${sui.pages.AddPop(id)}&nbsp;&nbsp;`;\n\t\t\t\t$(this.children[0]).html(str.replace(/\\t|\\n|\\r/g,\"\"));\n\t\t\t\t})\n\n\t\t\tlet s=`<p><b>ALTERNATIVE FORMATS</b></p>\n\t\t\t<p>&nbsp;&nbsp;&nbsp;&nbsp;<a target='_blank' href='https://texts.shanti.virginia.edu/book_pubreader/${o.id}'>&#xe678&nbsp;&nbsp;View in PubReader</a></p>\n\t\t\t<p>&nbsp;&nbsp;&nbsp;&nbsp;<a target='_blank' href='https://texts.shanti.virginia.edu/shanti_texts/voyant/${o.id}'>&#xe678&nbsp;&nbsp;View in Voyant</a></p>\n\t\t\t<p>&nbsp;&nbsp;&nbsp;&nbsp;<a target='_blank' href='https://texts.shanti.virginia.edu/shanti_texts/node_ajax_text/${o.id}'>&#xe678&nbsp;&nbsp;View as raw text</a></p>`;\n\t\t\tthis.content[2]=s.replace(/\\t|\\n|\\r/g,\"\");\t\t\t\t\t\t\t\t\t\t\t// Set view content\n\n\t\t\tsui.GetJSONFromKmap(o, (d)=> { \t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get JSON\n\t\t\t\tlet i,str=\"\";\n\t\t\t\tstr+=\"<table style='width:100%'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Start data table\t\t\n\t\t\t\ttry { s=`<a title='Collection' id='sui-txtCol' href='#p=${o.collection_uid_s}'>${o.collection_title}</a>${sui.pages.AddPop(o.collection_uid_s)}`;\n\t\t\t\tif (o.collection_title)\tstr+=this.DrawItem(\"&#xe633\",\"COLLECTION\",s) }\t\t catch(e) {}\n\t\t\t\tstr+=this.DrawItem(\"&#xe67c\",\"VISIBILITY\",\"Public - accessible to all site users\");\n\t\t\t\tif (o.summary) str+=\"<tr><hr><td colspan='2' style='max-width:\"+$(\"#sui-content\").width()/4+\"px'>\"+o.summary+\"<hr><td></tr>\";\t\t// Add summary\n\t\t\t\ttry { str+=this.DrawItem(\"&#xe600\",\"AUTHOR\",d.field_book_author.und,\"\",\"sui-pageLab\"); } \t\t\t\t\t\t\t\t\t\t\t\t\tcatch(e) {}\n\t\t\t\ttry { str+=this.DrawItem(\"&#xe675\",\"EDITOR\",d.field_book_editor.und,\"\",\"sui-pageLab\"); }\t\t\t\t\t\t\t\t\t\t\t\t\tcatch(e) {}\n\t\t\t\ttry { str+=this.DrawItem(\"&#xe633\",\"YEAR&nbsp;PUBLISHED\", d.field_dc_date_publication_year.und[0].value.substr(0,4),\"sui-pageLab\"); }\t\tcatch(e) {}\n\t\t\t\ttry { str+=this.DrawItem(\"&#xe633\",\"ORIGINAL&nbsp;YEAR PUBLISHED\", d.field_dc_date_orginial_year.und[0].value.substr(0,4),\"sui-pageLab\"); }\tcatch(e) {}\n\t\t\t\tif (d.field_kmap_places && d.field_kmap_places.und) {\t\t\t\t\t\t\t// If places\n\t\t\t\t\tstr+=\"<tr><td style='vertical-align:top'><span class='sui-pageLab'>&#xe62b&nbsp;&nbspPLACES:</td><td>\" ;// Add header\n\t\t\t\t\tfor (i=0;i<d.field_kmap_places.und.length;++i) {\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=d.field_kmap_places.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmap_places.und[i].domain+\"-\"+d.field_kmap_places.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < d.field_kmap_places.und.length-1)\tstr+=\"<br>\";\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</td></tr>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\tif (d.field_kmap_subjects && d.field_kmap_subjects.und) {\t\t\t\t\t\t// If subjects\n\t\t\t\t\tstr+=\"<tr><td style='vertical-align:top'><span class='sui-pageLab'>&#xe634&nbsp;&nbspPLACES:</td><td>\" ; // Add header\n\t\t\t\t\tfor (i=0;i<d.field_kmap_subjects.und.length;++i) {\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=d.field_kmap_subjects.und[i].header;\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmap_subjects.und[i].domain+\"-\"+d.field_kmap_subjects.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < d.field_kmap_subjects.und.length-1)\tstr+=\"<br>\";\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</td></tr>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\tif (d.field_kmap_terms && d.field_kmap_terms.und) {\t\t\t\t\t\t\t\t// If terms\n\t\t\t\t\tstr+=\"<tr><td style='vertical-align:top'><span class='sui-pageLab'>&#xe635&nbsp;&nbspTERMS:</td><td>\" ; // Add  header\n\t\t\t\t\tfor (i=0;i<d.field_kmap_terms.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=d.field_kmap_terms.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmap_termss.und[i].domain+\"-\"+d.field_kmap_terms.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < d.field_kmap_terms.und.length-1)\tstr+=\"<br>\";\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</td></tr>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t\ttry { str+=this.DrawItem(\"&#xe674\",\"TRANSLATOR\",d.field_book_translator.und,\"sui-pageLab\"); }\tcatch(e) {}\n\t\t\t\ttry { str+=this.DrawItem(\"&#xe670\",\"LANGUAGE\",d.field_dc_language_original.und,\"sui-pageLab\"); }\tcatch(e) {}\n\t\t\t\ttry { str+=this.DrawItem(\"&copy;\",\"RIGHTS\", d.field_dc_rights_general.und,\"sui-pageLab\"); }\t\t\tcatch(e) {}\n\t\t\t\tstr+=\"</table>\"\n\t\t\t\tthis.content[1]=str.replace(/\\t|\\n|\\r/g,\"\");\t\t\t\t\t\t\t\t\t// Set view content\n\t\t\t\ttry{ this.content[2]+=\"<p>&nbsp;&nbsp;&nbsp;&nbsp;<a target='_blank' href='\"+d.field_pdf_version.und[0].url+\"'>&#xe678&nbsp;&nbsp;View as PDF</a></p>\"; } catch(e) {}\n\t\t\t});\n\t\t\t\n\t\t\t$(\"[id^=sui-textTab]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\t\tvar id=e.currentTarget.id.substring(11);\t\t\t\t\t\t\t\t\t\t// Get index of tab\t\n\t\t\t\t\tshowTab(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t\t\t});\n\t\n\t\t\tfunction showTab(which) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW TAB CONTENTS\n\t\t\t\t$(\"#sui-textContent\").html(\"<div class='sui-sourceText' style='font-size:18px;color:#000'>\"+o.title+\"<div><hr>\");\t// Set title\n\t\t\t\t$(\"[id^=sui-textTab]\").css({\"background-color\":\"#eee\"});\n\t\t\t\t$(\"#sui-textTab\"+which).css({\"background-color\":\"#fff\"});\n\t\t\t\t$(\"#sui-textContent\").append(_this.content[which]);\t\t\t\t\t\t\t\t// Set content\n\t\t\t\t$(\"#sui-txtCol\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear old handler\n\t\t\t\t$(\"#sui-txtCol\").on(\"click\",()=>\t{\t\t\t\t\t\t\t\t\t\t\t// ON COLLECTION CLICK\n\t\t\t\t\tsui.GetKmapFromID(o.collection_uid_s,(kmap)=>{ sui.SendMessage(\"\",kmap); }); // Get kmap and show page\n\t\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t\t\t});\n\t\n\t\t\t}\n\t\t});\t\t\t\t\t\t\t\n\t}\n\n\tDrawItem(icon, label, value, def, style, bold)\t\t\t\t\t\t\t\t\t\t\t// DRAW ITEM\n\t{\n\t\tlet i,str=\"<tr><td>\";\n\t\tif ((value == null) || (value == undefined) || (value == \"\"))\treturn \"\";\t\t\t\t// Return nothing\n\t\tif (icon)\tstr+=icon+\"&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add icon\n\t\tstr+=\"<span class='sui-pageLab'\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Label head\n\t\tif (bold)\tstr+=\" style='font-weight:600'\";\t\t\t\t\t\t\t\t\t\t\t// Bold?\n\t\tstr+=\">\"+label+\":&nbsp;&nbsp;</span>\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\tstr+=\"</td><td><span class='\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add value span\n\t\tstr+=(style ? style : \"sui-pageVal\")+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Default, or special style\n\t\tif (typeof(value) == \"object\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If an array\n\t\t\tfor (i=0;i<value.length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tif (value[i].header)\t\tstr+=value[i].header;\t\t\t\t\t\t\t\t// Use .header\n\t\t\t\telse if (value[i].value)\tstr+=value[i].value;\t\t\t\t\t\t\t\t// .value\n\t\t\t\telse if (value[i].val)\t\tstr+=value[i].val;\t\t\t\t\t\t\t\t\t// .val\n\t\t\t\telse if (value[i].title)\tstr+=value[i].title;\t\t\t\t\t\t\t\t// .title\n\t\t\t\telse \t\t\t\t\t\tstr+=value[i];\t\t\t\t\t\t\t\t\t\t// Plain\t\n\t\t\t\tif (i != value.length-1)\tstr+=\", \";\t\t\t\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t}\n\t\t\t}\n\t\telse str+=(value && (!value.match(/undefined/))) ? value : def;\t\t\t\t\t\t\t// Add def if bad value or show value\n\t\treturn str+\"</span></td></tr>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return item\n\t}\n\n\n} // Texts class closure\n","/* \tSOURCE PAGES ****************************************************************************************************************************\n\n\tThis module draws the sources page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the JSON data coming from Drupal. \t\n\t\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tLooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n*********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\nexport default class Sources  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW SOURCE PAGE FROM KMAP\n\t{\n\t\tconst sui = this.sui;\n\t\tvar i;\n\t\tvar str=`<div class='sui-sources' id='sui-sources'>\n\t\t<span style='font-size:24px;color:${sui.assets[o.asset_type].c};vertical-align:-4px'>${sui.assets[o.asset_type].g}</span>\n\t\t&nbsp;&nbsp;<span class='sui-sourceTitle'>${o.title[0]}</span>\n\t\t<hr style='border-top: 1px solid ${sui.assets[o.asset_type].c}'>\n\t\t<div class='sui-sourceSec' id='sui-srcSec'></div><br>`;\n\t\tif (o.creator && o.creator.length) {\n\t\t\tstr+=`<span class='sui-pageLab' style='color:${sui.assets[o.asset_type].c}'>&#xe600</span>\n\t\t\t&nbsp;&nbsp;${o.creator.join(\", \")}<br><br>`;\n\t\t\t}\n\t\tif (o.url_thumb && !o.url_thumb.match(/gradient.jpg/)) str+=\"<img src='\"+o.url_thumb+\"' style='float:right;width:33%; padding:0 0 12px 12px'>\";\n\t\tif (o.collection_title) str+=`<p>COLLECTION:&nbsp;&nbsp<a id='sui-imgCol' href='#p=${o.collection_uid_s}'>${o.collection_title}</a></p>`;\n\t\tif (o.asset_subtype) str+=\"<p>FORMAT:&nbsp;&nbsp<span class='sui-sourceText'>\"+o.asset_subtype+\"</span></p>\";\n\t\tstr+=\"<p class='sui-pageLab' id='sui-p2'>PUBLICATION YEAR:&nbsp;&nbsp<span class='sui-sourceText' id='sui-srcYear'></span>\";\n\t\tif (o.publisher_s) str+=\"<p>PUBLISHER:&nbsp;&nbsp<span class='sui-sourceText'>\"+o.publisher_s+\"</span></p>\";\n\t\tstr+=\"<p class='sui-pageLab' id='sui-p3'>PLACE OF PUBLICATION:&nbsp;&nbsp<span class='sui-sourceText' id='sui-srcPlc'></span>\";\n\t\tstr+=\"<p class='sui-pageLab' id='sui-p1'>PAGES:&nbsp;&nbsp<span class='sui-sourceText' id='sui-srcPages'></span>\";\n\t\tstr+=\"<p class='sui-pageLab'>SOURCE ID:&nbsp;&nbsp<span class='sui-sourceText'>sources-\"+o.id+\"</span></p>\";\n\t\tif (o.summary) str+=\"<p>ABSTRACT:<div class='sui-sourceText'>\"+o.summary+\"</div></p>\";\n\t\tstr+=\"</div>\";\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\t\tsui.pages.DrawRelatedAssets();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\n\t\t$(\"#sui-imgCol\").on(\"click\",()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLECTION CLICK\n\t\t\tsui.GetKmapFromID(o.collection_uid_s,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t// Get kmap and show page\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});\n\n\t\tsui.GetJSONFromKmap(o, (d)=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get details from JSON\n\t\t\tlet i,str=\"\";\n\t\t\tif (d.biblio_pages) \t\t\t$(\"#sui-srcPages\").html(d.biblio_pages);\t\t\t// Add pages\n\t\t\telse\t\t\t\t\t\t\t$(\"#sui-sp1\").hide();\t\t\t\t\t\t\t\t// Hide\n\t\t\tif (d.biblio_year) \t\t\t\t$(\"#sui-srcYear\").html(d.biblio_year);\t\t\t\t// Year\n\t\t\telse\t\t\t\t\t\t\t$(\"#sui-sp2\").hide();\t\t\t\t\t\t\t\t// Hide\n\t\t\tif (d.biblio_secondary_title) \t$(\"#sui-srcSec\").html(d.biblio_secondary_title);\t// Pub\n\t\t\telse\t\t\t\t\t\t\t$(\"#sui-srcSec\").hide();\t\t\t\t\t\t\t// Hide\n\t\t\tif (d.biblio_place_published) \t$(\"#sui-srcPlc\").html(d.biblio_place_published);\t// Pub place\n\t\t\telse\t\t\t\t\t\t\t$(\"#sui-sp3\").hide();\t\t\t\t\t\t\t\t// Hide\n\t\t\tif (d.field_kmaps_subjects && d.field_kmaps_subjects.und) {\t\t\t\t\t\t\t// If subjects\n\t\t\t\tstr+=\"<p class='sui-pageLab'>SUBJECTS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t// Add header\n\t\t\t\tfor (i=0;i<d.field_kmaps_subjects.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tstr+=d.field_kmaps_subjects.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmaps_subjects.und[i].domain+\"-\"+d.field_kmaps_subjects.und[i].id);\t// Add drop\n\t\t\t\t\tif (i < d.field_kmaps_subjects.und.length-1)\tstr+=\", \";\t\t\t\t\t// Add separator\n\t\t\t\t\t}\n\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End TERMS\n\t\t\t\t}\n\t\t\tif (d.field_kmaps_places && d.field_kmaps_places.und) {\t\t\t\t\t\t\t\t// If places\n\t\t\t\tstr+=\"<p class='sui-pageLab'>TERMS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t// Add header\n\t\t\t\tfor (i=0;i<d.field_kmaps_places.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tstr+=d.field_kmaps_places.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmaps_places.und[i].domain+\"-\"+d.field_kmaps_places.und[i].id);\t// Add drop\n\t\t\t\t\tif (i < d.field_kmaps_places.und.length-1)\tstr+=\", \";\t\t\t\t\t\t// Add separator\n\t\t\t\t\t}\n\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End PLACES\n\t\t\t\t}\n\t\t\tif (d.field_kmap_terms && d.field_kmap_terms.und) {\t\t\t\t\t\t\t\t\t// If terms\n\t\t\t\tstr+=\"<p class='sui-pageLab'>TERMS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t// Add TERMS header\n\t\t\t\tfor (i=0;i<d.field_kmap_terms.und.length;++i) {\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\tstr+=d.field_kmap_terms.und[i].header;\t\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\tstr+=sui.pages.AddPop(d.field_kmap_terms.und[i].domain+\"-\"+d.field_kmap_terms.und[i].id);\t// Add drop\n\t\t\t\t\tif (i < d.field_kmap_terms.und.length-1)\tstr+=\", \";\t\t\t\t\t\t// Add separator\n\t\t\t\t\t}\n\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End TERMS\n\t\t\t\t}\n\t\t\tif (d.biblio_url) str+=\"<p class='sui-pageLab'>URL:&nbsp;&nbsp;<a target='_blank' href='\"+d.biblio_url+\"'>\"+d.biblio_url+\"</a></p>\";\t// URL\n\t\t\t$(\"#sui-sources\").append(str);\n\t\t\t});\t\t\t\t\t\t\t\t\t\n\t}\n\n} // Sources class closure\n","/* \tVISUAL PAGES ****************************************************************************************************************************\n\n\tThis module draws the visuals page based on a kmap from SOLR. An iframe displays the visualization \n\tbased on a url and the metadata associated with it appears below. The various methods of sharing\n\tthe viz with other are revealed aa they are clicked on.\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tlooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\nexport default class Visuals  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW VISUAL PAGE FROM KMAP\n\t{\n\t\tconst sui = this.sui;\n\t\tsui.GetJSONFromKmap(o, (d)=> { drawDetails(d); });\t\t\t\t\t\t\t\t\t\t// Gert JSON\n\t\tvar url=\"//visuals.shanti.virginia.edu/sites/all/libraries/SHIVA/go.htm?m=//visuals.shanti.virginia.edu/data/json/\";\n\t\turl+=o.id;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Full url\n\t\tvar d=sui.pages.DrawItem;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at item drawer\n\t\n\t\tfunction drawDetails(j) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw details\n\t\t\tlet s;\n\t\t\tvar shivaNode=$.parseJSON(j.shivanode_json.und[0].value);\t\t\t\t\t\t\t// Get shiva data\n\t\t\tvar wid=shivaNode.width ? shivaNode.width+\"px\" : \"100%\";\t\t\t\t\t\t\t// If width set use it \n\t\t\tvar hgt=shivaNode.height ? shivaNode.height+\"px\" : \"calc(100% - 155px)\";\t\t\t// Height \n\t\t\tvar src=shivaNode.dataSourceUrl ? shivaNode.dataSourceUrl : \"\";\t\t\t\t\t\t// Data source\n\t\t\tvar str=`<iframe id='sui-iframe' frameborder='0' scrolling='no' src='${url}' \n\t\t\tstyle='margin-left:auto;margin-right:auto;height:${hgt};width:${wid};display:block;overflow:hidden'></Iframe><br>`;\t\n\t\t\tstr+=\"<div class='sui-sources' style='padding-top:0'>\";\n\t\t\ttry{ if (o.collection_title)\ts=`<a title='Collection' id='sui-imgCol'\thref='#p=${o.collection_uid_s}'>${o.collection_title}</a>`;\n\t\t\telse\t\t\t\t\t\t\ts=\"None\"; }  catch(e) {}\n\t\t\tstr+=\"<div style='text-align:center'>\"+d(\"&#xe633\",\"MANDALA COLLECTION\",s)+\"</div>\";\n\t\t\tstr+=\"<hr style='border-top: 1px solid #6e9456;margin-top:12px'>\";\n\t\t\ttry{ str+=d(\"&#xe63b\",\"TITLE\",o.title[0],\"Untitled\"); } catch(e){}\n\t\t\ttry{ str+=d(\"&#xe65f\",\"TYPE\",o.asset_subtype.replace(/:/g,\" | \")) } catch(e){}\n\t\t\ttry{ str+=d(\"&#xe60c\",\"DATE\",o.node_created.substr(0,10)) } catch(e){}\n\t\t\ttry{ str+=\"&#xe600&nbsp;&nbsp;<span class='sui-pageLab'>CREATOR</span>:&nbsp;&nbsp;<span class='sui-pageVal'>\";\n\t\t\t\tstr+=(o.node_user_full) ? o.node_user_full+\"&nbsp;&nbsp\" : \"\" +\"\";\n\t\t\t\tstr+=(o.node_user) ? o.node_user : \"\"; str+=\"</span>\"; } catch(e) {}\n\t\t\t\tif (j.field_kmaps_subjects && j.field_kmaps_subjects.und) {\t\t\t\t\t\t\t// If subjects\n\t\t\t\t\tstr+=\"<p class='sui-pageLab'>SUBJECTS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t// Add header\n\t\t\t\t\tfor (let i=0;i<j.field_kmaps_subjects.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=j.field_kmaps_subjects.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(j.field_kmaps_subjects.und[i].domain+\"-\"+j.field_kmaps_subjects.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < j.field_kmaps_subjects.und.length-1)\tstr+=\", \";\t\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End TERMS\n\t\t\t\t\t}\n\t\t\t\tif (j.field_kmaps_places && j.field_kmaps_places.und) {\t\t\t\t\t\t\t\t// If places\n\t\t\t\t\tstr+=\"<p class='sui-pageLab'>TERMS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t// Add header\n\t\t\t\t\tfor (let i=0;i<j.field_kmaps_places.und.length;++i) {\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=j.field_kmaps_places.und[i].header;\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(j.field_kmaps_places.und[i].domain+\"-\"+j.field_kmaps_places.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < j.field_kmaps_places.und.length-1)\tstr+=\", \";\t\t\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End PLACES\n\t\t\t\t\t}\n\t\t\t\tif (j.field_kmap_terms && j.field_kmap_terms.und) {\t\t\t\t\t\t\t\t\t// If terms\n\t\t\t\t\tstr+=\"<p class='sui-pageLab'>TERMS:&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t// Add TERMS header\n\t\t\t\t\tfor (let i=0;i<j.field_kmap_terms.und.length;++i) {\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\t\t\tstr+=j.field_kmap_terms.und[i].header;\t\t\t\t\t\t\t\t\t\t// Add name\n\t\t\t\t\t\tstr+=sui.pages.AddPop(j.field_kmap_terms.und[i].domain+\"-\"+j.field_kmap_terms.und[i].id);\t// Add drop\n\t\t\t\t\t\tif (i < j.field_kmap_terms.und.length-1)\tstr+=\", \";\t\t\t\t\t\t// Add separator\n\t\t\t\t\t\t}\n\t\t\t\t\tstr+=\"</p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// End TERMS\n\t\t\t\t\t}\t\t\n\t\t\tif (src) \t\tstr+=\"<p>&#xe678&nbsp;&nbsp;<a target='_blank' href='\"+src+\"'>External spreadsheet</a></p>\"; \n\t\t\tif (o.caption)\tstr+=o.caption;\t\t\n\t\n\t\t\tvar urlw=`[iframe src=\"${url}\" width=\"${wid}\" height=\"${hgt}\"]`;\t\t\t\t\t// Wordpress embed code\n\t\t\tvar urli=`&lt;iframe src=\\\"${url}\\\" width=\\\"${wid}\\\" height=\\\"${hgt}\\\"&gt;`;\t\t// Iframe\n\t\t\tstr+=`<hr>&#xe600&nbsp;&nbsp;<span class='sui-pageLab'>SHARE AS</span>:&nbsp;&nbsp;\n\t\t\t\t<a id='sui-share-1' style='display:inline-block;cursor:pointer'>Link&nbsp;&nbsp;&nbsp;</a>\n\t\t\t\t<a id='sui-share-2' style='display:inline-block;cursor:pointer'>WordPress&nbsp;&nbsp;&nbsp;</a>\n\t\t\t\t<a id='sui-share-3' style='display:inline-block;cursor:pointer'>Iframe&nbsp;&nbsp;&nbsp;</a>\n\t\t\t\t<p id='sui-resShare' style='border-radius:4px;background-color:#fff;padding:8px;display:none;border:1px solid #ccc'></p>\n\t\t\t\t</div>`;\n\n\t\t\t$(\"#sui-resShare\").html(\"<b>LINK</b>: ${url}\"); $(\"#sui-resShare\").toggle();\n\t\t\t$(sui.pages.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\t\t\tsui.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\t\t\n\t\t\t$(\"[id^=sui-share-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON THUMBNAIL CLICK\n\t\t\t\tvar id=e.currentTarget.id.split(\"-\")[2];\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif (id == \"1\")\t\t$(\"#sui-resShare\").html(url);\t\t\t\t\t\t\t\t// Link\n\t\t\t\telse if (id == \"2\")\t$(\"#sui-resShare\").html(`[iframe src=\"${url}\" width=\"${wid}\" height=\"${hgt}\"]`);\t\t// Wordpress embed code\n\t\t\t\telse if (id == \"3\")\t$(\"#sui-resShare\").html(`&lt;iframe src=\"${url}\" width=\"${wid}\" height=\"${hgt}\"&gt;`);\t// Iframe\n\t\t\t\t$(\"#sui-resShare\").show();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Toggle state\n\t\t\t\t});\n\t\t\t}\n\t}\n\n} // Visuals class closure","/* \tTEERMS PAGES ****************************************************************************************************************************\n\n\tThis module draws the terms page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the child data in the Terms index. \tThe terms icon\n\tand the term are shown, followed by a list of names associated with that term.\n\n\tThe related resources menu is drawn, which pulls data via another SOLR call. If an image is present\n\tit is drawn there. Below that is a browsable index of terms. Clicking on one will bring up that page.\n\n\tAn button will appear if there is a recording associated with the term,found by a third query to SOLR.\n\tClicking on it will play the various mp3 versions as available  and chosen by the pulldown menu.\n\n\tA tabbed menu shows the DEFINITIONS, whih lists the definition for that term, along with its language.\n\tThe DETAILS tab lists the subjects to this page Hovering over a blue popover icon will show more information \n\tabout it. The OTHER DICTIONARIES tab shows definitions from other dictionaries.\n\n\tThe tab will open to the DEFINATIONS tab is there are any, otehr wise it will open the OTHER DICTIONARIES\n\ttab, and fianlly the DETAILS tab\n\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tLooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n\t\n*********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\n\nexport default class Terms  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\t// sui.trm=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tthis.sui = sui;\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t\tthis.recordingGroup=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Which group\n\t\tthis.tabs=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Tab contents\n\t\tthis.tagged=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kmaps of tagged definitions\n\t\tthis.kmap=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Current kmap\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TERM PAGE FROM KMAP\n\t{\n\t\tconst LEGACY_SUI = this.sui;\n\t\tlet audioURLs=[\"\"];\n\t\tthis.kmap=o;\n\t\tvar str=`<div class='sui-terms' id='sui-terms' style=''>\n\t\t<span class='sui-termIcon'>${LEGACY_SUI.assets[o.asset_type].g}</span>&nbsp;&nbsp;&nbsp;\n\t\t<span class='sui-termTitle' id='sui-termTitle'>${o.title[0]}</span>\n\t\t<hr style='border-top: 1px solid ${LEGACY_SUI.assets[o.asset_type].c}'>\n\t\t<p id='sui-termNames'>Names</p>\n\t\t<div id='sui-player' style='display:none'>\n\t\t<p><div class='sui-termPlay' id='sui-termPlay'>&#xe60a</div>\n\t\t<select class='sui-termSpeak unpopulated' id='sui-termGroup'><option>AMDO GROUP</option></select></p></div>`;\n\t\tstr+=\"<div id='sui-termDetails'></div>\";\t\t\t\t\t\t\t\t\t\t\t\t// Add div for details\n\n\t\tstr+=\"<div id='sui-termDefs' class='sui-termOther'></div>\";\t\t\t\t\t\t\t\t// Add div for primary defs\n\t\tstr+=\"<br><div class='sui-termOHead'>OTHER DICTIONARIES</div>\";\t\t\t\t\t\t\t// Add other header\n\t\tstr+=\"<div id='sui-termOther' class='sui-termOther' style='padding:0 24px'></div></div>\";\t// Add div for other dictionaries\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\t\tthis.tabs=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start fresh\n\t\tthis.SetTabContent(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Fill tab contents\n\n\t\t/*\n\t\t * REFACTOR:  Audio Player\n\t\t * Todo:  Refactor Audio-Player into a more React-friendly form...\n\t\t *\n\t\t */\n\t\t$(\"#sui-termPlay\").off(\"click\").on(\"click\", (e)=>{\t\t\t\t\t\t\t\t\t\t// ON TERM PLAY\n\t\t\t// let snd=new Audio();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Init audio object\n\t\t\tlet snd=new Audio(audioURLs[this.recordingGroup]);\t\t\t\t\t\t\t\t\t\t// Load it\n\t\t\tsnd.play();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Play it\n\t\t\t});\n\n\t\t$(\"#sui-termGroup\").off(\"change\").on(\"change\", (e)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON GROUP SET\n\t\t\tthis.recordingGroup=$(\"#sui-termGroup\").prop('selectedIndex');\t\t\t\t\t\t// Get group\n\t\t\t});\n\n\t\tLEGACY_SUI.GetAudioFromID(o.id, (d)=>{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get audio info\n\t\t\taudioURLs=d; \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get urls\n\t\t\tif (d.length)\t\t$(\"#sui-player\").slideDown();\t\t\t\t\t\t\t\t\t// If any recording, show structure\n\t\t\tif (d.length > 1)\t$(\"#sui-termGroup.unpopulated\").append(\"<option>KHAM-HOR GROUP</option>\");\t// Add 2nd group if there\n\t\t\tif (d.length > 2)\t$(\"#sui-termGroup.unpopulated\").append(\"<option>CENTRAL TIBET DIALECT</option>\");\t// Add 3rd group if there\n\t\t\t$(\"#sui-termGroup.unpopulated\").removeClass(\"unpopulated\");\n\t\t});\n\t\t/* END REFACTOR:   Audio Player */\n\n\t\tLEGACY_SUI.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu\n\t}\n\n\tSetTabContent(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// FILL TABS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t{\n\t\tconst LEGACY_SUI = this.sui;\n\t\tLEGACY_SUI.GetChildDataFromID(o.uid,(odata)=> { \t\t\t\t\t\t\t\t\t\t\t\t// LOAD CHILD DATA\n\t\t\tlet i,k=1,l=0,t;\n\t\t\tlet str=\"<br>\",str2=\"\";\n\t\t\tlet str3=\"<div style='height:2px'/>\";\t\t\t\t\t\t\t\t\t\t\t\t// Spacer\n\t\t\tlet str4=\"<table>\";\n\t\t\tlet firstName=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// First name listed\n\t\t\ttry { \n\t\t\t\tlet data=odata._childDocuments_;\t\t\t\t\t\t\t\t\t\t\t\t// Point at data\n\t\t\t\tfor (i=0;i<data.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each doc\n\t\t\t\t\tif (data[i].id.match(/_definitions-/)) {\t\t\t\t\t\t\t\t\t// If a definition\n\t\t\t\t\t\tif (data[i].related_definitions_source_s) {\t\t\t\t\t\t\t\t// If another dictionary\n\t\t\t\t\t\t\tstr+=\"<div>\"+(k++)+\". <i>\"+data[i].related_definitions_source_s+\"</i></div>\";\t// Add title\n\t\t\t\t\t\t\tstr+=\"<p class='termDefs'>\";\n\t\t\t\t\t\t\tstr+=data[i].related_definitions_content_s;\t\t\t\t\t\t\t// Add text\n\t\t\t\t\t\t\tstr+=\"</p><div class='sui-termData'>\";\n\t\t\t\t\t\t\tif (data[i].related_definitions_author_s) str+=\"AUTHOR: \"+data[i].related_definitions_author_s+\" | \";\t\t\t\t\t\t\n\t\t\t\t\t\t\tstr+=\"LANGUAGE: \"+data[i].related_definitions_language_s;\t\t\t// Add language\n\t\t\t\t\t\t\tstr+=\"</div><br><hr style='border-top:1px solid #a2733f'>\";\t\t\t// End rule and div\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\telse{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// A primary definition\n\t\t\t\t\t\t\tstr2+=this.DrawTabMenu(l++,[l+\".&nbsp;&nbsp;DEFINITION\",\"DETAILS\",\"PASSAGES (0)\",\"RESOURCES (0)\"]);\t// Add tab menu\n\t\t\t\t\t\t\tt=[\"\",\"<br>\",\"<br>Waiting for data from Derik...<br><br><br><br>\",\"<br>\"] ;// New tab\n\t\t\t\t\t\t\tt[0]+=\"<div class='termDefs'>\";\n\t\t\t\t\t\t\tt[0]+=data[i].related_definitions_content_s;\t\t\t\t\t\t// Add text\n\t\t\t\t\t\t\tt[0]+=\"</div><div class='sui-termData'>\";\n\t\t\t\t\t\t\tif (data[i].related_definitions_author_s) t[0]+=\"AUTHOR: \"+data[i].related_definitions_author_s+\" | \";\t\t\t\t\t\t\n\t\t\t\t\t\t\tt[0]+=\"LANGUAGE: \"+data[i].related_definitions_language_s+\"</div><br><br>\"; // Add language\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tif (data[i][\"related_definitions_branch_subjects-185_header_s\"]) {\t// If a header\n\t\t\t\t\t\t\t\tt[1]+=data[i][\"related_definitions_branch_subjects-185_header_s\"].toUpperCase();\t\t\t\t\t\t// Add label\n\t\t\t\t\t\t\t\tt[1]+=\": <i>\"+data[i][\"related_definitions_branch_subjects-185_subjects_headers_t\"]+\"</i>\";\t\t\t\t// Add value\n\t\t\t\t\t\t\t\tt[1]+=LEGACY_SUI.pages.AddPop(data[i][\"related_definitions_branch_subjects-185_subjects_uids_t\"][0])+\"<br>\";\t// Add popover\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tt[1]+=\"LANGUAGE: <i>\"+data[i].related_definitions_language_s+\"</i>\";\n\n\t\t\t\t\t\t\tif (data[i][\"related_definitions_branch_subjects-184_subjects_uids_t\"]) {\n\t\t\t\t\t\t\t\tt[1] += LEGACY_SUI.pages.AddPop(data[i][\"related_definitions_branch_subjects-184_subjects_uids_t\"][0]) + \"<br>\";\t\t// Add popover\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (data[i][\"related_definitions_branch_subjects-5855_header_s\"]) {\t// If a header\n\t\t\t\t\t\t\t\tt[1]+=data[i][\"related_definitions_branch_subjects-5855_header_s\"].toUpperCase();\t\t\t\t\t\t// Add label\n\t\t\t\t\t\t\t\tt[1]+=\": <i>\"+data[i][\"related_definitions_branch_subjects-5855_subjects_headers_t\"]+\"</i>\";\t\t\t// Add value\n\t\t\t\t\t\t\t\tt[1]+=LEGACY_SUI.pages.AddPop(data[i][\"related_definitions_branch_subjects-5855_subjects_uids_t\"][0])+\"<br>\";\t// Add popover\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tt[1]+=\"<br>\";\n\t\t\t\t\t\t\tthis.tabs.push(t);\t\t\t\t\t\t\t\t\t\t\t\t\t// Add tab data for this def\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\tif (data[i].id.match(/_names-/)) {\t\t\t\t\t\t\t\t\t\t\t// If a name\n\t\t\t\t\t\tif (!firstName) firstName=data[i].related_names_header_s;\t\t\t\t// Save first name listed\n\t\t\t\t\t\tstr4+=`<tr><td <td style='padding-left:${data[i].related_names_level_i*16}px'>> <b>${data[i].related_names_header_s}&nbsp;&nbsp;&nbsp;</b></td><td>\n\t\t\t\t\t\t<i>${data[i].related_names_language_s}, ${data[i].related_names_writing_system_s}, ${data[i].related_names_relationship_s}\n\t\t\t\t\t\t</i></td></tr>`;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it\n\t\t\t\t\t\tstr+=\"</table><br>\";\t\t\n\t\t\t\t\t\t}\n\n\t\t\t\t\t// Todo: REFACTOR TabContent OUTPUT\n\t\t\t\t\t$(\"#sui-termNames\").html(str4+\"</table>\");\t\t\t\t\t\t\t\t\t// Add names\n\t\t\t\t\t$(\"#sui-termTitle\").html(`${firstName}&nbsp;&nbsp;&nbsp;${o.title[0]}`);\t// Add first\n\t\t\t\t\t// END REFACTOR\n\t\t\t\t\t}\n\t\t\t\t} catch(e) { throw (e)}\n\n\t\t\tfunction drawAssetButton(facet, defNum, num) {\n\t\t\t\tlet str=`<div id='sui-termAssetBut-${defNum}-${facet}'\n\t\t\t\t\tclass='sui-termAssetBut' style='background-color:${LEGACY_SUI.assets[facet].c}'>\n\t\t\t\t\t<span style='font-size:20px; vertical-align:-4px'>${LEGACY_SUI.assets[facet].g}&nbsp;</span>${facet}&nbsp;&nbsp;\n\t\t\t\t\t(${num})</div>`;\n\t\t\t\t\treturn str.replace(/\\t|\\n|\\r/g,\"\");\n\t\t\t\t}\n\t\t\t\t\n\t\t\tLEGACY_SUI.GetDefinitionAssets(o.uid, (data)=> {\t\t\t\t\t\t\t\t\t\t\t// MAKE TAGGED RESOUCES BUTTONS\n\t\t\t\tlet i,j,d,s,def,t=[];\n\t\t\t\tif (!data) \t\t\treturn \"\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if nothing tagged\n\t\t\t\tif (!data.length) \treturn \"\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if nothing tagged\n\t\t\t\tthis.tagged=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Init tagged array\n\t\t\t\tfor (i=0;i<this.tabs.length;++i) this.tagged.push([])\t\t\t\t\t\t\t// For each def, add array\n\t\t\t\n\t\t\t\tfor (i=0;i<data.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each result, get list of tagged assets\n\t\t\t\t\td=data[i];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at it\n\t\t\t\t\tif (d.asset_type == \"terms\")\tcontinue;\t\t\t\t\t\t\t\t\t// Skip terms\n\t\t\t\t\tfor (j=0;j<d.kmapid.length;++j) {\t\t\t\t\t\t\t\t\t\t\t// Look through kmapids\n\t\t\t\t\t\tdef=d.kmapid[j].match(/_definitions-(\\d*)/i);\t\t\t\t\t\t\t// A def?\n\t\t\t\t\t\tif (def) this.tagged[def[1]-1].push(d);\t\t\t\t\t\t\t\t\t// Add kmap\tif tied to a tag\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\n\t\t\t\tfor (i=0;i<this.tabs.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t// For each def, make button panel\n\t\t\t\t\tt.all=t.subjects=t.places=t.images=t.sources=t.visuals=t.collections=t.texts=t[\"audio-video\"]=0;\t// Reset counts\n\t\t\t\t\tfor (j=0;j<this.tagged[i].length;++j) {\t\t\t\t\t\t\t\t\t\t// For each tagged kmap in def\n\t\t\t\t\t\tt[this.tagged[i][j].asset_type]++;\t\t\t\t\t\t\t\t\t\t// Update count\n\t\t\t\t\t\tt[\"all\"]++;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Update total count\n\t\t\t\t\t\t}\n\t\t\t\t\ts=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Null title \n\t\t\t\t\tfor (j in t) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each asset type\t\n\t\t\t\t\t\tif (t[j]) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If anything tagged\n\t\t\t\t\t\t\ts=\"<b>Resources tagged with this definition: </b><br>\"; \t\t\t// Add title\n\t\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit looking\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\tfor (j in t) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each asset type\t\n\t\t\t\t\t\tif (t[j]) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If anything tagged\n\t\t\t\t\t\t\ts+=drawAssetButton(j,i,t[j]);\t\t\t\t\t\t\t\t\t\t// Make button\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t$(\"#sui-tabTab-\"+i+\"-3\").text(\"RESOURCES (\"+t[\"all\"]+\")\");\t\t\t\t\t// Set number of resources\n\t\t\t\t\tthis.tabs[i][3]+=s;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to definition tab\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\tstr3=\"<table style='width:100%'><tr>\"\t\t\t\t\t\t\t\t\t\t\t\t// Add subject types\n\t\t\taddSubjectsPopover(\"PHONEME\",o.data_phoneme_ss);\t\t\t\t\t\t\t\t\t\t\t\n\t\t\taddSubjectsPopover(\"GRAMMARS\",o.data_grammars_ss);\t\t\t\t\t\t\t\t\t\t\t\n\t\t\tstr3+=\"</tr><tr>\"\n\t\t\taddSubjectsPopover(\"TOPICS\",o.data_tibet_and_himalayas_ss);\t\t\t\t\t\t\t\t\t\t\t\n\t\t\taddSubjectsPopover(\"LITERARY PERIOD\",o.data_literary_period_ss);\t\t\t\t\t\t\t\n\t\t\tstr3+=\"</tr><tr>\"\n\t\t\taddSubjectsPopover(\"REGISTER\",o.data_register_ss);\t\t\t\t\t\t\t\t\t\t\t\n\t\t\taddSubjectsPopover(\"LANGUAGE CONTEXT\",o.data_language_context_ss);\n\t\t\tstr3+=\"</tr></table>\";\n\t\t\tif (odata.etymologies_ss && odata.etymologies_ss.length) {\t\t\t\t\t\t\t// If etymologies\n\t\t\t\tstr3+=\"<br><b>Etymology</b><br><div class='sui-termDefs'>\";\t\t\t\t\t\t// Add header\n\t\t\t\tfor (i=0;i<odata.etymologies_ss.length;++i) \t\t\t\t\t\t\t\t\t// For each one\n\t\t\t\t\tstr3+=odata.etymologies_ss[i];\t\t\t\t\t\t\t\t\t\t\t\t// Add it\n\t\t\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Close div\n\t\t\t\t}\n\t\t\t$(\"#sui-termDetails\").html(str3+\"<br>\");\t\t\t\t\t\t\t\t\t\t\t// Add Details\n\t\t\t$(\"#sui-termDefs\").html(str2.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t// Remove format and add primary defs to div\n\t\t\t$(\"#sui-termOther\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t// Remove format and add others to div\n\t\t\tfor (i=0;i<l;++i) this.ShowTab(i,0)\t\t\t\t\t\t\t\t\t\t\t\t\t// Open 1st tab\tin each def\t\n\t\t\t\n\t\t\tfunction addSubjectsPopover(title, val) {\t\t\t\t\t\t\t\t\t\t\t// ADD SUBJECTS\n\t\t\t\tlet i=0;\n\t\t\t\tif (!val)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if nothing there\n\t\t\t\tif (o.kmapid_subjects_idfacet) {\t\t\t\t\t\t\t\t\t\t\t\t// No facet data\n\t\t\t\t\tfor (i=0;i<o.kmapid_subjects_idfacet.length;++i)\t\t\t\t\t\t\t// For each one\n\t\t\t\t\t\tif (o.kmapid_subjects_idfacet[i].split(\"|\")[0] == val)\t\t\t\t\t// Find a match\n\t\t\t\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t\t\ti=Math.min(o.kmapid_subjects_idfacet.length-1,i);\t\t\t\t\t\t\t// Cap\n\t\t\t\t\t}\n\t\t\t\tstr3+=`<td>${title}: <i>${val}</i>`; // Add title\n\n\n\t\t\t\t// WARNING: changes str3 via context\n\t\t\t\tif (o.kmapid_subjects_idfacet)\t\t\t\t\t\t\t\t\t\t\t\t\t// If data\n\t\t\t\t\tstr3+=LEGACY_SUI.pages.AddPop(o.kmapid_subjects_idfacet[i].split(\"|\")[1])+\"</td>\";\t// Add popover\n\t\t\t\telse\n\t\t\t\t\tstr3+=LEGACY_SUI.pages.AddPop(o.related_uid_ss[i])+\"</td>\";\t\t\t\t\t\t// Add popover\n\t\t\t\t}\t\n\t\t});\n\t}\n\n\tDrawTabMenu(num, tabs)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TAB MENU\n\t{\n\t\tlet i,str=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\tfor (i=0;i<tabs.length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each tab\t\n\t\t\tstr+=`<div class='sui-tabTab' id='sui-tabTab-${num}-${i}' style='display:inline-block;text-align:left;padding-left:24px;width:calc(25% - 26px)'>\n\t\t\t${tabs[i]}&nbsp;&#xe609</div>`;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add it\n\t\t\t}\n\t\tstr+=`<div class='sui-tabContent' id='sui-tabContent-${num}'>hhh</div>`;\t\t\t\t// Tab contents\n\t\treturn str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Return tab markup\n\t}\n\n\tShowTab(num, which) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW TAB\n\t{\n\t\tconst LEGACY_SUI = this.sui;\n\t\t$(\"[id^=sui-tabTab-\"+num).css({\"background-color\":\"#999\",color:\"#fff\",\"border-top\":\"1px solid #999\"});\t// Reset all tabs\n\t\t$(\"#sui-tabContent-\"+num).css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t// Show content\n\t\t$(\"#sui-tabTab-\"+num+\"-\"+which).css({\"background-color\":\"#eee\",color:\"#000\",\"border-top\":\"1px solid #a2733f\"});\t// Active tab\n\t\t$(\"#sui-tabContent-\"+num).html(this.tabs[num][which]);\t\t\t\t\t\t\t\t\t// Set content\n\n\t\t$(\"[id^=sui-tabTab]\").off();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill old handlers\n\t\t$(\"[id^=sui-termAssetBut-]\").off();\n\t\n\t\t$(\"[id^=sui-termAssetBut-]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t// ON TAGGED BUTTON CLICK\n\t\t\tlet i,v=e.currentTarget.id.substring(17).split(\"-\");\t\t\t\t\t\t\t\t// Get def and facet type\n\t\t\tLEGACY_SUI.ss.mode=\"related\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Go to related mode\n\t\t\tif (v[1] == \"audio\")\tv[1]=\"audio-video\";\t\t\t\t\t\t\t\t\t\t\t// Compensate for extra '-'\n\t\t\tLEGACY_SUI.pages.relatedType=v[1];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set asset type\n\t\t\tLEGACY_SUI.pages.relatedBase=this.kmap;\t\t\t\t\t\t\t\t\t\t\t\t\t// Set base\t\t\t\t\t\t\t\t\t\n\t\t\tLEGACY_SUI.pagesrelatedId=LEGACY_SUI.pages.relatedBase.asset_type+\"-\"+LEGACY_SUI.pages.relatedBase.id;\t// Set id\n\t\t\tif (v[1] == \"all\")\tLEGACY_SUI.curResults=this.tagged[v[0]];\t\t\t\t\t\t\t\t// Show all\n\t\t\telse {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Just one\n\t\t\t\tLEGACY_SUI.curResults=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear\n\t\t\t\tfor (i=0;i<this.tagged[v[0]].length;++i)\t\t\t\t\t\t\t\t\t\t// For each asset\n\t\t\t\t\tif (this.tagged[v[0]][i].asset_type == v[1])\t\t\t\t\t\t\t\t// If it matches\n\t\t\t\t\t\tLEGACY_SUI.curResults.push(this.tagged[v[0]][i]);\t\t\t\t\t\t\t\t// Add it\n\t\t\t\t}\n\t\t\tLEGACY_SUI.DrawResults();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw results\n\t\t\t});\n\n\t\t$(\"[id^=sui-tabTab]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\tvar id=e.currentTarget.id.substring(11);\t\t\t\t\t\t\t\t\t\t\t// Get index of tab\t\n\t\t\tlet v=id.split(\"-\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get num and which\n\t\t\tthis.ShowTab(v[0],v[1]);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t\t});\n\t}\n\n\n} // CLASS CLOSURE\n","/* \tCOLLECTIONS PAGES ****************************************************************************************************************************\n\n\tThis module draws the collections page based on a kmap from SOLR. Some information comes from the kmap\n\tpassed in and some from the a second query from the JSON data coming from Drupal. \t\n\t\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tJSON:\t\tFrom Drupal site\n\tGlobals:\tLooks for sui and sui.pages\n\tDependents:\tpages.js, searchui.js\t\t\t\t\t\t\t\t// JS modules called\n\n*********************************************************************************************************************************************/\nimport $ from 'jquery';\n\nexport default class Collections  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"SearchUI must be passed to constructor\");\n\t\t}\n\t\tthis.div=sui.pages.div;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page (same as Pages class)\n\t\tthis.content=[\"\",\"\",\" \"];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Content pages\n\t\tthis.sui=sui;\n\t}\n\n\tDraw(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW SOURCE PAGE FROM KMAP\n\t{\n\t\tconst sui = this.sui;\n\t\tlet a=sui.assets[o.asset_subtype.toLowerCase()];\n\t\tvar str=`<div id='sui-topCon' style='margin-left:192px'>\n\t\t<div class='sui-sources'  id='sui-collections'>\n\t\t\t<span style='font-size:24px;color:${a.c};vertical-align:-4px'>${a.g}</span>\n\t\t\t&nbsp;&nbsp;<span class='sui-sourceTitle'>${o.title[0]}</span>\n\t\t\t&nbsp;&nbsp;(${o.asset_subtype.toUpperCase()})\n\t\t\t<hr style='border-top: 1px solid ${sui.assets[o.asset_type].c}'>\n\t\t\t<div class='sui-sourceSec' id='sui-srcSec'></div><br>`;\n\t\tif (o.url_thumb && !o.url_thumb.match(/gradient.jpg/)) str+=\"<img src='\"+o.url_thumb+\"' style='width:33%;padding-right:12px;vertical-align:top'>\";\n\t\tif (o.summary)\n\t\t\tstr+=`<div class='sui-sourceText' style='display:inline-block;width:calc(66% - 12px)'>${o.summary}</div>`;\n\t\tstr+=\"<br><br>\"+sui.pages.DrawTabMenu([\"RELATED COLLECTIONS\",\"MEMBERS\",\"DETAILS\"])+\"</div>\";\t// Add tab menu\n\t\t$(this.div).html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\t\n\n\t\t$(\"[id^=sui-tabTab]\").on(\"click\", (e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON TAB CLICK\n\t\t\tvar id=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t\t// Get index of tab\t\n\t\t\tthis.ShowTab(id);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw it\n\t\t\t});\n\n\t\t$(\"#sui-imgCol\").on(\"click\",()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON COLLECTION CLICK\n\t\t\tsui.GetKmapFromID(o.collection_uid_s,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t// Get kmap and show page\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t\t});\n\t\t\t\n\t\tsui.pages.DrawRelatedAssets(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw related assets menu if active\n\t\tthis.AddTabContent(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add contents of tabs\n\t\tthis.ShowTab(0);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show collections\n\t\t}\n\t\n\tAddTabContent(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET TAB CONTENTS\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,a,tab=0;\n\t\tthis.content[0]=\"<br>\";\n\t\tlet base=o.asset_subtype.toLowerCase()+\"-collection-\";\t\t\t\t\t\t\t\t\t// Collections base id\n\t\t\ttry {if (o.collection_title_path_ss)\t{\t\t\t\t\t\t\t\t\t\t\t\t// If a parent\n\t\t\ta=o.collection_uid_path_ss;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get parent id\n\t\t\tthis.content[0]+=`<div><a href='#p=${a}' id='sui-spItem-${a}+\"'>${o.collection_title_path_ss}</a></div>`; // Add\n\t\t\ttab++;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Next tab\t\n\t\t} } catch(e){}\n\t\n\t\tthis.content[0]+=`<div style='margin-left:${tab*24}px'><b>${o.title[0]}</b></div>`; \t\t\t// Add\n\t\n\t\tif (o.subcollection_name_ss && o.subcollection_name_ss.length) \t{\t\t\t\t\t\t// If subcollections\n\t\t\ttab++;\n\t\t\tfor (i=0;i<o.subcollection_name_ss.length;++i) {\t\t\t\t\t\t\t\t\t// For each sub\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\ta=base+o.subcollection_id_is[i];\t\t\t\t\t\t\t\t\t\t\t\t// Make full id\n\t\t\t\tthis.content[0]+=`<div style='margin-left:${tab*24}px'><a  href='#p=${a}' id='sui-spItem-${a}+\"'>${o.subcollection_name_ss[i]}</a></div>`; // Add\n\t\t\t\t}\n\t\t\t}\t\n\t\tthis.content[0]+=\"<br><br>\";\n\t\tthis.content[1]=\"\";\n\t\tif (o.members_name_ss && o.members_name_ss.length) {\t\t\t\t\t\t\t\t\t// If members\n\t\t\tfor (i=0;i<o.members_name_ss.length;++i)\t\t\t\t\t\t\t\t\t\t\t// For each member\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tthis.content[1]+=\"<br>\"+o.members_name_ss[i]+\" &nbsp; (\"+o.members_id_ss[i]+\")\"; // Add\n\t\t\tthis.content[1]+=\"<br><br>\";\n\t\t\t}\t\n\t\tthis.content[2]=\"<br>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Advance to details tab\n\t\tif (o.node_user_full_s) this.content[2]+=sui.pages.DrawItem(\"&#xe600\",\"OWNER\",o.node_user_full_s+\" &nbsp; (\"+o.node_user+\")\",\"\",\"sui-pageLab\",1);\t// Owner\n\t\tif (o.collection_visibility_s) this.content[2]+=sui.pages.DrawItem(\"&#xe622\",\"VISIBILITY\",o.collection_visibility_s.substr(0,1).toUpperCase()+o.collection_visibility_s.substr(1),\"\",\"sui-pageLab\",1);\t// Visibility\n\t\tif (o.asset_subtype) this.content[2]+=sui.pages.DrawItem(sui.assets[o.asset_subtype.toLowerCase()].g,\"TYPE\",o.asset_subtype,\"\",\"sui-pageLab\",1);\t// Type\n\t\tif (o.collection_title) this.content[2]+=sui.pages.DrawItem(sui.assets[o.asset_subtype.toLowerCase()].g,\"COLLECTION\",`<a title='Collection' id='sui-imgCol'\thref='#p=${o.collection_uid_s}'>${o.collection_title}</a>`,\"\",\"sui-pageLab\",1);\t// Type\n\t\tthis.content[2]+=\"<br>\";\n\t}\n\n\tShowTab(which) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW TAB\n\t{\n\t\t$(\"[id^=sui-tabTab]\").css({\"background-color\":\"#999\",color:\"#fff\" });\t\t\t\t\t// Reset all tabs\n\t\t$(\"#sui-tabContent\").css({display:\"block\",\"background-color\":\"#eee\"});\t\t\t\t\t// Show content\n\t\t$(\"#sui-tabTab\"+which).css({\"background-color\":\"#eee\",color:\"#000\"});\t\t\t\t\t// Active tab\n\t\t$(\"#sui-tabContent\").html(this.content[which]);\t\t\t\t\t\t\t\t\t\t\t// Set content\n\t}\n\n\n} // Collections class closure\n","/* \tPAGES ****************************************************************************************************************************\n\n\tThis module provide the backbone to draw individual asset pages, and control the somewhat complex flow\n\twhen browsing collections and related resources. It routes to the specific modules that draw a page based on a kmap,\n\tand it contains helper functions to  that all pages use to draw (.e. headers, footers, related assets, popovers)\n\n\tIt allocates the indivisual page classes and puts pointer to them in the global app variable (sui)\n\n\t\n\tRequires: \tjQuery \t\t\t\t\t\t\t\t\t\t\t\t// Almost any version should work\n\tCalls:\t\tseachui.js, audiovideo.js, places.js,\t\t\t\t// Other JS modules that are dynamically loaded (not ued in plain search)\n\t\t\t\ttexts.js, images.js, subjects.js, sources.js,\n\t\t\t\tterms.js, places.js, visuals.js\n\tCSS:\t\tsearchui.css\t\t\t\t\t\t\t\t\t\t// All styles are prefixed with 'sui-'\n\tJS:\t\t\tECMA-6\t\t\t\t\t\t\t\t\t\t\t\t// Uses lambda (arrow) functions\n\tImages:\t\tpopover.png\n\tGlobals:\tsui\t\t\t\t\t\t\t\t\t\t\t\t\t// Declared globally\n\n********************************************************************************************************************************************/\n/* eslint-disable */\nimport $ from 'jquery';\n\nimport Places from './places';\nimport AudioVideo from './audiovideo';\nimport Subjects from './subjects';\nimport Images from './images';\nimport Texts from './texts';\nimport Sources from './sources';\nimport Visuals from './visuals';\nimport Terms from './terms';\nimport Collections from './collections';\n\nexport default class Pages  {\n\n\tconstructor(sui)   \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CONSTRUCTOR\n\t{\n\t\tif (!sui) {\n\t\t\tthrow new Error(\"sui must be defined in constructor\");\n\t\t}\n\t\tthis.sui = sui;\n\t\tsui.pages=this;// Save context\n\t\t\n\t\t// OUTPUT DIVS\n\t\tthis.div=$(\"<div></div>\"); //\"#sui-legacy\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Div to hold page\n\t\tthis.reldiv=$(\"<div></div>\"); // '#sui-legacy-related';\n\t\t\n\t\tthis.relatedBase=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds based kmap for related\n\t\tthis.relatedType=\"Home\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds current related category\n\t\tthis.relatedId=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Holds current related id\n\t\tthis.lastMode=sui.ss.mode;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Previous search mode\n\t\tthis.curKmap=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Currently active page kmap\n\t\tthis.carouselTimer=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Timer to advance carousel\n\t\tsui.plc=new Places(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc places module (standalone)\n\t\tsui.av=new AudioVideo(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc AV (standalone)\n\t\tsui.sub=new Subjects(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Subjects (standalone)\n\t\tsui.img=new Images(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Images (standalone)\n\t\tsui.txt=new Texts(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Texts (standalone)\n\t\tsui.src=new Sources(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Sources (standalone)\n\t\tsui.vis=new Visuals(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Visuals (standalone)\n\t\tsui.trm=new Terms(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Terms (standalone)\n\t\tsui.col=new Collections(sui);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Alloc Collections (standalone)\n\t\tthis.recentPages=[];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Hold recent pages (title|id)\n\t\tthis.editing=false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Show editing interface?\n\t\tif (window.location.hash) sui.PageRouter(window.location.hash);\t\t\t\t\t\t\t\t\t\t// Go to particular page\n\t}\n\n\tDraw(kmap, fromHistory)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW KMAP PAGE\n\t{\n\t\tconsole.error(\"pages.Draw() called! with args: \");\n\t\tconsole.dir(arguments);\n\t\tconst sui = this.sui;\n\t\tclearInterval(this.carouselTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill carousel timer\n\t\tif (!kmap)\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if no kmap\n\t\tif (!fromHistory)\tsui.SetState(`p=${kmap.uid}`);\t\t\t\t\t\t\t\t\t\t// This is the active page\n\t\tthis.curKmap=kmap;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set active page's map\n\t\tthis.recentPages.push(kmap.uid+\"|\"+kmap.title+\"|\"+kmap.asset_type);\t\t\t\t\t\t// Add to recents list\n\t\tlet i,n=this.recentPages.length-1;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Length of recents\t\n\t\tfor (i=n-1;i>=0;--i)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Work backwards\n\t\t\tif (this.recentPages[i] == this.recentPages[n]) {\t\t\t\t\t\t\t\t\t// Ff already saved \n\t\t\t\tthis.recentPages.splice(i,1);\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove it \n\t\t\t\tbreak;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit looking\n\t\t\t\t}\n\t\tif (sui.ss.mode != \"related\") {\n\t\t\tthis.DrawHeader(kmap);\t\t\t\t\t\t\t// Draw header if not showing relateds\n\t\t}\n\n\t\t// Style sui-legacy\n\t\t$(this.div).css({ \"background-image\":\"\"});\t\t\t\t\t\t\t\t\t\t// Remove any backgeound image\n\t\t$(this.div).css({ \"padding-left\":\"12px\", width:\"calc(100% - 24px\"});\t\t\t\t// Reset to normal size and hide\n\t\t$(this.div).css({ display:\"block\",color:\"#000\"});\t\t\t\t\t\t\t\t\t\t// Show page\n\t\tif (sui.ss.mode == \"related\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If browsing related pages\n\t\t\tif (!kmap.asset_type.match(/places|subjects|terms/))\t\t\t\t\t\t\t\t// Need to add space for these types\n\t\t\t\t$(this.div).css({ \"padding-left\": \"192px\", width:\"calc(100% - 216px\"});\t\t\t// Shrink page\n\t\t\t}\n\n\t\t// Draw Content\n\t\tif (kmap.asset_type == \"places\")\t\t\tsui.plc.Draw(kmap);\t\t\t\t\t\t\t// Show place\n\t\telse if (kmap.asset_type == \"sources\") \t\tsui.src.Draw(kmap);\t\t\t\t\t\t\t// Source\n\t\telse if (kmap.asset_type == \"terms\") \t\tsui.trm.Draw(kmap);\t\t\t\t\t\t\t// Term\n\t\telse if (kmap.asset_type == \"subjects\") \tsui.sub.Draw(kmap);\t\t\t\t\t\t\t// Subject\n\t\telse if (kmap.asset_type == \"images\") \t\tsui.img.Draw(kmap);\t\t\t\t\t\t\t// Image\n\t\telse if (kmap.asset_type == \"audio-video\") \tsui.av.Draw(kmap);\t\t\t\t\t\t\t// AV\n\t\telse if (kmap.asset_type == \"texts\") \t\tsui.txt.Draw(kmap);\t\t\t\t\t\t\t// Text\n\t\telse if (kmap.asset_type == \"visuals\") \t\tsui.vis.Draw(kmap);\t\t\t\t\t\t\t// Visual\n\t\telse if (kmap.asset_type == \"collections\") \tsui.col.Draw(kmap);\t\t\t\t\t\t\t// Collections\n\t}\n\n\tShowPopover(id, event)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DISPLAY KMAP DROP DOWN FROM EVENT\n\t{\n\t\tconst sui = this.sui;\n\t\tif (id && id.match(/collections-/))\t\t\t\t\t\t\t\treturn;\t\t\t\t\t// No maps for collections yet\n\t\tif (this.PopoverTimer && (event.type == \"mousemove\")) \t\t\treturn;\t\t\t\t\t// Already timeing one\n\t\tif ((event.type == \"mousemove\") && (id == this.lastPopover)) \treturn;\t\t\t\t\t// Already in this one\n\t\tif (event.type == \"mousedown\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Click on popover\n\t\t\tif (sui.ss.mode == \"related\")  sui.ss.mode=this.lastMode;\t\t\t\t\t\t\t// Get out of related and collections\n\t\t\tthis.relatedBase=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No base and set to home\n\t\t\tsui.GetKmapFromID(id,(kmap)=>{ this.Draw(kmap); });\t\t\t\t\t\t\t\t\t// Get kmap and show page\n\t\t\tthis.ClearPopover();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear popover\t\n\t\t\treturn;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit\n\t\t\t}\n\t\tthis.PopoverTimer=setTimeout(()=>{ this.DisplayPopover(id,event)},500);\t\t\t\t\t// Draw it\n\t}\n\n\tClearPopover()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// CLEAR KMAP DROP DOWN\n\t{\n\t\tclearTimeout(this.PopoverTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\tthis.PopoverTimer=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill flag\n\t\t$(\"[id^=sui-popover-]\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove old one\n\t\tthis.lastPopover=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear last\n\t}\n\n\t// CALLS sui.GetKmapFromID();\n\t// MAKES AJAX CALLS\n\n\t// Todo:  Refactor popup closing:(ClearPopovers)\n\tDisplayPopover(id, event)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ACTUALLY DISPLAY KMAP DROP DOWN\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,pos;\n\n\t\tclearTimeout(this.PopoverTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\tthis.PopoverTimer=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill flag\n\n\t\tif (event.target) {\n\t\t\tpos=$(event.target).offset();\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get position of icon\n\t\telse {\n\t\t\tpos=$(\"#plc-main\").offset();\n\t\t\tpos.top+=event.y;\n\t\t\tpos.left+=event.x;\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If coming from a map\n\t\tlet x=Math.max(160,Math.min(pos.left,$(\"#sui-main\").width()-200));\t\t\t\t\t\t// Cap sides\n\t\tlet offset=pos.left-x+150;\t// Offset for triangle\n\t\tlet offsetString = String(offset) + 'px';\n\t\tif (!pos.top) {\n\t\t\treturn;\n\t\t} // Race condition\n\t\tthis.lastPopover=id;\n\n\t\t// DRAW POPOVER DATA\n\t\tsui.GetKmapFromID(id,(o)=>{ \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// GET KMAP DATA\n\t\t\tlet v;\n\t\t\tif (!o)  return; \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if nothing\n\t\t\t$(\"[id^=sui-popover-]\").remove();\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove old one\n\t\t\tlet str=`<div id='sui-popover-${id}' class='sui-popover' \n\t\t\tstyle='top:${pos.top+24+$(this.div).scrollTop()}px;left:${x-150}px'>\n\t\t\t<div style='position:absolute;width:0;height:0;border-left:8px solid transparent;\n\t\t\tborder-right:8px solid transparent;border-bottom:10px solid #999;top:-10px;\n\t\t\tleft:${offsetString}'</div>\n\t\t\t<div style='position:absolute;width:0;height:0;border-left:8px solid transparent;\n\t\t\tborder-right:8px solid transparent;border-bottom:10px solid white;left:-8px;top:2px;'</div>\n\t\t\t</div>`;\n\t\t\t$(\"#sui-main\").append(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\t\t// one-time trap to clear popover\n\t\t\t$(\"#sui-main\").one('mousemove', () => {\n\t\t\t\tconsole.log(\"clearing popover on mousemove \" + event.target);\n\t\t\t\tthis.ClearPopover();\n\t\t\t});\n\n\t\t\tstr=`<div style='float:right;margin-top:-8px;font-size:10px'>${o.id}</div>\n\t\t\t<b>${o.title[0]}</b><hr style='border-top:1px solid #ccc'>\n\t\t\t<span style='font-size:12px;text-transform:capitalize'>\n\t\t\tFor more information about this ${o.asset_type.slice(0,-1)}, see Full Entry below.<p>`;\n\t\t\tif (o.feature_types_idfacet && (o.asset_type == \"places\")) {\t\t\t\t\t\t// Show Feature types in places\n\t\t\t\tstr+=\"<b>Feature types: </b>\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\t\t\tfor (i=0;i<o.feature_types_idfacet.length;++i) {\t\t\t\t\t\t\t\t// For each feature\n\t\t\t\t\tv=o.feature_types_idfacet[i].split(\"|\");\t\t\t\t\t\t\t\t\t// Split title and id\n\t\t\t\t\tstr+=`<a class='sui-crumb' style='color:#000;text-transform:none' id='sui-crumb-${v[1]}'\n\t\t\t\t\thref='#p=${v[1]}'>${v[0]}</a>`;\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (i < o.feature_types_idfacet.length-1)\tstr+=\", \";\t\t\t\t\t\t// Add separator\n\t\t\t\t\telse str+=\"<br>\"\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\tif (o.ancestors_txt && o.ancestors_txt.length > 1)\tstr+=`<b>${o.asset_type}: </b>`; // Show header if any breadcrumbs\n\t\t\tif (o.ancestors_txt)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If breadcrumbs\n\t\t\t\tfor (i=0;i<o.ancestors_txt.length-1;++i) {\t\t\t\t\t\t\t\t\t\t// For each trail member\n\t\t\t\t\tstr+=`<a class='sui-crumb' style='color:#000;text-transform:none' id='sui-crumb-${o.asset_type}-${o.ancestor_ids_is[i]}'\n\t\t\t\t\thref='#p=${o.asset_type}-${o.ancestor_ids_is[i]}'>${o.ancestors_txt[i]}</a>`;\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (i < o.ancestors_txt.length-2)\tstr+=\" / \";\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t\t}\n\t\t\tstr+=`</p></span><br>\n\t\t\t<div id='sui-popbot' style='width:100%;padding:1px 12px;background-color:#333;font-size:14px;\n\t\t\tborder-radius:0 0 6px 6px;color:#ddd;margin:-12px;cursor:pointer'>\n\t\t\t<a class='sui-popItem' href='#p=${o.uid}'>\n\t\t\t<p id='sui-full-${o.uid}'>&#xe629&nbsp;&nbsp;FULL ENTRY</p></a>\n\t\t\t</div>`;\n\t\t\t$(\"#sui-popover-\"+id).append(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\t\t// MOUSELEAVE LISTENER\n\t\t\t$(\"#sui-popover-\"+id).on('mouseleave', () => { this.ClearPopover(); } );\n\n\t\t\t$(\"#sui-full-\"+id).on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON FULL ENTRY CLICK\n\t\t\t\tthis.ClearPopover();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear popover\t\n\t\t\t\tif (sui.ss.mode == \"related\")  sui.ss.mode=this.lastMode;\t\t\t\t\t\t// Get out of related and collections\n\t\t\t\tthis.relatedBase=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No base and set to home\n\t\t\t\tvar id=e.currentTarget.id.substring(9).toLowerCase();\t\t\t\t\t\t\t// Get id\n\t\t\t\tsui.GetKmapFromID(id,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t\t\t\t// Get kmap and show page\n\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t\t\t});\n\t\t\t\n\t\t\t$(\"[id^=sui-crumb-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON BREAD CRUMB CLICK\n\t\t\t\tthis.ClearPopover();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear popover\t\n\t\t\t\tif (sui.ss.mode == \"related\")\t sui.ss.mode=this.lastMode;\t\t\t\t\t\t// Get out of related and collections\n\t\t\t\tthis.relatedBase=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No base and set to home\n\t\t\t\tvar id=e.currentTarget.id.substring(10).toLowerCase();\t\t\t\t\t\t\t// Get id\n\t\t\t\tsui.GetKmapFromID(id,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t\t\t\t// Get kmap and show page\n\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t\t\t});\n\t\t\t});\n\n\t\t// DRAW MORE POPOVER DATA\n\t\tvar url=sui.solrUtil.createKmapQuery(id,null,null,300);\t\t\t\t\t\t\t\t\t// Get query url\n\t\t$.ajax( { url: url,  dataType: 'jsonp', jsonp: 'json.wrf' }).done((data)=> {\t\t\t// Get related places\n\t\t\tlet i,n,str=\"\";\n\t\t\tif ($(\"[id^=sui-pop-]\")[0])\treturn; \t\t\t\t\t\t\t\t\t\t\t\t// Quit if already loaded\n\t\t\tif (data.facets.asset_counts.buckets && data.facets.asset_counts.buckets.length){\t// If valid data\n\t\t\t\tlet d=data.facets.asset_counts.buckets;\t\t\t\t\t\t\t\t\t\t\t// Point at bucket array\n\t\t\t\tfor (i=0;i<d.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each bucket\n\t\t\t\t\tn=d[i].count;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get count\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tif (d[i].val == \"texts:pages\") continue;\t\t\t\t\t\t\t\t\t// Ignore pages of texts\n\t\t\t\t\tif (n > 1000)\tn=Math.floor(n/1000)+\"K\";\t\t\t\t\t\t\t\t\t// Shorten\n\t\t\t\t\tstr+=`<a class='sui-popItem' href='#v=${id}=${d[i].val}'>\n\t\t\t\t\t<p id='sui-pop-${id}-${d[i].val}' style='cursor:pointer;text-transform:capitalize'>\n\t\t\t\t\t<span style='color:${sui.assets[d[i].val].c}'>${sui.assets[d[i].val].g}</span>\n\t\t\t\t\t&nbsp;&nbsp;Related ${d[i].val} (${n})</p></a>`;\n\t\t\t\t\t}\n\t\t\t\t$(\"#sui-popbot\").append(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t// Remove format and add to div\n\t\t\t\t\n\t\t\t\t$(\"[id^=sui-pop-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t// ON ITEM CLICK\n\t\t\t\t\tthis.ClearPopover();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Clear popover\t\n\t\t\t\t\tlet v=e.currentTarget.id.toLowerCase().split(\"-\");\t\t\t\t\t\t\t// Get id\n\t\t\t\t\tif (v[4] == \"audio\") v[4]=\"audio-video\";\t\t\t\t\t\t\t\t\t// Rejoin AV\n\t\t\t\t\tlet url=sui.solrUtil.createKmapQuery(v[2]+\"-\"+v[3],v[4],0,1000);\t\t\t// Get query url\n\t\t\t\t\t$.ajax( { url: url,  dataType: 'jsonp', jsonp: 'json.wrf' }).done((data)=>{ // Get related places\n\t\t\t\t\t\tsui.curResults=sui.MassageKmapData(data.response.docs);\t\t\t\t\t// Normalize for display\n\t\t\t\t\t\tsui.DrawItems();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw items\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tsui.DrawFooter();\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw footer\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tsui.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at beginning\n\t\t\t\t\t});\n\t\t\t\t\tsui.GetKmapFromID(id,(o)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// Get kmap\n\t\t\t\t\t\t this.relatedBase=o;\t\t\t\t\t\t\t\t\t\t\t\t\t// Set new base\n\t\t\t\t\t\t\tthis.relatedId=o.asset_type+\"-\"+o.id;\t\t\t\t\t\t\t\t// Set id\n\t\t\t\t\t\t\tthis.DrawHeader(o);\t\t\t\t\t\t\t\t\t\t\t\t\t// Set header\n\t\t\t\t\t\t\t});\n\t\t\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// RELATED SIDEBAR\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\t// ARGUMENT o: kmassets solr entry\n\t// ARGUMENT fromHistory: boolean that determines whether a new history item is pushed\n\t// CALLS sui.GetKmapFromID()\n\t// MAKES AJAX CALLS\n\t// ATTACHES HANDLERS WHICH CALL this.DrawRelatedResults(o), sui.plc.Draw(), sui.sub.Draw();\n\tDrawRelatedAssets(o, fromHistory)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RELATED ASSETS MENU\n\t{\n\t\tconsole.error(\"pages.DrawRelatedAssets() called with arguments\");\n\t\tconsole.dir(arguments);\n\t\tconst sui = this.sui;\n\t\tlet i, v, k, sk, str = \"\", browse = true;\n\t\tlet p = (this.relatedBase || o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Pointer to base kmap\n\t\tif (p) {\n\t\t\tbrowse = p.asset_type.match(/places|subjects|terms|collections/);\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add browsing to this menu?\n\n\t\tif (sui.ss.mode == \"related\") {\n\t\t\to = this.relatedBase;\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If special, use base\n\t\telse {\n\t\t\tthis.lastMode = sui.ss.mode;\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save last search mode\n\n\t\t// SHORT CIRCUIT\n\t\tif (!o) {\n\t\t\treturn;\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No related to show\n\n\t\t// SHORT CIRCUIT\n\t\tif (!browse && (sui.ss.mode != \"related\")) {\n\t\t\treturn;\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Quit if not related or a sub/term/place/collection\n\n\t\t// SIDE QUERY FOR COLLECTIONS\n\t\tif (p.asset_type != \"collections\") {\n\t\t\tvar url = sui.solrUtil.createKmapQuery(o.uid);\t\t\t\t\t\t\t\t\t\t// Get query url\n\t\t\t$.ajax({url: url, dataType: 'jsonp', jsonp: 'json.wrf'}).done((data) => {\t\t// Get related assets\n\t\t\t\tvar i, n, tot = 0;\n\t\t\t\tif (data.facets.asset_counts.buckets && data.facets.asset_counts.buckets.length) { // If valid data\n\t\t\t\t\tlet d = data.facets.asset_counts.buckets;\t\t\t\t\t\t\t\t\t\t// Point at bucket array\n\t\t\t\t\tfor (i = 0; i < d.length; ++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each bucket\n\t\t\t\t\t\tif (d[i].val == \"texts:pages\") continue;\t\t\t\t\t\t\t\t// Skip it\n\t\t\t\t\t\tif ((o.asset_type == \"terms\") && (d[i].val == \"terms\")) continue;\t\t// Skip\n\t\t\t\t\t\tn = d[i].count;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get count\n\t\t\t\t\t\ttot += n;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add to total\n\t\t\t\t\t\tif (n > 1000) n = Math.floor(n / 1000) + \"K\";\t\t\t\t\t\t\t\t// Shorten\n\t\t\t\t\t\t$(\"#sui-rln-\" + d[i].val).html(n);\t\t\t\t\t\t\t\t\t\t// Set number\n\t\t\t\t\t\t$(\"#sui-rl-\" + d[i].val).css({display: \"block\"});\t\t\t\t\t\t\t// Show it\n\t\t\t\t\t}\n\t\t\t\t\tif (tot > 1000) tot = Math.floor(tot / 1000) + \"K\";\t\t\t\t\t\t\t\t// Shorten\n\t\t\t\t\t$(\"#sui-rln-all\").html(tot);\t\t\t\t\t\t\t\t\t\t\t\t// Set total number\n\t\t\t\t\t$(\"#sui-rl-all\").css({display: \"block\"});\t\t\t\t\t\t\t\t\t// Show total\n\t\t\t\t}\n\t\t\t\tlet div = \"#sui-btree-\" + o.asset_type;\t\t\t\t\t\t\t\t\t\t\t\t// Point at tree\n\n\t\t\t\t// COSMETICS\n\t\t\t\tif ($(\"#sui-footer\").offset() && $(div).offset()) {\n\t\t\t\t\t$(div).css(\"max-height\", $(\"#sui-footer\").offset().top - $(div).offset().top - 40 + \"px\");\t// Fill space\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error(\"no footer or no sui-btree\");\n\t\t\t\t}\n\t\t\t\t;\n\t\t\t});\n\t\t} else {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Collections\n\t\t\tbrowse = false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No browsing\n\t\t\tsk = o.asset_subtype.toLowerCase();\t\t\t\t\t\t\t\t\t\t\t\t\t// Get asset sub-type\n\t\t}\n\n\t\t$(\"#sui-content\").scrollTop(0);\n\t\t$(this.div).scrollTop(0);\t\t\t\t\t\t\t// Scroll to top\n\t\tk = o.asset_type;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Get this asset type\n\t\tstr += `<div class='sui-related' style='border-color:${sui.ss.mode == \"related\" ? sui.assets[k].c : \"transparent\"};\n\t\t\theight:${$(this.div).height() + 6}px'>`;\n\t\tif (sui.ss.mode != \"related\") str += \"RELATED RESOURCES<hr>\";\n\t\tstr += \"<div class='sui-relatedList'>\";\n\t\tstr += \"<div class='sui-relatedItem' id='sui-rl-Home'><span style='font-size:18px; vertical-align:-3px; color:\" + sui.assets[k].c + \"'>\" + sui.assets[k].g + \" </span> <b style='color:\" + sui.assets[k].c + \"'>Home</b></div>\";\n\t\tif (p.asset_type == \"collections\")\n\t\t\tstr += \"<div class='sui-relatedItem' id='sui-rl-\" + sk + \"'><span style='font-size:18px; vertical-align:-3px; color:\" + sui.assets[sk].c + \"'>\" + sui.assets[sk].g + \" </span> \" + o.asset_subtype + \"</div>\";\n\t\tfor (k in sui.assets) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each asset type\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\tstr += \"<a class='sui-relatedItem' style='display:none' id='sui-rl-\" + k.toLowerCase();\n\t\t\tstr += \"' href='#r=\" + this.relatedId + \"=\" + this.relatedId + \"=\" + k + \"=\" + o.uid + \"'>\";\n\t\t\tstr += \"<span style='font-size:18px; vertical-align:-3px; color:\" + sui.assets[k].c + \"'>\" + sui.assets[k].g + \"</span> \";\n\t\t\tstr += k.charAt(0).toUpperCase() + k.substr(1) + \" (<span id='sui-rln-\" + k.toLowerCase() + \"'>0</span>)</a>\";\n\t\t}\n\t\tif (false && browse && p) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If browsing\n\t\t\tstr += \"<img id='sui-relatedImg'></div>\";\t\t\t\t\t\t\t\t\t\t\t\t// Image, if available\n\t\t\tstr += \"RECENTLY VIEWED<hr style='margin:8px 0 12px 0'>\";\t\t\t\t\t\t\t\t// Add label\n\t\t\tstr += \"<div class='sui-relatedRecent' id='sui-relatedRecent'>\";\t\t\t\t\t\t// Div to recent entries\n\t\t\tfor (i = this.recentPages.length - 1; i >= 0; --i) {\t\t\t\t\t\t\t\t\t\t// For each recent (backwards)\n\t\t\t\tv = this.recentPages[i].split(\"|\");\t\t\t\t\t\t\t\t\t\t\t\t// Split title from id\n\t\t\t\tv[1] = sui.ShortenString(v[1], 18);\t\t\t\t\t\t\t\t\t\t\t\t// Cap\n\t\t\t\tstr += `<a class='sui-noA' id='sui-rcItem-${v[0]}' href='#p=${v[0]}'>\n\t\t\t\t<div class='sui-relatedRecentItem' id='sui-rr-${v[0]}'>&nbsp;&nbsp;\n\t\t\t\t<span style='color:${sui.assets[v[2]].c}'>${sui.assets[v[2]].g}\n\t\t\t\t</span>&nbsp;&nbsp;${v[1]}</div></a>`;\t\t\t\t\t\t\t\t\t\t\t// Add entry\n\t\t\t}\n\t\t\tstr += \"</div><br>BROWSE \" + p.asset_type.toUpperCase() + \"<hr style='margin:8px 0 16px 0'>\";\t// Add label\n\t\t\tstr += \"<div class='sui-tree' style='padding-left:0;margin-right:12px;' id='sui-btree-\" + p.asset_type + \"'></div>\";\t// Add browsing tree div\n\t\t}\n\n\t\t// OUTPUT append to div\n\t\t$(this.reldiv).html(str.replace(/\\t|\\n|\\r/g, \"\"));\t\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\tif (browse) {\n\t\t\tthis.DrawTree(\"#sui-btree-\" + o.asset_type, o.asset_type);\n\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If browsing, add tree\n\n\t\tif (!this.relatedType) {\n\t\t\t$(\"#sui-rl-Home\").css({\"background-color\": \"#f7f7f7\"});\n\t\t}\t\t// Hilite Home\n\t\telse {\n\t\t\t$(\"#sui-rl-\" + this.relatedType).css({\"background-color\": \"#f7f7f7\"});\n\t\t} // Hilite current\n\n\n\t\t// HANDLERS\n\t\t$(\"[id^=sui-rcItem-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// KILL RECENTS HANDLER\n\t\t$(\"[id^=sui-rcItem-]\").on(\"click\", (e) => {\t\t\t\t\t\t\t\t\t\t\t\t// ON RECENTS CLICK\n\t\t\tlet id = e.currentTarget.id.substring(11);\t\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\tif (sui.ss.mode == \"related\") sui.ss.mode = this.lastMode;\t\t\t\t\t\t\t// Get out of related\n\t\t\tthis.relatedBase = null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Remove umbrella\n\t\t\tsui.GetKmapFromID(id, (kmap) => {\n\t\t\t\tsui.SendMessage(\"\", kmap);\n\t\t\t});\t\t\t\t\t\t// Get kmap and show page\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Stop propagation\n\t\t});\n\n\t\t$(\"[id^=sui-rl-]\").on(\"click\", (e) => {\t\t\t\t\t\t\t\t\t\t\t\t\t// ON CLICK ON ASSET\n\n\n\t\t\talert(\"CLICKED RELATED LINK \" + e.target);\n\t\t\tthis.relatedType = e.currentTarget.id.substring(7);\t\t\t\t\t\t\t\t\t// Get asset type\n\t\t\tif (this.relatedType == \"Home\") {\t\t\t\t\t\t\t\t\t\t\t\t\t// Home asset\n\t\t\t\tif (sui.ss.mode == \"related\") sui.ss.mode = this.lastMode;\t\t\t\t\t\t// Get out of related\n\n\t\t\t\tthis.Draw(this.relatedBase ? this.relatedBase : o);\t\t\t\t\t\t\t\t// Show\n\t\t\t\tthis.relatedBase = null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// No base and set to home\n\t\t\t} else if ((p.asset_type == \"places\") && (this.relatedType == \"places\"))\n\t\t\t\tsui.plc.Draw(o, 4);\t\t// If place in places, show places\n\t\t\telse if ((p.asset_type == \"places\") && (this.relatedType == \"subjects\"))\n\t\t\t\tsui.plc.Draw(o, 3);\t\t// If subject in places, show subjects\n\t\t\telse if ((p.asset_type == \"subjects\") && (this.relatedType == \"subjects\"))\n\t\t\t\tsui.sub.Draw(o, 1);\t\t// If subject in subjects\n\t\t\telse if ((p.asset_type == \"subjects\") && (this.relatedType == \"places\"))\n\t\t\t\tsui.sub.Draw(o, 2);\t\t// If places in subjects\n\t\t\telse {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Regular results\n\t\t\t\tif (!this.relatedBase) {\n\t\t\t\t\tthis.relatedBase = o;\t\t\t\t\t\t\t\t\t// If starting fresh\n\t\t\t\t}\n\n\t\t\t\tthis.DrawRelatedResults(o);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Related asset browsing\n\n\t\t\t\tif (!fromHistory) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If not from history API\n\t\t\t\t\tsui.SetState(\"r=\" + this.relatedId + \"=\" + this.relatedBase.uid + \"=\" + this.relatedType + \"=\" + o.uid);\t// Set state\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t});\n\t}\n\n\tDrawRelatedResults(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SHOW RELATED ASSETS\n\t{\n\n\t\tlet x = (o.uid)? o.uid:o;\n\t\tconst message = \"pages.DrawRelatedResults() called with \" + x;\n\t\tconsole.error(message);\n\t\t// alert(message);\n\t\tconsole.dir(o);\n\t\tconst sui = this.sui;\n\t\tsui.ss.mode=\"related\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Go to related mode\n\t\tif (!this.relatedBase)\t this.relatedBase=o;\t\t\t\t\t\t\t\t\t\t\t// If starting fresh\n\t\tthis.relatedId=this.relatedBase.asset_type+\"-\"+this.relatedBase.id;\t\t\t\t\t\t// Set id\n\t\tsui.Query(false, o.asset_type == \"collections\" ? o.uid : \"\");\t\t\t\t\t\t\t// Query and show results add id if a collection to trigger collection search\n\t\tsui.DrawFooter();\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw footer\n\t\tsui.ss.page=0;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Start at beginning\n\t}\n\n\tDrawHeader(o)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW HEADER\n\t{\n\t\t// alert(\"pages.DrawHeader called()\");\n\t\tconsole.error(\"STUBBED pages.Drawheader called with arguments\");\n\t\tconsole.dir(o);\n\t\treturn;\n\n\t\tconst sui = this.sui;\n\t\tvar i;\n\t\tif (!o) return;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return if not kmap defines\n\t\tvar str=`${sui.assets[o.asset_type].g}&nbsp;&nbsp`;\n\t\tstr+=o.title[0];\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add title\n\t\tif (o.ancestors_txt && o.ancestors_txt.length) {\t\t\t\t\t\t\t\t\t\t// If has an ancestors trail\n\t\t\tstr+=\"<br><div class='sui-breadCrumbs'>\"+o.asset_type.toUpperCase()+\":&nbsp; \";\t\t// Header\n\t\t\tfor (i=0;i<o.ancestors_txt.length;++i) {\t\t\t\t\t\t\t\t\t\t\t// For each trail member\n\t\t\t\tstr+=`<a class='sui-crumb' style='color:#fff' id='sui-crumb-${o.uid.split(\"-\")[0]}-${o.ancestor_ids_is[i]}'\n\t\t\t\t href='#p=${o.uid.split(\"-\")[0]}-${o.ancestor_ids_is[i]}'>\t\t\t\t\n\t\t\t\t${o.ancestors_txt[i]}</a>`;\n\t\t\t\tif (i < o.ancestors_txt.length-1)\tstr+=\" > \";\t\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t}\n\t\t\tstr+=\"</div>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Cloase breadcrumbs div\n\t\t\t}\n\t\tif (this.editing)\tstr+=\"<div id='sui-editBut' class='sui-editBut' title='Edit this item'>&#xe688</div>\";\t\t// Add editing button\n\n\t\tconsole.error(\"EXAMINE sui\");\n\t\tconsole.dir(sui);\n\n\t\t$(\"#sui-contentHead\").html(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t// Remove format and add to div\n\t\t$(\"#sui-footer\").html(`<div style='float:right;font-size:14px;margin-right:16px'>${o.asset_type.toUpperCase()} ID: ${o.id}</div>`);\t// Set footer\n\t\t$(\"#sui-header\").css(\"background-color\",sui.assets[o.asset_type].c);\t\t\t\t\t// Color header\n\t\t$(\"#sui-footer\").css(\"background-color\",sui.assets[o.asset_type].c);\t\t\t\t\t// Color footer\n\t\n\t\t$(\"[id^=sui-crumb-]\").on(\"click\",(e)=> {\t\t\t\t\t\t\t\t\t\t\t\t// ON BREAD CRUMB CLICK\n\t\t\tvar id=e.currentTarget.id.substring(10).toLowerCase();\t\t\t\t\t\t\t\t// Get id\n\t\t\tif (sui.ss.mode == \"related\") sui.ss.mode=sui.ss.lastMode;\t\t\t\t\t\t\t// Get back to regular search mode\n\t\t\tsui.GetKmapFromID(id,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t\t\t\t\t// Get kmap and show page\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t\t});\n\t\t\n\t\t$(\"#sui-editBut\").on(\"click\",()=> {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ON EDIT BUTTON CLICK\n\t\t\tlet str=\"http://\"+o.asset_type+\".\";\t\t\t\t\t\t\t\t\t\t\t\t\t// URL head\n\t\t\tsui.Popup(\"Editing this item in Rails now!\");\t\t\t\t\t\t\t\t\t\t// Show we're editing\n\t\t\tif (o.asset_type.match(/subjects|places|terms/i))\tstr+=\"kmaps.virginia.edu/admin/slices/\"+o.id;\n\t\t\telse\t\t\t\t\t\t\t\t\t\t\t\tstr+=\"shanti.virginia.edu/node/\"+o.id+\"/edit\";\n\t\t\twindow.open(str,\"_blank\");\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Open in new window\n\t\t\t});\n\t\t\t\n\t\t}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// RELATED TREE TOOLS\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\t\n\tAddRelTreeLine(lab, id, marker, path) \t\t\t\t\t\t\t\t\t\t\t\t\t// ADD LINE TO TREE\n\t{\n\t\tconst sui = this.sui;\n\t\tlet s=`<li style='margin:2px 0 2px ${-24}px'>`;\t\t\t\t\t\t\t\t\t\t\t// Header\n\t\tif (marker)\ts+=`<div class='sui-spDot' id='sui-spDot-${path}'>${marker}</div>`;\t\t\t// If a dot, add it\n\t\telse\t\ts+=\"<div class='sui-spLoner'><b>&bull;&nbsp;&nbsp;</b></div>\";\t\t\t\t// If a loner\n\t\ts+=`<a class='sui-noA' href='#p=${id}' id='sui-spLab-${id}'>${lab}</b>${sui.pages.AddPop(id)}</a>`;\t\t\n\t\treturn s;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return line\n\t}\n\n\tAddRelBranch(facet, path, dot) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// LAZY LOAD BRANCH\n\t{\n\t\tconst sui = this.sui;\n\t\tlet _this=this;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save context\n\t\tsui.GetTreeChildren(facet,path,(res)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// Get children\n\t\t\tlet str=\"\";\n\t\t\tlet i,j,re,m,path;\n\t\t\tlet counts=[];\n\t\t\ttry { counts=res.facets.child_counts.buckets; } catch(e) {}\t\t\t\t\t\t\t// Get child counts\n\t\t\tres=res.response.docs;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Point at docs\n\t\t\tfor (i=0;i<res.length;++i) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each child\n\t\t\t\tpath=\"\";\tm=null;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Assume a loner\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tre=new RegExp(res[i].id.split(\"-\")[1]);\t\t\t\t\t\t\t\t\t\t\t// Get id to search on\n\t\t\t\tfor (j=0;j<counts.length;++j) {\t\t\t\t\t\t\t\t\t\t\t\t\t// For each count\n\t\t\t\t\tif (counts[j].val.match(re)) {\t\t\t\t\t\t\t\t\t\t\t\t// In this one\n\t\t\t\t\t\tm=\"+\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Got kids\n\t\t\t\t\t\tpath=counts[j].val;\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add path\n\t\t\t\t\t\t}\n\t\t\t\t\t}\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\tstr+=\"<ul style='list-style-type:none'>\";\t\t\t\t\t\t\t\t\t\t// Header\n\t\t\t\tstr+=this.AddRelTreeLine(res[i].header,res[i].id,m,path)+\"</li></ul>\"; \t\t\t// Add it\n\t\t\t\t}\n\t\t\t$(dot).prop(\"id\",\"sui-spDot-null\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Inhibit reloading\n\t\t\tdot.parent().append(str);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Append branch\n\n\t\t\t$(\"[id^=sui-spDot-]\").off(\"click\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill handler\n\t\t\t$(\"[id^=sui-spDot-]\").on(\"click\", function(e) {\t\t\t\t\t\t\t\t\t\t// ON RELATIONSHIP TREE DOT CLICK\n\t\t\t\tlet firstChild=$(this).parent().find(\"ul\")[0];\t\t\t\t\t\t\t\t\t// Get first child\n\t\t\t\tlet path=e.currentTarget.id.substring(10);\t\t\t\t\t\t\t\t\t\t// Get id\n\t\t\t\tif (path != \"null\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Not loaded yet\n\t\t\t\t\t$(this).html(\"&ndash;\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Show it's open\n\t\t\t\t\t_this.AddRelBranch(facet,path,$(this));\t\t\t\t\t\t\t\t\t\t// Lazy load branch\n\t\t\t\t\t}\n\t\t\t\telse $(this).html($(firstChild).css(\"display\") == \"none\" ? \"&ndash;\" : \"+\"); \t// Change label\n\t\t\t\t$(this).parent().find('ul').slideToggle();            \t\t\t\t\t\t\t// Slide into place\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n// HELPERS\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\t// NO SIDE EFFECTS\n\tDrawTabMenu(tabs)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW TAB MENU\n\t{\n\t\tlet i, str=\"\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\tfor (i=0;i<tabs.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// For each tab\t\n\t\t\tstr+=`<div class='sui-tabTab' id='sui-tabTab${i}' style='width:calc(${100/tabs.length}% - 2px)'>${tabs[i]}&nbsp;&#xe609</div>`;\n\t\tstr+=\"<div class='sui-tabContent' id='sui-tabContent'></div>\";\t\t\t\t\t\t\t// Tab contents\n\t\treturn str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Return tab markup\n\t}\n\n\t// OUTPUT: WRITES TO DOM\n\tDrawCarousel(content)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW RESOURCE CAROUSEL\n\t{\n\t\tconst sui = this.sui;\n\t\tlet i,curCon=0;\n\t\tcontent=[\n\t\t\t{ title:\"The Shinj Yapyum Cham is performed\", \n\t\t\ttext:\"One of the most common sacred masked dances performed during religious festivals in Bhutan is the Shinj Yapyum Cham. The dance is often performed early during a festivals program as it is believed to subdue negative spirits and harmful influences. Although known as the Shinj Yapyum Cham, or the Dance of the Male and Female Lords of Death, it represents the male and female Yamntaka is the Destroyer of Death...\",\n\t\t  \tpic:\"https://cicada.shanti.virginia.edu/images/mandala/shanti-image-550401/full/!600,/0/default.jpg\", id:\"images-stage_shanti_virginia_edu-1187696\"},\n\t\t\t{ title:\"A Song Called Ja legmo Tsering\", \n\t\t\ttext:\"Unlike today, meeting a person was extremely difficult in the past. The lyrics of this song say that meeting someone was considered as an act of fate. People would meet even if they had never thought of meeting that person. The composer wishes for two people who have met through fate, to stay together for their entire life...\",\n\t\t\tpic:\"https://cfvod.kaltura.com/p/381832/sp/38183200/thumbnail/entry_id/1_xvwn4fvx/version/100021/600/600/height/0\", id:\"audio-video-stage_shanti_virginia_edu-22741\"},\n\t\t\t{ title:\"Tongue Twister in the Kheng Language\", \n\t\t\ttext:\"In the past, parents taught their kids tongue twisters as a way to practice pronunciation. Rinchen Drakpa from Sharigang presents two tongue twisters in his local language, Khengkha. Rinchen Drakpa says that in his childhood he witnessed villagers competing to be the one who could say the tongue twisters with the most perfect pronunciation.\",\n\t\t\tpic:\"https://cfvod.kaltura.com/p/381832/sp/38183200/thumbnail/entry_id/0_ou7n6lp9/version/100021/600/600/height/0\", id:\"audio-video-stage_shanti_virginia_edu-3806\"},\n\t\t\t{ title:\"Seven Limbs of Practice: Chpa\", \n\t\t\ttext:\"Most Bhutanese Buddhist rituals contain the set of seven practices known as yoen lak duen pa (). The seven practices prostration (), offering (), confession (), rejoicing (), request to live long (), request to turn the wheel of Dharma () and to dedicate the merits ().This piece was initially published in Bhutans national newspaper Kuensel..\",\n\t\t\tpic:\"https://mms.thlib.org/images/0050/8753/63691_large.jpg\", id:\"texts-stage_shanti_virginia_edu-38836\"},\n\t\t\t{ title:\"A Story of a Rich and a Poor Girl\", \n\t\t\ttext:\"Ap Tempo of Karna Gewog, Dagana narrates a story of a poor girl who is straight forward and faithful. Her rich friend was always insecure. The poor girl gets rewarded by a deity for her kind heart and good attitude; she suddenly becomes rich, and her rich friend became insecure about her. She tries to achieve what the poor girl has achieved, but gets punished due to her jealousy and greediness.\",\n\t\t\tpic:\"https://cfvod.kaltura.com/p/381832/sp/38183200/thumbnail/entry_id/1_607tfowl/version/100031/600/600/height/0\", id:\"audio-video-stage_shanti_virginia_edu-24651\"},\n\t\t\t{ title:\"An Exchange of Tsangmo Poems\", \n\t\t\ttext:\"Tsangmo is a type of song used to express individual's emotions, conveying their inner warmth and affection to another person, through numerious lyrical tunes. Tsangmo can be sung to express love, hatred and any other feelings. While it is sung, the Tsangmo songs are never sung with dance, as it is a poetry song for a singing expression without a dance. It is usually a composition limited to a verse of four lines for an expression.\",\n\t\t\tpic:\"https://cfvod.kaltura.com/p/381832/sp/38183200/thumbnail/entry_id/1_zk9hsnff/version/100011/609/600/height/0\", id:\"audio-video-stage_shanti_virginia_edu-22596\"},\n\t\t\t];\t\t\n\t\t\t\t\n\t\tlet str=`<div class='sui-caroBox'>\n\t\t<div class='sui-caroButL' id='sui-caroButL'>&#xe640</div>\n\t\t<div class='sui-caroButR' id='sui-caroButR'>&#xe641</div>\n\t\t<div class='sui-caroHeader'>&nbsp;</div>\n\t\t\t<div class='sui-caroLeft'>\n\t\t\t\t<div class='sui-caroTitle' id='sui-caroTitle'></div>\n\t\t\t\t<div class='sui-caroText' id='sui-caroText'></div>\n\t\t\t</div>\n\t\t\t<img class='sui-caroPic' id='sui-caroPic' src=''><br>\n\t\t\t<a class='sui-caroRes' id='sui-caroRes')' href='#p=${content[curCon].id}'>\n\t\t\t<i>View Resource</i>&nbsp;&nbsp;&#xe683</a>\n\t\t\t<div class='sui-caroDots'>`;\n\t\t\t\tfor (i=0;i<content.length;++i) \t\t\t\t\t\t\t\t\t\t\t\t\t// For each panel\n\t\t\t\t\tstr+=`<div class='sui-caroDot' id='sui-caroDot-${i}'></div>`;\t\t\t\t// Add dot\n\t\tstr+=\"</div></div>\";\n\t\t$(this.div).append(str.replace(/\\t|\\n|\\r/g,\"\"));\t\t\t\t\t\t\t\t\t// Remove format and add to div\n\n\t\t// TIMERS\n\t\tclearInterval(this.carouselTimer);\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Kill timer\n\t\tthis.carouselTimer=setInterval(()=> { $(\"#sui-caroButR\").trigger(\"click\"); },8000);\t\t// Change panel every 8 secs\n\n\t\t// OUTPUT\n\t\tsetPanel(curCon);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Set 1st pane;\n\t\tfunction setPanel(num) {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// SET PANEL CONTENTS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t$(\"#sui-caroTitle\").html(\"&#xe633&nbsp;&nbsp;\" + content[num].title);\t\t\t\t\t// Set title\n\t\t\t$(\"#sui-caroText\").html(content[num].text);\t\t\t\t\t\t\t\t\t\t\t// Set text\n\t\t\t$(\"#sui-caroPic\").prop(\"src\", content[num].pic);\t\t\t\t\t\t\t\t\t\t// Set pic\n\t\t\t$(\"[id^=sui-caroDot-]\").css({\"background-color\": \"#fff\"});\t\t\t\t\t\t\t// Reset dot\n\t\t\t$(\"#sui-caroDot-\" + num).css({\"background-color\": \"#5d68cc\"});\t\t\t\t\t\t\t// Highlight current\n\t\t}\n\n\t\t// HANDLERS\n\t\t$(\"#sui-caroRes\").on(\"click\", (e)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON SEE RESOURCE CLICK\n\t\t\tsui.GetKmapFromID(content[curCon].id,(kmap)=>{ sui.SendMessage(\"\",kmap); });\t\t// Get kmap and show page\n\t\t\treturn false;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Don't propagate\n\t\t});\n\n\t\t$(\"#sui-caroButL\").on(\"click\", (e)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON BACK CLICK\n\t\t\tcurCon=curCon ? curCon-1 : content.length-1;\t\t\t\t\t\t\t\t\t\t// Go back or wrap\n\t\t\tsetPanel(curCon);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw panel\n\t\t\t});\n\n\t\t$(\"#sui-caroButR\").on(\"click\", (e)=>{\t\t\t\t\t\t\t\t\t\t\t\t\t// ON FORWARD CLICK\n\t\t\tcurCon=(curCon == content.length-1) ? 0 : curCon+1;\t\t\t\t\t\t\t\t\t// Go forward or wrap\n\t\t\tsetPanel(curCon);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw panel\n\t\t\t});\n\t\t\n\t\t$(\"[id^=sui-caroDot-]\").on(\"click\", (e)=>{\t\t\t\t\t\t\t\t\t\t\t\t// ON DOT CLICK\n\t\t\tcurCon=e.target.id.substring(12);\t\t\t\t\t\t\t\t\t\t\t\t\t// Get number\n\t\t\tcurCon=Math.min(content.length-1,Math.max(curCon,0));\t\t\t\t\t\t\t\t// Cap\n\t\t\tsetPanel(curCon);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Draw panel\n\t\t\t});\n\t}\n\n\n\t// NO SIDE EFFECTS\n\tDrawItem(icon, label, value, def, style, bold)\t\t\t\t\t\t\t\t\t\t\t// DRAW ITEM\n\t{\n\t\tlet i,str=\"<p>\";\n\t\tif ((value == null) || (value == undefined))\treturn \"\";\t\t\t\t\t\t\t\t// Return nothing\n\t\tif (icon)\tstr+=icon+\"&nbsp;&nbsp;\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add icon\n\t\tstr+=\"<span class='sui-pageLab'\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Label head\n\t\tif (bold)\tstr+=\" style='font-weight:600'\";\t\t\t\t\t\t\t\t\t\t\t// Bold?\n\t\tstr+=\">\"+label+\":&nbsp;&nbsp;</span>\";\t\t\t\t\t\t\t\t\t\t\t\t\t// Add label\n\t\tstr+=\"<span class='\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Add value span\n\t\tstr+=(style ? style : \"sui-pageVal\")+\"'>\";\t\t\t\t\t\t\t\t\t\t\t\t// Default, or special style\n\t\tif (typeof(value) == \"object\") {\t\t\t\t\t\t\t\t\t\t\t\t\t\t// If an array\n\t\t\tfor (i=0;i<value.length;++i)\t{\t\t\t\t\t\t\t\t\t\t\t\t\t// For each item\n\t\t\t\tif (value[i].header)\t\tstr+=value[i].header;\t\t\t\t\t\t\t\t// Use .header\n\t\t\t\telse if (value[i].value)\tstr+=value[i].value;\t\t\t\t\t\t\t\t// .value\n\t\t\t\telse if (value[i].val)\t\tstr+=value[i].val;\t\t\t\t\t\t\t\t\t// .val\n\t\t\t\telse if (value[i].title)\tstr+=value[i].title;\t\t\t\t\t\t\t\t// .title\n\t\t\t\telse \t\t\t\t\t\tstr+=value[i];\t\t\t\t\t\t\t\t\t\t// Plain\t\n\t\t\t\tif (i != value.length-1)\tstr+=\", \";\t\t\t\t\t\t\t\t\t\t\t// Add separator\n\t\t\t\t}\n\t\t\t}\n\t\telse str+=(value && (!value.match(/undefined/))) ? value : def;\t\t\t\t\t\t\t// Add def if bad value or show value\n\t\treturn str+\"</span></p>\";\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Return item\n\t}\n\n\t// NO SIDE EFFECTS\n\tFormatDate(date)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// FRIENDLY FORMAT OF DATE\n\t{\n\t\tlet d=new Date(date);\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Parse date\n\t\tif (d)\tdate=(d.getMonth()+1)+\"/\"+d.getDate()+\"/\"+d.getFullYear();\t\t\t\t\t\t// Remake it\n\t\treturn date;\n\t}\t\t\n\n\t// !!!!  WRITES sui TO GLOBAL WINDOW IN ORDER TO IMPLEMENT POPOVERS...   !!!!\n\tAddPop(id, small)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// ADD KMAP POPOVER\n\t{\n\t\tconst sui = this.sui;\n\t\twindow.sui = this.sui;\n\n\t\tlet str=`&nbsp;<img style='display:inline-block' src='/popover.png' ${small ? \"style='width:13px'\" : \"\"}\n\t\tonmouseenter='sui.pages.ShowPopover(\"${id}\",event); return false;' \n\t\tonmousemove='sui.pages.ShowPopover(\"${id}\",event); return false;' \n\t\tonmousedown='sui.pages.ShowPopover(\"${id}\",event) return false;'>`;\t\t\t\t\t\t\t\t\t// Make image call to show popover\n\t\treturn str.replace(/\\t|\\n|\\r|/g,\"\");\t\t\t\t\t\t\t\t\t\t\t\t\t// Return markup\n\t}\n\n\t// ARGUMENT  div\n\t// ARGUMENT facet (string) e.g. \"places\"\n\t// USES this.sui\n\t// SETS sui.curTree\n\t// CALLS sui.LazyLoad()\n\t// CALLS sui.GetTopRow()\n\t// OUTPUT: alters CSS of passed div\n\tDrawTree(div, facet)  \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// DRAW FACET TREE\n\t{\n\t\tconst sui = this.sui;\n\t\tsui.curTree=facet;\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// Save current facet\n\t\tif (facet == \"places\") \t\t \tsui.LazyLoad(div,null,facet,13735);\t\t\t\t\t\t// Embedded top layer for places\n\t\telse \t\t\t\t\t\t\tsui.GetTopRow(div,facet);\t\t\t\t\t\t\t\t// Constructed top layers\n\n\t\tif ($(\"#sui-footer\").offset() && $(div).offset()) {\n\t\t\t$(div).css(\"max-height\", $(\"#sui-footer\").offset().top - $(div).offset().top - 120 + \"px\");\t// Fill space\n\t\t} else {\n\t\t\tconsole.error(\"no footer\");\n\t\t}\n\t}\n\n\t\n} // Pages class closure","import {Link} from \"react-router-dom\";\nimport React from \"react\";\n\nexport function TopBar() {\n    const topBar = <div className={'sui-topBar'}>\n        <Link to={'/home'}>\n            <img src={'/mandala-om/img/bhutanleft.gif'} style={{cursor: 'pointer'}} alt={'Home Page'} />\n        </Link>\n    </div>\n    return topBar;\n}","import {Link} from \"react-router-dom\";\nimport React from \"react\";\n\nexport function Home(props) {\n    return <div><h2>Home</h2>\n\n        <h3>Work-in-Progress</h3>\n        <ul>\n            <li><Link to={'/view/terms/terms-12434'}>/view/terms/terms-12434</Link></li>\n            <li><Link to={'/view/terms/terms-45057'}>/view/terms/terms-45057</Link></li>\n            <li><Link to={'/view/terms/terms-85193'}>/view/terms/terms-85193</Link></li>\n            <li><Link to={'/view/terms/places-16408'}>/view/terms/places-16408</Link></li>\n        </ul>\n\n        <h3>Semi-functional legacy viewer</h3>\n        <ul>\n            <li><Link to={'/view/assets/terms-85193'}>/view/assets/terms-85193</Link></li>\n            <li><Link\n                to={'/view/assets/texts-dev_shanti_virginia_edu-16202'}>/view/assets/texts-dev_shanti_virginia_edu-16202</Link>\n            </li>\n        </ul>\n\n        <h3>Dys-functional legacy viewer</h3>\n        <ul>\n            <li><Link to={'/view/assets/subjects-6752'}>/view/assets/subjects-6752</Link></li>\n            <li><Link to={'/view/assets/places-637'}>/view/assets/places-637</Link></li>\n        </ul>\n\n    </div>\n}","import React from \"react\";\n\nexport function ContentHeader(props) {\n    const cheader =\n        <div id='sui-header' className={`sui-header legacy ${props.siteClass}`}>\n            <div id='sui-contentHead' className='sui-contentHead legacy'>\n                <div>\n                    <span>{props.kmasset.title}</span>\n                    <span>({props.kmasset.uid})</span>\n                </div>\n            </div>\n        </div>;\n    return cheader;\n}","import React from 'react';\nimport { Parser } from 'html-to-react';\nimport $ from 'jquery';\n\nexport class AudioVideoViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n\n\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n    }\n\n    render() {\n\n        // TODO: markup issues\n        const parser = new Parser();\n        console.dir(this.sui.pages.div.html());\n        const output = parser.parse($(this.sui.pages.div).html());\n        return <div> { output }</div>;\n    }\n\n\n\n}","import React from 'react';\n\nexport class ImagesViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n    }\n\n    render() {\n        return <div class={\"images legacy\"} >NOT YET IMPLEMENTED IMAGES LEGACY { JSON.stringify(this.props) }</div>\n    }\n\n\n}","import React from 'react';\n\nexport function TextsViewer(props) {\n    // This has been passed props from <KmapContext> which currently wraps it\n    const kmap = props.kmaps;\n    const kmasset = props.kmasset;\n\n\n    let output = [ <div>I am TextViewer, hear me roar.</div> ];\n    output.push(<div>I have been passed the properties: <pre>{ JSON.stringify(props, undefined, 2)} </pre></div>);\n\n\n    return output\n\n}","import React from 'react';\n\nexport class SourcesViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n    }\n\n    render() {\n        return <div class={\"sources legacy\"} >NOT YET IMPLEMENTED SOURCES LEGACY { JSON.stringify(this.props) }</div>\n    }\n\n\n}","import React from 'react';\n\nexport class VisualsViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n        return nextProps.id\n    }\n\n    render() {\n        return <div class={\"VISUALS legacy\"} >VISUALS LEGACY { JSON.stringify(this.props) }</div>\n    }\n\n\n}","import React from 'react';\n\nexport class PlacesViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n    }\n\n    render() {\n        return <div class={\"places legacy\"} >NOT YET IMPLEMENTED PLACES LEGACY { JSON.stringify(this.props) }</div>\n    }\n\n\n}","import React from 'react';\n\nexport class SubjectsViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n\n        if (typeof props.onStateChange !== 'function') {\n            throw new Error(\"onStateChange must be passed\");\n        }\n    }\n\n    componentDidMount() {\n        console.log(\"componentDidMount\");\n        this.sui.GetKmapFromID(this.props.id, (kmasset) => {\n            console.log(\"calling pages.Draw() with kmasset=\" + kmasset.uid);\n            this.props.onStateChange( { kmasset: kmasset });\n            this.sui.pages.Draw(kmasset, true);\n        });\n    }\n\n    componentDidCatch(error, errorInfo) {\n\n    }\n\n    componentWillUnmount() {\n        console.log(\"componentWillUnmount\");\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n        this.sui.GetKmapFromID(this.props.id, (kmasset) => {\n            console.log(\" calling pages.Draw() with kmasset=\" + kmasset.uid);\n            this.props.onStateChange( { kmasset: kmasset });\n            this.sui.pages.Draw(kmasset, true);\n        });\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n        console.log(\"shouldComponentUpdate\");\n        return true;\n    }\n\n    render() {\n        return <div className={\"Subjects legacy\"} >SUBJECTS LEGACY { JSON.stringify(this.props.kmaps) }</div>\n    }\n\n\n}","import React from 'react';\nimport {Link} from \"react-router-dom\";\n\nexport function RelatedsViewer(props) {\n\n    console.log(\"Relateds props = \", props);\n\n    const baseArgs = {baseType: \"terms\", baseUid: props.id, relateds: props.relateds}\n    if (!props.id) {\n        return null;\n    }\n\n    return <div className={\"relatedsviewer\"}>\n        <div className=\"sui-related\">\n            RELATED RESOURCES\n            <hr/>\n            <div className=\"sui-relatedList\">\n\n                <Link to={\"/view/\" + baseArgs.baseType + \"/\" + baseArgs.baseUid}>\n                    <div className=\"sui-relatedItem  sui-color-terms\" id=\"sui-rl-Home\">\n                        <span className={'sui-relatedItem-icon'}></span> <b>Home</b>\n                    </div>\n                </Link>\n\n                <RelatedCount type={\"all\"} {...baseArgs}/>\n                <RelatedCount type={\"places\"} {...baseArgs}/>\n                <RelatedCount type={\"audio-video\"} {...baseArgs}/>\n                <RelatedCount type={\"images\"} {...baseArgs}/>\n                <RelatedCount type={\"sources\"} {...baseArgs}/>\n                <RelatedCount type={\"texts\"} {...baseArgs}/>\n                <RelatedCount type={\"visuals\"} {...baseArgs}/>\n                <RelatedCount type={\"subjects\"} {...baseArgs}/>\n                <RelatedCount type={\"terms\"} {...baseArgs}/>\n                <RelatedCount type={\"collections\"} {...baseArgs}/>\n            </div>\n        </div>\n    </div>\n}\n\nfunction RelatedCount(p) {\n    const count = (p.relateds?.assets) ? p.relateds.assets[p.type]?.count : 0;\n\n    // assign shanticon class according to type.  \"all\" type should get the \"shanticon-logo-shanti\" icon.\n    const iconClass = \"shanticon-\" + ((p.type === \"all\") ? \"logo-shanti\" : p.type);\n\n    // return null if the count doesn't exist or is === 0\n    return count ?\n        <Link to={\"/view/\" + p.baseType + \"/\" + p.baseUid + \"/related/\" + p.type + \"/default\"}>\n            <span className={\"sui-relatedItem\"} id={\"sui-rl-\" + p.type} href=\"#\">\n                <span className={\"sui-color-\" + p.type + \" \" + iconClass}></span>\n                <span className={\"sui-relatedItem-label\"}> {p.type}</span>\n                &nbsp;(<span id=\"sui-rln-places\">{count}</span>)\n            </span>\n        </Link>\n        : null;\n}","import React from 'react';\nimport {Parser} from \"html-to-react\";\nimport $ from \"jquery\";\nimport {withRouter} from \"react-router-dom\";\n\nclass LegacyViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n        this.props = props;\n        this.sui = props.sui;\n\n        const id = this.props.id || this.props.match.params.id;\n\n        this.sui.GetKmapFromID(id, (kmasset) => {\n            console.log(\"LegacyViewer: kmasset = \", kmasset );\n            if ( !this.state || !this.state.kmasset || kmasset.uid && kmasset.uid !== this.state.kmasset.uid) {\n                this.state={ kmasset: kmasset, id:id };\n                this.sui.pages.Draw(this.state.kmasset, false);\n                this.props.onStateChange( this.state );\n                console.log(\"LegacyViewer: whoop\")\n            }\n        });\n    }\n\n    render() {\n        const parser = new Parser();  // html-to-jsx parser\n        const viewer = parser.parse($(this.sui.pages.div).html());\n        const relateds = parser.parse($(this.sui.pages.reldiv).html())\n        console.log(\"LegacyViewer VIEWER = \", viewer);\n        console.log(\"LegacyViewer RELDIV = \" + relateds);\n        return <div className={\"legacyviewer\"} >{ viewer }</div>\n    }\n}\n\nexport default withRouter(LegacyViewer);","import _ from \"lodash\";\n\nexport function buildNestedDocs(docs, child_type, path_field) {\n\n    path_field = (path_field) ? path_field : child_type + \"_path_s\";\n\n    const base = {};\n    docs = _.filter(docs, (x) => {\n        return x.block_child_type === child_type;\n    });\n\n    // console.log(\"buildNestedDocs: \", docs)\n\n    _.forEach(docs, (doc,i) => {\n        // console.log(\"buildNestedDocs: i=\" +i);\n        // console.log(\"buildNestedDocs: pathField = \" + path_field);\n        const path = doc[path_field].split('/');\n        // console.log(\"buildNestedDocs path = \" + path);\n        doc.order=i;\n        // console.log(\"buildNestedDocs path.length == \" + path.length);\n        if (path.length === 1) {\n            // this is a \"root doc\", push it on the base list\n            base[path[0]] = doc;\n        } else {\n            // this is a \"nested doc\"\n            // this is a \"nested doc\"\n\n            // check for each \"ancestor\"\n            // create  \"fake ancestor\", if it doesn't exist\n            // add the doc to its parent in _nestedDoc_ field\n            //      created _nestedDoc_ field if it doesn't exist\n            //      if it already exists (it might have been faked earlier), populate fields\n            // console.log(\"buildNestedDocs: nested path = \", path);\n            var curr = base;\n            for (let i = 0; i < path.length; i++) {\n                // console.log(\"buildNestedDocs segment: \" + path.slice(0, i + 1).join(\"/\"));\n                if (!curr[path[i]]) {\n                    curr[path[i]] = {};\n                }\n                if (i === path.length - 1) {\n                    curr[path[i]] = doc;\n                }\n                if (!curr[path[i]]._nested_) {\n                    curr[path[i]]._nested_ = {};\n                }\n                curr = curr[path[i]]._nested_;\n            }\n\n        }\n    })\n    // console.log(\"buildNestedDocs:\", base);\n    return base;\n}\n","import React, {useState} from \"react\";\nimport {buildNestedDocs} from \"./common/utils\";\n// import Tab from \"react-bootstrap/Tab\";\nimport Card from \"react-bootstrap/Card\";\nimport Collapse from \"react-bootstrap/Collapse\";\n// import Fade from \"react-bootstrap/Fade\";\nimport Nav from \"react-bootstrap/Nav\";\nimport _ from 'lodash';\nimport {Parser} from \"html-to-react\";\n\nfunction Definitions(props) {\n    const definitionsTree = buildNestedDocs(props.kmap._childDocuments_, \"related_definitions\");\n    console.log(\"Definition: nested doc = \", definitionsTree);\n    let output = <Card>\n        <Card.Body><Card.Title>Definitions</Card.Title>\n            <ul className={\"sui-definitionEntry\"}><Definition definitions={definitionsTree}\n                                                              kmap={props.kmap}/></ul>\n        </Card.Body>\n    </Card>\n    return output;\n}\n\nfunction Definition(props) {\n    let primaryList = [];\n    let otherSort = {};\n    let otherList = [];\n\n    // TODO: Review whether this collation of \"Other Definitions\" should be part of view logic or business logic.\n    //  Right now, I'm thinking it should stay as view logic.\n\n    Object.entries(props.definitions).map(([id, entry]) => {\n        const otherSource = entry.related_definitions_source_s;\n        if (otherSource) {\n\n            // find or create the dictionary\n            let otherDict = otherSort[otherSource];\n            if (!otherDict) {\n                otherDict = {name: otherSource, definitions: []}\n                otherSort[otherSource] = otherDict;\n            }\n\n            // add the definition to the dictionary\n            otherDict.definitions.push(entry.related_definitions_content_s)\n\n        } else {\n\n            // only recurse if the _nested_ attribute is populated\n            let nested = \"\";\n            if (!_.isEmpty(entry._nested_)) {\n                nested = <ul>\n                    <Definition definitions={entry._nested_} kmap={props.kmap}/>\n                </ul>\n            }\n            primaryList.push(\n                <li key={entry.uid} className={\"sui-definitionEntry\"}>\n                    <DefinitionEntry data={entry} kmap={props.kmap} nested={nested}/>\n                </li>\n            )\n        }\n        return true;\n    });\n\n    // assemble otherList from otherSort\n    Object.entries(otherSort).map(([id, entry]) => {\n        otherList.push(\n            <li key={ entry.uid } className={\"sui-definitionEntry\"}>\n                <OtherDefinitionEntry data={entry} kmap={props.kmap}/>\n            </li>\n        )\n        return true;\n    });\n\n\n    // Add the Primary Definitions to the output.\n    let output = [<React.Fragment>{primaryList}</React.Fragment>];\n\n    // Add an \"Other Dictionaries\" Header if there are other dictionaries.\n    if (otherList.length) {\n        output.push(\n            <React.Fragment>\n                <hr/>\n                <h5>Other Dictionaries</h5>\n            </React.Fragment>,\n            <React.Fragment>{otherList}</React.Fragment>);\n    }\n\n    return output;\n}\n\n\nfunction DefinitionEntry(props) {\n\n    // if (props.data.related_definitions_source_s) {\n    //     headerContent = props.data.related_definitions_source_s;\n    // }\n\n    const [open, setOpen] = useState(false);\n    const [details, setDetails] = useState(false);\n\n\n    // TODO: NEED TO comb out naughty markup in the data. e.g. <p>'s need to be converted to <div>'s\n    //  See htmlToReactParser.parseWithInstructions() at https://www.npmjs.com/package/html-to-react\n    //  I think one could intercept those <p>'s (and any other offending markup) and rewrite them.\n\n    const parser = new Parser();\n    const definitionUnescaped = parser.parse(props.data.related_definitions_content_s);\n\n    const definitionDetails = parseDetails(props.data);\n\n\n    // TODO: need to refactor this logic out of the Component and into middleware/business logic.\n    //  Just haven't decided where it should go yet.\n    function parseDetails(d) {\n\n        let branches = {};\n        let details = [];\n\n        // collect data by \"branch\"\n        Object.entries(d).forEach(([key, value]) => {\n            if (key.startsWith('related_definitions_branch_subjects')) {\n                // eslint-disable-next-line\n                const [match, uid, field] = key.match(/related_definitions_branch_(subjects-\\d+)_(\\S+)/);\n                if (!branches[uid]) {\n                    branches[uid] = {};\n                }\n                branches[uid][field] = value;\n            }\n        });\n\n        // reorganize by \"branch\" subject\n        Object.entries(branches).forEach(([uid, entry]) => {\n            let subjects = [];\n            for (let i = 0; i < entry.subjects_uids_t.length; i++) {\n                const sub = {header: entry.subjects_headers_t[i], uid: entry.subjects_uids_t[i]}\n                subjects.push(sub);\n            }\n            const deets = {header: entry.header_s, uid: uid, values: subjects};\n            // console.log(\"Deeting: \", deets);\n            details.push(deets);\n        });\n\n        // The markup code below should stay in the Viewer\n\n        // render the markup list\n        let detailsMarkup = [];\n        _.forEach(details, (e,i) => {\n            // TODO: refactor the href's into ...  <Link>'s?\n            const valuesList = _.map(e.values, x => <a href={\"#\" + x.uid}>{x.header}</a>)\n            detailsMarkup.push(<li key={i} ><span><a href={\"#\" + e.uid}>{e.header}</a></span>: <span>{valuesList}</span></li>);\n        });\n\n        // render the div\n        return <div>\n            <h6>Details</h6>\n            {detailsMarkup}\n        </div>\n\n    }\n\n    // TODO: review whether this could/should be simplified to use <Tabs>/<Tab>/<TabPane> instead.\n    // ys2n: I couldn't get the markup to look right when <Tabs>'s were nested in other Bootstrap components.\n    // So I went with this more-complicated implementation.\n    //\n    // I also introduced mouseover/mouseleave mechanics, which I personally find more clear since it hides the\n    // tabbed interface when casually browsing.  These mechanics need to be reviewed to handle the case where\n    // sub-defintion are within the same div as the parent.  Currently the parent definition is expanded still\n    // when you mouseover a sub-definition.  That maybe okay,  I'm just not sure.\n    //\n    return <div>\n        <Card>\n            <Card onMouseEnter={() => {setOpen(true)}}\n                  onMouseLeave={() => {setOpen(false)}}>\n                <Collapse in={open}>\n                    <Card.Header>\n                        <Nav variant=\"tabs\" defaultActiveKey=\"definition\">\n                            <Nav.Item>\n                                <Nav.Link eventKey={\"definition\"} onSelect={() => {setDetails(false)}}>\n                                    Definition\n                                </Nav.Link>\n                            </Nav.Item>\n                            <Nav.Item>\n                                <Nav.Link eventKey={\"details\"} onSelect={() => { setDetails(true)}}>\n                                    Other Info\n                                </Nav.Link>\n                            </Nav.Item>\n                        </Nav>\n                    </Card.Header>\n                </Collapse>\n\n                <Card.Body>\n                    <Card.Text>\n                        <dl>\n                            <dt className={\"sui-definitionEntry-term\"}>{props.kmap.name_latin[0]}:</dt>\n                            <dd>{definitionUnescaped}</dd>\n\n                            <Collapse in={open}>\n                                <ul className={\"list-group list-group-horizontal-sm justify-content-end\"}>\n                                    <li key='lang' className={\"list-group-item border-0\"}>\n                                        <span>Definition Language:</span>\n                                        <span>{props.data.related_definitions_language_s}</span></li>\n                                    <li key='author' className={\"list-group-item border-0\"}>\n                                        <span>Definition Author:</span>\n                                        <span>{props.data.related_definitions_author_s}</span></li>\n                                </ul>\n                            </Collapse>\n\n\n                            <Collapse in={details}>\n                                <div>\n                                    {definitionDetails}\n                                </div>\n                            </Collapse>\n                        </dl>\n                    </Card.Text>\n\n                    {props.nested}\n\n                </Card.Body>\n            </Card>\n        </Card>\n    </div>\n}\n\n\nfunction OtherDefinitionEntry(props) {\n\n    const definitions = props.data.definitions.map((x,i) => {\n        const parser = new Parser();\n        const out = parser.parse(x);\n        return <li key={i} className={\"sui-definitionEntry-other\"}>{out}</li>;\n    });\n\n    const entry = <>\n        <Card>\n            <Card.Header>\n                {props.data.name}\n            </Card.Header>\n            <Card.Body>\n                <div className={\"sui-definitionEntry-term\"}>{props.kmap.name_latin[0]}</div>\n                <ol className={\"sui-definitionEntry-other\"}>\n                    {definitions}\n                </ol>\n            </Card.Body>\n        </Card>\n\n\n        {/*<pre>{ JSON.stringify(props,undefined,3) }</pre>*/}\n    </>\n\n\n    return entry;\n}\n\nexport default Definitions;","import {buildNestedDocs} from \"./common/utils\";\nimport Card from \"react-bootstrap/Card\";\nimport React from \"react\";\n\nexport default function TermNames(props) {\n\n    // console.log(\"calling buildNestedDocs\");\n\n    // TODO: Refactor so that Redux delivers the rebuilt nested docs instead of leaving it up to the Components.\n    const namesTree = buildNestedDocs(props.kmap._childDocuments_, \"related_names\");\n\n    let output = <Card className={\"kmap-entry\"}>\n        <Card.Body><Card.Title>Names</Card.Title>\n            <ul className={\"sui-nameEntry\"}><NameEntry names={namesTree}/></ul>\n        </Card.Body>\n    </Card>\n    return output;\n\n}\n\n/* NameEntry recursively draws the Name Tree\n*   expects: props.names = tree built by buildNestedDocs()\n*\n* Perhaps this should parameterized...?\n*\n*/\nexport function NameEntry(props) {\n    let outlist = [];\n\n    console.log(\"NameEntry: props.names=\", props.names)\n    Object.entries(props.names).map(([id, entry]) => {\n        outlist.push(\n            <li id={id} key={id} className={\"sui-nameEntry\"}>\n                <span className={\"sui-nameEntry-header\"}>{entry.related_names_header_s}</span>\n                <span className={\"sui-nameEntry-meta\"}>\n                            <span className={\"sui-nameEntry-language\"}>{entry.related_names_language_s}</span>\n                            <span className={\"sui-nameEntry-relationship\"}>{entry.related_names_relationship_s}</span>\n                            <span\n                                className={\"sui-nameEntry-writing-system\"}>{entry.related_names_writing_system_s}</span>\n                        </span>\n                <ul>\n                    <NameEntry names={entry._nested_}/>\n                </ul>\n            </li>\n        );\n        return true;\n    });\n    const output = <React.Fragment>{outlist}</React.Fragment>\n    return output;\n}\n","import _ from \"lodash\";\nimport React, {useRef, useState} from \"react\";\nimport Card from \"react-bootstrap/Card\";\n\nfunction TermAudioPlayer(props) {\n    const audioRefs = _.filter(props.kmap._childDocuments_, (x) => {\n        return x.block_child_type === \"terms_recording\"\n    });\n\n    const player = useRef();\n    const defRecordingUrl = audioRefs[0]?.recording_url;\n\n    const [audioUrl, setAudioUrl] = useState(defRecordingUrl);\n\n    const option_list = _.map(audioRefs, (x,i) => <option\n        key={i}\n        value={x.recording_url}>{x.recording_dialect_s}</option>);\n    const handleSelect = (e) => {\n        setAudioUrl(e.target.value)\n    }\n\n    const playButton = (audioUrl) ? <>\n            <button onClick={() => {\n                player.current.play();\n            }}><span>{'\\ue60a'}</span>\n            </button>\n            <select onChange={e => handleSelect(e)}>{option_list}</select></>\n        : \"No Audio Available\";\n\n    return <Card>\n        <div className={\"sui-audioPlayer\"}>\n            <audio src={audioUrl} ref={ref => player.current = ref}/>\n            <form onSubmit={(event) => {\n                event.preventDefault();\n                return false;\n            }}>\n                <Card.Body>\n                    <Card.Title>Audio</Card.Title>\n                    {playButton}\n                </Card.Body>\n            </form>\n        </div>\n    </Card>\n}\n\nexport default TermAudioPlayer;","import {buildNestedDocs} from \"./common/utils\";\nimport React from \"react\";\n\nfunction RelatedTerms(props) {\n    const terms = buildNestedDocs(props.kmap._childDocuments_, \"related_terms\");\n    return <div><h3>Related Terms</h3>\n        <pre>{JSON.stringify(terms, undefined, 3)}</pre>\n    </div>\n}\n\nexport default RelatedTerms;\n","import * as PropTypes from \"prop-types\";\nimport React from \"react\";\n\nfunction NodeHeader(props) {\n    const nameTibtElement = (props.kmasset.name_tibt)?props.kmasset.name_tibt[0]:props.kmasset.header;\n    const nameLatinElement = (props.kmasset.name_latin)?props.kmasset.name_latin[0]:\"\";\n    return <div className={\"sui-nodeHeader\"}>\n        <span className=\"shanticon-terms\"></span>\n        &nbsp;&nbsp;&nbsp;\n        <span className=\"sui-termTitle sui-nodeTitle\"\n              id=\"sui-termTitle\"><span\n            className={\"sui-nodeTitle-item tibt\"}>{nameTibtElement}</span>&nbsp;&nbsp;&nbsp;<span\n            className={\"sui-nodeTitle-item latin\"}>{nameLatinElement}</span></span>\n        <hr style={{\"borderTop\": \"1px solid rgb(162, 115, 63)\"}}/>\n    </div>;\n}\n\nNodeHeader.propTypes = {kmap: PropTypes.any};\n\nexport default NodeHeader;","import InputNumber from \"rc-input-number\";\nimport * as PropTypes from \"prop-types\";\nimport React, { useState } from \"react\";\n\nexport function FeaturePager(props) {\n    return <div>\n        <span>\n            <span>Page</span>\n            <InputNumber\n                aria-label=\"Set number of items per page\"\n                min={1}\n                max={props.pager.getMaxPage() + 1}\n                style={{width: \"4em\"}}\n                value={props.pager.getPage() + 1}\n                onChange={(pg) => {\n                    console.log(\"FeaturePager pg = \" + pg + \" maxPage = \" + props.pager.getMaxPage() );\n                    props.pager.setPage(pg - 1);\n                }}\n                onPressEnter={(evt) => {\n                    evt.target.blur();\n                }}\n                readOnly={false}\n                disabled={false}\n            /> of {props.pager.getMaxPage() + 1}\n        </span>\n        {props.loadingState?<span> loading...</span>:<span></span> }\n\n\n        <span className={\"float-right\"}>\n            <span>items per page:</span>\n            <InputNumber\n                aria-label=\"Set number of items per page\"\n                min={1}\n                max={100}\n                style={{width: \"4em\"}}\n                value={props.pager.getPageSize()}\n                onChange={(ps) => {\n                    props.pager.setPageSize(ps);\n                }}\n                onPressEnter={(evt) => {\n                    evt.target.blur();\n                }}\n                readOnly={false}\n                disabled={false}\n            />\n        </span>\n\n    </div>;\n}\n\nFeaturePager.propTypes = {\n    pager: PropTypes.shape({\n        getPageSize: PropTypes.func,\n        getMaxPage: PropTypes.func,\n        getPage: PropTypes.func,\n        setPageSize: PropTypes.func,\n        setPage: PropTypes.func\n    }),\n};","import Card from \"react-bootstrap/Card\";\nimport Accordion from \"react-bootstrap/Accordion\";\nimport Button from \"react-bootstrap/Button\";\n\nimport { Link } from \"react-router-dom\";\nimport _ from \"lodash\";\n// import Accordion from \"react-bootstrap/Accordion\";\n// import Button from \"react-bootstrap/Button\";\nimport * as PropTypes from \"prop-types\";\nimport React from \"react\";\n\nexport function FeatureCard(props) {\n    return <Card className={\"m-2 zoom\"} key={props.doc.uid} >\n        <Link to={ `/view/assets/${props.doc.uid}`}>\n        <Card.Img variant=\"top\" src={props.doc.url_thumb}/>\n        </Link>\n        <Card.Body>\n            <Card.Title>{props.doc.title[0]}</Card.Title>\n            <Card.Text>\n                <p>{props.doc.uid}</p>\n                <p>{!_.isEmpty(props.doc.caption) ? props.doc.caption : props.doc.summary}</p>\n            </Card.Text>\n            {/*<Button variant=\"primary\">Go somewhere</Button>*/}\n\n            <Accordion>\n                <Accordion.Toggle as={Button} eventKey=\"0\">\n                    Item JSON\n                </Accordion.Toggle>\n                <Accordion.Collapse eventKey=\"0\">\n                        <pre>\n                            {JSON.stringify(props.doc, undefined, 2)}\n                        </pre>\n                </Accordion.Collapse>\n            </Accordion>\n        </Card.Body>\n    </Card>;\n}\n\nFeatureCard.propTypes = {doc: PropTypes.any};","import React, {useEffect, useState} from \"react\";\nimport Card from \"react-bootstrap/Card\";\nimport Accordion from \"react-bootstrap/Accordion\";\nimport Button from \"react-bootstrap/Button\";\nimport Jumbotron from \"react-bootstrap/Jumbotron\";\nimport Container from \"react-bootstrap/Container\";\nimport CardDeck from \"react-bootstrap/CardDeck\";\nimport CardGroup from \"react-bootstrap/CardGroup\";\nimport {FeaturePager} from \"./FeaturePager\";\nimport {FeatureCard} from \"./FeatureCard\";\nimport PhotoGallery from \"react-photo-gallery\";\nimport ImageGallery from \"react-image-gallery\";\n\n\nimport \"react-image-gallery/styles/css/image-gallery.css\";\n\n// The length of the Rows at each Break Point  TODO: make the breakpoints adjustable.  Config and/or Dynamic?\nconst BP_SIZES = {\n    sm: 2,\n    md: 3,\n    lg: 4,\n    xl: 6\n}\n\n// utility function to insert breakpoints\nfunction insertBreakPoints(i, BP_SIZES, ret) {\n    if (i !== 0) {\n        if (i % BP_SIZES.sm === 0) {\n            ret.push(<div className=\"w-100 d-none d-sm-block d-md-none\" key={\"sm\" + i}></div>)\n        }\n        if (i % BP_SIZES.md === 0) {\n            ret.push(<div className=\"w-100 d-none d-md-block d-lg-none\" key={\"md\" + i}></div>)\n        }\n        if (i % BP_SIZES.lg === 0) {\n            ret.push(<div className=\"w-100 d-none d-lg-block d-xl-none\" key={\"lq\" + i}></div>)\n        }\n        if (i % BP_SIZES.xl === 0) {\n            ret.push(<div className=\"w-100 d-none d-xl-block\" key={\"xl\" + i}></div>)\n        }\n    }\n}\n\nexport function FeatureGallery(props) {\n\n\n    console.log(\"FeatureGallery\");\n\n    const docs = props.docs;\n\n    let DEBUG_PRE = [];\n    let LIST = [];\n\n    if (docs) {\n        console.log(\"FeatureGallery: looking at \", docs);\n        LIST = docs?.map((doc, i) => {\n            // TODO: how to handle missing width or height\n\n            console.log(\"FeatureGallery: url_large = \", doc.url_large);\n            console.log(\"FeatureGallery: doc = \", doc);\n\n            const featureCard = {\n\n                original: (doc.url_large)?doc.url_large:doc.url_thumb,\n                thumbnail: doc.url_thumb,\n                src: doc.url_thumb,\n                width: Number(doc.url_thumb_width),\n                height: Number(doc.url_thumb_height),\n                key: doc.uid\n            }\n            return featureCard;\n        });\n        console.log(\"FeatureGallery LIST = \", LIST);\n\n        DEBUG_PRE =\n            <Accordion>\n                <Accordion.Toggle as={Button} eventKey=\"0\">Full JSON</Accordion.Toggle>\n                <Accordion.Collapse eventKey=\"0\">\n                    <pre>{JSON.stringify(docs, undefined, 1)}</pre>\n                </Accordion.Collapse>\n            </Accordion>\n    }\n\n    const output = <React.Fragment>\n        <h2>\n            View</h2>\n        <FeatureGalleryHeaderLine title={props.title}/>\n        <FeaturePager pager={props.pager}/>\n            <PhotoGallery targetRowHeight={200}  photos={ LIST } />\n            <ImageGallery items={ LIST } />\n        <FeaturePager pager={props.pager}/>\n\n\n\n\n        <Jumbotron>\n            {DEBUG_PRE}\n        </Jumbotron>\n\n    </React.Fragment>;\n    return output\n}\n\n// /* utility function to fill the remaining spaces in the last row */\n// function rowFiller(length, bp_sizes) {\n//     let remainderCards = [];\n//     const maxLength = bp_sizes.xl;\n//     const remainVisible = \"invisible\"\n//     for (let i = 0; i < maxLength; i++) {\n//         let remClasses = [\"m-1\", \"p-2\", \"d-none\"];  // TODO: need to get / set defaults from someplace...\n//         for (let [type, size] of Object.entries(bp_sizes)) {\n//             // console.log(`${type}: ${size}`);\n//             if (length % size !== 0 && i < size - (length % size)) {\n//                 remClasses.push(`d-${type}-block ${remainVisible}`);\n//             } else {\n//                 remClasses.push(`d-${type}-none`);\n//             }\n//         }\n//         const remainderCard = <Card className={remClasses.join(\" \")} key= { \"fill\" + i }>\n//             <Card.Text>\n//                 {/* for debugging */}\n//                 <pre>{remClasses.join(\"\\n\")}</pre>\n//             </Card.Text>\n//         </Card>\n//         remainderCards.push(remainderCard);\n//     }\n//     return remainderCards;\n// }\n\n\nfunction FeatureGalleryHeaderLine(props) {\n    if (props.title) {\n        return <h5 className={\"sui-relatedHeader\"}>{props.title}</h5>;\n    } else {\n        return null\n    }\n\n}","import Card from \"react-bootstrap/Card\";\nimport Accordion from \"react-bootstrap/Accordion\";\nimport Button from \"react-bootstrap/Button\";\nimport Jumbotron from \"react-bootstrap/Jumbotron\";\nimport {FeatureCard} from \"./FeatureCard\";\nimport React, {useEffect, useState} from \"react\";\nimport Container from \"react-bootstrap/Container\";\nimport CardDeck from \"react-bootstrap/CardDeck\";\nimport {FeaturePager} from \"./FeaturePager\";\n\n// The length of the Rows at each Break Point  TODO: make the breakpoints adjustable.  Config and/or Dynamic?\nconst BP_SIZES = {\n    sm: 2,\n    md: 3,\n    lg: 4,\n    xl: 6\n}\n\n// utility function to insert breakpoints\nfunction insertBreakPoints(i, BP_SIZES, ret) {\n    if (i !== 0) {\n        if (i % BP_SIZES.sm === 0) {\n            ret.push(<div className=\"w-100 d-none d-sm-block d-md-none\" key={\"sm\" + i}></div>)\n        }\n        if (i % BP_SIZES.md === 0) {\n            ret.push(<div className=\"w-100 d-none d-md-block d-lg-none\" key={\"md\" + i}></div>)\n        }\n        if (i % BP_SIZES.lg === 0) {\n            ret.push(<div className=\"w-100 d-none d-lg-block d-xl-none\" key={\"lq\" + i}></div>)\n        }\n        if (i % BP_SIZES.xl === 0) {\n            ret.push(<div className=\"w-100 d-none d-xl-block\" key={\"xl\" + i}></div>)\n        }\n    }\n}\n\nexport function FeatureDeck(props) {\n    const docs = props.docs;\n\n    let DEBUG_PRE = [];\n    let LIST = [];\n\n    if (docs) {\n        console.log(\"FeatureDeck: looking at \", docs);\n        LIST = docs?.map((doc, i) => {\n            let ret = [];\n            const featureCard = <FeatureCard doc={doc} key={ i }/>;\n\n            // Insert breakpoints for various window sizes\n            insertBreakPoints(i, BP_SIZES, ret);\n            ret.push(featureCard);\n            return ret;\n        });\n        let REMAINDER = rowFiller(LIST.length, BP_SIZES);\n        LIST.push(...REMAINDER);\n        console.log(\"FeatureDeck LIST = \", LIST);\n\n        DEBUG_PRE =\n            <Accordion>\n                <Accordion.Toggle as={Button} eventKey=\"0\">Full JSON</Accordion.Toggle>\n                <Accordion.Collapse eventKey=\"0\">\n                    <pre>{JSON.stringify(docs, undefined, 1)}</pre>\n                </Accordion.Collapse>\n            </Accordion>\n    }\n\n    const output = <React.Fragment>\n        <FeatureGalleryHeaderLine title={props.title}/>\n        <h2>Card Deck View</h2>\n        <FeaturePager pager={props.pager}/>\n        <Container>\n            <CardDeck>\n                {LIST}\n            </CardDeck>\n        </Container>\n        <FeaturePager pager={props.pager}/>\n        <Jumbotron>\n            {DEBUG_PRE}\n        </Jumbotron>\n\n    </React.Fragment>;\n    return output\n}\n\n/* utility function to fill the remaining spaces in the last row */\nfunction rowFiller(length, bp_sizes) {\n    let remainderCards = [];\n    const maxLength = bp_sizes.xl;\n    const remainVisible = \"invisible\"\n    for (let i = 0; i < maxLength; i++) {\n        let remClasses = [\"m-1\", \"p-2\", \"d-none\"];  // TODO: need to get / set defaults from someplace...\n        for (let [type, size] of Object.entries(bp_sizes)) {\n            // console.log(`${type}: ${size}`);\n            if (length % size !== 0 && i < size - (length % size)) {\n                remClasses.push(`d-${type}-block ${remainVisible}`);\n            } else {\n                remClasses.push(`d-${type}-none`);\n            }\n        }\n        const remainderCard = <Card className={remClasses.join(\" \")} key= { \"fill\" + i }>\n            <Card.Text>\n                {/* for debugging */}\n                <pre>{remClasses.join(\"\\n\")}</pre>\n            </Card.Text>\n        </Card>\n        remainderCards.push(remainderCard);\n    }\n    return remainderCards;\n}\n\n\nfunction FeatureGalleryHeaderLine(props) {\n    if (props.title) {\n        return <h5 className={\"sui-relatedHeader\"}>{props.title}</h5>;\n    } else {\n        return null\n    }\n\n}","import React from \"react\";\nimport {FeaturePager} from \"./FeaturePager\";\nimport _ from 'lodash';\nimport Card from \"react-bootstrap/Card\";\nimport Container from \"react-bootstrap/Container\";\nimport Accordion from \"react-bootstrap/Accordion\";\nimport Button from \"react-bootstrap/Button\";\n\nexport function FeatureList(props) {\n\n    let LIST =\n        _.map(props.docs, (doc) => {\n            return <Card className={\"p-0 m-1\"}>\n                <Accordion>\n                    <Card.Body className={\"p-1\"}><span\n                        className={\"shanticon-\" + doc.asset_type}></span> {doc.title} ({doc.uid})\n                        <Accordion.Toggle as={\"span\"} eventKey=\"0\" onClick={(x) => {\n                            if (x.target.innerHTML === \"(+)\") {\n                                x.target.innerHTML = \"(-)\"\n                            } else {\n                                x.target.innerHTML = \"(+)\"\n                            }\n                        }}>(+)</Accordion.Toggle>\n                        <Accordion.Collapse eventKey=\"0\">\n                            <Card>\n                        <pre>\n                            {JSON.stringify(doc, undefined, 2)}\n                        </pre>\n                            </Card>\n                        </Accordion.Collapse>\n                    </Card.Body>\n                </Accordion>\n\n                {/*<Card.Footer><pre>{ JSON.stringify(doc, undefined,2)}</pre></Card.Footer>*/}\n            </Card>\n        })\n\n\n    const output = <div>\n        <h2>Feature List</h2>\n        <Container>\n            <FeaturePager pager={props.pager}/>\n            {LIST}\n            <FeaturePager pager={props.pager}/>\n        </Container>\n    </div>\n\n\n    return <div>{output}\n        <pre>{JSON.stringify(props, undefined, 2)}</pre>\n    </div>\n\n}","import {FeatureGallery} from \"./FeatureGallery\";\nimport React, {useState} from \"react\";\nimport {useParams, Redirect, useHistory} from \"react-router\";\nimport _ from 'lodash';\nimport {FeatureDeck} from \"./FeatureDeck\";\nimport {FeatureList} from \"./FeatureList\";\nimport ButtonGroup from \"react-bootstrap/ButtonGroup\";\nimport Button from \"react-bootstrap/Button\";\nimport ToggleButton from \"react-bootstrap/ToggleButton\";\nimport ToggleButtonGroup from \"react-bootstrap/ToggleButtonGroup\";\n\n// There are three view modes encapsulated by three different components\n//          gallery:    FeatureGallery\n//          list:       FeatureList\n//          deck:       FeatureDeck\n//\n// FeatureCollection decides which view mode to use depending on two different settings\n//  1. viewMode property\n//  2. viewMode path id\n//\n\nconst DEFAULT_VIEWMODE = \"deck\"   //  deck or gallery or list\n\nexport function FeatureCollection(props) {\n    const params = useParams();\n    console.log(\"FeatureCollection: params: \", params);\n    const { viewMode: paramsViewMode } = params;\n    const [ viewMode, setViewMode ] = useState(DEFAULT_VIEWMODE);\n\n    // let determine the requested viewMode from props or from params.\n    const requestedViewMode = (paramsViewMode)?paramsViewMode:props.viewMode;\n\n    console.log(\"FeatureCollection: props.viewMode = \", props.viewMode);\n    console.log(\"FeatureCollection: requestedViewMode = \", requestedViewMode);\n    console.log(\"FeatureCollection: paramsViewMode = \", paramsViewMode);\n\n\n    if (!_.isEmpty(requestedViewMode) && viewMode !== requestedViewMode) {\n        setViewMode(requestedViewMode);\n    }\n\n    if ( (viewMode && paramsViewMode) && (paramsViewMode !== viewMode)) {\n        return <Redirect to={viewMode}/>\n    }\n\n    console.log( \"FeatureCollection: FINAL VIEWMODE = \", viewMode );\n\n    let viewer = <Redirect to={ DEFAULT_VIEWMODE } />; // by default, let's redirect to the DEFAULT_VIEWMODE url\n    switch(viewMode) {\n        case \"gallery\":\n            viewer =<FeatureGallery {...props}/>\n            break;\n        case \"deck\":\n            viewer= <FeatureDeck {...props}/>\n            break;\n        case \"list\":\n            viewer= <FeatureList {...props}/>\n            break;\n    }\n\n    return <div>\n        <h5>View Mode: <FeatureCollectionViewModeSelector viewMode={viewMode} /></h5>\n        {viewer}\n    </div>\n}\n\nfunction FeatureCollectionViewModeSelector(props) {\n\n    const history = useHistory();\n    const { viewMode } = props;\n    const deck = { active: `viewMode === \"deck\"`};\n    const gallery = { active: `viewMode === \"gallery\"`};\n    const list = { active: `viewMode === \"list\"`};\n\n    function navigate(viewMode) {\n        console.log(\"navigating \", viewMode);\n        history.push(viewMode);\n    }\n\n    return <ToggleButtonGroup name={viewMode} value={viewMode} type={\"radio\"} onChange= { (x) => { navigate(x)} }>\n        <ToggleButton name={\"viewMode\"} value={\"deck\"} type={\"radio\"}>Card Deck</ToggleButton>\n        <ToggleButton name={\"viewMode\"} value={\"gallery\"} type={\"radio\"}>Gallery</ToggleButton>\n        <ToggleButton name={\"viewMode\"} value={\"list\"} type={\"radio\"}>List</ToggleButton>\n    </ToggleButtonGroup>\n}","import {useParams} from \"react-router-dom\";\nimport React from \"react\";\nimport {FeatureGallery} from \"./FeatureGallery\";\nimport {FeatureCollection} from \"./FeatureCollection\";\n\n\n\n// Special case of the FeatureGallery\nexport function RelatedsGallery(props) {\n    const {relatedType: type} = useParams(); // USES PARAMS from React Router  Refactor?\n    const allAssets = props.relateds?.assets;\n    const assets = (allAssets) ? allAssets[type] : null;\n    const docs = assets?.docs;\n\n    // Give a nice title.\n    const title = (type !== \"all\")?`Related ${type}`: \"All Related Items\";\n    return <FeatureCollection docs={docs} pager={props.pager} title={title} viewMode={\"gallery\"}/>\n}","import React from 'react';\nimport {Route, Switch} from 'react-router-dom';\nimport Definitions from './TermsViewer_Definitions';\nimport TermNames from \"./TermsViewer_Names\";\nimport TermAudioPlayer from \"./TermsViewer_AudioPlayer\";\nimport RelatedTerms from \"./TermsViewer_RelatedTerms\";\n// import CardGroup from \"react-bootstrap/CardGroup\";\nimport 'rc-input-number/assets/index.css';\nimport NodeHeader from \"./common/NodeHeader\";\nimport {FeatureGallery} from \"./common/FeatureGallery\";\nimport {RelatedsGallery} from \"./common/RelatedsGallery\";\n\n// import KmapContext from \"../context/KmapContext\";\n\n// Bootstrap\n\nexport default function TermsViewer(props) {\n\n    let output = <div className={'termsviewer'}>\n        Loading...\n    </div>;\n    if (props.kmasset && props.kmasset.asset_type) {\n        output =\n            <div className={'termsviewer'}>\n                <div className={\"sui-terms\"}>\n                    <NodeHeader kmasset={props.kmasset}/>\n                    <Switch>\n                        <Route path={'/view/:viewerType/:id/related/:relatedType/:viewMode?'}>\n                            <RelatedsGallery {...props}/>\n                        </Route>\n                        <Route>\n                            <TermNames kmap={props.kmap}/>\n                            <TermAudioPlayer kmap={props.kmap}/>\n                            <Definitions kmap={props.kmap}/>\n                            <RelatedTerms kmap={props.kmap}/>\n                        </Route>\n                    </Switch>\n                </div>\n                {/*<pre>{JSON.stringify(props.kmap, undefined, 2)}</pre>*/}\n            </div>\n    }\n\n    return output;\n}\n\n","import React from \"react\";\nimport {FeatureCollection} from \"./common/FeatureCollection\";\n\nexport function SearchViewer (props) {\n    let output = <FeatureCollection {...props} viewMode={\"deck\"} />;\n    return <><h2>SEARCH IS GROOVY</h2> { output }</>\n}","import React from 'react';\n\nexport class CollectionsViewer extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        console.error(typeof props.sui);\n        if (typeof props.sui !== 'object') {\n            throw new Error(\"sui must be passed as a property to the component!\");\n        }\n\n        if (typeof props.sui.pages !== 'object') {\n            throw new Error(\"sui.pages must be passed as part of the sui passed to the constructor!\");\n        }\n\n        this.sui = props.sui;\n        this.props = props;\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    shouldComponentUpdate(nextProps, nextState, nextContext) {\n    }\n\n    render() {\n        return <div class={\"collections legacy\"} >COLLECTIONS LEGACY { JSON.stringify(this.props) }</div>\n\n    }\n}","import axios from 'axios';\nimport jsonpAdapter from 'axios-jsonp';\nimport crypto from 'crypto';\nimport _ from 'lodash';\n\nfunction checksum(data) {\n    return crypto.createHash('sha1').update(data).digest('base64');\n}\n\n// TODO: There needs to be better/smarter caching.  sessionStorage is too small to be unmanaged like this.\nexport async function search(searchstate) {\n\n    return await getAssetSearchPromise(searchstate);\n\n    // TODO:  need to pass configuration.   dev defaults are used now.\n}\n\n//  TODO: Maybe refactor to use declarative caching instead...?\nfunction getCached(request) {\n\n    let data = null;\n    // TODO: Need explicit cache controls and timeouts, etc.\n    if (sessionStorage) {\n        try {\n            const cached = sessionStorage.getItem(checksum(JSON.stringify(request)));\n            if (cached) {\n                data = JSON.parse(cached);\n            }\n        } catch (e) {\n            console.log(\"Ignored sessionStorage error: \", e);\n        }\n    }\n    console.log(\"getCached: returning: \", data);\n    return data;\n}\n\nfunction setCache(request, data) {\n    if (sessionStorage) {\n        try {\n            sessionStorage.setItem(checksum(JSON.stringify(request)), JSON.stringify(data));\n            console.log(\"Cached: data for \", JSON.stringify(request));\n        } catch (e) {\n            console.log(\"Ignored sessionStorage error: \", e);\n            // ignore\n        }\n    }\n}\n\nexport function clearCache() {\n    sessionStorage.clear();\n}\n\nexport function getAssetSearchPromise(search) {\n\n    // TODO: parameterize the use of facets\n    // TODO: parameterize constructTextQuery\n\n    console.log(\"UNPACKING search: \", search);\n    const {page, query} = search;\n\n    console.log(\"UNPACKING page: \", page);\n    console.log(\"UNPACKING query: \", query);\n\n    const host = 'ss251856-us-east-1-aws.measuredsearch.com';\n    const index = 'kmassets_dev';\n    const selectUrl = 'https://' + host + '/solr/' + index + '/select';\n    const startRec = page.start || 0;\n    const rowsRec = page.rows || 10;\n\n    // TODO: Parameterize facets.  e.g. You won't need all of them, every time.\n    const jsonFacet = {\n        asset_count: {\n            type: \"terms\",\n            field: \"asset_type\",\n            limit: 500\n        },\n        related_subjects: {\n            type: \"terms\",\n            field: \"kmapid_subjects_idfacet\",\n            limit: 500\n        },\n        related_terms: {\n            type: \"terms\",\n            field: \"kmapid_terms_idfacet\",\n            limit: 500\n        },\n        \"feature_types\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"feature_types_idfacet\"\n        },\n        \"languages\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"node_lang\"\n        },\n        \"collections\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"collection_idfacet\"\n        },\n\n        \"collection_nid\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"collection_nid\"\n        },\n        \"collection_uid\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"collection_uid_s\"\n        },\n        \"asset_subtype\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"asset_subtype\",\n            \"facet\": {\n                \"parent_type\": {\n                    \"limit\": 1,\n                    \"type\": \"terms\",\n                    \"field\": \"asset_type\"\n                }\n            }\n        },\n        \"node_user\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"user_name_full_s\"\n        },\n        \"creator\": {\n            \"limit\": 300,\n            \"type\": \"terms\",\n            \"field\": \"creator\"\n        }\n    };\n\n    let params = {\n        'fl': '*',\n        'wt': 'json',\n        'echoParams': 'explicit',\n        'indent': 'true',\n        'start': startRec,\n        'rows': rowsRec,\n        // eslint-disable-next-line\n        // 'q': 'text:${text}',\n        // 'text': search.query.searchText,\n        'json.facet': JSON.stringify(\n            jsonFacet\n        )\n    };\n\n    const queryParams = constructTextQuery(search.query.searchText);\n\n    params = {...params, ...queryParams}\n\n    const request = {\n        'adapter': jsonpAdapter,\n        'callbackParamName': 'json.wrf',\n        'url': selectUrl,\n        'params': params\n    }\n\n    const promise = new Promise((resolve, reject) => {\n        let data = getCached(request);\n        if (data) {\n            resolve(data);\n            return;\n        }\n\n        console.log(\"getAssetSearchPromise(): Calling axios:\", request);\n\n        performance.mark(\"getAssetSearchPromise:start\");\n        axios.request(request).then((res) => {\n            console.log(\"getAssetSearchPromise():  Yay! axios call succeeded!\", res);\n            console.log(\"getAssetSearchPromise(): res = \", res);\n            const data = {\n                numFound: res.data.response.numFound,\n                docs: _.map(res.data.response.docs, (x) => { return cleanAssetData(x); }),\n                facets: res.data.facets\n            }\n\n\n            setCache(request, data);\n            resolve(data);\n        }).catch(reason => {\n            console.log(\"getAssetSearchPromise(): OUCH axios call failed!\", reason);\n            reject(reason);\n        }).finally(() => {\n            performance.mark(\"getAssetSearchPromise:done\");\n            performance.measure(\"getAssetSearchPromise\", \"getAssetSearchPromise:start\", \"getAssetSearchPromise:done\");\n            console.log(\"performance:\", performance.getEntriesByName(\"getAssetSearchPromise\"));\n\n            const perf = performance.getEntriesByName(\"getAssetSearchPromise\");\n            perf.forEach( (x) => { console.log(\"getAssetSearchPromise() duration:\" + x.duration )});\n            console.log(\"performance getEntries:\", performance.getEntries());\n            performance.clearMeasures();\n        })\n    });\n    return promise;\n}\n\nexport function getAssetDataPromise(kmapid) {\n\n    const host = 'ss251856-us-east-1-aws.measuredsearch.com';\n    const index = 'kmassets_dev';\n    const selectUrl = 'https://' + host + '/solr/' + index + '/select';\n    const startRec = 0;\n    const rowsRec = 1;\n\n    const request = {\n        'adapter': jsonpAdapter,\n        'callbackParamName': 'json.wrf',\n        'url': selectUrl,\n        'params': {\n            'fl': '*',\n            'wt': 'json',\n            'echoParams': 'explicit',\n            'indent': 'true',\n            'start': startRec,\n            'rows': rowsRec,\n            // eslint-disable-next-line\n            'q': 'uid:${kmapid}',\n            'kmapid': kmapid\n        }\n    }\n\n    const promise = new Promise((resolve, reject) => {\n        let data = getCached(request);\n        if (data) {\n            resolve(data);\n            return;\n        }\n\n        console.log(\"getAssetDataPromise(): Calling axios:\");\n        axios.request(request).then((res) => {\n            console.log(\"getAssetDataPromise():  Yay! axios call succeeded!\", res);\n            const data = res.data.response.docs[0];\n            setCache(request, data);\n            resolve(data);\n        }).catch(reason => {\n            console.log(\"gertAssetDataPromise(): OUCH axios call failed!\", reason);\n            reject(reason);\n        });\n    });\n    return promise;\n}\n\nexport function getFullKmapDataPromise(kmapid) {\n\n    const host = 'ss251856-us-east-1-aws.measuredsearch.com';\n    const index = 'kmterms_dev';\n    const selectUrl = 'https://' + host + '/solr/' + index + '/select';\n    const startRec = 0;\n    const rowsRec = 1;\n\n    const request = {\n        'adapter': jsonpAdapter,\n        'callbackParamName': 'json.wrf',\n        'url': selectUrl,\n        'params': {\n            'fl': '*,[child parentFilter=block_type:parent limit=1000]',\n            'wt': 'json',\n            'echoParams': 'explicit',\n            'indent': 'true',\n            'start': startRec,\n            'rows': rowsRec,\n            // eslint-disable-next-line\n            'q': 'uid:${kmapid}',\n            'kmapid': kmapid\n        }\n    }\n\n    const promise = new Promise((resolve, reject) => {\n        let data = getCached(request);\n        if (data) {\n            resolve(data);\n            return;\n        }\n        console.log(\"getFullKmapDataPromise(): Calling axios:\")\n        axios.request(request).then((res) => {\n            console.log(\"getFullKmapDataPromise(): Yay! axios call succeeded!\", res);\n            const data = cleanKmapData(res.data.response.docs[0]);\n            setCache(request, data);\n            resolve(data);\n        }).catch(reason => {\n            console.log(\"getFullKmapDataPromise(): OUCH axios call failed!\", reason);\n            reject(reason);\n        });\n    });\n    return promise;\n\n\n}\n\nfunction deriveImageUrl(url_thumb, size) {\n    console.log(\"deriveImageUrl: \", url_thumb);\n    const url_large = url_thumb.toString().replace('200,200',size +\",\" + size);\n    console.log(\"deriveImageUrl: large = \", url_large);\n    return url_large;\n}\n\nfunction cleanKmapData(data) {\n\n    console.log(\"clean kmap data = \", data);\n    return data;\n}\n\nexport function getRelatedAssetsPromise(kmapid, type, start, rows) {\n\n    console.log(\"getRelatedAssetsPromise() Promising: \", arguments);\n    const host = 'ss251856-us-east-1-aws.measuredsearch.com';\n    const index = 'kmassets_dev';\n    const selectUrl = 'https://' + host + '/solr/' + index + '/select';\n    const defaultStart = 0;\n    const defaultRows = 100;\n\n    const ALL = [\"audio-video\", \"images\", \"texts\", \"visuals\", \"sources\", \"subjects\", \"places\", \"terms\"];\n\n    const asset_types = (typeof type === \"undefined\" || type === \"all\") ? ALL : [type];\n    const startRec = (typeof start === \"undefined\") ? defaultStart : start;\n    const rowsRec = (typeof rows === \"undefined\") ? defaultRows : rows;\n\n    console.log(\"getRelatedAssetsPromise: start = \" + startRec + \" rows = \" + rowsRec);\n\n\n    const facetJson = JSON.stringify({\n        'asset_counts': {\n            'limit': 20,\n            'type': 'terms',\n            'field': 'asset_type',\n            'domain': {'excludeTags': 'ast'}\n        }\n    });\n\n    let params = {\n        'fl': '*',\n        'wt': 'json',\n        'echoParams': 'explicit',\n        'indent': 'true',\n        'start': startRec,\n        'rows': rowsRec,\n        'json.facet': facetJson,\n        // eslint-disable-next-line\n        'q': '(uid:${kmapid}^100+kmapid:${kmapid})',\n        'kmapid': kmapid,\n        'fq': '{!tag=ast}asset_type:( ' + asset_types.join(' ') + ')'\n    };\n\n    const request = {\n        'adapter': jsonpAdapter,\n        'callbackParamName': 'json.wrf',\n        'url': selectUrl,\n        'params': params\n    }\n\n    const unpackResponse = (res) => {\n\n        console.log(\"unpacking asset_counts: \", res.data.facets);\n\n        const buckets = res.data.facets.asset_counts.buckets;\n\n        let asset_counts = {\n            \"all\": {\"count\": 0, \"docs\": res.data.response.docs}\n        };\n        buckets.forEach((x) => {\n            asset_counts[x.val] = {count: x.count, docs: []};\n            asset_counts[\"all\"].count += x.count;\n        });\n\n        console.log(\"unpacking assets: \", res.data.response.docs);\n        const docs = res.data.response.docs;\n\n\n        docs.forEach((x) => {\n            const y = cleanAssetData(x);\n            asset_counts[x.asset_type].docs.push(y);\n        });\n\n        return {\n            uid: kmapid,\n            start: start,\n            rows: rows,\n            type: type,\n            stateKey: [kmapid, type, start, rows].join(\"/\"),\n            assets: asset_counts\n        };\n    };\n\n    const promise = new Promise((resolve, reject) => {\n        let data = getCached(request);\n        if (data) {\n            resolve(data);\n            return;\n        }\n        console.log(\"getRelatedAssetsPromise(): Calling axios:\")\n        axios.request(request).then((res) => {\n            console.log(\"getRelatedAssetsPromise():  Yay! axios call succeeded!\", res);\n            const data = unpackResponse(res);\n            setCache(request, data);\n            resolve(data);\n        }).catch(reason => {\n            console.log(\"getRelatedAssetsPromise(): OUCH axios call failed!\", reason);\n            reject(reason);\n        });\n    });\n    return promise;\n\n}\n\nfunction cleanAssetData(data) {\n\n    // TODO: refactor this grunginess\n\n    const asset_type = data.asset_type;\n\n    console.log(\"cleanAssetData \", asset_type);\n\n    switch (asset_type) {\n        case 'texts':\n        case 'sources':\n        case 'subjects':\n        case 'places':\n        case 'terms':\n        case 'collections':\n            data.url_large = \"/mandala-om/gradient.jpg\";\n            data.url_thumb = \"/mandala-om/gradient.jpg\";\n            data.url_thumb_height = 100.0;\n            data.url_thumb_width = 150.0;\n            break;\n        case 'images':\n            data.url_large = deriveImageUrl(data.url_thumb,1200);\n            break;\n        default:\n            break;\n    }\n\n    console.log(\"clean thumb = \", data.url_thumb);\n\n    console.log(\"returning clean: \", data);\n    return data;\n}\n\n// TODO: Refactor: parameterize basic_req to select which fields to search.\nfunction constructTextQuery(searchString) {\n\n    let searchstring = escapeSearchString(searchString || \"\");\n\n    // console.log (JSON.stringify(state));\n    let starts = (searchstring.length) ? searchstring + \"*\" : \"*\";\n    let search = (searchstring.length) ? \"*\" + searchstring + \"*\" : \"*\";\n    let slashy = searchstring + \"/\";\n    if (!searchString || searchstring.length === 0) {\n        searchstring = search = slashy = \"*\";\n    }\n\n    var basic_req = {\n        // search: tweak for scoping later\n        \"q\": \"(\" +\n            \" title:${xact}^100\" +\n            \" title:${slashy}^100\" +\n            // \" title:${search}^10\" +\n            \" title:${starts}^80\" +\n            \" names_txt:${xact}^90\" +\n            \" names_txt:${starts}^70\" +\n            // \" names_txt:${search}\" +\n            // \" caption:${search}\" +\n            // \" summary:${search}\" +\n            \")\",\n\n        // search strings\n        \"xact\": searchstring,\n        \"starts\": starts,\n        \"search\": search,\n        \"slashy\": slashy,\n    };\n\n    return basic_req;\n}\n\nfunction escapeSearchString(str) {\n    str = str.replace(/ /g, '\\\\ '); // escape spaces\n    str = str.replace('(', '\\\\(');\n    str = str.replace(')', '\\\\)');\n    str = str.replace(':', '\\\\:');\n    str = str.replace('+', '\\\\+');\n    str = str.replace('-', '\\\\-');\n    str = str.replace('\"', '\\\\\\\"');\n    str = str.replace('?', '\\\\?');\n    return str;\n}\n","import React, {useState} from 'react';\nimport {useParams} from \"react-router\";\nimport {getRelatedAssetsPromise, getAssetDataPromise, getFullKmapDataPromise} from \"../logic/searchapi\";\nimport _ from 'lodash';\n\n/**\n *    Container which injects the kmap and kmasset data, before rendering the its children.\n *\n *    It injects the props:\n *\n *          kmap:  The current fully-populated KMAP data including full solr child data\n *          kmasset:  The current ASSET data\n *\n *          NB:  This will ONLY inject into top-level children.  It is fully expected for these top-level components to manage\n *          passing its props to its children as needed.\n *\n *\n * */\nexport default function KmapContext(props) {\n\n    console.log(\"KmapContext: props=\", props);\n\n    // eslint-disable-next-line\n    const [kmapId, setKmapId] = useState(\"\");\n    const [kmasset, setKmAsset] = useState({});\n    const [relateds, setRelateds] = useState({});\n    const [kmap, setKmap] = useState({});\n    const [loadingState, setLoadingState] = useState (false);\n\n    // const [relatedType, setRelatedType] = useState( \"all\");\n    const [relatedPage, setRelatedPage] = useState(0);\n    const [pageSize, setPageSize] = useState(10);  // TODO this should be a configuration\n    const params = useParams();\n    const {id, relatedType} = params;\n\n    const pager = {\n        getMaxPage: () => {\n            if (!relateds.assets) {\n                return 0;\n            } else {\n                const maxCount = relateds.assets[relatedType].count;\n                const maxPage = Math.floor((maxCount-1) / pageSize);\n                console.log( \"getMaxPage(): pageSize = \",pageSize, \" maxCount = \",maxCount,\" => maxPage = \", maxPage);\n                return maxPage;\n            }\n        },\n        getPage: () => {\n            return relatedPage\n        },\n        setPage: (pg) => {\n            pg = Number(pg);\n            const maxCount = relateds.assets[relatedType].count;\n            const maxPage = Math.floor(maxCount / pageSize);\n            pg = (_.isNaN(pg))?0:pg;\n            if (pg > maxPage) {\n                setRelatedPage(() => maxPage);\n            } else if (pg < 0) {\n                setRelatedPage(() => 0);\n            } else {\n                setRelatedPage(() => pg);\n            }\n        },\n        setPageSize: (size) => {\n            size = Number(size);\n            let oldSize = Number(size);\n            let oldPage = Number(relatedPage);\n            size=(size < 1)?1:size;\n            size=_.isNaN(size)?oldSize:size;\n            setPageSize(size);\n            let newPage = Math.floor((pageSize / oldSize) * oldPage);\n            // console.log(\"newPage: \" + newPage + \" oldPage: \" + oldPage + \" pageSize = \" + pageSize + \" oldSize = \" + oldSize);\n            newPage= _.isNaN(newPage)?0:newPage;\n            pager.setPage(newPage);\n        },\n        getPageSize: () => {\n            return pageSize;\n        },\n\n    }\n\n    if (!props.children) {\n        let output = <h2>No Children?</h2>;\n        return output;\n    } else {\n\n        let changed = false;\n\n        const start = relatedPage * pageSize;\n\n        console.log(\"KmapContext: id = \" + id + \" relatedType = \" + relatedType);\n\n        const promises = [getAssetDataPromise(id),\n            getFullKmapDataPromise(id),\n            getRelatedAssetsPromise(id, relatedType, start, pageSize)];\n\n        Promise.allSettled(promises).then(([kmasset_result, kmap_result, relateds_result]) => {\n\n            const {status: kmasset_status, value: new_kmasset} = kmasset_result;\n            const {status: kmap_status, value: new_kmap} = kmap_result;\n            const {status: relateds_status, value: new_relateds} = relateds_result;\n\n            let kmprops = {};\n\n            if (new_kmap && (kmap_status === 'fulfilled') && kmap.uid !== new_kmap.uid) {\n                kmprops.kmap = new_kmap;\n                setKmap(new_kmap);\n                setKmapId(id);\n                changed = true;\n            }\n            if (new_kmasset && kmasset_status === 'fulfilled' && kmasset.uid !== new_kmasset.uid) {\n                kmprops.kmasset = new_kmasset;\n                setKmAsset(new_kmasset);\n                changed = true;\n            }\n\n            console.log(\"relateds looks like: \", new_relateds);\n            if (relateds_status === 'fulfilled' && relateds.stateKey !== new_relateds.stateKey) {\n                kmprops.relateds = new_relateds;\n                setRelateds(new_relateds);\n                changed = true;\n            }\n\n            if (changed && props.onStateChange) {\n                props.onStateChange({id: id, kmap: kmap, kmasset: kmasset, relateds: relateds, pager: pager});\n            }\n        }).catch(e => {\n            console.error(\"oh dear! \", e)\n        });\n    }\n\n\n    const ret_children = React.Children.map(props.children, (child) => {\n        if (child.type) {\n            const new_child = React.cloneElement(child, {\n                id: id,\n                kmap: kmap,\n                kmasset: kmasset,\n                relateds: relateds,\n                pager: pager\n            });\n            return new_child;\n        } else {\n            return child;\n        }\n    });\n    return ret_children;\n}\n\n\n\n\n\n\n","import {Action, action, Computed, computed, thunk, Thunk, ThunkOn, thunkOn} from 'easy-peasy';\nimport {search} from '../logic/searchapi';\nimport {StoreModel} from \"./StoreModel\";\n\ninterface Results {\n    numFound: number | number;\n    docs: string[];\n    facets: string[];\n}\n\ninterface Query {\n    searchText: string;\n    filters: Filter[];\n    facetConfigs: FacetConfig[];\n}\n\ninterface Page {\n    current: number;\n    start: number;\n    rows: number;\n    maxStart: number;\n}\n\nexport interface SearchModel {\n    loadingState: boolean,\n    results: Results,\n    query: Query,\n    page: Page\n\n    // PAGING ACTIONS\n    gotoPage: Action<SearchModel, number>\n    nextPage: Action<SearchModel, number>\n    prevPage: Action<SearchModel, number>\n    firstPage: Action<SearchModel, number>\n    lastPage: Action<SearchModel, number>\n    setPageSize: Action<SearchModel, number>\n\n    // QUERY ACTIONS\n    setSearchText: Action<SearchModel, string>\n    update: Thunk<SearchModel,\n        void,\n        any,\n        StoreModel,\n        any>\n    receiveResults: Action<SearchModel, Results>\n    addFilters: Action<SearchModel, Filter[]>\n    removeFilters: Action<SearchModel, Filter[]>\n\n    // can clearFilters of a certain type\n    clearFilters: Action<SearchModel, string>\n\n    onUpdate: ThunkOn<SearchModel, StoreModel>\n}\n\nenum AssetType {\n    Places = \"places\",\n    Subjects = \"subjects\",\n    Terms = \"terms\",\n    AudioVideo = \"audio-video\",\n    Images = \"images\",\n    Visuals = \"visuals\",\n    Sources = \"sources\"\n}\n\nenum Oper {\n    Not = \"NOT\",\n    And = \"AND\",\n    Or = \"OR\"\n}\n\ninterface Filter {\n    id: string;\n    label: string;\n    asset_type?: AssetType;\n    operator: Oper;\n    field: string;\n    match: string;\n}\n\ninterface FacetConfig {\n    id: string;\n    jsonFacet: string;\n}\n\nexport const searchModel: SearchModel = {\n    loadingState: false,\n    results: {\n        numFound: 0,\n        docs: [],\n        facets: []\n    },\n    query: {\n        searchText: \"lhasa\",\n        filters: [\n            {\n                id: \"places\",\n                label: \"Places\",\n                operator: Oper.Or,\n                field: \"asset_type\",\n                match: AssetType.Places,\n            }\n        ],\n        facetConfigs: [],\n    },\n    page: {\n        current: 0,\n        start: 0,\n        rows: 10,\n        maxStart: 219\n    },\n    gotoPage: action((state, pageNum) => {\n        if (pageNum * state.page.rows > state.page.maxStart) {\n            pageNum = Math.floor(state.page.maxStart / state.page.rows)\n        } else if (pageNum < 0) {\n            pageNum = 0;\n        }\n\n        console.error(\"gotoPage() pageNum = \", pageNum);\n\n        state.page.start = state.page.rows * pageNum\n        state.page.current = pageNum;\n    }),\n    nextPage: action((state, increment) => {\n        let newStart = state.page.start + increment * state.page.rows;\n        if (newStart > state.page.maxStart) {\n            newStart = state.page.rows * Math.floor(state.page.maxStart / state.page.rows)\n        }\n        state.page.start = newStart\n    }),\n    prevPage: action((state, decrement) => {\n        let newStart = state.page.start - decrement * state.page.rows;\n        if (newStart < 0) {\n            newStart = 0\n        }\n        ;\n        state.page.start = newStart;\n    }),\n    lastPage: action((state) => {\n        state.page.start = state.page.rows * Math.floor(state.page.maxStart / state.page.rows);\n    }),\n    firstPage: action((state) => {\n        state.page.start = 0;\n    }),\n\n    setPageSize: action((state, pageSize) => {\n        if (pageSize < 1) {\n            pageSize = 1\n        }\n        state.page.rows = pageSize;\n    }),\n\n    update: thunk(async (actions, payload, helpers) => {\n        const searchState = helpers.getStoreState().search\n\n        searchState.loadingState=true;\n        console.log(\"SEARCH START: \", searchState.page.current);\n        const results = await search(searchState);\n        console.log(\"SEARCH DONE: \", searchState.page.current);\n        searchState.loadingState=false;\n\n        actions.receiveResults(results)\n    }),\n\n    receiveResults: action((state, results) => {\n        console.log(\"SEARCH Receive RESULTS: \", results);\n\n        // Is it as simple as that?\n        if (state.page.maxStart !== results.numFound) {\n            state.page.maxStart = results.numFound;\n        }\n\n        if (state.results !== results) {\n            state.results = results;\n        }\n    }),\n    setSearchText: action((state, payload) => {\n    }),\n\n    addFilters: action((state, payload) => {\n    }),\n    removeFilters: action((state, payload) => {\n    }),\n    clearFilters: action((state, payload) => {\n    }),\n\n    // LISTENERS\n    onUpdate: thunkOn(\n        // targetResolver:\n        (actions, storeActions) => [\n            actions.setPageSize,\n            actions.nextPage,\n            actions.prevPage,\n            actions.gotoPage,\n            actions.lastPage,\n            actions.firstPage,\n            actions.removeFilters,\n            actions.clearFilters,\n            actions.addFilters,\n            actions.setSearchText\n        ],\n        // handler:\n        async (actions, target) => {\n            actions.update();\n        }\n    )\n}\n\n\n","\nexport interface KmapModel {\n    uid: string;\n    kmap: KmapSolrModel;\n    asset: KmAssetSolrModel;\n    relateds: string[];\n}\n\nexport const kmapModel: KmapModel = {\n    uid: \"\",\n    kmap: { uid:\"\" },\n    asset: { uid:\"\" },\n    relateds: []\n}\n\nexport interface KmAssetSolrModel {\n    schema_version_i?:        number;\n    asset_type?:              string;\n    service?:                 string;\n    id?:                      string;\n    uid:                      string;\n    uid_i?:                   number;\n    url_html?:                string;\n    kmapid?:                  string[];\n    kmapid_is?:               number[];\n    kmapid_strict?:           string[];\n    names_txt?:               string[];\n    name_autocomplete?:       string[];\n    name_tibt?:               string[];\n    name_latin?:              string[];\n    title?:                   string[];\n    feature_types_ss?:        string[];\n    ancestors_txt?:           string[];\n    ancestor_ids_is?:         number[];\n    kmapid_subjects_idfacet?: string[];\n    kmapid_places_idfacet?:   string[];\n    feature_types_idfacet?:   string[];\n    position_i?:              number;\n    parent_uid?:              string;\n    caption?:                 string;\n    _version_?:               number;\n    timestamp?:               Date;\n}\n\n\nexport interface KmapSolrModel {\n    tree?:                                   string;\n    feature_types?:                          string[];\n    feature_type_ids?:                       number[];\n    has_shapes?:                             boolean;\n    has_altitudes?:                          boolean;\n    block_type?:                             string;\n    interactive_map_url?:                    string;\n    kmz_url?:                                string;\n    closest_fid_with_shapes?:                number;\n    id?:                                     string;\n    uid?:                                    string;\n    uid_i?:                                  number;\n    header?:                                 string;\n    position_i?:                             number;\n    caption_eng?:                            string[];\n    text?:                                   string[];\n    caption_eng_2_content_t?:                string[];\n    summary_eng?:                            string[];\n    summary_eng_1_content_t?:                string[];\n    illustration_mms_url?:                   string[];\n    created_at?:                             Date;\n    updated_at?:                             Date;\n    \"ancestor_id_closest_cult.reg_path\"?:    string;\n    \"level_closest_cult.reg_i\"?:             number;\n    \"ancestor_id_cult.reg_path\"?:            string;\n    \"ancestors_closest_cult.reg\"?:           string[];\n    \"ancestor_ids_closest_cult.reg\"?:        number[];\n    \"ancestor_uids_closest_cult.reg\"?:       string[];\n    \"level_pol.admin.hier_i\"?:               number;\n    \"ancestor_id_pol.admin.hier_path\"?:      string;\n    \"ancestors_pol.admin.hier\"?:             string[];\n    \"ancestor_ids_pol.admin.hier\"?:          number[];\n    \"ancestor_uids_pol.admin.hier\"?:         string[];\n    \"level_closest_hist.pol.admin.unit_i\"?:  number;\n    \"ancestor_id_hist.pol.admin.unit_path\"?: string;\n    \"ancestor_id_closest_elect.rel_path\"?:   string;\n    \"level_closest_elect.rel_i\"?:            number;\n    \"ancestor_id_elect.rel_path\"?:           string;\n    \"ancestors_closest_elect.rel\"?:          string[];\n    \"ancestor_ids_closest_elect.rel\"?:       number[];\n    \"ancestor_uids_closest_elect.rel\"?:      string[];\n    \"level_closest_site.rel_i\"?:             number;\n    \"ancestor_id_site.rel_path\"?:            string;\n    \"level_closest_pol.rel_i\"?:              number;\n    \"level_closest_cult.rel_i\"?:             number;\n    \"ancestor_id_closest_envir.rel_path\"?:   string;\n    \"level_closest_envir.rel_i\"?:            number;\n    \"ancestor_id_envir.rel_path\"?:           string;\n    \"ancestors_closest_envir.rel\"?:          string[];\n    \"ancestor_ids_closest_envir.rel\"?:       number[];\n    \"ancestor_uids_closest_envir.rel\"?:      string[];\n    \"level_closest_admin.rel_i\"?:            number;\n    \"level_closest_org.rel_i\"?:              number;\n    \"level_closest_rel.rel_i\"?:              number;\n    \"level_closest_geo.rel_i\"?:              number;\n    \"name_roman.popular\"?:                   string[];\n    \"name_roman.scholar\"?:                   string[];\n    \"name_trad.chi\"?:                        string[];\n    \"name_simp.chi\"?:                        string[];\n    \"name_pri.tib.sec.roman\"?:               string[];\n    \"name_pri.tib.sec.chi\"?:                 string[];\n    name_deva?:                              string[];\n    name_tibt?:                              string[];\n    name_autocomplete?:                      string[];\n    name_latin?:                             string[];\n    name?:                                   string[];\n    name_hans?:                              string[];\n    name_zh?:                                string[];\n    name_hant?:                              string[];\n    ancestors?:                              string[];\n    ancestor_ids_generic?:                   number[];\n    ancestor_uids_generic?:                  string[];\n    ancestor_id_path?:                       string;\n    level_i?:                                number;\n    _version_?:                              number;\n    _timestamp_?:                            Date;\n    _childDocuments_?:                       ChildDocuments[];\n}\n\nexport interface ChildDocuments {\n    id?:                               string;\n    uid?:                              string;\n    related_uid_s?:                    string;\n    origin_uid_s?:                     string;\n    feature_type_path_s?:              string;\n    block_child_type?:                 BlockChildType;\n    block_type?:                       BlockType;\n    feature_type_name_s?:              string;\n    related_names_t?:                  string[];\n    feature_type_id_i?:                number;\n    _timestamp_?:                      Date;\n    related_places_id_s?:              string;\n    related_places_header_s?:          string;\n    related_places_path_s?:            string;\n    related_places_feature_type_s?:    string;\n    related_places_feature_type_id_i?: number;\n    related_subjects_t?:               string[];\n    related_subject_ids?:              string[];\n    related_places_feature_types_t?:   string[];\n    related_places_feature_type_ids?:  string[];\n    related_places_relation_label_s?:  string;\n    related_places_relation_code_s?:   string;\n    related_kmaps_node_type?:          string[];\n}\n\nexport enum BlockChildType {\n    FeatureTypes = \"feature_types\",\n    RelatedPlaces = \"related_places\",\n}\n\nexport enum BlockType {\n    Child = \"child\",\n}\n\n","import {SearchModel, searchModel} from \"./SearchModel\";\nimport {KmapModel, kmapModel} from \"./KmapModel\";\nimport {createTypedHooks} from \"easy-peasy\";\n\nexport interface StoreModel {\n    kmap: KmapModel;\n    search: SearchModel;\n}\n\nexport const storeModel: StoreModel = {\n    kmap: kmapModel,\n    search: searchModel\n}\n\nexport const {\n    useStoreActions,\n    useStoreState,\n    useStoreDispatch,\n    useStore\n} = createTypedHooks <StoreModel > ();\n\n\n","import React, { useCallback, useEffect, useState } from \"react\";\nimport {useStoreState, useStoreActions} from '../model/StoreModel';\nimport _ from \"lodash\";\nimport {useParams} from \"react-router\";\n\n/**\n *    Container which injects the current search data, before rendering the its children.\n *\n *    It injects the props:\n *\n *         searchState:  the current searchState object\n *         results: the current populated results\n *\n *          NB:  This will ONLY inject into top-level children.  It is fully expected for these top-level components to manage\n *          passing its props to its children as needed.\n *\n *          We may memoize the results at this point for performance reasons.\n *\n * */\n\nexport default function SearchContext(props) {\n\n    const params = useParams();\n    console.log( \"SearchContext params = \", params);\n\n    function debounce(func) { return _.debounce(func, 500) };\n\n    function debounceAll(funcs) {\n        return _.reduce(funcs, (result, f, key) => {\n            result[key] = debounce(f);\n            return result;\n        }, {});\n    }\n\n    // This makes the Easy Peasy State Store available.\n    // we are mapping \"search\" from the Store into const \"search\".\n    const search = useStoreState(state => state.search);\n\n    // we are unpacking all the state store's actions.\n    // eventually this list of action will be enhanced with things like sort controls\n    // TODO: review: we debounce ALL the calls, for now...   maybe this is not the right place to do that.\n    const {\n        update,\n        setSearchText,\n        addFilters,\n        gotoPage,\n        nextPage,\n        prevPage,\n        lastPage,\n        firstPage,\n        clearFilters,\n        removeFilters,\n        setPageSize\n    } = debounceAll(useStoreActions(actions => actions.search));\n\n    // Let's dispatch an update right off the bat...\n    useEffect(() => {\n        console.log(\"INITING\");\n        update();\n    }, []);\n\n    // The pager encapsulates controls paging of the results in docs.\n    // Eventually it will also include things like sorting\n    const docs = search.results?.docs;\n    const pager = {\n        getMaxPage: () => {\n            if (!search.results?.numFound) {\n                return 0;\n            } else {\n                const maxCount = search.results.numFound;\n                const pageSize = search.page.rows;\n                const maxPage = Math.floor((maxCount-1) / pageSize);\n                // console.log( \"getMaxPage(): pageSize = \",pageSize, \" maxCount = \",maxCount,\" => maxPage = \", maxPage);\n                return maxPage;\n            }\n        },\n        getPage: () => {\n            return search.page.current;\n        },\n        setPage: (pg) => {\n            pg = Number(pg);\n            const maxCount = search.results.numFound;\n            const pageSize = search.page.rows;\n            const maxPage = Math.floor(maxCount / pageSize);\n            pg = (_.isNaN(pg))?0:pg;\n            if (pg > maxPage) {\n                gotoPage(maxPage);\n            } else if (pg < 0) {\n                console.log (\"SearchContext: gotoPage: 0\");\n                gotoPage(0);\n            } else {\n                console.log (\"SearchContext: gotoPage: \" + pg);\n                gotoPage(pg);\n            }\n        },\n        setPageSize: (size) => {\n\n            size = Number(size);\n            let oldSize = Number(size);\n            let oldPage = Number(search.page.current);\n            size=(size < 1)?1:size;\n            size=_.isNaN(size)?oldSize:size;\n            setPageSize(size);\n            const pageSize = search.page.rows;\n            let newPage = Math.floor((pageSize / oldSize) * oldPage);\n            // console.log(\"newPage: \" + newPage + \" oldPage: \" + oldPage + \" pageSize = \" + pageSize + \" oldSize = \" + oldSize);\n            newPage= _.isNaN(newPage)?0:newPage;\n            pager.setPage(newPage);\n        },\n        getPageSize: () => {\n            return search.page.rows;\n        },\n        // nextPage: () => {\n        //     alert(\"next\");\n        //\n\n    }\n\n\n    // Pass the docs and pager as properties.\n    const ret_children = React.Children.map(props.children, (child) => {\n        // when a child is an Element or Component it will have a \"type\" attribute\n        // if its a text node, it will not.\n        if (child.type) {\n            // clone the element (or Component) and pass new properties.\n            const new_child = React.cloneElement(child, {\n                docs: docs,\n                pager: pager\n            });\n            return new_child;\n        } else {\n            // otherwise, just pass the child as-is.\n            return child;\n        }\n    });\n    return ret_children;\n\n}\n","import React from \"react\";\nimport {ContentHeader} from \"./ContentHeader\";\nimport {Switch, Route, Redirect, useRouteMatch} from \"react-router-dom\";\nimport {AudioVideoViewer} from \"../views/AudioVideoViewer\";\nimport {ImagesViewer} from \"../views/ImagesViewer\";\nimport {TextsViewer} from \"../views/TextsViewer\";\nimport {SourcesViewer} from \"../views/SourcesViewer\";\nimport {VisualsViewer} from \"../views/VisualsViewer\";\nimport {PlacesViewer} from \"../views/PlacesViewer\";\nimport {SubjectsViewer} from \"../views/SubjectsViewer\";\nimport {RelatedsViewer} from \"../views/RelatedsViewer\";\nimport LegacyViewer from \"../views/LegacyViewer\";\nimport TermsViewer from \"../views/TermsViewer\";\nimport {SearchViewer} from \"../views/SearchViewer\";\nimport {CollectionsViewer} from \"../views/CollectionsViewer\";\nimport {Error404} from \"../App\";\nimport KmapContext from \"../context/KmapContext\";\nimport SearchContext from \"../context/SearchContext\";\n\nexport function ContentPane(props) {\n\n\n    console.log(\"ContentPanel: props =  \", props);\n\n    let {path} = useRouteMatch();\n    const title = props.title || \"Untitled\";\n    const siteClass = props.site || \"defauit\";\n    const left =\n        <div id='sui-content' className='sui-content'>\n            <ContentHeader siteClass={siteClass} title={title} sui={props.sui} kmasset={props.kmasset}/>\n            <div id={\"sui-results\"}>\n                <Switch>\n                    <Route path={`${path}/audio-video/:id`}>\n                        <AudioVideoViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/images/:id`}>\n                        <ImagesViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/texts/:id`}>\n                        <KmapContext>\n                            <TextsViewer onStateChange={props.onStateChange}/>\n                        </KmapContext>\n                    </Route>\n                    <Route path={`${path}/sources/:id`}>\n                        <SourcesViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/visuals/:id`}>\n                        <VisualsViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/places/:id`}>\n                        <PlacesViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/subjects/:id`}>\n                        <SubjectsViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/assets/:id`}>\n                        <RelatedsViewer id={props.id} onStateChange={props.onStateChange}/>\n                        <LegacyViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={[`${path}/terms/:id/related/:relatedType`,`${path}/terms/:id`]}>\n                        <KmapContext>\n                            <RelatedsViewer id={props.id} onStateChange={props.onStateChange}/>\n                            <TermsViewer onStateChange={props.onStateChange}/>\n                        </KmapContext>\n                    </Route>\n                    <Route path={`${path}/collections/:id`}>\n                        <CollectionsViewer id={props.id} sui={props.sui} onStateChange={props.onStateChange}/>\n                    </Route>\n                    <Route path={`${path}/search/:viewMode`}>\n                        <SearchContext>\n                            <SearchViewer />\n                        </SearchContext>\n                    </Route>\n                    <Route exact path={`${path}/search`}>\n                        <Redirect to={`${path}/search/default`} />\n                    </Route>\n                    <Route path=\"*\">\n                        <Error404/>\n                    </Route>\n                </Switch>\n            </div>\n        </div>;\n    return left;\n}","import React from \"react\";\n\nexport function Hamburger(props) {\n    const helpIcon = \"\\ue67e\";\n    const homeIcon = \"\\ue60b\";\n    const openclass = props.hamburgerOpen ? \"open\" : \"closed\";\n    const hamburger =\n        <div className={`sui-hamburger ${openclass}`} id='sui-hamburger'>\n            <span id='sui-help' className='sui-hamItem'>{helpIcon}&nbsp;&nbsp;HELP GUIDE</span>\n            <span id='sui-home' className='sui-hamItem'>{homeIcon}&nbsp;&nbsp;HOME</span>\n        </div>\n    return hamburger;\n}","import React, {useRef} from \"react\";\nimport * as PropTypes from \"prop-types\";\nimport _ from \"lodash\";\n\nexport function BasicSearch(props) {\n    const inputEl = useRef(null);\n    const currText=\"\";\n    // const [state, setState] = useState({searchString: {currText}});\n    const clearInput = () => {\n        inputEl.current.value = \"\";\n        props.onSubmit(inputEl.current.value);\n    };\n    const handleSubmit = () => {\n        props.onSubmit(inputEl.current.value);\n    }\n    const handleChange =\n        // To be used for completions if desired\n        _.debounce(() => {\n            console.log(\"handleChange: \",inputEl.current.value);\n        }, 300)\n\n    const handleKey = (x) => {\n        // submit on return\n        if (x.keyCode === 13) {\n            handleSubmit();\n        }\n    }\n    return <>\n        <div className='sui-search1'>\n            <input type='text' id='sui-search' className='sui-search2'\n                   defaultValue={currText}\n                   placeholder='Enter Search'\n                   onChange={handleChange}\n                   onKeyDownCapture={handleKey}\n                   ref={inputEl}/>\n            <div id='sui-clear' className='sui-search3' onClick={clearInput}>&#xe610;</div>\n        </div>\n        <div id='sui-searchgo' className='sui-search4' onClick={handleSubmit}>&#xe623;</div>\n    </>\n\n}\n\nBasicSearch.propTypes = {onChange: PropTypes.func};","import React from \"react\";\nimport {ADVANCED_LABEL, BASIC_LABEL} from \"../App\";\n\nexport class AdvancedToggle extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        this.toggleAdvanced = this.toggleAdvanced.bind(this);\n        this.setAdvanced = this.setAdvanced.bind(this);\n    }\n\n    setAdvanced(adv) {\n        // send state change message\n        this.props.onStateChange({advanced: adv});\n    }\n\n    toggleAdvanced() {\n        this.setAdvanced(!this.props.advanced);\n    }\n\n\n    componentDidMount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    render() {\n        const label = (this.props.advanced) ? BASIC_LABEL : ADVANCED_LABEL;\n        return (\n            <div onClick={this.toggleAdvanced} id='sui-mode' className='sui-search5'\n                 title='{label}'>{label}</div>\n        )\n    }\n}","import React from \"react\";\n\nexport class HamburgerToggle extends React.Component {\n\n    constructor(props) {\n        super(props);\n\n        this.toggleHamburger = this.toggleHamburger.bind(this);\n        this.setHamburgerOpen = this.setHamburgerOpen.bind(this);\n    }\n\n    setHamburgerOpen(hamOpen) {\n        // send state change message\n        this.props.onStateChange({hamburgerOpen: hamOpen});\n    }\n\n    toggleHamburger() {\n        this.setHamburgerOpen(!this.props.hamburgerOpen);\n    }\n\n    componentDidMount() {\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n    }\n\n    componentWillUnmount() {\n    }\n\n    componentDidCatch(error, errorInfo) {\n    }\n\n    render() {\n        return (\n            <div onClick={this.toggleHamburger} id='sui-hamBut' className='sui-hamBut'\n                 title='Help + options'>&#xe627;</div>\n        )\n    }\n}","import React from \"react\";\nimport {BasicSearch} from \"../main/BasicSearch\";\nimport {AdvancedToggle} from \"../main/AdvancedToggle\";\nimport {HamburgerToggle} from \"../main/HamburgerToggle\";\n\nexport class SearchBar extends React.Component {\n\n    constructor(props) {\n        super(props);\n        this.state = {advanced: false, hamburgerOpen: false};\n        this.handleStateChange = this.handleStateChange.bind(this);\n        this.handleInputChange = this.handleInputChange.bind(this);\n        this.handleSubmit = this.handleSubmit.bind(this);\n    }\n\n    render() {\n        const searchbar =\n            <div id='sui-top' className='sui-top'>\n                {/*<form onSubmit={this.handleSubmit}>*/}\n                <div style={{display: 'inline-block'}}>\n                    <BasicSearch onSubmit={this.handleSubmit} onChange={this.handleInputChange}/>\n                    <AdvancedToggle onStateChange={this.handleStateChange} advanced={this.state.advanced}/>\n                    <HamburgerToggle onStateChange={this.handleStateChange}\n                                     hamburgerOpen={this.state.hamburgerOpen}/>\n                </div>\n                {/*</form>*/}\n            </div>;\n        return searchbar;\n    }\n\n    handleInputChange(event) {\n        console.log(\"Input Change\", event.target.value);\n        this.setState({search: event.target.value});\n    }\n\n    handleSubmit(value) {\n        console.log(\"Submit: \" + value);\n        // alert(\"Submit: \" + value);\n        // this is a \"fake\" submit\n    }\n\n    handleClearBasic(event) {\n        console.log(\"Clear\");\n        event.preventDefault();\n    }\n\n    handleStateChange(newstate) {\n        this.setState(newstate, () => {\n            // console.log(\"SearchBar State now: \" + JSON.stringify(this.state));\n            this.props.onStateChange(this.state);\n        });\n    }\n}","import React, {useState} from \"react\";\n\nexport function FacetBox(props) {\n    const [open, setOpen] = useState(false);\n    let chosen_icon = props.icon;\n    const assetType = props.assetType;\n    const filters = props.filters;\n    console.log(\"FacetBox Filters: \", filters);\n\n    const ICON_MAP = {\n        \"audio-video\": \"\\ue648\",\n        \"texts\": \"\\ue636\",\n        \"images\": \"\\ue62a\",\n        \"sources\": \"\\ue631\",\n        \"visuals\": \"\\ue63b\",\n        \"places\": \"\\ue62b\",\n        \"subjects\": \"\\ue634\",\n        \"terms\": \"\\ue635\",\n        \"collections\": \"\\ue633\",\n        \"recent-searches\": \"\\ue62e\",\n        \"assets\": \"\\ue60b\",\n        \"users\": \"\\ue600\",\n        \"languages\": \"\\ue670\"\n    }\n    chosen_icon = chosen_icon || ICON_MAP[assetType];\n    const icon = chosen_icon;\n    const plus = \"\\ue669\";\n    const minus = \"\\ue66a\";\n    const label = props.label || \"UNKNOWN LABEL\";\n\n    const facetBox =\n        <div className='sui-advBox' id={\"sui-advBox-\" + props.id}>\n            <div className={'sui-advHeader'} id={'sui-advHeader-A'}\n                 onClick={() => setOpen(!open)}>{icon}&nbsp;&nbsp;{label}\n                {/* TODO: refactor setOpen to be css-based */}\n                <span id={'sui-advPlus-' + props.id} style={{float: 'right'}}>{open ? minus : plus}</span>\n            </div>\n\n            <div className={'sui-advTerm'} id={'sui-advTerm-' + props.id}>\n            </div>\n            <div className={'sui-advEdit ' + ((open) ? \"open\" : \"closed\")} id={'sui-advEdit-' + props.id}>\n                {/* TODO: refactor style to css*/}\n                <input placeholder='Search this list' value='' style={{\n                    width: '90px',\n                    border: '1px solid #999',\n                    borderRadius: '12px',\n                    fontSize: '11px',\n                    paddingLeft: '6px'\n                }}/>\n            </div>\n        </div>;\n    return facetBox;\n}","import {FacetBox} from \"./FacetBox\";\nimport React from \"react\";\n\nexport function SearchAdvanced(props) {\n    const query = \"\";\n    console.log(\"SearchAdvanced: query = \", query);\n    const openclass = props.advanced ? \"open\" : \"closed\";\n    const advanced =\n        <div id='sui-adv' className={`sui-adv ${openclass}`}>\n\n            <FacetBox id='squawk' label=\"item type\" assetType=\"assets\" filters={query.assets}/>\n            <FacetBox id='squawk' label=\"audio-video\" assetType=\"audio-video\"/>\n            <FacetBox id='squawk' label=\"images\" assetType=\"images\"/>\n            <FacetBox id='squawk' label=\"texts\" assetType=\"texts\"/>\n            <FacetBox id='squawk' label=\"images\" assetType=\"images\"/>\n            <FacetBox id='squawk' label=\"sources\" assetType=\"sources\"/>\n            <FacetBox id='squawk' label=\"visual\" assetType=\"visuals\"/>\n            <FacetBox id='squawk' label=\"subjects\" assetType=\"subjects\"/>\n            <FacetBox id='squawk' label=\"places\" assetType=\"places\"/>\n            <FacetBox id='squawk' label=\"texts\" assetType=\"texts\"/>\n            <FacetBox id='squawk' label=\"collections\" assetType=\"collections\"/>\n            <FacetBox id='squawk' label=\"languages\" assetType=\"languages\"/>\n\n            <FacetBox id='squawk' label=\"users\" assetType=\"users\"/>\n            <FacetBox id='squawk' label=\"languages\" assetType=\"languages\"/>\n\n            <FacetBox id='squawk' label=\"recent searches\" assetType=\"recent-searches\"/>\n\n            <div style={{\"marginTop\": '14px', float: 'right', \"fontSize\": '13px'}}>\n                <div>Show Boolean Controls? &nbsp;<input type='checkbox' id='sui-showBool'\n                                                         defaultChecked={'checked'}></input></div>\n            </div>\n            <div id='sui-footer' className='sui-footer'></div>\n        </div>;\n    return advanced;\n}","import React, {useState} from \"react\";\nimport {BrowserRouter as Router, Route, Redirect, Switch} from \"react-router-dom\";\n\nimport {TopBar} from \"./TopBar\";\nimport {Home} from \"./Home\";\nimport {ContentPane} from \"./ContentPane\";\nimport {Hamburger} from \"./Hamburger\";\n\nimport {SearchBar} from \"../search/SearchBar\";\nimport {SearchAdvanced} from \"../search/SearchAdvanced\";\nimport {Error404} from \"../App\";\nimport SearchContext from \"../context/SearchContext\";\n\n\nconst stateDefault = {\n    kmasset: {\n        header: \"Mandala\",\n        title: [\"Mandala\"],\n        uid: \"mandala\",\n    }\n};\n\nexport function Main(props) {\n\n    const [state, setState] = useState(stateDefault);\n    const handleStateChange = (new_state) => {\n\n        console.log(\"Setting state with: \", new_state);\n        console.log(\"Old state = \", state);\n\n        setState({...state, ...new_state});\n\n        console.log(\"New state = \", state);\n\n        console.log(\"Main() state = \", state);\n    }\n\n    const main =\n        <Router basename={\"/mandala-om\"}>\n            <div id={'sui-main'} className={'sui-main'}>\n                <div>\n                    <TopBar/>\n                        <SearchBar onStateChange={handleStateChange}/>\n                    <Switch>\n                        <Route path={\"/home\"}>\n                            <Home/>\n                        </Route>\n                        <Route exact path={\"/\"}>\n                            <Redirect to={\"/home\"}/>\n                        </Route>\n                        <Route path={\"/view\"}>\n                            <ContentPane site={'mandala'} mode={'development'} title={'Mandala'}\n                                         sui={props.sui}\n                                         kmasset={state.kmasset}\n                                         kmap={state.kmap}\n                                         onStateChange={handleStateChange}/>\n                        </Route>\n                        <Route path={\"*\"}>\n                            <Error404/>\n                            <Home/>\n                        </Route>\n                    </Switch>\n                    <SearchAdvanced advanced={state.advanced}/>\n                    <Hamburger hamburgerOpen={state.hamburgerOpen}/>\n                </div>\n            </div>\n        </Router>;\n    return main;\n}\n","import React from 'react';\n\nimport SearchUI from \"./legacy/searchui\";\nimport Pages from \"./legacy/pages\";\n\nimport './Om.css';\nimport './shanticon.css';\n// import {BrowserRouter as Router, Redirect, Route, Switch} from 'react-router-dom';\nimport {Main} from \"./main/Main\";\nimport 'bootstrap/dist/css/bootstrap.min.css';\n\nexport const ADVANCED_LABEL = \"Advanced Search\";\nexport const BASIC_LABEL = \"Basic Search\";\n\nclass App extends React.Component {\n\n    constructor(props) {\n        super();\n\n        if (!window.sui) {\n            window.sui = new SearchUI();\n        }\n        this.sui = window.sui;\n\n        if (!window.sui.pages) {\n            this.sui.pages = window.sui.pages = new Pages(this.sui);\n        }\n\n    }\n\n    render() {\n        return (\n            <Main sui={this.sui}/>\n        );\n    };\n}\n\nexport function Error404() {\n    return <div><h2>OUCH!</h2>\n        Unknown Path: {window.location.pathname}\n    </div>;\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\r\n// register() is not called by default.\r\n\r\n// This lets the app load faster on subsequent visits in production, and gives\r\n// it offline capabilities. However, it also means that developers (and users)\r\n// will only see deployed updates on subsequent visits to a page, after all the\r\n// existing tabs open on the page have been closed, since previously cached\r\n// resources are updated in the background.\r\n\r\n// To learn more about the benefits of this model and instructions on how to\r\n// opt-in, read https://bit.ly/CRA-PWA\r\n\r\nconst isLocalhost = Boolean(\r\n  window.location.hostname === 'localhost' ||\r\n    // [::1] is the IPv6 localhost address.\r\n    window.location.hostname === '[::1]' ||\r\n    // 127.0.0.0/8 are considered localhost for IPv4.\r\n    window.location.hostname.match(\r\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\r\n    )\r\n);\r\n\r\nexport function register(config) {\r\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\r\n    // The URL constructor is available in all browsers that support SW.\r\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\r\n    if (publicUrl.origin !== window.location.origin) {\r\n      // Our service worker won't work if PUBLIC_URL is on a different origin\r\n      // from what our page is served on. This might happen if a CDN is used to\r\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\r\n      return;\r\n    }\r\n\r\n    window.addEventListener('load', () => {\r\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\r\n\r\n      if (isLocalhost) {\r\n        // This is running on localhost. Let's check if a service worker still exists or not.\r\n        checkValidServiceWorker(swUrl, config);\r\n\r\n        // Add some additional logging to localhost, pointing developers to the\r\n        // service worker/PWA documentation.\r\n        navigator.serviceWorker.ready.then(() => {\r\n          console.log(\r\n            'This web app is being served cache-first by a service ' +\r\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\r\n          );\r\n        });\r\n      } else {\r\n        // Is not localhost. Just register service worker\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    });\r\n  }\r\n}\r\n\r\nfunction registerValidSW(swUrl, config) {\r\n  navigator.serviceWorker\r\n    .register(swUrl)\r\n    .then(registration => {\r\n      registration.onupdatefound = () => {\r\n        const installingWorker = registration.installing;\r\n        if (installingWorker == null) {\r\n          return;\r\n        }\r\n        installingWorker.onstatechange = () => {\r\n          if (installingWorker.state === 'installed') {\r\n            if (navigator.serviceWorker.controller) {\r\n              // At this point, the updated precached content has been fetched,\r\n              // but the previous service worker will still serve the older\r\n              // content until all client tabs are closed.\r\n              console.log(\r\n                'New content is available and will be used when all ' +\r\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\r\n              );\r\n\r\n              // Execute callback\r\n              if (config && config.onUpdate) {\r\n                config.onUpdate(registration);\r\n              }\r\n            } else {\r\n              // At this point, everything has been precached.\r\n              // It's the perfect time to display a\r\n              // \"Content is cached for offline use.\" message.\r\n              console.log('Content is cached for offline use.');\r\n\r\n              // Execute callback\r\n              if (config && config.onSuccess) {\r\n                config.onSuccess(registration);\r\n              }\r\n            }\r\n          }\r\n        };\r\n      };\r\n    })\r\n    .catch(error => {\r\n      console.error('Error during service worker registration:', error);\r\n    });\r\n}\r\n\r\nfunction checkValidServiceWorker(swUrl, config) {\r\n  // Check if the service worker can be found. If it can't reload the page.\r\n  fetch(swUrl, {\r\n    headers: { 'Service-Worker': 'script' },\r\n  })\r\n    .then(response => {\r\n      // Ensure service worker exists, and that we really are getting a JS file.\r\n      const contentType = response.headers.get('content-type');\r\n      if (\r\n        response.status === 404 ||\r\n        (contentType != null && contentType.indexOf('javascript') === -1)\r\n      ) {\r\n        // No service worker found. Probably a different app. Reload the page.\r\n        navigator.serviceWorker.ready.then(registration => {\r\n          registration.unregister().then(() => {\r\n            window.location.reload();\r\n          });\r\n        });\r\n      } else {\r\n        // Service worker found. Proceed as normal.\r\n        registerValidSW(swUrl, config);\r\n      }\r\n    })\r\n    .catch(() => {\r\n      console.log(\r\n        'No internet connection found. App is running in offline mode.'\r\n      );\r\n    });\r\n}\r\n\r\nexport function unregister() {\r\n  if ('serviceWorker' in navigator) {\r\n    navigator.serviceWorker.ready.then(registration => {\r\n      registration.unregister();\r\n    });\r\n  }\r\n}\r\n","import React from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport './index.css';\r\nimport App from './App';\r\n// import store from './app/store';\r\n// import { Provider } from 'react-redux';\r\nimport * as serviceWorker from './serviceWorker';\r\nimport { storeModel } from './model/StoreModel';\r\nimport { createStore, StoreProvider } from \"easy-peasy\";\r\n\r\nconst store = createStore(storeModel);\r\n\r\n\r\nReactDOM.render(\r\n  // <React.StrictMode>\r\n    <StoreProvider store={store}>\r\n      <App />\r\n    </StoreProvider>\r\n  // </React.StrictMode>\r\n    ,\r\n  document.getElementById('root')\r\n);\r\n\r\n// If you want your app to work offline and load faster, you can change\r\n// unregister() to register() below. Note this comes with some pitfalls.\r\n// Learn more about service workers: https://bit.ly/CRA-PWA\r\nserviceWorker.unregister();\r\n"],"sourceRoot":""}